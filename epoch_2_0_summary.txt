================================================================================
EPOCH TRADING SYSTEM v2.0 - ZONE ANALYSIS APPLICATION
System Specifications
XIII Trading LLC
================================================================================

1. IMPLEMENTATION OVERVIEW
================================================================================

The Epoch Zone Analysis application is a PyQt6 desktop application that serves
as a pre-market preparation tool for identifying high-probability supply and
demand trading zones through volume profile analysis. The system operates as a
closed-loop pipeline: a two-phase market scanner first filters the S&P 500 or
NASDAQ 100 universe by ATR (>=$2.00), price (>=$10.00), and gap magnitude
(>=2%), then ranks survivors by overnight volume, relative volume, and gap
size to surface "in-play" candidates. Once the user selects tickers and
assigns anchor dates (the start of the volume profile epoch), the pipeline
fetches 1-minute bar data from Polygon.io, constructs a $0.01-granularity
volume profile across the full epoch period, and extracts the top 10
non-overlapping High Volume Nodes (HVNs) ranked by cumulative volume with an
ATR/2 separation threshold. Each HVN Point of Control (POC) becomes the
center of a confluence zone (POC +/- M15_ATR/2), which is then scored against
60+ multi-timeframe technical levels -- including monthly/weekly/daily OHLC,
prior period levels, Camarilla pivots (S3/S4/S6, R3/R4/R6), top-10 options
open interest strikes, and fractal-based market structure strong/weak levels
across D1, H4, H1, and M15 timeframes -- using a bucket-max scoring system
that prevents intra-category stacking. The resulting confluence scores drive an
L1-L5 rank (thresholds at 3/6/9/12 points) and T1-T3 tier classification,
after which zones are filtered by proximity (within 2x D1 ATR of current
price), deduplicated for overlap, and the closest HVN above and below price
are designated as bull and bear POC anchors. Finally, the setup analyzer
assigns primary and secondary trading directions aligned with a weighted
composite market structure score (D1:1.5, H4:1.5, H1:1.0, M15:0.5), calculates
targets via a 3R/4R HVN POC cascade, and exports all results to Supabase for
downstream consumption by the backtesting engine.


2. HIGH-LEVEL TECHNICAL SPECIFICATIONS
================================================================================

2.1 APPLICATION FRAMEWORK
--------------------------------------------------------------------------------
- Runtime:          Python 3.12+
- UI Framework:     PyQt6 desktop application
- Window Size:      Minimum 1400 x 900 pixels
- Theme:            Dark mode (custom stylesheet)
- Tab Count:        10 tabs in sequential workflow
- State Management: QObject with pyqtSignal for inter-tab communication

2.2 DATA SOURCES
--------------------------------------------------------------------------------
- Market Data:      Polygon.io REST API (1-min, 15-min, 1-hour, 4-hour, daily)
- Database:         Supabase (PostgreSQL) via psycopg2 with SSL
- Caching:          File-based pickle cache with configurable TTL
                    - Intraday: 1-hour TTL
                    - Daily: 24-hour TTL
- Rate Limiting:    0.25s between Polygon API calls, 3 retry attempts

2.3 ANALYSIS PIPELINE (6 STAGES)
--------------------------------------------------------------------------------

  Stage 1: Market Structure
  -------------------------
  - Fractal detection (length=5, p=2 bars each side) across 4 timeframes
  - Timeframes: D1 (250-day lookback), H4 (100-day), H1 (50-day), M15 (15-day)
  - Break types: BOS (Break of Structure), ChoCH (Change of Character)
  - Output: Direction per timeframe (Bull/Bear/Neutral) + strong/weak levels
  - Composite: Weighted score (D1=1.5, H4=1.5, H1=1.0, M15=0.5)
  - Thresholds: score >= 3.5 = Bull+, score <= -3.5 = Bear+

  Stage 2: Bar Data
  -----------------
  - OHLC: Current + prior period for Monthly, Weekly, Daily
  - ATR: M1, M5, M15, H1, D1 (14-period)
  - Camarilla Pivots: S3/S4/S6, R3/R4/R6 at daily, weekly, monthly
  - Overnight: High and Low from extended hours
  - Output: BarData Pydantic model with ~70 technical levels

  Stage 2b: Options Levels
  ------------------------
  - Top 10 strikes by open interest near current price
  - Weighted by proximity to price (op_01=2.5 down to op_09/10=0.5)

  Stage 3: HVN POC Identification
  --------------------------------
  - Data: 1-minute bars from anchor_date to analysis_date
  - Chunked fetching: 30-day chunks for API compliance
  - Volume Profile: $0.01 price granularity, volume distributed proportionally
  - Selection: Top 10 POCs by volume, non-overlapping (ATR/2 minimum distance)
  - Base weights: POC1=3.0, POC2=2.5, POC3=2.0 ... POC10=0.1

  Stage 4: Zone Calculation (Confluence Scoring)
  -----------------------------------------------
  - Zone boundaries: POC +/- (M15_ATR / 2)
  - Confluence check: Each zone tested against all technical levels
  - Scoring: Bucket-max system (max weight per confluence category, no stacking)
  - Total score = base_score (from POC rank) + sum(bucket_max scores)
  - Ranking thresholds:
      L5: score >= 12.0 (highest quality)
      L4: score >= 9.0
      L3: score >= 6.0
      L2: score >= 3.0
      L1: score < 3.0  (lowest quality)

  Stage 5: Zone Filtering
  -----------------------
  - Tier classification: L4/L5 = T3, L3 = T2, L1/L2 = T1
  - Proximity filter: Within 2x D1 ATR of current price
  - Proximity groups: Group 1 (<=1 ATR), Group 2 (1-2 ATR)
  - Overlap elimination: Highest score wins
  - Max zones per ticker: 10
  - Bull/Bear POC: Closest HVN above/below current price

  Stage 6: Setup Analysis
  -----------------------
  - Target selection: 3R/4R HVN POC cascade
    - Bull: Find POC above zone >= 3R from zone_high (highest volume priority)
    - Bear: Find POC below zone <= 3R from zone_low (highest volume priority)
    - Fallback: Calculated 4R level if no qualifying POC
  - R:R calculation: reward / risk based on zone boundaries
  - Direction assignment:
    - Bull/Bull+ composite: Primary = Bull setup, Secondary = Bear
    - Bear/Bear+ composite: Primary = Bear setup, Secondary = Bull
    - Neutral: Primary = Bull (default), Secondary = Bear

2.4 CONFLUENCE WEIGHT SYSTEM
--------------------------------------------------------------------------------

  Category                Weight    Bucket Max
  -------------------------------------------
  Monthly OHLC            3.0       3.0
  Prior Monthly           3.0       3.0
  Monthly Camarilla       3.0       3.0
  Weekly OHLC             2.0       2.0
  Prior Weekly            2.0       2.0
  Weekly Camarilla        2.0       2.0
  Options (top 10 OI)     0.5-2.5   2.5
  Market Structure D1     1.5       1.5
  Market Structure H4     1.25      1.25
  Market Structure H1     1.0       1.0
  Market Structure M15    0.75      0.75
  Daily OHLC              1.0       1.0
  Prior Daily             1.0       1.0
  Daily Camarilla         1.0       1.0

  Maximum theoretical score: ~27.0 (base 3.0 + all buckets)

2.5 USER INTERFACE (10 TABS)
--------------------------------------------------------------------------------

  Tab 1:  Pre-Market Scanner
          - Universe: S&P 500 (~503 tickers) or NASDAQ 100
          - Phase 1 filters: ATR >= $2.00, Price >= $10.00, Gap >= 2%
          - Phase 2 ranking: Normalized composite (overnight vol, relative vol, gap)
          - Parallel execution: 10 worker threads

  Tab 2:  Market Screener
          - Up to 10 custom tickers with individual anchor dates
          - Anchor presets: Custom, Prior Day, Prior Week, Prior Month, YTD
          - Index tickers (SPY, QQQ, DIA) auto-analyzed with prior month anchor
          - Pre-Market / Post-Market time modes with cutoff timestamps

  Tab 3:  Dashboard
          - Summary metrics per ticker (direction, zone count, bull/bear POC)

  Tab 4:  Bar Data
          - Full OHLC, ATR, Camarilla, Options, Market Structure levels

  Tab 5:  Raw Zones
          - All 10 zones per ticker before filtering (score, rank, confluences)

  Tab 6:  Zone Results
          - Filtered zones with tier, proximity group, bull/bear flags

  Tab 7:  Zone Analysis
          - Primary and secondary setups with targets and R:R ratios

  Tab 8:  TradingView Export
          - PineScript_6 format: pri_high,pri_low,pri_target,sec_high,sec_low,sec_target
          - PineScript_16 format: above + 10 POC prices

  Tab 9:  Database Export
          - Supabase upload: zones, setups, bar_data, hvn_pocs, market_structure
          - Terminal output for export confirmation

  Tab 10: Pre-Market Report
          - Full pre-market visualization and summary report

2.6 DATA MODELS (Pydantic v2)
--------------------------------------------------------------------------------

  - Direction:       Enum (Bull+, Bull, Neutral, Bear, Bear+)
  - Rank:            Enum (L1 through L5)
  - Tier:            Enum (T1, T2, T3)
  - TickerInput:     ticker, analysis_date, anchor_date
  - MarketStructure: D1/H4/H1/M15 TimeframeStructure + composite
  - TimeframeStructure: direction, strong level, weak level
  - BarData:         ~70 fields (OHLC x3 periods, ATR x5, Camarilla x3, etc.)
  - OHLCData:        open, high, low, close
  - CamarillaLevels: S3/S4/S6, R3/R4/R6
  - HVNResult:       10 POCResult objects (price, volume, rank)
  - RawZone:         POC, zone boundaries, score, rank, confluences
  - FilteredZone:    Extends RawZone with tier, proximity, bull/bear flags
  - Setup:           zone, target, R:R, direction, type (Primary/Secondary)

2.7 INDEX TICKER HANDLING
--------------------------------------------------------------------------------
  - SPY, QQQ, DIA always analyzed for broad market context
  - Default anchor: First day of prior month
  - Processed before custom tickers in pipeline

2.8 EXPORT TARGETS
--------------------------------------------------------------------------------

  Supabase Tables:
  - zones:             Filtered zone data per ticker
  - setups:            Primary/secondary setup configurations
  - bar_data:          Full OHLC, ATR, Camarilla, Options levels
  - hvn_pocs:          POC 1-10 price levels per ticker
  - market_structure:  Direction and strong/weak levels per timeframe

  TradingView:
  - PineScript_6:  6-value comma-separated string for zone overlay
  - PineScript_16: 16-value string including all 10 POC levels

2.9 RISK MANAGEMENT PARAMETERS
--------------------------------------------------------------------------------
  - Risk per trade:            $20.00 (ATR-based sizing)
  - Minimum R:R for targets:   3.0R (POC-based targets)
  - Default R:R fallback:      4.0R (calculated targets)
  - Zone risk:                 zone_high - zone_low (M15_ATR width)

2.10 CONFIGURATION DEFAULTS
--------------------------------------------------------------------------------
  - Scanner: min_atr=$2.00, min_price=$10.00, min_gap=2.0%
  - Zones: max_zones=10, zone_atr_divisor=2.0, proximity_multiplier=2.0
  - HVN: poc_count=10, $0.01 granularity, 30-day API chunks
  - Fractals: length=5, p=2 (bars each side)
  - Cache: intraday=3600s, daily=86400s

================================================================================
Document generated for XIII Trading LLC - Epoch Trading System v2.0
================================================================================


================================================================================
EPOCH TRADING SYSTEM v2.0 - ENTRY QUALIFIER APPLICATION
System Specifications
XIII Trading LLC
================================================================================

1. IMPLEMENTATION OVERVIEW
================================================================================

The Entry Qualifier is a live-session PyQt6 desktop tool that provides
real-time 1-minute (M1) indicator calculations to support the trader's entry
and exit decision matrix during active market hours. The application polls
Polygon.io every 60 seconds -- synchronized to minute boundaries so data
refreshes align with new candle closes -- and fetches 50 M1 bars per ticker
(25 displayed plus 25 additional for calculation warm-up), presenting a
rolling 25-bar indicator dashboard across up to 6 simultaneous tickers. Five
backtested indicators are computed per bar: Candle Range % (the absorption
zone filter that dims entire columns below 0.12% to signal consolidation
periods the trader should skip), Volume Delta (a 5-bar rolling sum of
close-position-weighted volume estimating net buying/selling pressure),
Volume Rate of Change (current volume vs. a 20-bar trailing average to
confirm momentum acceleration), SMA Configuration (SMA9 vs. SMA21 alignment
with spread percentage to gauge trend strength), and H1 Market Structure
(swing-based higher-high/higher-low analysis on hourly bars cached and
refreshed once per hour). These five indicators were selected through
extensive backtesting across hundreds of historical trades and represent the
highest-edge conditions identified by the EPCH model, with H1 Structure
neutral being the single strongest validated edge at +36 percentage points
above baseline. The system also computes LONG and SHORT composite scores
(0-7 scale) that combine the indicator readings -- notably using deliberate
contrarian "paradoxes" in the SHORT score where bullish SMA configuration and
positive volume delta award points, reflecting an exhaustion/failed-rally
thesis -- which feed into the integrated DOW AI dual-pass analysis system
for structured TRADE/NO_TRADE recommendations.


2. HIGH-LEVEL TECHNICAL SPECIFICATIONS
================================================================================

2.1 APPLICATION FRAMEWORK
--------------------------------------------------------------------------------
- Runtime:          Python 3.12+
- UI Framework:     PyQt6 desktop application
- Window Size:      1920 x 1080 pixels (full-screen)
- Theme:            Dark mode (custom stylesheet, Segoe UI 10pt base)
- Version:          Entry Qualifier v3.0 / DOW AI Terminal v3.0
- Max Tickers:      6 simultaneous

2.2 DATA SOURCES
--------------------------------------------------------------------------------
- Market Data:      Polygon.io REST API
                    - M1 bars: /v2/aggs/ticker/{}/range/1/minute/{from}/{to}
                    - H1 bars: /v2/aggs/ticker/{}/range/1/hour/{from}/{to}
- M1 Lookback:      2 calendar days, 50 bars fetched, 25 displayed
- H1 Lookback:      5 calendar days, 25 bars fetched
- Rate Limiting:    0.1s between API calls, 3 retry attempts, 1.0s retry delay
- API Parameters:   adjusted=true, sort=asc, limit=50000
- AI Engine:        Anthropic Claude (claude-sonnet-4-20250514, 1500 max tokens)
- AI Context:       JSON files (model_stats, indicator_edges, zone_performance)

2.3 REFRESH ARCHITECTURE
--------------------------------------------------------------------------------
- Polling Interval:     60,000ms (1 minute)
- Minute Sync:          Initial timer aligned to next minute boundary
                        via seconds_until_next_minute() calculation
- Clock Timer:          1,000ms interval (UI clock update)
- Countdown Timer:      1,000ms interval (next-update countdown)
- Market Hours Check:   Polling pauses when market is closed
- H1 Cache:             Per-ticker cache, refreshes only when new H1 candle closes
- Threading:            QThread workers per ticker (parallel data fetch)

2.4 MARKET HOURS (US Equity)
--------------------------------------------------------------------------------
- Pre-Market:       04:00 - 09:30 ET
- Regular Session:  09:30 - 16:00 ET
- After-Hours:      16:00 - 20:00 ET
- Closed:           20:00 - 04:00 ET, weekends, US market holidays
- Holiday Calendar: Hardcoded 2024-2026 (New Year's, MLK, Presidents',
                    Good Friday, Memorial, Juneteenth, Independence,
                    Labor, Thanksgiving, Christmas)
- Timezone:         America/New_York (Eastern Time)

2.5 INDICATOR SPECIFICATIONS
--------------------------------------------------------------------------------

  Indicator 1: Candle Range %
  ---------------------------
  Purpose:    Primary absorption zone filter. Identifies when price action
              is too compressed for a tradeable move.
  Formula:    candle_range_pct = (high - low) / close * 100
  Thresholds:
    - ABSORPTION:  < 0.12%  (skip -- entire column dimmed in UI)
    - LOW:         0.12% - 0.15%
    - NORMAL:      >= 0.15% (tradeable edge confirmed)
    - HIGH:        >= 0.20% (strong signal)
  Display:    "X.XX%" with 2 decimal places
  Colors:     Green (>= 0.15%), Gray (0.12-0.15%), Red (< 0.12%)
  UI Effect:  Absorption bars dim entire column to #1a1a1a background
              with #4a4a4a muted text across ALL indicator rows

  Indicator 2: Volume Delta
  -------------------------
  Purpose:    Estimates net buying vs. selling pressure using bar
              close position within the high-low range.
  Formula:
    bar_range    = high - low
    position     = (2 * (close - low) / bar_range) - 1    [range: -1 to +1]
    raw_delta    = position * volume
    roll_delta   = sum(raw_deltas[-5:])                    [5-bar rolling sum]
  Parameters:
    - Roll period: 5 bars (VOL_DELTA_ROLL_PERIOD)
    - Close at high: position = +1 (all buying)
    - Close at low: position = -1 (all selling)
    - Close at midpoint: position = 0 (neutral)
    - Zero-range bar: delta = 0
  Display:    Formatted with K/M suffixes (e.g., "+45k", "-2M")
  Colors:     Green (positive), Red (negative), Gray (zero)

  Indicator 3: Volume Rate of Change (ROC)
  -----------------------------------------
  Purpose:    Measures current volume against recent average to
              confirm momentum and acceleration.
  Formula:
    avg_volume = mean(volumes[-lookback:])   [previous N bars, excluding current]
    volume_roc = ((current_volume - avg_volume) / avg_volume) * 100
  Parameters:
    - Lookback: 20 bars (VOL_ROC_LOOKBACK)
    - Returns None for bars before lookback period fills
  Thresholds:
    - ELEVATED:  >= 30%  (momentum confirmation)
    - HIGH:      >= 50%  (strong momentum)
  Display:    "+XX%" or "-XX%" (signed integer percentage)
  Colors:     Green (>= 30%), Gray (0-30%), Red (< 0%)

  Indicator 4: SMA Configuration
  ------------------------------
  Purpose:    Determines trend alignment via SMA9/SMA21 crossover
              state and spread magnitude.
  Formula:
    sma9       = mean(closes[-9:])
    sma21      = mean(closes[-21:])
    config     = BULL if sma9 > sma21, BEAR if sma9 < sma21, FLAT if equal
    spread_pct = abs(sma9 - sma21) / close * 100
  Parameters:
    - Short period: 9
    - Long period: 21
    - Minimum bars: 21 (returns None before)
  Thresholds:
    - WIDE_SPREAD: >= 0.15% (strong trend)
  Price Position:
    - ABOVE: close > max(sma9, sma21)
    - BETWEEN: between the two SMAs
    - BELOW: close < min(sma9, sma21)
  Display:    "BULL 0.15%" or "BEAR 0.08%" or "FLAT 0.02%"
  Colors:     Green (BULL), Red (BEAR), Gray (FLAT)

  Indicator 5: H1 Market Structure
  --------------------------------
  Purpose:    Determines macro market structure on the 1-hour timeframe
              using swing high/low analysis.
  Algorithm:
    1. Takes most recent lookback+2 H1 bars (default: 7 bars)
    2. Splits at midpoint
    3. Compares max highs and min lows of first half vs. second half
    4. Higher highs AND higher lows = BULL
    5. Lower highs AND lower lows = BEAR
    6. Otherwise = NEUTRAL
  Parameters:
    - Lookback: 5 H1 bars (plus 2 for comparison = 7 total)
    - H1 bars fetched: 25 (H1_BARS_NEEDED)
    - Cache refresh: Only when new H1 candle closes
  Display:    "BULL", "BEAR", or "NEUT"
  Colors:     Green (BULL), Red (BEAR), Cyan #00BCD4 (NEUT)
  NOTE:       NEUTRAL is the PREFERRED condition for trading --
              H1 neutral is the single strongest validated backtested
              edge at +36 percentage points above baseline hit rate

2.6 COMPOSITE SCORING SYSTEM
--------------------------------------------------------------------------------

  LONG Score (0-7 points):
  -------------------------
  | Condition                              | Points |
  |----------------------------------------|--------|
  | Candle Range >= 0.15%                  | +2     |
  | H1 Structure = NEUTRAL                 | +2     |
  | Volume ROC >= 30%                      | +1     |
  | |Volume Delta| > 100,000 (magnitude)   | +1     |
  | SMA Spread >= 0.15% (wide)             | +1     |
  |                                 Total: | 0-7    |

  SHORT Score (0-7 points -- contains deliberate paradoxes):
  ----------------------------------------------------------
  | Condition                              | Points |
  |----------------------------------------|--------|
  | Candle Range >= 0.15%                  | +2     |
  | H1 Structure = NEUTRAL                 | +2     |
  | Volume ROC >= 30%                      | +1     |
  | Volume Delta > 0 (POSITIVE = paradox)  | +1     |
  | SMA Config = BULLISH (paradox)         | +1     |
  |                                 Total: | 0-7    |

  SHORT Score Paradox Design:
  - Positive volume delta awards SHORT points because it signals
    exhausted buyers (buying pressure that failed to push price higher)
  - Bullish SMA configuration awards SHORT points because it signals
    a failed rally setup (catching the reversal from bullish structure)

  Score Interpretation:
  - 0-2: Weak (Red)
  - 3-4: Moderate (Yellow)
  - 5-7: Strong (Green)

  NOTE: Composite scores are calculated and passed to the DOW AI
  dual-pass analysis system but are not displayed in the current
  ticker panel UI (reserved for AI context layer).

2.7 USER INTERFACE LAYOUT
--------------------------------------------------------------------------------

  Component 1: Header Bar
  -----------------------
  - Title: "EPOCH ENTRY QUALIFIER v3.0" (18px bold)
  - Live clock: ET time "HH:MM:SS" (Consolas 14pt), updates every second
  - Status: Green circle + "LIVE" (market open)
            Yellow circle + "PAUSED" (market closed)
            "STARTING" (initialization)

  Component 2: Ticker Management
  ------------------------------
  - "+ Add Ticker" button
  - Validation: Ticker verified against Polygon API before adding
  - Maximum: 6 tickers, button disabled at capacity
  - Remove: X button per ticker panel

  Component 3: Ticker Panels (up to 6)
  -------------------------------------
  - Layout: QTableWidget, 5 rows x 26 columns (1 label + 25 data)
  - Column order: Newest (0) to oldest (-24), left to right
  - Row 0: Candle %
  - Row 1: Vol Delta
  - Row 2: Vol ROC
  - Row 3: SMA
  - Row 4: H1 Struct
  - Empty panels: "No Ticker Configured" placeholder
  - Absorption dimming: Full-column visual override for bars < 0.12%

  Component 4: Global Control Panel (140px height)
  -------------------------------------------------
  - Ticker dropdown: ComboBox of active tickers
  - Direction selector: LONG (green) / SHORT (red) radio buttons
  - "Ask DOW AI" button: Triggers dual-pass AI analysis
  - Perspective input: "Your Perspective (Pass 1)" text area
    (QTextEdit, Consolas 9pt, max 60px height, dark background)

  Component 5: DOW AI Terminal (280px height)
  --------------------------------------------
  - Header: "DOW AI TERMINAL v3.0" (Consolas 11pt bold)
  - Status: "Ready" / "Analyzing..." / "Complete" / "Error"
  - Response area: Read-only QTextEdit (Consolas 11pt)
  - Dual-pass workflow: User perspective + AI analysis =
    structured TRADE/NO_TRADE recommendation with confidence

  Component 6: Status Bar (30px height)
  --------------------------------------
  - Status message (initialization/refresh)
  - Next update countdown ("Next Update: XXs")
  - Ticker count ("Tickers: X/6")
  - Market status ("Pre-Market" / "Market Open" /
                    "After-Hours" / "Market Closed")

2.8 DOW AI INTEGRATION
--------------------------------------------------------------------------------
- Architecture:     Dual-pass analysis (v3.0)
- Pass 1:           Trader's market perspective and directional read
- Pass 2:           AI evaluates perspective against backtested edges
- Context Sources:  model_stats.json, indicator_edges.json, zone_performance.json
- Data Passed:      Full M1BarFull objects including all 5 indicators + scores
- Output:           Structured TRADE/NO_TRADE recommendation with confidence
- Model:            claude-sonnet-4-20250514 (1500 max tokens)
- Strongest Edge:   H1 Structure neutral = +36pp above baseline hit rate

2.9 DATA FLOW ARCHITECTURE
--------------------------------------------------------------------------------

  1. Refresh timer fires (every 60s, synced to minute boundary)
  2. Market hours check -- skip if closed
  3. Per-ticker DataWorker (QThread) spawned:
     a. Fetch 50 M1 bars from Polygon.io (2-day lookback)
     b. Check H1 cache -- fetch 25 H1 bars if stale (5-day lookback)
     c. Calculate: candle_range, volume_delta, volume_roc, sma_config
     d. Calculate: h1_structure (from cached H1 bars)
     e. Calculate: long_score, short_score (composite)
     f. Assemble processed bar dictionaries
     g. Emit data_ready signal
  4. MainWindow receives signal, updates TickerPanel
  5. TickerPanel renders 25 most recent bars with color-coding
  6. Absorption zones trigger full-column dimming

2.10 CONFIGURATION SUMMARY
--------------------------------------------------------------------------------

  Application Settings:
  - ROLLING_BARS:           25 (bars displayed per ticker)
  - REFRESH_INTERVAL_MS:    60,000 (1 minute polling)
  - MAX_TICKERS:            6
  - PREFETCH_BARS:          50 (extra bars for calculation warm-up)
  - WINDOW_WIDTH:           1,920
  - WINDOW_HEIGHT:          1,080

  Indicator Parameters:
  - VOL_DELTA_ROLL_PERIOD:  5 bars
  - VOL_ROC_LOOKBACK:       20 bars
  - H1_BARS_NEEDED:         25 bars
  - SMA Short Period:       9
  - SMA Long Period:        21
  - H1 Structure Lookback:  5 bars (+ 2 for comparison)

  Thresholds:
  - Absorption Zone:        < 0.12% candle range (skip signal)
  - Tradeable Range:        >= 0.15% candle range
  - Strong Range:           >= 0.20% candle range
  - Elevated Volume ROC:    >= 30%
  - High Volume ROC:        >= 50%
  - Wide SMA Spread:        >= 0.15%
  - High Vol Delta:         > 100,000 (absolute magnitude)

  API Settings:
  - Rate Limit Delay:       0.1 seconds
  - Max Retries:            3
  - Retry Delay:            1.0 seconds

  Number Formatting:
  - >= 1,000,000:           "XM" (millions)
  - >= 1,000:               "Xk" (thousands)
  - < 1,000:                whole number

2.11 RELATIONSHIP TO EPOCH SYSTEM
--------------------------------------------------------------------------------
The Entry Qualifier is a sub-tool within the 02_dow_ai module of the
Epoch v2.0 system. It imports API credentials from the parent 02_dow_ai
config.py rather than from 00_shared infrastructure. It uses its own
self-contained calculation modules rather than the shared indicator
library, maintaining independence as a direct V1 port. The AI context
layer connects to backtested model statistics, indicator edges, and
zone performance data generated by the Epoch backtesting engine
(03_backtest), creating a closed feedback loop where historical trade
outcomes inform live-session decision support.

Launch methods:
  - Direct:   python entry_qualifier/main.py
  - Via app:  python app.py --entry-qualifier
  - Launcher: Epoch master launcher (launcher.py)

================================================================================
Document generated for XIII Trading LLC - Epoch Trading System v2.0
================================================================================


================================================================================
EPOCH TRADING SYSTEM v2.0 - BACKTEST RUNNER APPLICATION
System Specifications (Excluding Secondary Processors)
XIII Trading LLC
================================================================================

1. IMPLEMENTATION OVERVIEW
================================================================================

The Backtest Runner is a PyQt6 desktop application that simulates the
execution of Epoch zone-based trading setups against historical intraday
price data using a hybrid dual-timeframe model: 15-second (S15) bars drive
entry detection at high granularity while 5-minute (M5) bars manage all exit
logic including stop losses, targets, structural exits, and end-of-day
closures. For each trading date the system loads primary and secondary zone
setups from the Supabase setups table -- the same zones previously identified
and exported by the 01_application Zone Analysis pipeline -- then fetches
extended-hours S15 and M5 bar data from Polygon.io spanning from the prior
day's 16:00 close through the current session. Four entry models (EPCH1-4)
are evaluated on every S15 bar close: EPCH1 and EPCH3 detect zone
continuation patterns where price traverses completely through a primary or
secondary zone, while EPCH2 and EPCH4 detect zone rejection patterns where
price opens outside a zone, wicks into it, and closes back beyond the zone
boundary, with a price-origin lookback system that disambiguates signals
when price opens inside a zone by tracing the most recent bar that closed
outside the zone. Exit management follows a strict priority hierarchy on M5
bars -- STOP (zone boundary + 5% buffer), TARGET (3R or calculated target
from the zone pipeline, whichever is more favorable), CHoCH (M5 Change of
Character via fractal-based structure break detection with length=5), and
EOD (forced close at 15:50 ET) -- with completed trades recording full
P&L in both dollar and R-multiple terms. Results are exported back to
Supabase with aggregated session statistics, closing the feedback loop that
enables the system to improve its zone identification and entry model
calibration over time.


2. HIGH-LEVEL TECHNICAL SPECIFICATIONS
================================================================================

2.1 APPLICATION FRAMEWORK
--------------------------------------------------------------------------------
- Runtime:          Python 3.12+
- UI Framework:     PyQt6 desktop application
- Window Size:      Minimum 1200 x 900, default 1400 x 1000
- Theme:            Dark mode (custom stylesheet)
- Version:          Backtest Runner v3.0 (Hybrid S15/M5)
- Execution:        QProcess subprocess for CLI script isolation

2.2 DATA SOURCES
--------------------------------------------------------------------------------
- Zone Data:        Supabase PostgreSQL (setups table) via psycopg2 + SSL
- Market Data:      Polygon.io REST API
                    - S15: /v2/aggs/ticker/{}/range/15/second/{from}/{to}
                    - M5:  /v2/aggs/ticker/{}/range/5/minute/{from}/{to}
- API Parameters:   adjusted=true, sort=asc, limit=50000
- Rate Limiting:    0.25s between API calls, 3 retry attempts, 2.0s retry delay
- Extended Hours:   Prior day 16:00-20:00, pre-market 04:00-09:30, RTH 09:30-16:00

2.3 HYBRID DUAL-TIMEFRAME MODEL
--------------------------------------------------------------------------------

  The v3.0 engine uses two timeframes in parallel:

  S15 (15-second bars) -- ENTRY DETECTION:
  - High-granularity price action for precise entry timing
  - All four EPCH entry models evaluated on each S15 bar close
  - Extended hours fetch from prior day close (16:00)
  - Typical bar count: ~800+ bars per session (pre-market included)

  M5 (5-minute bars) -- EXIT MANAGEMENT:
  - Coarser timeframe for position management and structure tracking
  - Stop, target, CHoCH, and EOD exits evaluated on M5 bar close
  - Extended hours fetch from prior day close (16:00)
  - Typical bar count: ~50+ bars per session (pre-market included)

  Synchronization:
  - S15 bars are iterated sequentially
  - Current M5 bar is tracked via timestamp alignment
  - Exit checks fire only when the M5 bar changes (new M5 candle)
  - Entry checks fire on every S15 bar close

2.4 TRADING SESSION PARAMETERS
--------------------------------------------------------------------------------
- Entry Window:     09:30 - 15:30 ET (new entries allowed)
- Entry Cutoff:     15:30 ET (no new positions after this time)
- Force Exit:       15:50 ET (all remaining positions closed at market)
- Session Type:     Day-trading only (no overnight holds)

2.5 ENTRY MODELS (EPCH1-4)
--------------------------------------------------------------------------------

  EPCH1 - Primary Zone Continuation:
  ----------------------------------
  Detects price traversing completely through the PRIMARY zone.
  - LONG:  Bar opens BELOW zone_low -> closes ABOVE zone_high
           OR opens INSIDE zone with price origin BELOW -> closes above zone_high
  - SHORT: Bar opens ABOVE zone_high -> closes BELOW zone_low
           OR opens INSIDE zone with price origin ABOVE -> closes below zone_low
  - Entry Price: Bar close
  - Entry on: S15 bar close

  EPCH2 - Primary Zone Rejection:
  --------------------------------
  Detects price rejecting from the PRIMARY zone boundary.
  - LONG:  Bar opens ABOVE zone_high -> wick enters zone (low <= zone_high)
           -> closes ABOVE zone_high
           OR opens INSIDE zone with price origin ABOVE -> closes above zone_high
  - SHORT: Bar opens BELOW zone_low -> wick enters zone (high >= zone_low)
           -> closes BELOW zone_low
           OR opens INSIDE zone with price origin BELOW -> closes below zone_low
  - Entry Price: Bar close
  - Entry on: S15 bar close

  EPCH3 - Secondary Zone Continuation:
  -------------------------------------
  Same logic as EPCH1, applied to the SECONDARY zone.

  EPCH4 - Secondary Zone Rejection:
  ----------------------------------
  Same logic as EPCH2, applied to the SECONDARY zone.

  Price Origin Detection:
  -----------------------
  When a bar opens INSIDE a zone, the system cannot immediately determine
  directionality. The price origin lookback scans bar history in reverse
  to find the most recent bar that closed OUTSIDE the zone:
  - If last external close was BELOW zone_low -> origin = BELOW
  - If last external close was ABOVE zone_high -> origin = ABOVE
  - If no external close found -> no signal generated
  - Max lookback: 1,000 bars

  Entry Signal Filters:
  ---------------------
  - Time window: 09:30 - 15:30 ET only
  - Minimum risk: >= $0.10 per share (MIN_RISK_DOLLARS)
  - All four models checked on every qualifying bar

2.6 STOP LOSS CALCULATION
--------------------------------------------------------------------------------
  LONG:
    zone_distance = entry_price - zone_low
    buffer = zone_distance * 0.05                    (5% buffer)
    stop_price = zone_low - buffer

  SHORT:
    zone_distance = zone_high - entry_price
    buffer = zone_distance * 0.05                    (5% buffer)
    stop_price = zone_high + buffer

  Risk = abs(entry_price - stop_price)

  Stop Fill Assumption:
  - ASSUME_STOP_FILL_AT_PRICE = True (default)
  - When True: stop fills at exact stop_price (-1R)
  - When False: stop fills at actual bar low/high (may be worse than -1R)

2.7 TARGET CALCULATION
--------------------------------------------------------------------------------
  Two target types are evaluated, and the MORE FAVORABLE one is used:

  3R Target (always calculated):
  - LONG:  target_3r = entry_price + (3.0 * risk)
  - SHORT: target_3r = entry_price - (3.0 * risk)

  Calculated Target (from Zone Analysis pipeline):
  - Passed through from Supabase setups table (target_price field)
  - Originally determined by 3R/4R HVN POC cascade in 01_application

  Target Selection Logic:
  - LONG:  If calc_target > target_3r -> use calc_target (type='CALC')
           Otherwise -> use target_3r (type='3R')
  - SHORT: If calc_target < target_3r -> use calc_target (type='CALC')
           Otherwise -> use target_3r (type='3R')

2.8 EXIT PRIORITY HIERARCHY
--------------------------------------------------------------------------------
  Exits are checked in strict priority order on each M5 bar:

  Priority 1: STOP LOSS
  - LONG: bar_low <= stop_price (or bar_high for SHORT >= stop_price)
  - Fill: At stop_price (when ASSUME_STOP_FILL_AT_PRICE = True)
  - Result: Always -1R (by design)

  Priority 2: TARGET HIT
  - LONG: bar_high >= target_used (or bar_low for SHORT <= target_used)
  - Fill: At target_used price
  - Exit code: TARGET_3R or TARGET_CALC depending on target_type

  Priority 3: CHoCH (Change of Character)
  - Enabled: USE_CHOCH_EXIT = True (default)
  - Minimum bars: Must be >= FRACTAL_LENGTH (5) bars since entry
  - LONG exit: bar_close < min(recent_lows[-5:]) (structure break down)
  - SHORT exit: bar_close > max(recent_highs[-5:]) (structure break up)
  - Fill: At bar_close

  Priority 4: EOD (End of Day)
  - Trigger: bar_time >= 15:50 ET
  - Fill: At bar_close
  - Purpose: Ensures no overnight holds

2.9 M5 STRUCTURE TRACKER (CHoCH Detection)
--------------------------------------------------------------------------------
  The exit_models.py contains a more sophisticated M5StructureTracker
  that uses fractal-based structure analysis:

  Fractal Detection:
  - Length: 5 bars (configurable via FRACTAL_LENGTH)
  - p = length // 2 = 2 (bars each side of pivot)
  - Bearish fractal (swing high): pivot bar high > all p bars on each side
  - Bullish fractal (swing low): pivot bar low < all p bars on each side

  Structure State:
  - os = 0 (initial), 1 (bullish), -1 (bearish)
  - Tracks upper_fractal_value and lower_fractal_value
  - CHoCH bullish: close > upper_fractal while os == -1 (bear -> bull break)
  - CHoCH bearish: close < lower_fractal while os == 1 (bull -> bear break)
  - Continuation tracking: updates swing high/low within current structure

  Trade Simulator CHoCH (simplified):
  - Uses recent_highs/recent_lows lists (last FRACTAL_LENGTH bars)
  - LONG exit: bar_close < min(recent_lows[-5:])
  - SHORT exit: bar_close > max(recent_highs[-5:])

2.10 P&L CALCULATION
--------------------------------------------------------------------------------
  Per-Trade P&L:
  - LONG:  pnl_dollars = exit_price - entry_price
  - SHORT: pnl_dollars = entry_price - exit_price
  - pnl_r = pnl_dollars / risk
  - is_win = pnl_dollars > 0

  Session Statistics:
  - Total Trades
  - Win Rate: wins / total_trades
  - Total P&L (R): sum of all pnl_r
  - Expectancy: total_pnl_r / total_trades
  - Profit Factor: gross_profit_r / gross_loss_r
  - Breakdown by Model (EPCH1-4): trades, win rate, total R
  - Breakdown by Exit Type (STOP/TARGET_3R/TARGET_CALC/CHOCH/EOD): trades, total R

  Trade ID Format: {ticker}_{MMDDYY}_{model}_{HHMM}
  Example: AAPL_012026_EPCH1_1045

2.11 ZONE DATA LOADING
--------------------------------------------------------------------------------
  Source: Supabase setups table
  Query: SELECT by date and setup_type (PRIMARY/SECONDARY)
  Fields loaded:
  - ticker, ticker_id, zone_id
  - direction (Bull/Bear)
  - hvn_poc, zone_high, zone_low
  - target_id, target_price, risk_reward

  Validation:
  - zone_high and zone_low must be non-null
  - If zone_high < zone_low, values are swapped
  - If hvn_poc is null, defaults to (zone_high + zone_low) / 2

  Available Dates: Query distinct dates from setups table (limit 30)
  Setup Counts: Aggregated PRIMARY/SECONDARY counts per date

  ZoneData Dataclass:
  - ticker, ticker_id, zone_id, direction
  - hvn_poc, zone_high, zone_low
  - tier (T1/T2/T3, optional)
  - target_id, target, rr
  - zone_type (PRIMARY/SECONDARY)

2.12 TRADES EXPORT
--------------------------------------------------------------------------------
  Target Table: Supabase trades table (21 columns)
  Export Fields:
    trade_id, date, ticker, model, zone_type, direction,
    zone_high, zone_low, entry_price, entry_time,
    stop_price, target_3r, target_calc, target_used,
    exit_price, exit_time, exit_reason,
    pnl_dollars, pnl_r, risk, is_winner

  Conflict Resolution: ON CONFLICT (trade_id) DO UPDATE
    - Updates exit fields and pnl on duplicate trade_id
  Duplicate Handling: Appends _1, _2, etc. for same-session duplicates

  Daily Sessions Table:
  - Auto-creates daily_sessions record (export_source='backtest_runner', version='3.0')
  - Updates aggregated stats: total_trades, wins, losses, net_pnl_r, win_rate

  Pre-Export: Optionally clears existing trades for the date (clear_existing=True)

2.13 USER INTERFACE
--------------------------------------------------------------------------------

  Header:
  - Title: "EPOCH BACKTEST RUNNER" (Segoe UI 18pt bold)
  - Version: "v3.0 Hybrid S15/M5" (Consolas 12pt, muted)

  Control Panel (130px height):
  - Date selector: QDateEdit with calendar popup (YYYY-MM-DD format)
  - Options: "Run Secondary Processors" checkbox
  - Progress bar: 0-100% with step tracking
  - Buttons: CLEAR TRADES, RUN BACKTEST, STOP

  Terminal Output (80% of window):
  - Header: "TERMINAL OUTPUT" + status indicator + Clear button
  - Font: Consolas 10pt, read-only QTextEdit
  - Color coding:
    - Red: ERROR, Traceback
    - Green: Complete, WIN
    - Orange: WRONG, LOSS
    - Blue: SECONDARY processor output
    - Default: Standard output
  - Progress parsing: Detects [X/Y] patterns for progress bar updates

  Status Bar (35px height):
  - Left: Status message
  - Right: Timestamp

  Process Management:
  - Backtest runs as QProcess subprocess (run_backtest.py)
  - PYTHONUNBUFFERED=1 for real-time output streaming
  - Kill support with 3-second wait for graceful shutdown
  - Close confirmation dialog when backtest is running

2.14 CLI INTERFACE
--------------------------------------------------------------------------------
  Script: scripts/run_backtest.py
  Usage:
    python run_backtest.py 2026-01-20              # Standard run
    python run_backtest.py 2026-01-20 --dry-run    # No database writes
    python run_backtest.py 2026-01-20 --secondary  # Run secondary processors
    python run_backtest.py 2026-01-20 --no-export  # Skip Supabase export

  Workflow:
  1. [1/3] Load zones from Supabase for target date
  2. [2/N] Per ticker: fetch S15 + M5 data, run hybrid simulation
  3. [3/3] Calculate stats, export trades, optionally run secondary processors

  Output: Per-trade summary with model, direction, entry/exit, R-multiple, WIN/LOSS

2.15 CONFIGURATION SUMMARY
--------------------------------------------------------------------------------

  Session Timing:
  - ENTRY_START_TIME:           09:30 ET
  - ENTRY_END_TIME:             15:30 ET
  - FORCE_EXIT_TIME:            15:50 ET

  Entry Parameters:
  - STOP_BUFFER_PCT:            0.05 (5% buffer beyond zone boundary)
  - MIN_RISK_DOLLARS:           $0.10 (minimum risk filter)
  - TARGET_R_MULTIPLE:          3.0 (3R target)
  - MAX_LOOKBACK_BARS:          1,000 (price origin detection)

  Exit Parameters:
  - USE_CHOCH_EXIT:             True
  - FRACTAL_LENGTH:             5
  - ASSUME_STOP_FILL_AT_PRICE:  True
  - BAR_TIMEFRAME_MINUTES:      5 (M5 exit bars)

  API Settings:
  - API_DELAY:                  0.25 seconds
  - API_RETRIES:                3
  - API_RETRY_DELAY:            2.0 seconds
  - API_LIMIT:                  50,000 bars per request

  Entry Models:
  - EPCH1:  Model 1 - Primary zone continuation
  - EPCH2:  Model 2 - Primary zone rejection
  - EPCH3:  Model 3 - Secondary zone continuation
  - EPCH4:  Model 4 - Secondary zone rejection

2.16 DATA MODELS
--------------------------------------------------------------------------------

  EntrySignal (dataclass):
    model, model_name, zone_type, direction, entry_price, entry_time,
    bar_index, stop_price, target_3r, target_calc, target_used,
    target_type, zone_high, zone_low, hvn_poc, risk

  ActivePosition (dataclass):
    position_id, signal (EntrySignal), entry_bar_idx,
    swing_high, swing_low, bars_since_entry

  CompletedTrade (dataclass):
    trade_id, ticker, date, model, model_name, zone_type, direction,
    zone_high, zone_low, entry_price, entry_time, stop_price,
    target_3r, target_calc, target_used, target_type,
    exit_price, exit_time, exit_reason, pnl_dollars, pnl_r, risk, is_win

  ExitSignal (dataclass):
    reason (ExitReason), exit_price, exit_time, bar_index,
    pnl_dollars, pnl_r, is_win

  ExitReason (Enum):
    STOP, TARGET_3R, TARGET_CALC, CHOCH, EOD

  ZoneData (dataclass):
    ticker, ticker_id, zone_id, direction, hvn_poc, zone_high, zone_low,
    tier, target_id, target, rr, zone_type

  S15Bar (dataclass):
    timestamp, open, high, low, close, volume, vwap, transactions

  M5Bar (dataclass):
    timestamp, open, high, low, close, volume, vwap, transactions

  ExportStats (dataclass):
    trades_exported, trades_skipped, errors, success (property)

2.17 RELATIONSHIP TO EPOCH SYSTEM
--------------------------------------------------------------------------------
  The Backtest Runner is the third module in the Epoch closed-loop system.
  It consumes the zone setups exported by 01_application (Zone Analysis)
  from the Supabase setups table, simulates trade execution against
  historical price data, and writes completed trade records back to the
  Supabase trades table. These trade results then feed into:

  - 02_dow_ai: AI context files (model_stats.json, indicator_edges.json,
    zone_performance.json) that inform live-session DOW AI recommendations
  - 05_system_analysis: Monte Carlo simulation and statistical analysis
    of backtest results for portfolio-level risk assessment
  - processor/ (secondary): 13 specialized analysis processors that
    generate detailed trade-level analytics (excluded from this document)

  This creates the self-improving feedback loop:
  Zone Identification -> Backtesting -> Statistical Analysis -> Refinement

  Launch Methods:
  - GUI:     python app.py
  - CLI:     python scripts/run_backtest.py {date}
  - Master:  Via Epoch launcher (launcher.py)

================================================================================
Document generated for XIII Trading LLC - Epoch Trading System v2.0
================================================================================


================================================================================
EPOCH TRADING SYSTEM v2.0 - SECONDARY ANALYSIS PROCESSOR
System Specifications
XIII Trading LLC
================================================================================

1. IMPLEMENTATION OVERVIEW
================================================================================

The Secondary Analysis Processor is a 15-step sequential pipeline that
enriches every completed backtest trade with detailed post-trade analytics
spanning excursion measurement, indicator snapshots, health scoring, stop
simulation, entry model refinement, R-multiple outcome evaluation, and
options performance tracking. The master orchestrator (run_all.py v1.6.0)
executes each processor as an isolated subprocess in strict dependency
order -- beginning with raw M1 and H1 bar ingestion from the Polygon.io
REST API, progressing through MFE/MAE potential calculation, multi-
timeframe indicator computation at the M1, M5, and entry-time level,
health-scored trade bar assembly, optimal trade event generation, R-level
crossing detection, options chain analysis, six distinct stop type
simulations, continuation and rejection indicator refinement scoring,
ATR-based R win/loss evaluation, and finally a unified canonical outcome
table that reconciles ATR-based and zone-buffer fallback methodologies.
All processors follow a consistent incremental pattern: query the source
trades table via LEFT JOIN exclusion to identify unprocessed records,
calculate metrics using a combination of Polygon.io market data and
previously computed secondary tables, and upsert results into dedicated
Supabase PostgreSQL target tables using psycopg2 with SSL and ON CONFLICT
handling. The shared indicators library provides standardized calculations
for SMA 9/21 spread and momentum, VWAP, volume rate of change, bar-
position volume delta, cumulative volume delta slope, and fractal-based
multi-timeframe market structure detection -- ensuring calculation
consistency across all 15 processors and the live Entry Qualifier tool.


2. HIGH-LEVEL TECHNICAL SPECIFICATIONS
================================================================================

2.1 ORCHESTRATION FRAMEWORK
--------------------------------------------------------------------------------
- Runner:           run_all.py v1.6.0 (SecondaryAnalysisRunner class)
- Execution:        subprocess.run() per module, real-time stdout
- Pipeline Steps:   15 sequential processors
- Dependency Graph: Strict ordering with declared depends_on per module
- CLI Arguments:    --dry-run, --limit N, --start-from STEP, --only STEP,
                    --no-stop, --verbose
- Error Handling:   Stop-on-error by default (--no-stop to continue)
- Database:         Supabase PostgreSQL via psycopg2 (SSL required)
- Data Source:      Polygon.io REST API for M1/M5/H1/H4/Daily bars

2.2 PIPELINE EXECUTION ORDER
--------------------------------------------------------------------------------
Step  Module               Description                           Target Table
----  -------------------  ------------------------------------  ----------------------
  1   m1_bars              Store raw M1 bar data from Polygon    m1_bars
  2   h1_bars              Store raw H1 bar data from Polygon    h1_bars
  3   mfe_mae              MFE/MAE potential (entry to EOD)      mfe_mae_potential
  4   entry_indicators     Entry-time indicator snapshots         entry_indicators
  5   m5_indicator_bars    Full-day M5 bars with indicators      m5_indicator_bars
  6   m1_indicator_bars    Full-day M1 bars with indicators      m1_indicator_bars
  7   m5_trade_bars        Trade-specific M5 bars + health       m5_trade_bars
  8   optimal_trade        ENTRY/MFE/MAE/EXIT event generation   optimal_trade
  9   r_level_events       R1/R2/R3 crossing event detection     optimal_trade (append)
 10   options_analysis     Options performance (FIRST_ITM)       options_analysis
 11   op_mfe_mae           Options MFE/MAE potential              op_mfe_mae_potential
 12   stop_analysis        6 stop types + outcome simulation     stop_analysis
 13   indicator_refinement Continuation/Rejection scores         indicator_refinement
 14   r_win_loss           ATR-based R win/loss (1R-5R)          r_win_loss
 15   trades_unified       Canonical outcome table               trades_m5_r_win

2.3 DEPENDENCY GRAPH
--------------------------------------------------------------------------------
Step 1  (m1_bars)              depends_on: []
Step 2  (h1_bars)              depends_on: []
Step 3  (mfe_mae)              depends_on: [m1_bars]
Step 4  (entry_indicators)     depends_on: [mfe_mae]
Step 5  (m5_indicator_bars)    depends_on: []
Step 6  (m1_indicator_bars)    depends_on: [m1_bars]
Step 7  (m5_trade_bars)        depends_on: [mfe_mae, m5_indicator_bars]
Step 8  (optimal_trade)        depends_on: [mfe_mae, m5_trade_bars]
Step 9  (r_level_events)       depends_on: [optimal_trade]
Step 10 (options_analysis)     depends_on: []
Step 11 (op_mfe_mae)           depends_on: [options_analysis]
Step 12 (stop_analysis)        depends_on: [mfe_mae, m1_bars, m5_trade_bars]
Step 13 (indicator_refinement) depends_on: [entry_indicators, m5_indicator_bars]
Step 14 (r_win_loss)           depends_on: [m1_bars, m5_trade_bars, m5_indicator_bars]
Step 15 (trades_unified)       depends_on: [r_win_loss, m1_bars]

2.4 STEP 1 - M1 BARS (Raw Data Ingestion)
--------------------------------------------------------------------------------
- Purpose:          Fetch and store raw 1-minute OHLCV bars from Polygon.io
- Batch Size:       500 records per INSERT
- Target Table:     m1_bars
- Fields:           trade_id, ticker, date, bar_time, bar_date, open, high,
                    low, close, volume, vwap

2.5 STEP 2 - H1 BARS (Raw Data Ingestion)
--------------------------------------------------------------------------------
- Purpose:          Fetch and store raw H1 (1-hour) bars from Polygon.io
- Lookback:         30 bars / 7 calendar days
- Target Table:     h1_bars
- Fields:           ticker, date, bar_time, open, high, low, close, volume

2.6 STEP 3 - MFE/MAE POTENTIAL (Excursion Analysis)
--------------------------------------------------------------------------------
- Purpose:          Calculate POTENTIAL MFE and MAE from entry time to EOD
                    (as opposed to REALIZED MFE/MAE which measures entry to exit)
- EOD Cutoff:       15:30 ET
- Minimum Risk:     $0.01 stop_distance (MIN_RISK_DOLLARS)
- Bar Timeframe:    1-minute bars from Polygon.io
- LONG Calculation:
    MFE = (highest_high - entry_price) / stop_distance
    MAE = (entry_price - lowest_low) / stop_distance
- SHORT Calculation:
    MFE = (entry_price - lowest_low) / stop_distance
    MAE = (highest_high - entry_price) / stop_distance
- Optimization:     Groups trades by (ticker, date) to minimize API calls
- Comparison Data:  Fetches realized MFE/MAE from optimal_trade for reference
- Target Table:     mfe_mae_potential
- Output Fields:    trade_id, date, ticker, direction, model, entry_time,
                    entry_price, stop_price, stop_distance, mfe_r_potential,
                    mfe_potential_price, mfe_potential_time, mae_r_potential,
                    mae_potential_price, mae_potential_time, bars_analyzed,
                    eod_cutoff, mfe_r_realized, mae_r_realized, pnl_r,
                    is_winner (21 fields)

2.7 STEP 4 - ENTRY INDICATORS (Entry-Time Snapshot)
--------------------------------------------------------------------------------
- Purpose:          Capture full indicator state at the exact moment of entry
- Data Source:      M1 bars aggregated to M5 for indicator calculation
- Minimum Bars:     25 M5 bars required (SMA21 + 10-bar momentum lookback)
- Health Score:     10-component composite (0-10 scale)
    Structure Score (0-4):
      - H4 aligned with direction:  +1
      - H1 aligned with direction:  +1
      - M15 aligned with direction: +1
      - M5 aligned with direction:  +1
    Volume Score (0-3):
      - Volume ROC >= 20%:           +1
      - Volume delta matches dir:    +1
      - CVD slope matches dir:       +1
    Price Score (0-3):
      - SMA alignment matches dir:   +1
      - SMA momentum WIDENING:       +1
      - VWAP position matches dir:   +1
- Health Labels:    CRITICAL (0-3), WEAK (4-5), MODERATE (6-7), STRONG (8-10)
- Structure:        Fractal-based at H4, H1, M15, M5 timeframes
                    (fractal_length=5, BOS/ChoCH detection)
- Structure Lookbacks:
    M5:  3 days
    M15: 7 days
    H1:  14 days
    H4:  30 days
- Target Table:     entry_indicators
- Output Fields:    50+ fields including all 10 health factors, structure
                    labels, indicator values, healthy flags per component

2.8 STEP 5 - M5 INDICATOR BARS (Full-Day M5 Analysis)
--------------------------------------------------------------------------------
- Purpose:          Calculate complete M5 indicator bars for full trading day
- Time Range:       09:30 - 16:00 ET (regular session)
- Data Source:      Extended M5 bars (includes prior day for lookback)
- Indicators Per Bar:
    - OHLCV + VWAP
    - SMA 9/21, spread, alignment, momentum ratio/label
    - Volume ROC (20-bar baseline)
    - Volume delta (5-bar rolling)
    - CVD slope (15-bar window)
    - Market structure at M5, M15, H1, H4
    - bars_in_calculation (running count)
- Target Table:     m5_indicator_bars

2.9 STEP 6 - M1 INDICATOR BARS (Full-Day M1 Analysis with Health)
--------------------------------------------------------------------------------
- Purpose:          Calculate complete M1 indicator bars with health scores
- Time Range:       08:00 - 16:00 ET (includes premarket ramp-up)
- Premarket Start:  08:00 ET
- Ramp-Up Bars:     15 M1 bars before entry for indicator warm-up
- Batch Size:       500 records per INSERT
- Indicators Per Bar:
    - All M5 indicators (calculated on M1 aggregation)
    - Structure at 5 timeframes: H4, H1, M15, M5, M1
    - Health score (0-10) using HealthCalculator
    - candle_range_pct: (high - low) / close * 100
    - Entry qualifier scores: long_score (0-7), short_score (0-7)
- Target Table:     m1_indicator_bars

2.10 STEP 7 - M5 TRADE BARS (Trade-Specific Health Scoring)
--------------------------------------------------------------------------------
- Purpose:          Build trade-specific M5 bars with direction-aware health
- Dependencies:     mfe_mae + m5_indicator_bars
- Health Calculator: Direction-specific scoring (10 components, 0-10 scale)
    LONG Health Logic:
      - vol_delta > 0                    = healthy
      - cvd_slope >= 0.1                 = healthy
      - sma9 > sma21                     = healthy (alignment)
      - sma momentum WIDENING            = healthy
      - price > vwap                     = healthy
      - structure BULL at each timeframe  = healthy
    SHORT Health Logic:
      - vol_delta < 0                    = healthy
      - cvd_slope <= -0.1               = healthy
      - sma9 < sma21                     = healthy (alignment)
      - sma momentum WIDENING            = healthy
      - price < vwap                     = healthy
      - structure BEAR at each timeframe  = healthy
- Health Buckets:   CRITICAL (0-3), WEAK (4-5), MODERATE (6-7), STRONG (8-10)
- Target Table:     m5_trade_bars
- Output:           Per-bar OHLCV, all indicators, 10 healthy flags,
                    structure_score, volume_score, price_score, health_score,
                    health_label, bars_from_entry

2.11 STEP 8 - OPTIMAL TRADE (Event-Based Trade Tracking)
--------------------------------------------------------------------------------
- Purpose:          Generate 4 events per trade: ENTRY, MFE, MAE, EXIT
- Version:          Points-Based v2.0
- Win Condition:    mfe_potential_time < mae_potential_time (temporal ordering)
- P&L Metric:       Points (absolute dollars), not R-multiples
- EOD Exit:         Fixed at 15:30 ET
- Time Alignment:   All event times floored to M5 boundaries
                    (e.g., 10:07:23 -> 10:05:00)
- Health Delta:     health_score_at_event - health_score_at_entry
    IMPROVING:      delta >= +2
    DEGRADING:      delta <= -2
    STABLE:         -1 <= delta <= +1
- Calculation Version: 2.0
- Target Table:     optimal_trade
- Output Per Event: trade_id, event_type, date, ticker, direction, model,
                    win, event_time, bars_from_entry, entry_price,
                    price_at_event, points_at_event, actual_points,
                    health_score, health_label, health_delta, health_summary,
                    structure/volume/price scores, all indicator values,
                    all structure labels, all healthy flags (~44 fields)

2.12 STEP 9 - R-LEVEL EVENTS (R-Multiple Crossing Detection)
--------------------------------------------------------------------------------
- Purpose:          Detect precise M1 bar when each R-level is first crossed
- Event Types:      R1_CROSS, R2_CROSS, R3_CROSS
- R-Levels:         R1 = 1.0R, R2 = 2.0R, R3 = 3.0R
- Stop Source:      zone_buffer stop from stop_analysis (5% buffer default)
- Crossing Logic:
    LONG:  bar high >= R-level price
    SHORT: bar low <= R-level price
- Data Source:      M1 indicator bars from entry to EOD
- Batch Processing: 100 trades per batch, log every 10
- Target Table:     optimal_trade (appended alongside ENTRY/MFE/MAE/EXIT)
- Output Per Event: trade_id, event_type, date, ticker, event_time,
                    bars_from_entry, points_at_event, health_delta,
                    health_summary, full indicator snapshot

2.13 STEP 10 - OPTIONS ANALYSIS (Options Performance Tracking)
--------------------------------------------------------------------------------
- Purpose:          Evaluate parallel options trade performance
- Strike Selection: FIRST_ITM (default), ATM, FIRST_OTM configurable
    FIRST_ITM Selection:
      LONG:  Highest ITM call strike (strike < entry_price)
      SHORT: Lowest ITM put strike (strike > entry_price)
    ATM Selection:   Strike closest to entry_price
    FIRST_OTM Selection:
      LONG:  Lowest OTM call strike (strike > entry_price)
      SHORT: Highest OTM put strike (strike < entry_price)
- Entry Bar:        15-second multiplier (matches S15 backtest entry)
- Exit Bar:         5-minute multiplier (matches M5 backtest exit)
- Min Expiry:       2 days to expiration
- P&L Calculations:
    pnl_dollars  = (exit_price - entry_price) * 100 * contracts
    pnl_percent  = ((exit_price - entry_price) / entry_price) * 100
    option_r     = pnl_dollars / (underlying_risk * 100)
    r_multiplier = option_r / underlying_pnl_r
- Status Codes:     SUCCESS, NO_CHAIN, NO_CONTRACT, NO_ENTRY_QUOTE,
                    NO_EXIT_QUOTE, CALCULATION_ERROR
- Target Table:     options_analysis

2.14 STEP 11 - OP MFE/MAE (Options Excursion Analysis)
--------------------------------------------------------------------------------
- Purpose:          Calculate MFE/MAE potential for options contracts
- Bar Multiplier:   1 minute
- Min Option Price: $0.01
- Target Table:     op_mfe_mae_potential

2.15 STEP 12 - STOP ANALYSIS (6 Stop Types + Outcome Simulation)
--------------------------------------------------------------------------------
- Purpose:          Calculate stop prices for 6 methodologies and simulate
                    trade outcomes under each
- Reference:        CALC-009
- Stop Types:
    1. Zone Boundary + 5% Buffer (price-based trigger)
       LONG:  stop = zone_low - (zone_distance * 0.05)
       SHORT: stop = zone_high + (zone_distance * 0.05)

    2. Prior M1 Bar High/Low (price-based trigger)
       Stop at high/low of M1 candle immediately before entry
       Handles prior-day bars for early morning entries

    3. Prior M5 Bar High/Low (price-based trigger)
       Stop at high/low of M5 bar at bars_from_entry = -1

    4. M5 ATR 1.1x (close-based trigger)
       LONG:  stop = entry - (M5_ATR_14 * 1.1)
       SHORT: stop = entry + (M5_ATR_14 * 1.1)
       Triggers only when M5 bar CLOSES beyond level

    5. M15 ATR 1.1x (close-based trigger)
       Same formula using M15 ATR (aggregated from M5 bars: 3 M5 = 1 M15)
       Checked at M15 boundaries (every 3rd M5 bar)

    6. M5 Fractal High/Low (price-based trigger)
       Stop at most recent confirmed fractal swing
       Fractal length: 2 (requires 2 bars on each side)
       Note: Uses fractal_length=2 (different from indicator modules' 5)

- ATR Parameters:   Period = 14, Multiplier = 1.1
- Zone Buffer:      5% of zone distance
- Outcome Simulation:
    For each stop type, walks M1 (price-based) or M5 (close-based) bars:
    - WIN:     MFE reached before stop (R >= 1.0)
    - LOSS:    Stop hit before meaningful MFE (R = -1.0)
    - PARTIAL: MFE reached but R < 1.0, or stop never hit
    Output: stop_distance, stop_distance_pct, stop_hit, stop_hit_time,
            mfe_price, mfe_time, mfe_distance, r_achieved, outcome,
            trigger_type
- Target Table:     stop_analysis

2.16 STEP 13 - INDICATOR REFINEMENT (Continuation/Rejection Scoring)
--------------------------------------------------------------------------------
- Purpose:          Score entry quality based on model type (CALC-010)
- Model Mapping:
    Continuation Models: EPCH1, EPCH3 (with-trend entries)
    Rejection Models:    EPCH2, EPCH4 (counter-trend/exhaustion entries)

- Continuation Score (0-10):
    CONT-01  Multi-Timeframe Alignment (0-4):
             1 point per timeframe aligned with direction (H4, H1, M15, M5)

    CONT-02  SMA Momentum (0-2):
             +1 if SMA9/SMA21 spread aligned with direction
             +1 if spread WIDENING (ROC > 5%)

    CONT-03  Volume Thrust (0-2):
             +1 if volume ROC > 20%
             +1 if volume delta aligned with direction

    CONT-04  Pullback Quality (0-2):
             Measures accumulation during pullback
             delta_ratio < 0.3 = strong (+2)
             delta_ratio < 0.5 = moderate (+1)
             Pullback lookback: 3 bars

- Rejection Score (0-11):
    REJ-01   Structure Divergence (0-2):
             +2 if HTF trend opposite to LTF overextension (strong divergence)
             +1 if partial divergence

    REJ-02   SMA Exhaustion (0-3):
             +1 if spread < 0.25% (tight, Q2)
             +2 if spread < 0.15% (very tight, Q1)
             +1 if spread contracting

    REJ-03   Delta Absorption (0-2):
             Measures delta/price ratio as exhaustion signal
             ratio > 2.0 = strong absorption (+2)
             ratio > 1.5 = moderate absorption (+1)

    REJ-04   Volume Climax (0-2):
             +2 if volume ROC > 50% (extreme spike)
             +1 if volume ROC > 30% AND declining from peak

    REJ-05   CVD Extreme (0-2):
             +2 if CVD slope normalized < -0.5 (Q1, extreme selling)
             +1 if CVD slope normalized < -0.3 (Q2)
             (Reversed for SHORT: > +0.5 / > +0.3)
             CVD slope period: 15 bars

- Target Table:     indicator_refinement

2.17 STEP 14 - R WIN/LOSS (ATR-Based Outcome Evaluation)
--------------------------------------------------------------------------------
- Purpose:          Evaluate trade outcomes using M5 ATR-based stop and
                    R-multiple targets from 1R through 5R
- ATR Parameters:   Period = 14, Multiplier = 1.1
- 1R Definition:    stop_distance = M5_ATR_14 * 1.1
- R-Level Targets:  entry_price +/- (N * 1R) for N = 1, 2, 3, 4, 5
- Pre-Entry Bars:   16 M5 bars required (14 for ATR + buffer)
- EOD Cutoff:       15:30 ET
- Bar Walk Logic:
    Walk M1 bars from entry to 15:30 ET:
    1. Check R-level targets: high/low touch = price-based trigger
    2. Check stop: close beyond stop = close-based trigger
    3. Same-candle conflict: stop on same bar as R-level hit = LOSS
- Outcome Determination:
    R1+ hit before stop:  WIN (exit_reason = R_TARGET)
    Stop before R1:       LOSS (exit_reason = STOP)
    EOD without either:   WIN if price > entry (LONG), else LOSS
- Target Table:     r_win_loss
- Output Fields:    trade_id, date, ticker, direction, model, entry_price,
                    atr_value, stop_price, stop_distance, outcome,
                    exit_reason, exit_time, exit_price, R1-R5 hit flags,
                    R1-R5 times, bars_from_entry at exit

2.18 STEP 15 - TRADES UNIFIED (Canonical Outcome Table)
--------------------------------------------------------------------------------
- Purpose:          Build single-source-of-truth outcome table reconciling
                    ATR-based and zone-buffer methodologies
- Outcome Priority:
    1. PRIMARY:   r_win_loss record exists -> use ATR-based outcome
    2. SECONDARY: No r_win_loss -> calculate zone_buffer fallback
    3. TERTIARY:  No zone data -> use original trades.is_winner
- Zone Buffer Fallback:
    Stop = zone_low/high +/- (zone_height * 5%)
    1R = stop distance
    Walk M1 bars: R1 hit (price-based) vs stop (close-based)
    Same-candle conflict: stop takes priority (LOSS)
- Convenience Fields:
    outcome_method:  "atr_r_target" or "zone_buffer_fallback"
    pnl_r:           R-multiple achieved
    reached_2r:      Boolean flag
    reached_3r:      Boolean flag
    minutes_to_r1:   Time from entry to first R1 touch
- Target Table:     trades_m5_r_win
- Output:           50+ fields merging trade metadata, R-level outcomes,
                    and method reconciliation

2.19 SHARED INDICATORS LIBRARY
--------------------------------------------------------------------------------
All processors import from a centralized indicators package to ensure
calculation consistency across the pipeline and with the live Entry
Qualifier tool.

- SMA (sma.py):
    Periods: 9 and 21
    Outputs: sma9, sma21, spread (sma9 - sma21), alignment (BULLISH/BEARISH)
    Momentum: Compares current spread to spread N bars ago
              WIDENING (ratio > 1.1x), NARROWING (ratio < 0.9x), FLAT
    Momentum lookback: 10 bars

- VWAP (vwap.py):
    Formula: Cumulative(TP * Volume) / Cumulative(Volume)
    Typical Price: (High + Low + Close) / 3
    Outputs: vwap, price_diff, price_pct, side (ABOVE/BELOW/AT)

- Volume ROC (volume_roc.py):
    Formula: ((current_volume - baseline_avg) / baseline_avg) * 100
    Baseline period: 20 bars
    Thresholds: > 30% elevated, > 50% high

- Volume Delta (volume_delta.py):
    Bar position: (close - low) / (high - low)
    Bar delta: volume * ((2 * bar_position) - 1)
    Rolling delta: Sum of bar_delta over N bars (default 5)
    Outputs: rolling_delta, signal (Bullish/Bearish/Neutral)

- CVD Slope (cumulative volume delta):
    Window: 15 bars
    Rising threshold: slope >= +0.1
    Falling threshold: slope <= -0.1

- Market Structure (structure.py):
    Detection: Fractal-based swing high/low identification
    Fractal length: 5 bars (for indicator modules)
    Break types: BOS (Break of Structure), ChoCH (Change of Character)
    States: BULL, BEAR, NEUTRAL
    Output: direction_label, break_type, strong_level, weak_level
    Multi-timeframe: H4, H1, M15, M5 with HTF bar fetching via Polygon

- Health Score (composite):
    Components: 10 equal-weight binary factors
    Structure (0-4): h4, h1, m15, m5 aligned with trade direction
    Volume (0-3): vol_roc healthy, vol_delta healthy, cvd_slope healthy
    Price (0-3): sma_alignment healthy, sma_momentum healthy, vwap healthy
    Total: 0-10
    Labels: CRITICAL (0-3), WEAK (4-5), MODERATE (6-7), STRONG (8-10)

- Entry Qualifier Score (composite):
    Max score: 7 per direction
    Separate long_score and short_score
    Includes: candle_range_pct = (high - low) / close * 100

2.20 DATABASE ARCHITECTURE
--------------------------------------------------------------------------------
Source Tables (read):
    trades              Base trade metadata (from backtest runner)
    setups              Zone definitions (from 01_application pipeline)

Generated Tables (write):
    m1_bars             Raw 1-minute OHLCV bars
    h1_bars             Raw 1-hour OHLCV bars
    mfe_mae_potential   Potential excursion from entry to EOD
    entry_indicators    Indicator snapshot at entry time
    m5_indicator_bars   Full-day M5 bars with all indicators
    m1_indicator_bars   Full-day M1 bars with health + EQ scores
    m5_trade_bars       Trade-specific M5 bars with health scoring
    optimal_trade       Event-based trade tracking (4+3 events per trade)
    options_analysis    Options P&L performance metrics
    op_mfe_mae_potential Options excursion analysis
    stop_analysis       6 stop types with simulated outcomes
    indicator_refinement Continuation/Rejection quality scores
    r_win_loss          ATR-based R-multiple outcomes
    trades_m5_r_win     Unified canonical outcome table

Incremental Processing:
    All modules use LEFT JOIN exclusion to skip already-processed trades
    ON CONFLICT (trade_id) DO NOTHING for upsert safety
    Batch INSERT sizes: 500 (m1_bars, m1_indicator_bars), 100 (default)

2.21 CONFIGURATION DEFAULTS
--------------------------------------------------------------------------------
Parameter                    Value        Context
---------------------------  -----------  -----------------------------------
SMA Periods                  9, 21        All indicator modules
SMA Momentum Lookback        10 bars      Spread trend detection
SMA Widening Threshold       1.1x ratio   Momentum classification
Volume ROC Baseline          20 bars      Elevated volume detection
Volume ROC Healthy           >= 20%       Health scoring threshold
Volume Delta Rolling         5 bars       Short-term delta window
CVD Window                   15 bars      Slope calculation period
CVD Rising Threshold         >= +0.1      Bullish pressure signal
CVD Falling Threshold        <= -0.1      Bearish pressure signal
Fractal Length (indicators)  5 bars       Structure detection
Fractal Length (stops)       2 bars       Stop Type 6 (tighter)
ATR Period                   14           Stop and R calculations
ATR Multiplier               1.1x         1R distance definition
Zone Buffer Percentage       5%           Stop Type 1 / fallback
R-Levels                     1, 2, 3      R-level event detection
R-Levels (win/loss)          1, 2, 3, 4, 5  Full R evaluation
EOD Cutoff                   15:30 ET     MFE/MAE and exit boundary
Health Improving Threshold   >= +2 delta  Optimal trade classification
Health Degrading Threshold   <= -2 delta  Optimal trade classification
Min Days to Expiry           2            Options contract filter
Default Strike Method        FIRST_ITM    Options strike selection
Entry Bar Multiplier         15 seconds   Options entry timing
Exit Bar Multiplier          5 minutes    Options exit timing
Min Option Price             $0.01        Options validity filter
Min Risk Dollars             $0.01        MFE/MAE minimum stop
H1 Lookback Bars             30           H1 data ingestion
H1 Lookback Days             7            H1 calendar window
Premarket Start              08:00 ET     M1 indicator bars
Ramp-Up Bars Before Entry    15           M1 warm-up period
M5 HTF Lookback              3 days       Structure detection
M15 HTF Lookback             7 days       Structure detection
H1 HTF Lookback              14 days      Structure detection
H4 HTF Lookback              30 days      Structure detection
Batch Insert Size (default)  100          Database batch writes
Batch Insert Size (M1)       500          High-volume bar tables


================================================================================
EPOCH TRADING SYSTEM v2.0 - INDICATOR EDGE TESTING APPLICATION
System Specifications
XIII Trading LLC
================================================================================

1. IMPLEMENTATION OVERVIEW
================================================================================

The Indicator Edge Testing module is a PyQt6 desktop application that performs
rigorous statistical analysis of seven trading indicators against historical
trade outcomes to identify actionable edges for the Epoch zone-based trading
system. For each indicator, the system fetches completed trade records from
the Supabase trades table joined with M1-timeframe indicator snapshots from
the m1_indicator_bars table and multi-timeframe structure snapshots from the
entry_indicators table -- using the PRIOR completed M1 bar relative to each
trade's S15 entry time to avoid look-ahead bias. Two statistical tests drive
edge validation: the Chi-square test of independence for categorical
groupings (e.g., ALIGNED vs MISALIGNED, ABSORPTION vs NORMAL) and the
Spearman rank correlation for ordinal quintile distributions. An edge is
confirmed only when three conditions are simultaneously met: statistical
significance (p-value < 0.05), practical significance (effect size > 3.0
percentage points), and sufficient sample size (minimum 30 trades per group
for MEDIUM confidence, 100+ for HIGH). Each indicator is tested across nine
segments -- ALL trades, LONG, SHORT, CONTINUATION (EPCH1+EPCH3), REJECTION
(EPCH2+EPCH4), and the four individual entry models EPCH1-4 -- producing a
comprehensive matrix of up to 75+ individual statistical tests per run.
Results are displayed in a color-coded terminal GUI, tracked via progress bar,
and optionally exported to timestamped Markdown reports in the results/
directory. The module consumes trade data produced by 03_backtest and outcome
classifications from the stop_analysis table, feeding validated edge findings
into the 02_dow_ai trading assistant context files, thereby closing the
Epoch system's indicator refinement feedback loop.


2. HIGH-LEVEL TECHNICAL SPECIFICATIONS
================================================================================

2.1 APPLICATION FRAMEWORK
--------------------------------------------------------------------------------
- Runtime:          Python 3.12+
- UI Framework:     PyQt6 desktop application
- Window Size:      Minimum 900 x 700, default 1000 x 800
- Theme:            Dark mode (custom stylesheet, #1e1e1e background)
- Version:          Indicator Edge Testing v1.0
- Execution:        QProcess subprocess for CLI script isolation

2.2 DATA SOURCES
--------------------------------------------------------------------------------
- Trade Data:       Supabase PostgreSQL via psycopg2 + SSL
                    - Table: trades (trade records with entry times)
                    - Table: stop_analysis (WIN/LOSS outcomes by stop type)
- Indicator Data:   Supabase PostgreSQL via psycopg2 + SSL
                    - Table: m1_indicator_bars (M1 bar snapshots with indicators)
                    - Table: entry_indicators (multi-timeframe structure snapshots)
- Connection:       Direct psycopg2 with sslmode=require
- Query Pattern:    Single complex SQL join with parameterized filters

2.3 LOOK-AHEAD BIAS PREVENTION
--------------------------------------------------------------------------------

  The system prevents look-ahead bias through prior-bar alignment:

  Problem:
  - Trade entries occur on S15 (15-second) bars
  - M1 indicator bars represent 1-minute completed candles
  - Using the current M1 bar would include future data after entry

  Solution:
  - Entry at S15 timestamp -> use PRIOR completed M1 bar
  - Example: Entry at 09:35:15 -> use M1 bar at 09:34:00
  - SQL implementation:
    (date_trunc('minute', entry_time) - INTERVAL '1 minute')::time

  This ensures all indicator values were fully known before the trade entry.

2.4 DATA JOIN ARCHITECTURE
--------------------------------------------------------------------------------

  The master query constructs a four-table join:

  CTE: trade_with_prior_bar
  - Source: trades table
  - Calculates prior_bar_time for each trade entry
  - Filters: entry_time IS NOT NULL

  Main JOIN:
  1. trade_with_prior_bar (CTE)
     LEFT JOIN m1_indicator_bars ON (ticker, bar_date, bar_time=prior_bar_time)
     LEFT JOIN entry_indicators ON (trade_id)
     INNER JOIN stop_analysis ON (trade_id, stop_type)

  Filter: stop_analysis.stop_price IS NOT NULL

  Optional Filters (parameterized):
  - model (ANY array match)
  - direction (ANY array match)
  - date_from (>= date)
  - date_to (<= date)

  Columns Retrieved:
  - Trade: trade_id, date, ticker, model, direction, entry_price, entry_time
  - M1 Indicators: vol_delta, vol_roc, cvd_slope, vwap, sma9, sma21,
                    sma_spread, sma_momentum_label, health_score,
                    bar_open, bar_high, bar_low, bar_close
  - Structure: h4_structure, h1_structure, m15_structure, m5_structure
  - Outcome: is_winner (boolean), outcome_detail, r_achieved


3. INDICATOR SPECIFICATIONS
================================================================================

  Seven indicators are tested, each with multiple sub-tests.
  Indicators are ordered by historical edge strength.

3.1 CANDLE RANGE (Strongest - 18-29pp historical edge)
--------------------------------------------------------------------------------

  Source Data: M1 bar OHLC (bar_open, bar_high, bar_low)

  Calculation:
    candle_range_pct = (bar_high - bar_low) / bar_open * 100

  Threshold Categories:
    ABSORPTION:  candle_range_pct < 0.12%  (low volatility, skip zone)
    LOW:         0.12% <= candle_range_pct < 0.15%
    NORMAL:      0.15% <= candle_range_pct < 0.20%  (momentum present, take)
    HIGH:        candle_range_pct >= 0.20%  (strong signal)

  Quintile Bucketing:
    pd.qcut into 5 equal-frequency bins:
    Q1_Smallest, Q2, Q3, Q4, Q5_Largest

  Tests:
  1. Threshold Categories - Chi-square on ABSORPTION/LOW/NORMAL/HIGH
  2. Magnitude Quintiles - Spearman correlation on Q1-Q5 vs win rate
  3. Absorption Zone Filter - Chi-square on ABSORPTION vs NORMAL

  Key Finding: Absorption zone (< 0.12%) = ~33% WR -> universal skip filter

3.2 MARKET STRUCTURE (Strong - 24-54pp historical edge on H1)
--------------------------------------------------------------------------------

  Source Data: entry_indicators table (h1_structure, m15_structure, m5_structure)

  Value Standardization:
    Raw values -> uppercase -> mapped:
      'NEUT' -> 'NEUTRAL'
      'BULL' -> 'BULLISH'
      'BEAR' -> 'BEARISH'
    Missing values -> 'UNKNOWN'

  Multi-Timeframe Alignment Check:
    Examines H1, M15, M5 structures (excluding NEUTRAL and UNKNOWN):
    - ALIGNED: All non-neutral timeframes have same direction
    - NOT_ALIGNED: Timeframes disagree on direction
    - NEUTRAL: Fewer than 2 non-neutral timeframes to compare

  Confluence Score:
    Weighted score across timeframes:
      H1 weight: 1.5 (highest timeframe, most significant)
      M15 weight: 1.0
      M5 weight: 0.5 (lowest timeframe, least significant)

    Calculation:
      For each timeframe:
        BULLISH -> +weight
        BEARISH -> -weight
        NEUTRAL -> 0
      Range: -3.0 (max bearish) to +3.0 (max bullish)

  Tests:
  1. H1 Structure Direction - Chi-square on BULLISH/BEARISH/NEUTRAL
  2. M15 Structure Direction - Chi-square on BULLISH/BEARISH/NEUTRAL
  3. M5 Structure Direction - Chi-square on BULLISH/BEARISH/NEUTRAL
  4. MTF Alignment - Chi-square on ALIGNED/NOT_ALIGNED/NEUTRAL
  5. Confluence - Chi-square on confluence score categories

  Key Finding: NEUTRAL H1 structure paradoxically beats BULL/BEAR

3.3 CVD SLOPE (Strong for SHORT - 15-27pp historical edge)
--------------------------------------------------------------------------------

  Source Data: m1_indicator_bars.cvd_slope

  Direction Classification:
    RISING:   cvd_slope > 0.1  (threshold from CVD_CONFIG)
    FALLING:  cvd_slope < -0.1
    FLAT:     -0.1 <= cvd_slope <= 0.1

  Alignment (with trade direction):
    ALIGNED:
      (direction == LONG AND cvd_slope > 0) OR
      (direction == SHORT AND cvd_slope < 0)
    MISALIGNED: opposite of above

  Category by Magnitude:
    abs_slope computed, then percentile-based:
    EXTREME:   abs_slope >= 75th percentile
    MODERATE:  abs_slope >= median
    WEAK:      abs_slope < median

  Tests:
  1. CVD Direction - Chi-square on RISING/FALLING/FLAT
  2. CVD Alignment - Chi-square on ALIGNED/MISALIGNED

  Configuration:
    window: 15 bars
    rising_threshold: 0.1
    falling_threshold: -0.1

3.4 VOLUME DELTA (Good - 10-20pp historical edge)
--------------------------------------------------------------------------------

  Source Data: m1_indicator_bars.vol_delta

  Sign Classification:
    POSITIVE: vol_delta >= 0
    NEGATIVE: vol_delta < 0

  Absolute Value:
    vol_delta_abs = abs(vol_delta)

  Alignment (with trade direction):
    ALIGNED:
      (direction == LONG AND vol_delta > 0) OR
      (direction == SHORT AND vol_delta < 0)
    MISALIGNED: opposite of above

  Magnitude Quintiles:
    pd.qcut on vol_delta_abs into 5 bins:
    Q1_Smallest, Q2, Q3, Q4, Q5_Largest

  Tests:
  1. Sign (Pos/Neg) - Chi-square on POSITIVE/NEGATIVE
  2. Alignment - Chi-square on ALIGNED/MISALIGNED
  3. Magnitude Quintiles - Spearman correlation on Q1-Q5 vs win rate

  Key Finding: MISALIGNED delta beats ALIGNED by 5-21pp
               (trading against order flow captures exhaustion/reversals)

  Configuration:
    rolling_period: 5
    magnitude_threshold: 100000

3.5 SMA ANALYSIS (Good - 19-25pp historical edge)
--------------------------------------------------------------------------------

  Source Data: m1_indicator_bars.sma9, sma21, sma_spread

  SMA Spread Calculation:
    sma_spread = sma9 - sma21  (if not already in data)

  Spread Direction:
    BULLISH: sma_spread > 0  (fast SMA above slow)
    BEARISH: sma_spread < 0  (fast SMA below slow)

  Spread Magnitude:
    sma_spread_abs = abs(sma_spread)
    Wide Spread: sma_spread_abs >= 0.15 (from SMA_CONFIG)

  Price Position (relative to both SMAs):
    ABOVE_BOTH:  bar_close > sma9 AND bar_close > sma21
    BELOW_BOTH:  bar_close < sma9 AND bar_close < sma21
    BETWEEN:     price between the two SMAs

  Tests:
  1. Spread Direction - Chi-square on BULLISH/BEARISH
  2. Price Position - Chi-square on ABOVE_BOTH/BELOW_BOTH/BETWEEN

  Configuration:
    fast_period: 9
    slow_period: 21
    wide_spread_threshold: 0.15

3.6 VOLUME ROC (Moderate edge)
--------------------------------------------------------------------------------

  Source Data: m1_indicator_bars.vol_roc

  Threshold Categories:
    HIGH:      vol_roc >= 50  (high volume)
    ELEVATED:  30 <= vol_roc < 50  (elevated volume)
    NORMAL:    vol_roc < 30  (baseline volume)

  Elevated Flag:
    vol_roc_elevated = vol_roc >= 30

  Quintile Bucketing:
    pd.qcut into 5 bins:
    Q1_Lowest, Q2, Q3, Q4, Q5_Highest

  Tests:
  1. Category - Chi-square on NORMAL/ELEVATED/HIGH
  2. Magnitude Quintiles - Spearman correlation on Q1-Q5 vs win rate

  Configuration:
    baseline_period: 20
    elevated_threshold: 30
    high_threshold: 50

3.7 VWAP SIMPLE (Paradoxical - on hold)
--------------------------------------------------------------------------------

  Source Data: m1_indicator_bars.vwap

  Note: Listed in the indicator registry but NO test functions are
  implemented in edge_tests.py. The VWAP indicator is registered in
  config.py with two planned tests (position, alignment) but the
  ALL_TESTS registry in edge_tests.py does not include a 'vwap_simple'
  entry. This indicator is currently on hold due to paradoxical findings
  in early testing.


4. STATISTICAL TESTING FRAMEWORK
================================================================================

4.1 CHI-SQUARE TEST OF INDEPENDENCE
--------------------------------------------------------------------------------

  Purpose: Tests whether the distribution of wins/losses is independent
           of the categorical grouping variable.

  Implementation:
  - Constructs a contingency table: pd.crosstab(group_col, outcome_col)
  - Requires at least 2 groups and both outcome values (True/False)
  - Calls scipy.stats.chi2_contingency(contingency)
  - Returns: chi2 statistic, p-value, effect_size

  Effect Size Calculation:
    effect_size = max(group_win_rates) - min(group_win_rates)
    Measured in percentage points (pp)

  Usage: All categorical tests (threshold categories, sign, alignment,
         direction, structure categories)

4.2 SPEARMAN RANK CORRELATION
--------------------------------------------------------------------------------

  Purpose: Tests for monotonic relationship between ordered buckets
           (quintiles) and win rate.

  Implementation:
  - Calculates win rate per quintile bucket
  - Filters to only buckets that exist in data
  - Requires at least 3 buckets for valid test
  - Calls scipy.stats.spearmanr(positions, rates)
  - Returns: correlation coefficient, p-value, effect_size

  Effect Size Calculation:
    effect_size = abs(last_bucket_win_rate - first_bucket_win_rate)

  Usage: All quintile/ordinal tests (range quintiles, volume delta
         magnitude, volume ROC magnitude)

4.3 EDGE DETERMINATION LOGIC
--------------------------------------------------------------------------------

  Three conditions must ALL be met for a validated edge:

  Condition 1: Statistical Significance
    p_value < P_VALUE_THRESHOLD (0.05)

  Condition 2: Practical Significance
    effect_size > EFFECT_SIZE_THRESHOLD (3.0 percentage points)

  Condition 3: Sufficient Sample Size
    confidence != "LOW"
    (minimum group size >= 30 for MEDIUM, >= 100 for HIGH)

  Confidence Levels:
    HIGH:   min_group_size >= 100 (reliable conclusions)
    MEDIUM: min_group_size >= 30  (usable with caution)
    LOW:    min_group_size < 30   (insufficient for conclusions)

  Outcome:
    If all three conditions met -> has_edge = True
    If LOW confidence -> "INSUFFICIENT DATA"
    If p >= 0.05 -> "NO EDGE - Not statistically significant"
    If effect < 3pp -> "NO EDGE - Effect too small"


5. SEGMENT TESTING ARCHITECTURE
================================================================================

  Each indicator test is executed across multiple trade segments to identify
  where edges are strongest and most actionable.

5.1 SEGMENT DEFINITIONS
--------------------------------------------------------------------------------

  Name              Filter                          Category
  ----              ------                          --------
  ALL               No filter                       Overall
  LONG              direction == 'LONG'             Direction
  SHORT             direction == 'SHORT'            Direction
  CONTINUATION      model IN ('EPCH1', 'EPCH3')    Trade Type
  REJECTION         model IN ('EPCH2', 'EPCH4')    Trade Type
  EPCH1             model == 'EPCH1'                Model
  EPCH2             model == 'EPCH2'                Model
  EPCH3             model == 'EPCH3'                Model
  EPCH4             model == 'EPCH4'                Model

  Note: The CLI runner uses 5 segments (ALL, LONG, SHORT, CONTINUATION,
  REJECTION) by default. The config.py SEGMENTS list includes all 9
  segments including individual EPCH1-4 models.

5.2 SEGMENT FILTERING
--------------------------------------------------------------------------------

  Filters are applied before each test function call:
  - Direction filter: df[df['direction'] == value]
  - Models filter: df[df['model'].isin(model_list)]
  - Model filter: df[df['model'] == value]
  - Minimum 30 trades required per segment (skipped if below)

5.3 TEST MATRIX
--------------------------------------------------------------------------------

  7 indicators x variable tests x 5-9 segments = 75+ individual tests

  Per-indicator test counts:
    Candle Range:     3 tests x 5 segments = 15 tests
    Volume Delta:     3 tests x 5 segments = 15 tests
    Volume ROC:       2 tests x 5 segments = 10 tests
    CVD Slope:        2 tests x 5 segments = 10 tests
    SMA Analysis:     2 tests x 5 segments = 10 tests
    Market Structure: 3 tests x 5 segments = 15 tests
    VWAP Simple:      0 tests (not implemented)
    -------------------------------------------------
    Total:            15 sub-tests x 5 segments = 75 tests


6. STOP TYPE SUPPORT
================================================================================

  The module supports multiple stop type definitions for outcome
  classification. The stop_type parameter determines which row from the
  stop_analysis table defines the WIN/LOSS outcome for each trade.

6.1 AVAILABLE STOP TYPES
--------------------------------------------------------------------------------
  - zone_buffer     (default) - Zone boundary + 5% buffer
  - fractal         - Fractal-based stop level
  - m5_atr          - M5 ATR-based stop
  - m15_atr         - M15 ATR-based stop
  - prior_m1        - Prior M1 bar high/low
  - prior_m5        - Prior M5 bar high/low

6.2 DIAGNOSTIC SUPPORT
--------------------------------------------------------------------------------
  When no data is returned, the system queries stop_analysis for
  available stop_type values and reports which types exist in the
  database, helping diagnose configuration mismatches.


7. USER INTERFACE
================================================================================

7.1 WINDOW LAYOUT
--------------------------------------------------------------------------------

  Header:
  - Title: "EPOCH INDICATOR EDGE TESTING" (14px bold, #26a69a)
  - Subtitle: "Statistical Edge Analysis for M1 Bar Indicators" (11px, gray)

  Control Panel (three column groups):
  - Left: Indicator Selection (multi-select QListWidget, max 150px height)
    - All 7 indicators listed in DEFAULT_INDICATOR_ORDER
    - All selected by default
    - Select All / Select None buttons
    - Tooltips show indicator descriptions

  - Middle: Filters
    - Stop Type: QComboBox (6 options)
    - Date Range: QCheckBox toggle + QDateEdit from/to with calendar popup
    - Verbose Output: QCheckBox (unchecked by default)
    - Export Results to Markdown: QCheckBox (unchecked by default)

  - Right: Action Buttons
    - RUN TESTS: Green (#26a69a), minimum 40px height
    - STOP: Red (#ef5350), disabled until running
    - CLEAR: Orange (#ff9800)

  Progress Bar:
  - 0-100% with percentage text
  - Tracks via [X/N] pattern parsing from subprocess stdout

  Terminal Output (expandable, takes remaining space):
  - Font: Consolas 10pt, read-only QTextEdit
  - Background: #0d0d0d (near-black)
  - Color coding:
    - Red (#ef5350): ERROR, FAILED, Traceback
    - Green (#26a69a): EDGE DETECTED, EDGE, [+], SUCCESS
    - Orange (#ff9800): WARNING, NO_EDGE, LOW_DATA, [~]
    - Gray (#808080): Section dividers (=== and ---)
    - White (#e8e8e8): Default output

  Status Bar:
  - Background: #252526
  - Shows: "Ready", "Running tests...", completion status

7.2 PROCESS MANAGEMENT
--------------------------------------------------------------------------------
  - Tests run as QProcess subprocess (run_edge_tests.py)
  - Merged stdout/stderr channels
  - Real-time output streaming line by line
  - Kill support for immediate process termination
  - UI state management: Run/Stop button enable/disable
  - Close event kills running process

7.3 DARK THEME
--------------------------------------------------------------------------------
  Comprehensive QSS stylesheet covering all widgets:
  - QMainWindow, QWidget: #1e1e1e background
  - QPushButton: #2d2d2d with #404040 border, hover/pressed states
  - QTextEdit: #0d0d0d terminal background
  - QComboBox, QDateEdit: #2d2d2d with dropdown styling
  - QCheckBox: Custom indicator with #26a69a checked state
  - QProgressBar: #26a69a chunk on #2d2d2d background
  - QGroupBox: #404040 border with #26a69a title
  - QListWidget: #2d2d2d with #26a69a selected items
  - QScrollBar: Custom minimal scrollbars
  - QCalendarWidget: Full dark theme for date picker
  - QStatusBar: #252526 with #808080 text


8. CLI INTERFACE
================================================================================

  Script: scripts/run_edge_tests.py

  Usage:
    python run_edge_tests.py                                    # All tests
    python run_edge_tests.py --indicators candle_range,volume_delta
    python run_edge_tests.py --date-from 2026-01-01 --verbose
    python run_edge_tests.py --stop-type m5_atr
    python run_edge_tests.py --export edge_results.md

  Arguments:
    --indicators    Comma-separated indicator keys (default: all)
    --date-from     Start date filter YYYY-MM-DD (default: none)
    --date-to       End date filter YYYY-MM-DD (default: none)
    --stop-type     Stop type for outcome (default: zone_buffer)
    --export        Export to markdown file (default: none)
    --verbose       Show detailed output per test

  Workflow:
    [1/3] Connect to Supabase and fetch joined trade+indicator data
    [2/3] Report data summary (trade count, date range, baseline WR)
    [3/3] Report indicator data availability per column
    [1/N]-[N/N] Run each indicator's tests across segments
    Print results summary (edges sorted by effect size descending)
    Optionally print detailed results per indicator per test
    Optionally export markdown report

  Exit Codes:
    0 - Success
    1 - Unknown indicator, data fetch failure, or empty data


9. DATA MODELS
================================================================================

  EdgeTestResult (dataclass):
    indicator:          str     - Indicator name (e.g., "Volume Delta")
    test_name:          str     - Test name (e.g., "Vol Delta Sign")
    segment:            str     - Segment (e.g., "ALL", "LONG", "SHORT")
    has_edge:           bool    - True if all three edge conditions met
    p_value:            float   - From chi-square or spearman test
    effect_size:        float   - Win rate difference in percentage points
    groups:             Dict    - {group_name: {trades: n, wins: n, win_rate: pct}}
    baseline_win_rate:  float   - Overall win rate for comparison
    confidence:         str     - "HIGH", "MEDIUM", or "LOW"
    test_type:          str     - "chi_square", "spearman", or "none"
    recommendation:     str     - Action recommendation string
    total_trades:       int     - Total trades in segment (default 0)

  Methods:
    to_dict() -> Dict   - Serialization to dictionary

  Win Rate Group Structure:
    {
        'GROUP_NAME': {
            'trades': int,      # Total trades in group
            'wins': int,        # Winning trades in group
            'win_rate': float   # Win percentage (0-100)
        }
    }


10. MARKDOWN REPORT FORMAT
================================================================================

  Reports are exported to: 04_indicators/results/edge_results_{timestamp}.md

  Filename Pattern: edge_results_YYYYMMDD_HHMMSS.md

  Report Structure:
    1. Header with metadata (timestamp, trade count, baseline WR, stop type)
    2. Summary section (edges detected count, total tests)
    3. Validated Edges table (sorted by effect size descending)
       Columns: Indicator, Test, Segment, Effect, p-value, Confidence
    4. Detailed Results by Indicator
       - Each indicator as H3 heading
       - Each test result: EDGE / NO EDGE / LOW DATA
       - Edge results include effect size and p-value


11. CONFIGURATION SUMMARY
================================================================================

  Statistical Thresholds:
  - P_VALUE_THRESHOLD:          0.05 (statistical significance)
  - EFFECT_SIZE_THRESHOLD:      3.0 percentage points (practical significance)
  - MIN_SAMPLE_SIZE_HIGH:       100 trades per group (HIGH confidence)
  - MIN_SAMPLE_SIZE_MEDIUM:     30 trades per group (MEDIUM confidence)

  Candle Range:
  - absorption_threshold:       0.12% (below = absorption zone, skip)
  - normal_threshold:           0.15% (above = momentum, take)
  - high_threshold:             0.20% (strong signal)

  Volume Delta:
  - rolling_period:             5 bars
  - magnitude_threshold:        100,000

  Volume ROC:
  - baseline_period:            20 bars
  - elevated_threshold:         30 (elevated volume)
  - high_threshold:             50 (high volume)

  CVD Slope:
  - window:                     15 bars
  - rising_threshold:           0.1
  - falling_threshold:          -0.1

  SMA:
  - fast_period:                9 bars (SMA9)
  - slow_period:                21 bars (SMA21)
  - wide_spread_threshold:      0.15

  Structure:
  - lookback:                   5 bars
  - fractal_length:             5

  Health Score:
  - max_score:                  10
  - STRONG:                     8-10
  - MODERATE:                   6-7
  - WEAK:                       4-5
  - CRITICAL:                   0-3

  Default Indicator Run Order (strongest edges first):
  1. candle_range                (18-29pp historical edge)
  2. structure_edge              (24-54pp edge on H1)
  3. cvd_slope                   (15-27pp edge for SHORT)
  4. volume_delta                (10-20pp edge)
  5. sma_edge                    (19-25pp edge)
  6. volume_roc                  (moderate edge)
  7. vwap_simple                 (paradoxical - on hold)


12. DATABASE TABLES
================================================================================

12.1 INPUT TABLES
--------------------------------------------------------------------------------

  trades:
  - Trade records with entry times generated by 03_backtest
  - Key fields: trade_id, date, ticker, model, direction, entry_price,
                entry_time

  m1_indicator_bars:
  - M1 (1-minute) bar snapshots with pre-calculated indicator values
  - Key fields: ticker, bar_date, bar_time, vol_delta, vol_roc,
                cvd_slope, vwap, sma9, sma21, sma_spread,
                sma_momentum_label, health_score, open, high, low, close

  entry_indicators:
  - Multi-timeframe structure snapshots at trade entry time
  - Key fields: trade_id, h4_structure, h1_structure, m15_structure,
                m5_structure

  stop_analysis:
  - Win/loss outcome classification by stop type
  - Key fields: trade_id, stop_type, stop_price, outcome (WIN/LOSS),
                r_achieved
  - Multiple rows per trade (one per stop_type)

12.2 JOIN RELATIONSHIPS
--------------------------------------------------------------------------------

  trades (1) --[trade_id]--> (1) entry_indicators
  trades (1) --[trade_id]--> (N) stop_analysis (filtered by stop_type)
  trades (1) --[ticker,date,prior_bar_time]--> (1) m1_indicator_bars


13. INDICATOR EDGE TEST REGISTRY
================================================================================

  ALL_TESTS dictionary maps indicator keys to test function lists:

  candle_range:
    1. ('Threshold Categories',  test_candle_range_threshold)
    2. ('Magnitude Quintiles',   test_candle_range_quintile)
    3. ('Absorption Filter',     test_candle_range_absorption)

  volume_delta:
    1. ('Sign (Pos/Neg)',        test_vol_delta_sign)
    2. ('Alignment',             test_vol_delta_alignment)
    3. ('Magnitude Quintiles',   test_vol_delta_magnitude)

  volume_roc:
    1. ('Category',              test_vol_roc_category)
    2. ('Magnitude Quintiles',   test_vol_roc_quintile)

  cvd_slope:
    1. ('Direction',             test_cvd_slope_direction)
    2. ('Alignment',             test_cvd_slope_alignment)

  sma_edge:
    1. ('Spread Direction',      test_sma_spread_direction)
    2. ('Price Position',        test_sma_price_position)

  structure_edge:
    1. ('H1 Structure',          test_h1_structure)
    2. ('M15 Structure',         test_m15_structure)
    3. ('MTF Alignment',         test_structure_alignment)


14. PROCESSING PIPELINE
================================================================================

  Step 1: Data Acquisition
  -------------------------
  1. Parse CLI arguments (indicators, filters, stop type)
  2. Connect to Supabase PostgreSQL
  3. Execute master join query with parameterized filters
  4. Return DataFrame with all indicator columns

  Step 2: Per-Indicator Testing Loop
  -----------------------------------
  For each selected indicator (in priority order):
    For each registered test function:
      For each segment (ALL, LONG, SHORT, CONTINUATION, REJECTION):
        1. Apply segment filter to DataFrame
        2. Check minimum sample size (>= 30 trades)
        3. Calculate indicator-specific metrics (categories, quintiles)
        4. Compute win rates per group
        5. Run statistical test (chi-square or spearman)
        6. Determine edge (p-value + effect size + confidence)
        7. Create EdgeTestResult with full context
        8. Append to results list

  Step 3: Results Aggregation
  ----------------------------
  1. Separate results into: edges_found, no_edge, insufficient_data
  2. Sort edges by effect size descending
  3. Print summary with group-level win rates
  4. Optionally print detailed per-test results
  5. Optionally export to markdown file

  Data Flow Diagram:
  Supabase -> DataFrame -> Segment Filter -> Metric Calculation ->
  Statistical Test -> Edge Determination -> EdgeTestResult ->
  Summary / Export


15. RELATIONSHIP TO EPOCH SYSTEM
================================================================================

  The Indicator Edge Testing module is the fourth module in the Epoch
  closed-loop system. It sits downstream of 03_backtest and the indicator
  calculation pipeline, consuming completed trade records and their
  associated indicator snapshots to statistically validate which indicators
  provide actionable trading edges.

  Upstream Dependencies:
  - 01_application: Zone Analysis pipeline identifies trading zones
  - 03_backtest: Backtest Runner simulates trades against zones
  - stop_analysis table: Secondary processors classify outcomes by stop type
  - m1_indicator_bars: Pre-calculated M1 indicator snapshots
  - entry_indicators: Multi-timeframe structure snapshots at entry

  Downstream Consumers:
  - 02_dow_ai: AI trading assistant uses validated edges for live-session
    recommendations (indicator_edges.json context file)
  - 06_training: Training module incorporates edge findings for education
  - Manual: Trader uses edge findings to refine entry/exit criteria

  Feedback Loop:
  Zone Identification (01) -> Backtesting (03) -> Edge Testing (04) ->
  AI Recommendations (02) -> Refinement -> Zone Identification (01)

  Launch Methods:
  - GUI:     python app.py
  - CLI:     python scripts/run_edge_tests.py
  - Master:  Via Epoch launcher (launcher.py)


16. EXTERNAL DEPENDENCIES
================================================================================

  Python Packages:
  - PyQt6           (GUI framework - windows, widgets, process management)
  - psycopg2        (PostgreSQL database driver with SSL)
  - pandas          (DataFrame manipulation, groupby, qcut, crosstab)
  - numpy           (Numerical operations, conditional classification)
  - scipy           (Statistical tests - chi2_contingency, spearmanr)
  - argparse        (CLI argument parsing - stdlib)
  - pathlib          (Path manipulation - stdlib)
  - dataclasses     (Data structures - stdlib)
  - datetime        (Timestamps - stdlib)
  - re              (Regex for progress parsing - stdlib)
  - traceback       (Error reporting - stdlib)

  External Services:
  - Supabase PostgreSQL (db.pdbmcskznoaiybdiobje.supabase.co:5432)
    - SSL required
    - Direct psycopg2 connection (not via shared data layer)


17. FILE INVENTORY
================================================================================

  04_indicators/
   __init__.py                         Module package marker
   app.py                              Application entry point (45 lines)
   config.py                           Centralized configuration (182 lines)
   CLAUDE.md                           AI context documentation
   edge_testing/
      __init__.py                     Package exports (10 lines)
      base_tester.py                  Database, stats, metrics (566 lines)
      edge_tests.py                   Test functions + registry (617 lines)
   indicator_gui/
      __init__.py                     Package marker
      main.py                         Alternate GUI entry point (34 lines)
      main_window.py                  IndicatorEdgeWindow class (376 lines)
      styles.py                       DARK_THEME QSS stylesheet (322 lines)
   scripts/
      __init__.py                     Package marker
      run_edge_tests.py               CLI runner + report gen (400 lines)
   results/
       .gitkeep                        Directory placeholder
       edge_results_*.md               Generated markdown reports


18. ARCHITECTURAL NOTES
================================================================================

  Module Independence:
  - This module connects directly to Supabase via psycopg2 rather than
    using the shared data layer (00_shared/data/supabase.py)
  - Database credentials are duplicated in config.py rather than imported
    from shared.config.credentials
  - This is noted as a V1-to-V2 migration item (module 04 is pending)

  V2 Migration Status:
  - Module is listed as "Pending" in the Epoch CLAUDE.md migration tracker
  - Current implementation works standalone but does not follow the V2
    centralized import pattern (from shared.config import ...)

  Design Patterns:
  - Follows the same GUI+CLI dual-mode pattern as 03_backtest
  - Uses QProcess subprocess isolation (same as 03_backtest)
  - Terminal-style output with color coding (same UI pattern)
  - Progress tracking via [X/N] stdout pattern parsing

  No VWAP Tests:
  - VWAP is registered in config.py INDICATORS dict with tests=['position',
    'alignment'] but no test functions exist in edge_tests.py and no entry
    exists in ALL_TESTS. The DEFAULT_INDICATOR_ORDER comment notes it as
    "Paradoxical - on hold".


================================================================================
Document generated for XIII Trading LLC - Epoch Trading System v2.0
================================================================================


================================================================================
EPOCH TRADING SYSTEM v2.0 - SYSTEM ANALYSIS APPLICATION
System Specifications
XIII Trading LLC
================================================================================

1. IMPLEMENTATION OVERVIEW
================================================================================

The System Analysis module is a comprehensive Streamlit web application that
serves as the analytical hub for the Epoch zone-based trading system, providing
statistical analysis, trade management simulation, indicator edge testing,
options analysis, and AI-powered research assistance across four major
dashboard tabs plus an archived analysis tab. The application consumes trade
records from the Supabase trades table, MFE/MAE potential data from the
mfe_mae_potential table, indicator snapshots from entry_indicators, bar-by-bar
progression data from m5_trade_bars, pre-calculated stop analysis outcomes
from the stop_analysis table, indicator refinement scores from the
indicator_refinement table, options data from the op_mfe_mae_potential table,
and canonical unified outcomes from the trades_m5_r_win table. The module
implements 11 numbered calculation modules (CALC-001 through CALC-011) plus
5 options calculation modules (CALC-O01 through CALC-O09), each performing
specific statistical analyses: win rate by model (CALC-001), MFE/MAE
distribution analysis (CALC-002), MFE/MAE sequence analysis for Monte Carlo
baseline (CALC-003), simulated outcome grid search (CALC-004), health score
correlation (CALC-005), factor importance via information gain (CALC-006),
indicator progression analysis (CALC-007), rejection dynamics (CALC-008),
stop type analysis comparing 6 stop placement methods (CALC-009), indicator
refinement continuation/rejection scoring (CALC-010), and EPCH indicator
edge analysis via chi-square and Spearman tests (CALC-011). For each analysis,
the system generates structured Claude AI prompts through the Monte AI
subsystem, which assembles persona context, calculation results, and analysis
questions into copyable prompts for external AI analysis. A separate
secondary processor (ramp_up_analysis) performs batch pre-entry indicator
progression analysis using 15 M1 bars before entry, calculating trends,
momentum, and structure consistency across 9 analytical dimensions exported
to both database tables and Claude-readable markdown documents.


2. HIGH-LEVEL TECHNICAL SPECIFICATIONS
================================================================================

2.1 APPLICATION FRAMEWORK
--------------------------------------------------------------------------------
- Runtime:          Python 3.12+
- UI Framework:     Streamlit (web application)
- Default Port:     8502
- Layout:           Wide mode
- Theme:            Dark mode (#1a1a2e background)
- Charting:         Plotly Express + Plotly Graph Objects
- Data Caching:     st.cache_data with TTL (300s data, 600s metadata)

2.2 DATA SOURCES
--------------------------------------------------------------------------------
- Primary Database: Supabase PostgreSQL via psycopg2 + SSL
                    Direct connection (not via shared data layer)
- Market Data API:  Polygon.io REST API (for stop analysis calculations)
                    Rate limited: 0.25s delay, 3 retries, 2.0s retry delay
- Connection:       Singleton SupabaseClient with auto-reconnect

2.3 APPLICATION TABS
--------------------------------------------------------------------------------

  Tab 1: METRICS OVERVIEW
  - Stop Type Analysis (CALC-009, foundation)
  - Stop Type Selector (bridges CALC-009 to downstream)
  - Win Rate by Model (CALC-001)
  - MFE/MAE Distribution Analysis (CALC-002)
  - MFE/MAE Sequence Analysis (CALC-003)
  - Simulated Outcome Analysis (CALC-004)
  - Monte AI Research Assistant

  Tab 2: OPTIONS ANALYSIS
  - Options Stop Type Analysis (CALC-O09)
  - Options Win Rate by Model (CALC-O01)
  - Options MFE/MAE Distribution
  - Options MFE/MAE Sequence (CALC-O03)
  - Options Simulated Outcomes (CALC-O05)
  - Options vs Underlying Comparison (CALC-O04)
  - Monte AI Options Analysis

  Tab 3: INDICATOR ANALYSIS
  - Stop Type Selector for indicator win condition
  - Health Score Correlation (CALC-005)
  - Factor Importance (CALC-006)
  - Indicator Progression (CALC-007)
  - Rejection Dynamics (CALC-008)
  - Monte AI Indicator Analysis

  Tab 4: EPCH INDICATORS
  - Edge Analysis (CALC-011)
  - Chi-square and Spearman statistical tests
  - Candle Range, Volume Delta, Volume ROC, SMA, Structure tests

  Tab 5: ARCHIVED ANALYSIS
  - Overview, Continuation, Rejection, Indicators, Health, Raw Data


3. DATABASE TABLES
================================================================================

3.1 PRIMARY INPUT TABLES
--------------------------------------------------------------------------------

  trades:
  - Core trade records from 03_backtest
  - Fields: trade_id, date, ticker, model, direction, entry_price,
            entry_time, exit_price, exit_time, exit_reason, is_winner,
            pnl_r, zone_high, zone_low

  mfe_mae_potential:
  - Maximum Favorable/Adverse Excursion from entry to 15:30 ET
  - Fields: trade_id, date, ticker, direction, model, entry_time,
            entry_price, mfe_potential_price, mfe_potential_time,
            mfe_r_potential, mae_potential_price, mae_potential_time,
            mae_r_potential, bars_analyzed, is_winner, pnl_r

  optimal_trade:
  - Indicator snapshots at key trade events
  - Fields: trade_id, event_type (ENTRY/MFE/MAE/EXIT), date, ticker,
            direction, model, win, event_time, bars_from_entry,
            price_at_event, health_score, health_delta, health_summary,
            vwap, sma9, sma21, sma_spread, sma_momentum, vol_roc,
            vol_delta, cvd_slope, m5/m15/h1/h4_structure, actual_r

  entry_indicators:
  - Indicator snapshots specifically at trade entry time
  - Fields: trade_id, date, ticker, direction, model, entry_time,
            plus all indicator columns, health_score, structure columns

  m5_trade_bars:
  - 5-minute bar progression during each trade
  - Fields: trade_id, bar_seq, bar_time, bars_from_entry, event_type,
            OHLCV, all indicator columns, health_score, health_label,
            structure/volume/price sub-scores

  stop_analysis:
  - Pre-calculated stop outcomes for 6 stop types
  - Fields: trade_id, stop_type, date, ticker, direction, model,
            entry_time, entry_price, zone_low, zone_high, stop_price,
            stop_distance, stop_distance_pct, stop_hit, stop_hit_time,
            mfe_price, mfe_time, mfe_distance, r_achieved, outcome,
            trigger_type

  trades_m5_r_win:
  - Canonical unified trade outcomes (single source of truth)
  - Fields: trade_id, date, ticker, model, direction, entry_price,
            stop_price, stop_distance, r1_price, outcome, exit_reason,
            outcome_method, is_winner, pnl_r, max_r_achieved,
            reached_2r, reached_3r, minutes_to_r1

  indicator_refinement:
  - Continuation (0-10) and rejection (0-11) qualification scores
  - Fields: trade_id, date, ticker, direction, model, trade_type,
            continuation_score, continuation_label, rejection_score,
            rejection_label, plus individual component scores

  op_mfe_mae_potential:
  - Options MFE/MAE data from entry to 15:30 ET
  - Fields: trade_id, date, ticker, direction, model, options_ticker,
            strike, expiration, contract_type, entry_time,
            option_entry_price, mfe/mae/exit points/price/time/pct,
            underlying_mfe/mae/exit_pct, bars_analyzed

  m1_indicator_bars:
  - 1-minute bar data with pre-calculated indicators
  - Fields: ticker, bar_date, bar_time, OHLCV, vol_delta, vol_roc,
            cvd_slope, vwap, sma9, sma21, sma_spread,
            sma_momentum_label, health_score

  m1_bars:
  - Raw 1-minute OHLCV bars
  - Fields: ticker, bar_date, bar_time, open, high, low, close,
            volume, vwap

3.2 SECONDARY PROCESSOR TABLES
--------------------------------------------------------------------------------

  ramp_up_macro:
  - Per-trade summary of pre-entry indicator behavior
  - 44 columns: trade identity, outcome, entry bar snapshot (9 indicators),
    ramp averages (7), ramp trends (7), ramp momentum (7),
    structure consistency (2), bars_analyzed

  ramp_up_progression:
  - Bar-by-bar indicator values for 15 bars before entry
  - Fields: trade_id, bars_to_entry (-15 to 0), bar_time,
            9 indicator values per bar

  ramp_analysis_* (9 tables):
  - ramp_analysis_direction
  - ramp_analysis_trade_type
  - ramp_analysis_model
  - ramp_analysis_model_direction
  - ramp_analysis_indicator_trend
  - ramp_analysis_indicator_momentum
  - ramp_analysis_structure_consistency
  - ramp_analysis_entry_snapshot
  - ramp_analysis_progression_avg

3.3 DATABASE VIEWS
--------------------------------------------------------------------------------
  - v_stop_analysis_summary: Aggregated stop analysis by stop type
  - v_stop_analysis_by_model: Stop analysis by stop type + model
  - v_stop_analysis_by_direction: Stop analysis by stop type + direction


4. CALCULATION MODULES
================================================================================

4.1 CALC-009: STOP TYPE ANALYSIS (Foundation)
--------------------------------------------------------------------------------

  Purpose: Analyzes 6 different stop placement methods to determine which
  provides the best risk-adjusted returns. This is the foundation for all
  downstream win/loss classification.

  Stop Types:
    zone_buffer  - Zone boundary + 5% buffer (core thesis stop)
    prior_m1     - Prior M1 bar high/low
    prior_m5     - Prior M5 bar high/low
    m5_atr       - M5 ATR(14) x 1.1 close-based (DEFAULT)
    m15_atr      - M15 ATR(14) x 1.1 close-based
    fractal      - M5 fractal high/low

  Win Condition:
    WIN = MFE reached (>= 1R) before stop hit
    LOSS = Stop hit before reaching 1R
    PARTIAL = Stop hit after some MFE but < 1R

  Stop Analysis Components:
    - stop_calculator.py: Computes stop prices for all 6 types
    - atr_calculator.py: ATR calculation (True Range method)
    - fractal_detector.py: Fractal high/low detection (length=5)
    - outcome_simulator.py: Bar-by-bar simulation of stop/target outcomes
    - results_aggregator.py: Aggregates results into summary statistics
    - stop_selector.py: Session state management for UI selection
    - ui_components.py: Streamlit rendering of stop analysis results

  Metrics Per Stop Type:
    - Total trades, wins, losses, partials
    - Win rate %
    - Average stop distance %
    - Average R for winners
    - Expectancy = (win_rate * avg_win_r) - ((1 - win_rate) * 1.0)

4.2 CALC-001: WIN RATE BY MODEL
--------------------------------------------------------------------------------

  Purpose: Calculates win/loss rates for each EPCH entry model using the
  selected stop type's outcome classification.

  Models:
    EPCH1 - Primary zone continuation
    EPCH2 - Primary zone rejection
    EPCH3 - Secondary zone continuation
    EPCH4 - Secondary zone rejection

  Outputs:
    - Per-model: trades, wins, losses, win_rate, avg_points, total_points
    - Trade type grouping: continuation (EPCH1+3) vs rejection (EPCH2+4)
    - Zone type grouping: primary (EPCH1+2) vs secondary (EPCH3+4)

4.3 CALC-002: MFE/MAE DISTRIBUTION ANALYSIS
--------------------------------------------------------------------------------

  Purpose: Analyzes raw price movement potential from entry to 15:30 ET,
  independent of any stop selection.

  MFE/MAE as Percentage:
    mfe_pct = abs(mfe_potential_price - entry_price) / entry_price * 100
    mae_pct = abs(mae_potential_price - entry_price) / entry_price * 100

  Statistics Calculated:
    - Mean, median, std, min, max, percentiles (25th, 75th, 90th)
    - MFE:MAE ratio (median_mfe / median_mae)
    - Favorable ratio: trades where MFE > MAE / total trades
    - Breakdown by model and direction

  Visualizations:
    - MFE histogram (profit available)
    - MAE histogram (heat taken)
    - MFE vs MAE scatter (above diagonal = favorable)
    - Model breakdown table

4.4 CALC-003: MFE/MAE SEQUENCE ANALYSIS
--------------------------------------------------------------------------------

  Purpose: Determines WHEN MFE and MAE occur to establish probability
  of favorable movement happening before adverse movement.

  Key Metric: P(MFE First)
    Percentage of trades where MFE time < MAE time
    (favorable movement occurs before adverse movement)

  Monte Carlo Parameters Generated:
    - p_mfe_first: probability MFE occurs first
    - avg_time_to_mfe: average minutes to maximum favorable excursion
    - avg_time_to_mae: average minutes to maximum adverse excursion
    - Breakdown by model and direction

4.5 CALC-004: SIMULATED OUTCOME ANALYSIS
--------------------------------------------------------------------------------

  Purpose: Simulates trade outcomes at configurable stop/target levels
  to find optimal parameters.

  Grid Search:
    Stop levels: 0.5R to 3.0R in 0.25R increments
    Target levels: 1.0R to 5.0R in 0.5R increments
    For each (stop, target) combination:
      - Simulate which is hit first using MFE/MAE data
      - Calculate win rate, expectancy, profit factor
      - Identify optimal parameter set

  find_optimal_parameters():
    Returns the (stop, target) combination with highest expectancy

4.6 CALC-005: HEALTH SCORE CORRELATION
--------------------------------------------------------------------------------

  Purpose: Tests whether higher health scores predict higher win rates.

  Health Score: 10-factor composite (0-10 scale)
    Structure factors (4): H4, H1, M15, M5 structure alignment
    Volume factors (3): Volume ROC, Volume Delta, CVD slope
    Price factors (3): VWAP position, SMA alignment, SMA momentum
    Each factor: 1 point if aligned with trade direction, 0 otherwise

  Health Buckets:
    CRITICAL: 0-3  |  WEAK: 4-5  |  MODERATE: 6-7  |  STRONG: 8-10

  Analysis:
    - Win rate by health score (0-10) with 95% confidence intervals
    - Win rate by health bucket with lift vs baseline
    - Correlation coefficient and p-value
    - Model-specific health thresholds
    - Wilson confidence interval for small sample sizes

4.7 CALC-006: FACTOR IMPORTANCE
--------------------------------------------------------------------------------

  Purpose: Determines which of the 10 health score factors individually
  predict win/loss outcomes.

  Method: Information Gain (entropy reduction)
    For each factor:
      - Calculate baseline win rate
      - Calculate win rate when factor is HEALTHY vs UNHEALTHY
      - Lift = healthy_win_rate - baseline_win_rate
      - Information gain = H(outcome) - H(outcome | factor)

  Factor Groups:
    Structure: h4_structure, h1_structure, m15_structure, m5_structure
    Volume: vol_roc, vol_delta, cvd_slope
    Price: sma_alignment, sma_momentum, vwap_position

  Output: Ranked list of factors by predictive importance with lift values

4.8 CALC-007: INDICATOR PROGRESSION ANALYSIS
--------------------------------------------------------------------------------

  Purpose: Tracks how indicators change during a trade to identify early
  warning signals for winners vs losers.

  Data Source: m5_trade_bars (5-minute bar progression)

  Analysis:
    - Average indicator paths: winners vs losers at each bar position
    - Divergence detection: where paths separate meaningfully
    - Early warning signals: factors that predict outcome within N bars
    - Best early warning: factor with highest divergence earliest

4.9 CALC-008: REJECTION DYNAMICS
--------------------------------------------------------------------------------

  Purpose: Tests whether rejection trades (EPCH2/4) require different
  indicator analysis than continuation trades (EPCH1/3).

  Analysis:
    - Time-to-MFE comparison: rejections vs continuations
    - Time-to-MFE buckets: FAST (0-5m), QUICK (5-15m),
                           NORMAL (15-30m), SLOW (30m+)
    - Factor inversion: indicators that flip predictive direction
    - Exhaustion signals specific to rejection entries

4.10 CALC-010: INDICATOR REFINEMENT (DEPRECATED)
--------------------------------------------------------------------------------

  Purpose: Continuation (0-10) and rejection (0-11) qualification scores
  for trade entry filtering. Replaced by CALC-011.

  Continuation Score Components (10 points max):
    MTF Alignment (4pts): H4, H1, M15, M5 structure aligned
    SMA Momentum (2pts): Spread direction + expanding
    Volume Thrust (2pts): Vol ROC strong + Delta aligned
    Pullback Quality (2pts): In pullback + delta ratio favorable

  Rejection Score Components (11 points max):
    Structure Divergence (3pts): HTF aligned + LTF divergent
    SMA Exhaustion (2pts): Contracting + tight spread
    Delta Absorption (2pts): Absorption ratio favorable
    Volume Climax (2pts): Vol ROC Q5 + declining
    CVD Extreme (2pts): Extreme CVD + normalized extreme

4.11 CALC-011: EPCH INDICATOR EDGE ANALYSIS
--------------------------------------------------------------------------------

  Purpose: Statistical edge testing for EPCH v1.0 indicators using
  chi-square and Spearman correlation tests. Replaces CALC-010.

  Indicators Tested:
    - Candle Range: threshold categories, quintiles, absorption filter
    - Volume Delta: sign, alignment, magnitude quintiles
    - Volume ROC: category, quintiles
    - CVD Slope: direction, alignment
    - SMA: spread direction, price position
    - Market Structure: H1/M15/M5 direction, MTF alignment
    - Composite Score: combined indicator scoring

  Edge Criteria:
    - p-value < 0.05 (statistical significance)
    - Effect size > 3.0pp (practical significance)
    - Minimum 30 trades per group (MEDIUM confidence)

  Test Types:
    - Chi-square test of independence for categorical groupings
    - Spearman rank correlation for ordinal quintiles


5. OPTIONS ANALYSIS CALCULATIONS
================================================================================

5.1 CALC-O09: OPTIONS STOP TYPE ANALYSIS
--------------------------------------------------------------------------------
  Analyzes options-specific stop levels (percentage-based) to find
  best risk-adjusted returns for options trades.

5.2 CALC-O01: OPTIONS WIN RATE BY MODEL
--------------------------------------------------------------------------------
  Win/loss rates using stop-based outcomes for options positions.
  Win = Target reached before stop hit (in options price terms).

5.3 CALC-O02/O03: OPTIONS MFE/MAE DISTRIBUTION AND SEQUENCE
--------------------------------------------------------------------------------
  Options price movement analysis measured in points and percentages.
  P(MFE First) for options positions.

5.4 CALC-O04: OPTIONS VS UNDERLYING COMPARISON
--------------------------------------------------------------------------------
  Leverage analysis comparing options movement to underlying movement.
  Metrics: MFE leverage, MAE leverage, exit leverage multipliers.

5.5 CALC-O05: OPTIONS SIMULATED OUTCOMES
--------------------------------------------------------------------------------
  Grid search of stop/target parameters for options positions.
  Stop levels in percentage terms (10%-50%).


6. DATA LAYER
================================================================================

6.1 SUPABASE CLIENT (data/supabase_client.py)
--------------------------------------------------------------------------------

  Class: SupabaseClient
  Singleton access: get_client()
  Connection: psycopg2 with RealDictCursor, auto-reconnect

  Query Methods (30+ methods):

  Trade Data:
    fetch_trades() - Core trade records with filtering
    fetch_trade_bars() - Bar-by-bar trade data
    fetch_trade_bars_grouped() - Grouped by trade_id
    fetch_trades_with_zones() - Trades with zone boundaries
    fetch_trades_m5_r_win() - Canonical unified outcomes
    fetch_trades_m5_r_win_by_trade() - Indexed by trade_id

  Indicator Data:
    fetch_optimal_trades() - Event-level indicator snapshots
    fetch_entry_indicators() - Entry-time snapshots
    fetch_m5_trade_bars_with_outcomes() - M5 bars + outcomes

  MFE/MAE Data:
    fetch_mfe_mae_potential() - Price movement potential
    fetch_op_mfe_mae_potential() - Options price movement

  Stop Analysis Data:
    fetch_stop_analysis() - Pre-calculated outcomes
    fetch_stop_analysis_summary() - Aggregated by stop type
    fetch_stop_analysis_by_model() - By stop type + model
    fetch_stop_analysis_by_direction() - By stop type + direction
    fetch_stop_outcomes_by_trade() - Indexed by trade_id
    get_stop_analysis_count() - Record count check
    get_stop_analysis_trade_count() - Per-type count

  Indicator Refinement:
    fetch_indicator_refinement() - Scores with component details
    fetch_indicator_refinement_summary() - Aggregated stats
    get_indicator_refinement_count() - Record count

  M1 Bar Data:
    fetch_m1_bars() - Single ticker-date
    fetch_m1_bars_batch() - Batch fetch
    check_m1_bars_coverage() - Coverage statistics
    fetch_m1_bars_for_stop_analysis() - Optimized for stop calc
    fetch_m5_trade_bars_for_stop_analysis() - M5 bars for stops

  Metadata:
    get_available_tickers() - Distinct tickers
    get_available_models() - Distinct models
    get_date_range() - Min/max dates
    get_trade_count() - Total trade count
    get_trade_summary() - Aggregated stats
    get_summary_by_model() - Stats per model
    get_options_summary() - Options summary stats


7. ANALYSIS MODULES
================================================================================

7.1 TRADE STATISTICS (analysis/trade_stats.py)
--------------------------------------------------------------------------------

  Win Condition: Pre-computed is_winner from stop_analysis table

  Points Calculation:
    Win Points = abs(mfe_potential_price - entry_price) for winners
    Loss Points = abs(mae_potential_price - entry_price) for losers
    Total Points = Sum(Win Points) - Sum(Loss Points)
    Avg Points = Total Points / Total Trades

  Functions:
    get_trade_statistics(data) -> {total, wins, losses, win_rate,
                                   avg_points, total_points,
                                   median_mfe_pct, median_mae_pct}
    get_stats_by_model(data) -> [{model, trade_type, zone_type, ...stats}]
    get_stats_by_direction(data) -> {LONG: stats, SHORT: stats}
    get_stats_by_exit_reason(data) -> {reason: stats}

7.2 INDICATOR STATISTICS (analysis/indicator_stats.py)
--------------------------------------------------------------------------------

  Indicator Columns: health_score, vwap, sma9, sma21, sma_spread,
                     vol_roc, vol_delta, cvd_slope
  Structure Columns: m5_structure, m15_structure, h1_structure, h4_structure

  Functions:
    get_indicator_averages(data, group_by) -> {indicator_mean/median/std/...}
    get_indicator_by_event(data, indicator) -> {ENTRY/MFE/MAE/EXIT: stats}
    get_indicator_by_outcome(data, indicator) -> {WIN/LOSS: stats}
    get_health_distribution(data, by_outcome) -> {overall/winners/losers: dist}
    get_indicator_comparison_by_outcome(data) -> {winners/losers: {ind: avg}}

7.3 MODEL COMPARISON (analysis/model_comparison.py)
--------------------------------------------------------------------------------

  Functions:
    compare_continuation_vs_rejection(trades)
      -> {continuation: stats, rejection: stats}
    compare_primary_vs_secondary(trades)
      -> {primary: stats, secondary: stats}
    get_indicator_comparison_by_trade_type(optimal_trades, event_type)
      -> {continuation: indicator_avgs, rejection: indicator_avgs}
    get_win_rate_by_model_and_indicator(optimal_trades, indicator, threshold)
      -> {model: {above/below_threshold_count/wins/win_rate}}


8. INDICATOR CALCULATION MODULES
================================================================================

8.1 INDICATOR CALCULATORS (calculations/indicators/)
--------------------------------------------------------------------------------

  cvd.py - Cumulative Volume Delta Slope
    - Cumulates volume delta over rolling window
    - Slope via linear regression on rolling CVD
    - Thresholds: rising > 0.1, falling < -0.1

  sma.py - Simple Moving Average Analysis
    - SMA9 and SMA21 calculation
    - Spread = SMA9 - SMA21
    - Momentum = current_spread / prior_spread ratio
    - Labels: WIDENING (>1.1), NARROWING (<0.9), STABLE

  volume_delta.py - Volume Delta
    - Calculates buy vs sell volume imbalance
    - Rolling 5-bar sum

  volume_roc.py - Volume Rate of Change
    - ROC relative to 20-bar baseline average
    - Categories: HIGH (>50), ELEVATED (>30), NORMAL

  vwap.py - Volume Weighted Average Price
    - Standard VWAP calculation
    - Position: ABOVE/BELOW relative to price

8.2 STRUCTURE CALCULATORS (calculations/structure/)
--------------------------------------------------------------------------------

  Fractal-based market structure for 4 timeframes:

  m5_structure.py  - 5-minute timeframe
  m15_structure.py - 15-minute timeframe
  h1_structure.py  - 1-hour timeframe
  h4_structure.py  - 4-hour timeframe

  MarketStructureCalculator:
    - Fractal detection (length=5, p=2 bars each side)
    - Break of Structure (BOS): price breaks prior swing
    - Change of Character (ChoCH): structure direction reversal
    - States: BULLISH, BEARISH, NEUTRAL

8.3 HEALTH SCORE (calculations/health/)
--------------------------------------------------------------------------------

  health_score.py:
    10 binary factors (0 or 1), summed for 0-10 composite
    Each factor tests alignment with trade direction

  Factor Weights (all 1.0 in current config):
    h4_structure, h1_structure, m15_structure, m5_structure
    volume_roc, volume_delta, cvd
    sma_alignment, sma_momentum, vwap

  thresholds.py:
    STRONG: 8-10  |  MODERATE: 6-7  |  WEAK: 4-5  |  CRITICAL: 0-3


9. STOP ANALYSIS SUBSYSTEM
================================================================================

9.1 STOP CALCULATOR (calculations/stop_analysis/stop_calculator.py)
--------------------------------------------------------------------------------

  Computes stop prices for 6 stop types:

  Zone + 5% Buffer:
    LONG: stop = zone_low - (zone_high - zone_low) * 0.05
    SHORT: stop = zone_high + (zone_high - zone_low) * 0.05

  Prior M1 H/L:
    LONG: stop = prior M1 bar low
    SHORT: stop = prior M1 bar high

  Prior M5 H/L:
    LONG: stop = prior M5 bar low
    SHORT: stop = prior M5 bar high

  M5 ATR (Close-based):
    ATR = SMA(14) of True Range on M5 bars
    LONG: stop = close - ATR * 1.1
    SHORT: stop = close + ATR * 1.1

  M15 ATR (Close-based):
    Same as M5 ATR but on M15 timeframe

  M5 Fractal H/L:
    LONG: stop = most recent bullish fractal (swing low)
    SHORT: stop = most recent bearish fractal (swing high)
    Fractal length = 5, p = 2

9.2 ATR CALCULATOR (calculations/stop_analysis/atr_calculator.py)
--------------------------------------------------------------------------------

  True Range:
    TR = max(high - low, abs(high - prev_close), abs(low - prev_close))

  ATR(14):
    Simple moving average of True Range over 14 periods

9.3 FRACTAL DETECTOR (calculations/stop_analysis/fractal_detector.py)
--------------------------------------------------------------------------------

  Bearish Fractal (Swing High):
    pivot_high > all p bars on each side (p = length // 2 = 2)

  Bullish Fractal (Swing Low):
    pivot_low < all p bars on each side

  Length = 5, confirmed after p bars on right side

9.4 OUTCOME SIMULATOR (calculations/stop_analysis/outcome_simulator.py)
--------------------------------------------------------------------------------

  Bar-by-bar simulation:
    For each bar after entry:
      Check if stop hit (LONG: low <= stop, SHORT: high >= stop)
      Check if target hit (1R from entry)
      Record which occurs first

  Outcome Classification:
    WIN: Target hit before stop
    LOSS: Stop hit before target
    PARTIAL: Stop hit, but some MFE achieved

9.5 RESULTS AGGREGATOR (calculations/stop_analysis/results_aggregator.py)
--------------------------------------------------------------------------------

  Per Stop Type:
    total_trades, wins, losses, partials
    win_rate = wins / total * 100
    avg_stop_distance_pct
    avg_r_winners
    expectancy = (win_rate/100 * avg_r_winners) - ((1-win_rate/100) * 1.0)


10. TRADE MANAGEMENT SUBSYSTEM
================================================================================

10.1 MFE/MAE STATISTICS (calculations/trade_management/mfe_mae_stats.py)
--------------------------------------------------------------------------------

  MFE/MAE as R-multiples:
    mfe_r = mfe_r_potential (from mfe_mae_potential table)
    mae_r = mae_r_potential (from mfe_mae_potential table)

  Summary Statistics:
    Mean, median, std, min, max for both MFE and MAE
    Percentiles: 25th, 75th, 90th
    MFE:MAE ratio = median_mfe / median_mae
    Favorable ratio = trades where MFE > MAE / total

  By-Model Breakdown:
    Same statistics per EPCH model and per direction

  Visualizations:
    MFE/MAE histograms, scatter plot, model breakdown table

10.2 MFE/MAE SEQUENCE (calculations/trade_management/mfe_mae_sequence.py)
--------------------------------------------------------------------------------

  Sequence Analysis:
    P(MFE First) = trades where mfe_time < mae_time / total

  Time-to-Event:
    avg_time_to_mfe = mean(mfe_time - entry_time) in minutes
    avg_time_to_mae = mean(mae_time - entry_time) in minutes

  Monte Carlo Parameters:
    p_mfe_first, avg_time_to_mfe, avg_time_to_mae
    Breakdown by model and direction

10.3 SIMULATED OUTCOMES (calculations/trade_management/simulated_outcomes.py)
--------------------------------------------------------------------------------

  Grid Search:
    Stop levels: [0.5R, 0.75R, 1.0R, 1.25R, ..., 3.0R]
    Target levels: [1.0R, 1.5R, 2.0R, 2.5R, ..., 5.0R]

  Per (stop, target) combination:
    win_rate = trades where MFE >= target AND (MAE < stop OR MFE first)
    expectancy = (win_rate * target) - ((1 - win_rate) * stop)
    profit_factor = gross_wins / gross_losses

  find_optimal_parameters():
    Returns (stop, target) with max expectancy


11. MONTE AI PROMPT GENERATION SYSTEM
================================================================================

11.1 ARCHITECTURE
--------------------------------------------------------------------------------

  The Monte AI system generates structured Claude analysis prompts through
  a four-layer pipeline:

  Layer 1: Prompt Templates (prompts.py, indicator_prompts.py,
           options_prompts.py, refinement_prompts.py)
    - System persona and context
    - Tab-specific background information
    - Analysis request questions
    - Database schema (optional)

  Layer 2: Data Collectors (data_collector.py)
    - Collects computed statistics from the dashboard
    - Formats into Claude-readable text tables
    - Always uses default stop type (m5_atr) for reproducibility

  Layer 3: Prompt Generators (prompt_generator.py,
           indicator_prompt_generator.py, options_prompt_generator.py,
           refinement_prompt_generator.py)
    - Combines templates with collected data
    - Assembles: persona + context + schema + analysis + data
    - Full prompt and quick prompt variants

  Layer 4: UI Rendering (ui.py)
    - Displays prompt statistics (chars, words, tokens)
    - Copyable text area with JavaScript clipboard button
    - Download as .txt file
    - Expandable sections per analysis type

11.2 PROMPT TYPES
--------------------------------------------------------------------------------

  Metrics Overview:
    - System context with EPCH model definitions
    - Stop analysis data (always m5_atr default)
    - Model stats, MFE/MAE distributions, sequence analysis
    - 7 analysis sections requested

  Indicator Analysis (per CALC-005 through CALC-008):
    - Health score composition context (10 factors)
    - Specific calculation results as formatted tables
    - Analysis questions per calculation type
    - Synthesis option combining all four

  Options Analysis:
    - Options context (always buy, first ITM/ATM, CALL=LONG/PUT=SHORT)
    - MFE/MAE stats, leverage comparison, sequence analysis
    - Stop analysis and simulated outcomes

  Refinement Analysis:
    - Continuation scoring system (4 components, 10 points)
    - Rejection scoring system (5 components, 11 points)
    - Score label tables with lift vs baseline
    - Combined synthesis option

11.3 TOKEN ESTIMATION
--------------------------------------------------------------------------------
  Estimated tokens = character count / 4
  (approximate for Claude tokenizer)


12. SECONDARY PROCESSOR: RAMP-UP ANALYSIS
================================================================================

12.1 PURPOSE
--------------------------------------------------------------------------------

  The ramp-up analysis processor examines the 15 M1 bars BEFORE each trade
  entry to identify pre-entry indicator patterns that correlate with trade
  outcomes. This answers: "What was happening in the minutes leading up to
  a winning vs losing entry?"

12.2 INDICATORS ANALYZED
--------------------------------------------------------------------------------

  Numeric (7):
    candle_range_pct, vol_delta, vol_roc, sma_spread,
    sma_momentum_ratio, long_score, short_score

  Categorical (2):
    m15_structure, h1_structure

12.3 CALCULATIONS PER TRADE
--------------------------------------------------------------------------------

  Entry Bar Snapshot:
    Values of all 9 indicators at the entry bar (position 0)

  Ramp Averages (bars -1 to -14):
    Mean of each numeric indicator across pre-entry bars

  Ramp Trends:
    Linear regression slope normalized by value range
    Classification: RISING (slope > 0.05), FALLING (< -0.05), FLAT

  Ramp Momentum:
    First half average (bars -15 to -8) vs second half (bars -7 to -1)
    pct_change = (second_half - first_half) / abs(first_half)
    Classification: BUILDING (> 0.10), FADING (< -0.10), STABLE

  Structure Consistency (for M15, H1):
    If 80%+ of bars share same value -> CONSISTENT_BULL/BEAR/NEUTRAL
    If first half differs from second half -> FLIP_TO_BULL/FLIP_TO_BEAR
    Otherwise -> MIXED

12.4 NINE ANALYZERS
--------------------------------------------------------------------------------

  1. Direction Analysis: LONG vs SHORT win rates
  2. Trade Type Analysis: Continuation vs Rejection
  3. Model Analysis: EPCH1/2/3/4 individual performance
  4. Model Direction: 4 models x 2 directions = 8 combinations
  5. Indicator Trend: For each indicator, RISING/FALLING/FLAT vs outcome
  6. Indicator Momentum: BUILDING/FADING/STABLE vs outcome
  7. Structure Consistency: Consistency patterns vs outcome
  8. Entry Snapshot: Indicator value buckets at entry vs outcome
  9. Progression Average: Average indicator paths (winners vs losers)

  Each analyzer calculates lift vs baseline win rate and flags results
  with minimum 30-trade significance threshold.

12.5 EXPORTS
--------------------------------------------------------------------------------

  Database: 9 ramp_analysis_* tables with aggregated results

  Markdown: 10 Claude-readable documents:
    01_direction_analysis.md through 09_progression_summary.md
    Plus 09_progression_analysis.json for machine-readable data

  CSV: 3 export formats:
    ramp_up_macro_{date}.csv - One row per trade (44 columns)
    ramp_up_progression_{date}.csv - One row per bar per trade
    ramp_up_combined_{date}.csv - Flattened (one wide row per trade)


13. UI COMPONENTS
================================================================================

13.1 CHARTS (components/charts.py)
--------------------------------------------------------------------------------

  All charts use Plotly with consistent dark theme:
    background: #0e1117, text: white, transparent plot area

  Chart Types:
    render_win_rate_chart() - Bar chart by model
    render_indicator_distribution() - Histogram by win/loss
    render_health_heatmap() - Score x Model heatmap
    render_indicator_by_event() - Bar chart across events
    render_comparison_chart() - Continuation vs rejection subplots

13.2 INDICATOR CHARTS (components/indicator_charts.py)
--------------------------------------------------------------------------------

  Returns Plotly Figure objects (not rendered directly):
    render_health_correlation_curve() - Line with CI band
    render_health_bucket_bars() - Grouped bars by bucket
    render_factor_importance_bars() - Horizontal lift chart
    render_time_to_mfe_histogram() - With bar-count reference lines
    render_indicator_progression_lines() - Winner vs loser paths

13.3 OPTIONS CHARTS (components/options_charts.py)
--------------------------------------------------------------------------------

  Colors: call=#26a69a, put=#ef5350, mfe=#2E86AB, mae=#E94F37

  Chart Types:
    render_options_win_rate_by_model()
    render_options_win_loss_by_contract()
    render_options_mfe/mae_distribution() - With 25%/50%/100% refs
    render_options_mfe_mae_scatter() - With diagonal reference
    render_leverage_comparison_bars()
    render_leverage_scatter() - With 5x/10x/20x reference lines
    render_options_sequence_probability_chart()

13.4 FILTERS (components/filters.py)
--------------------------------------------------------------------------------

  Sidebar Filters:
    Date range: All Time, This Year, This Month, This Week, Today
    Models: Multiselect EPCH1-4
    Trade type: All / Continuation / Rejection
    Direction: All / Long / Short
    Tickers: Multiselect
    Outcome: All / Winners / Losers

13.5 SUMMARY CARDS (components/summary_cards.py)
--------------------------------------------------------------------------------

  render_summary_cards() - 5 metrics: Total, WR%, W/L, Avg Pts, Total Pts
  render_model_cards() - Split by Continuation/Rejection
  render_indicator_card() - Winner vs Loser value comparison

  Win Rate Color Thresholds:
    Green: >= 55%  |  Yellow: >= 45%  |  Red: < 45%

13.6 CHART CONFIGURATION
--------------------------------------------------------------------------------

  CHART_CONFIG Colors:
    background:     #1a1a2e     paper:        #1a1a2e
    grid:           #2a2a4e     text:         #e0e0e0
    text_muted:     #888888     win:          #26a69a
    loss:           #ef5350     continuation: #2196F3
    rejection:      #FF9800     long:         #00C853
    short:          #FF1744     strong:       #00C853
    moderate:       #FFC107     weak:         #FF9800
    critical:       #FF1744     height:       400px


14. CONFIGURATION SUMMARY
================================================================================

  Application:
  - STREAMLIT_PORT:             8502
  - PAGE_TITLE:                 "Epoch Indicator Analysis"
  - LAYOUT:                     wide
  - CACHE_TTL_DATA:             300 seconds (5 minutes)
  - CACHE_TTL_METADATA:         600 seconds (10 minutes)

  Entry Models:
  - EPCH1: continuation, primary zone
  - EPCH2: rejection, primary zone
  - EPCH3: continuation, secondary zone
  - EPCH4: rejection, secondary zone

  SMA:
  - fast_period: 9, slow_period: 21
  - momentum_lookback: 10
  - widening_threshold: 1.1, narrowing_threshold: 0.9

  Volume ROC:
  - baseline_period: 20
  - above_avg_threshold: 20, below_avg_threshold: -20

  Volume Delta:
  - rolling_period: 5

  CVD:
  - window: 15
  - rising_threshold: 0.1, falling_threshold: -0.1

  Structure:
  - fractal_length: 5

  Health Score:
  - max_score: 10
  - All factor weights: 1.0 (equal weighting)
  - STRONG: 8-10, MODERATE: 6-7, WEAK: 4-5, CRITICAL: 0-3

  Win Condition:
  - Default stop type: m5_atr
  - Win = MFE >= 1R before stop hit
  - Available: zone_buffer, prior_m1, prior_m5, m5_atr, m15_atr, fractal

  Indicator Analysis:
  - min_trades_for_analysis: 30
  - confidence_interval: 0.95
  - vol_roc threshold: 20.0
  - cvd_slope thresholds: 0.1 / -0.1
  - sma_widening: 1.1
  - time_to_mfe_buckets: FAST(0-5m), QUICK(5-15m), NORMAL(15-30m), SLOW(30m+)

  Polygon API:
  - delay: 0.25s, retries: 3, retry_delay: 2.0s

  Ramp-Up Analysis:
  - LOOKBACK_BARS: 15 (M1 bars before entry)
  - MIN_BARS_REQUIRED: 10
  - BATCH_SIZE: 100
  - TREND_THRESHOLD: 0.05
  - MOMENTUM_THRESHOLD: 0.10
  - MOMENTUM_SPLIT_BAR: -8


15. RELATIONSHIP TO EPOCH SYSTEM
================================================================================

  The System Analysis module is the fifth module in the Epoch closed-loop
  system. It serves as the primary analytical dashboard, consuming data
  produced by upstream modules and feeding insights back into the system.

  Upstream Dependencies:
  - 01_application: Zone identification and setup export
  - 03_backtest: Trade simulation producing trade records
  - 03_backtest/processor: Secondary processors populating
    mfe_mae_potential, stop_analysis, entry_indicators, m5_trade_bars,
    m1_indicator_bars, optimal_trade, indicator_refinement,
    op_mfe_mae_potential tables

  Downstream Consumers:
  - 02_dow_ai: Monte AI prompts inform AI trading assistant context
  - 04_indicators: Edge testing framework uses same statistical methods
  - 06_training: Training module uses findings for education
  - Manual: Trader uses dashboards for system refinement decisions

  Feedback Loop:
  Zone Identification (01) -> Backtesting (03) -> System Analysis (05) ->
  Statistical Edge Validation (04) -> AI Recommendations (02) ->
  Refinement -> Zone Identification (01)

  Launch Method:
  - Streamlit: streamlit run app.py --server.port 8502
  - Master: Via Epoch launcher (launcher.py)


16. EXTERNAL DEPENDENCIES
================================================================================

  Python Packages:
  - streamlit         (Web application framework)
  - plotly            (Interactive charting - Express and Graph Objects)
  - pandas            (DataFrame manipulation and statistics)
  - numpy             (Numerical operations)
  - scipy             (Statistical tests - chi-square, spearman)
  - psycopg2          (PostgreSQL database driver with SSL)
  - python-dotenv     (Environment variable loading)
  - logging           (Standard library - structured logging)

  External Services:
  - Supabase PostgreSQL (db.pdbmcskznoaiybdiobje.supabase.co:5432)
  - Polygon.io REST API (market data for stop analysis)


17. FILE INVENTORY
================================================================================

  05_system_analysis/
   app.py                                    Main Streamlit entry (1644 lines)
   config.py                                 Configuration (272 lines)
   credentials.py                            DB + API credentials
   CLAUDE.md                                 AI context documentation
   12_indicator_analysis.md                  Module documentation
  
   data/
      supabase_client.py                    Database client (1717 lines)
  
   analysis/
      trade_stats.py                        Trade statistics
      indicator_stats.py                    Indicator statistics
      model_comparison.py                   Model comparison
  
   calculations/
      model/
         win_rate_by_model.py              CALC-001
      trade_management/
         mfe_mae_stats.py                  CALC-002
         mfe_mae_sequence.py               CALC-003
         simulated_outcomes.py             CALC-004
      stop_analysis/
         stop_calculator.py                Stop price computation
         atr_calculator.py                 ATR calculation
         fractal_detector.py               Fractal detection
         outcome_simulator.py              Bar-by-bar simulation
         results_aggregator.py             Results aggregation
         stop_selector.py                  UI state management
         ui_components.py                  Streamlit rendering
      indicators/
         cvd.py, sma.py, volume_delta.py
         volume_roc.py, vwap.py
      structure/
         h4_structure.py, h1_structure.py
         m15_structure.py, m5_structure.py
      health/
         health_score.py, thresholds.py
      indicator_analysis/
         health_correlation.py             CALC-005
         factor_importance.py              CALC-006
         indicator_progression.py          CALC-007
         rejection_dynamics.py             CALC-008
      indicator_refinement/
         ui_components.py                  CALC-010 (deprecated)
      epch_indicators/
         base_tester.py                    CALC-011 infrastructure
         candle_range_tests.py             Range edge tests
         volume_delta_tests.py             Delta edge tests
         volume_roc_tests.py               ROC edge tests
         sma_tests.py                      SMA edge tests
         structure_tests.py                Structure edge tests
         composite_score_tests.py          Composite scoring
         prompt_generator.py               CALC-011 prompts
         ui_components.py                  CALC-011 Streamlit UI
      indicator_edge/
         base_tester.py, edge_report.py, vwap_edge.py
      options/
         op_win_rate_by_model.py           CALC-O01
         op_mfe_mae_stats.py               CALC-O02
         op_mfe_mae_sequence.py            CALC-O03
         op_vs_underlying.py               CALC-O04
         op_simulated_outcomes.py          CALC-O05
         op_stop_selector.py               Options stop selector
         op_stop_analysis/                 Options stop subsystem
             outcome_simulator.py, results_aggregator.py
             stop_calculator.py, stop_types.py
             ui_components.py
      derived/
          mfe_mae.py, trade_outcome.py
  
   components/
      charts.py                             Plotly chart rendering
      indicator_charts.py                   Indicator-specific charts
      options_charts.py                     Options charts
      filters.py                            Sidebar filter UI
      summary_cards.py                      Metric cards
      options_summary_cards.py              Options metric cards
      prompt_generator.py                   Legacy prompt generation
  
   monte_ai/
      ui.py                                 Monte AI UI components
      prompts.py                            Metrics overview templates
      indicator_prompts.py                  CALC-005-008 templates
      options_prompts.py                    Options templates
      refinement_prompts.py                 CALC-010 templates
      prompt_generator.py                   Metrics prompt assembly
      indicator_prompt_generator.py         Indicator prompt assembly
      options_prompt_generator.py           Options prompt assembly
      refinement_prompt_generator.py        Refinement prompt assembly
      data_collector.py                     Data formatting for prompts
  
   secondary_processor/
      ramp_up_analysis/
          ramp_config.py                    Configuration
          run.py                            Monolithic runner (original)
          run_analysis.py                   Modular orchestrator
          run_full_analysis.py              Full pipeline runner
          calculator.py                     Core calculations
          data_fetcher.py                   Database queries
          db_writer.py                      Database writes
          analysis/
             base.py                       Abstract analyzer base
             calculators.py                9 concrete analyzers
             run_analysis.py               Analyzer orchestrator
          exporters/
             csv_exporter.py               CSV export
             prompt_exporter.py            Markdown export
          schema/
             ramp_up_tables.sql
             ramp_analysis_tables.sql
          outputs/                          Generated reports
  
   results/                                  Generated analysis reports
   docs/                                     Documentation


18. ARCHITECTURAL NOTES
================================================================================

  Module Independence:
  - This module connects directly to Supabase via psycopg2 rather than
    using the shared data layer (00_shared/data/supabase.py)
  - Credentials are in a local credentials.py file
  - V2 migration status: "Complete (Hybrid approach)"

  Hybrid Architecture:
  - Uses Streamlit (not PyQt6 like other V2 modules)
  - Plotly for charting (not the shared UI framework)
  - V1 calculation logic preserved, V2 viewer layer on top

  Win Condition Evolution:
  - Original: MFE time < MAE time (temporal ordering)
  - Current: Stop-based from stop_analysis table (bar-by-bar simulation)
  - Canonical: trades_m5_r_win (M5 ATR 1.1x close-based)
  - Monte AI always uses m5_atr default regardless of UI selection

  Data Caching:
  - Streamlit cache with TTL prevents redundant queries
  - Data TTL: 300s (5 min), Metadata TTL: 600s (10 min)
  - Cache keys include all filter parameters

  Total Python Files: ~94
  Total Calculation Modules: 16 (CALC-001 through CALC-011 + O01-O09)
  Database Tables Consumed: 12+
  Database Tables Written: 11 (ramp-up analysis only)


================================================================================
Document generated for XIII Trading LLC - Epoch Trading System v2.0
================================================================================


================================================================================
EPOCH TRADING SYSTEM v2.0 - TRAINING MODULE
System Specifications
XIII Trading LLC
================================================================================

1. IMPLEMENTATION OVERVIEW
================================================================================

The Training Module is a Streamlit web application that implements an
interactive flashcard review system for deliberate practice of trade
evaluation. Users review historical trades from the Supabase database in
two modes: Pre-Trade view shows the setup at the right edge (entry point)
WITHOUT revealing the outcome, while Post-Trade view reveals the full trade
with exit, MFE/MAE markers, R-level crossings, and comprehensive outcome
metrics. The review queue is shuffled randomly to prevent temporal memory
leakage -- the phenomenon where reviewing trades in chronological order
allows the reviewer to recognize market context rather than evaluating
setups independently. Each trade is presented with multi-timeframe charts
(M5 execution, M15 structure, H1 context), a 1-minute ramp-up chart
showing pre-entry indicator progression, an event indicators table
tracking health score evolution across ENTRY/R1/R2/R3/MFE/MAE/EXIT
milestones, and an indicator refinement scoring panel that classifies
trades as CONTINUATION (EPCH1/3, scored 0-10) or REJECTION (EPCH2/4,
scored 0-11). The module integrates DOW AI -- a copy-paste prompt
generation system that creates structured analysis prompts for Claude
Desktop with full trade context including M1 ramp-up candle data, ATR
levels, Camarilla pivots, HVN POC levels, and market structure -- enabling
the trader to get AI-assisted pre-trade and post-trade reviews. Users
record observations through a multi-flag review form (16 boolean
assessment flags plus notes) that persists to a dedicated trade_reviews
table, and pre-computed AI predictions from the ai_predictions table are
displayed inline with TRADE/NO_TRADE decisions and confidence ratings.
Win condition uses the canonical outcome from the trades_m5_r_win table
(M5 ATR 1.1x close-based stop), aligned with the System Analysis module.


2. HIGH-LEVEL TECHNICAL SPECIFICATIONS
================================================================================

2.1 APPLICATION FRAMEWORK
--------------------------------------------------------------------------------
- Runtime:          Python 3.12+
- UI Framework:     Streamlit (web application)
- Page Title:       Epoch Trade Review
- Page Icon:        Target emoji
- Layout:           Wide, sidebar expanded
- Theme:            Dark mode (#1a1a2e background, custom CSS)
- Execution:        streamlit run streamlit_app.py --server.headless true
- Launcher:         python app.py (subprocess wrapper)
- Version:          v3.0 (M5 ATR canonical outcomes)

2.2 DATA SOURCES
--------------------------------------------------------------------------------
- Trade Data:       Supabase PostgreSQL (trades table) via psycopg2 + SSL
- Event Data:       optimal_trade table (ENTRY, R1_CROSS, R2_CROSS,
                    R3_CROSS, MFE, MAE, EXIT events)
- Market Data:      Polygon.io REST API (M5, M15, H1 OHLCV bars)
                    /v2/aggs/ticker/{}/range/{minutes}/minute/{from}/{to}
- Ramp-Up Data:     m1_indicator_bars table (pre-computed M1 indicators)
- Zone Data:        zones table (filtered zone boundaries, ranks, tiers)
- Image Data:       trade_images table (bookmap/footprint snapshot URLs)
- Review Data:      trade_reviews table (user assessment flags and notes)
- AI Analysis:      trade_analysis table (Claude prompt/response pairs)
- AI Predictions:   ai_predictions table (pre-computed TRADE/NO_TRADE)
- Refinement:       indicator_refinement table (continuation/rejection scores)
- Canonical Win:    trades_m5_r_win table (M5 ATR 1.1x stop outcomes)
- DOW AI Context:   bar_data, hvn_pocs, market_structure, setups tables

2.3 API CONFIGURATION
--------------------------------------------------------------------------------
- API Key:          Polygon.io REST API (f4vzZl0g...df4_)
- Rate Limiting:    0.25s between calls
- Retries:          3 attempts, 2.0s retry delay
- Parameters:       adjusted=true, sort=asc, limit=50000
- Extended Hours:   08:00 ET (pre-market) through 20:00 ET (after-hours)

2.4 CHART CONFIGURATION
--------------------------------------------------------------------------------
- Candle Count:     160 per timeframe
- Timeframes:       5m (40%), 15m (35%), 1h (25%) row heights
- Chart Height:     900px (multi-timeframe), 550px (ramp-up)
- Max Bars:         120 per subplot trace
- Rangebreaks:      Weekends (sat-mon), overnight (20:00-04:00)
- Prefetch Count:   3 upcoming trades cached ahead


3. FLASHCARD STATE MACHINE
================================================================================

The core interaction model is a two-state flashcard with a review queue:

3.1 SESSION STATE VARIABLES
--------------------------------------------------------------------------------
  review_queue         List[TradeWithMetrics]  Shuffled trade queue
  current_trade_index  int                     Current position (0-indexed)
  queue_loaded         bool                    Whether queue has been loaded
  last_filters         dict                    Filter state for reload
  view_mode            str                     'pre_trade' or 'post_trade'

3.2 PRE-TRADE VIEW (EVALUATE MODE)
--------------------------------------------------------------------------------
  Displays:
  - Trade info panel: Model, Zone Type, Zone POC, Entry Price, AI Prediction
  - Multi-timeframe chart: M5 (full width), H1 + M15 (side by side)
    - Bars sliced to entry time (future hidden)
    - Zone rectangles with midpoint line
    - Entry marker triangle
  - M1 ramp-up chart: 45 M1 bars before entry with indicator table
    - Candle %, Vol Delta, Vol ROC, SMA, H1 Struct, LONG score, SHORT score
    - Color-coded values (green=favorable, red=unfavorable, yellow=neutral)
  - Event indicators table: ENTRY column only
  - AI prediction detail (if available from ai_predictions)

3.3 POST-TRADE VIEW (REVEAL MODE)
--------------------------------------------------------------------------------
  Displays:
  - Trade info panel (same as pre-trade + AI prediction)
  - Multi-timeframe chart: Full bars (entry through exit + buffer)
    - R-level horizontal lines (Stop, 1R, 2R, 3R)
    - Exit marker with P&L label (R-multiple + points)
    - MFE marker (blue triangle, +R label)
    - MAE marker (orange triangle, -R label)
    - R-level crossing diamond markers with health deltas
  - Stats panel: P&L (R), MFE (R), MAE (R), Duration
    - R-Levels row: Stop, Entry, 1R, 2R, 3R prices
    - R-Level Crossings: Time, health score, health delta at each R
    - Full Trade Details (expandable): Trade info, Entry/Exit, Risk metrics,
      Health metrics, Zone boundaries
  - Event indicators table: ENTRY, R1, R2, R3, MAE, MFE, EXIT columns
    - 15 metrics per event: Time, Price, R-Multiple, Points, Health, VWAP,
      SMA9, SMA21, SMA Spread, SMA Momentum, Vol ROC, M5/M15/H1/H4 structure
  - Bookmap snapshot viewer (if bookmap_url available)
  - Review form: 16 boolean flags + notes + entry attempt selector
  - Navigation: "Next Trade" button (saves review, advances queue)
  - DOW AI sections: Prediction detail, Post-trade review (collapsed)


4. DATA MODELS
================================================================================

4.1 Trade (models/trade.py:12)
--------------------------------------------------------------------------------
  Core trade record from trades table.

  Fields:
    trade_id          str         Unique identifier
    date              date        Trading date
    ticker            str         Stock symbol
    model             str         EPCH1, EPCH2, EPCH3, EPCH4
    zone_type         str         PRIMARY, SECONDARY
    direction         str         LONG, SHORT
    zone_high         float       Zone upper boundary
    zone_low          float       Zone lower boundary
    entry_price       float       Entry price
    entry_time        time        Entry timestamp
    stop_price        float       Stop loss price
    target_3r         float       3R target price
    target_calc       float       Calculated target from zone pipeline
    target_used       float       Actual target used (3R or calc, whichever better)
    exit_price        float       Exit price
    exit_time         time        Exit timestamp
    exit_reason       str         STOP, TARGET_3R, TARGET_CALC, CHOCH, EOD
    pnl_dollars       float       P&L in dollars
    pnl_r             float       P&L in R-multiples
    risk              float       Risk per share
    is_winner         bool        Win/loss flag

  Computed Properties:
    zone_mid          float       (zone_high + zone_low) / 2
    entry_datetime    datetime    Combined date + entry_time
    exit_datetime     datetime    Combined date + exit_time
    duration_minutes  int         (exit_datetime - entry_datetime) in minutes

4.2 OptimalTradeEvent (models/trade.py:110)
--------------------------------------------------------------------------------
  Event row from optimal_trade table (points-based v2.0).
  Each trade has up to 7 events: ENTRY, R1_CROSS, R2_CROSS, R3_CROSS,
  MFE, MAE, EXIT.

  Fields:
    trade_id            str       Trade identifier
    event_type          str       ENTRY, MFE, MAE, EXIT, R1_CROSS, R2_CROSS, R3_CROSS
    date                date      Trading date
    ticker              str       Stock symbol
    direction           str       LONG, SHORT
    model               str       EPCH model
    win                 int       1 if mfe_time < mae_time (temporal win)
    event_time          time      When event occurred
    bars_from_entry     int       M5 bars since entry
    entry_price         float     Entry reference price
    price_at_event      float     Price when event occurred
    points_at_event     float     Points from entry (replaces r_at_event in v2.0)
    actual_points       float     Actual P&L points (replaces actual_r)
    health_score        int       Composite health (0-10)
    health_label        str       STRONG/MODERATE/WEAK/CRITICAL
    health_delta        int       Change from entry health
    health_summary      str       IMPROVING/DEGRADING/STABLE
    structure_score     int       Structure sub-score
    volume_score        int       Volume sub-score
    price_score         int       Price sub-score
    vwap                float     VWAP at event time
    sma9                float     9-period SMA
    sma21               float     21-period SMA
    sma_spread          float     SMA9 - SMA21
    sma_momentum_ratio  float     Spread change ratio
    sma_momentum_label  str       WIDENING/NARROWING/STABLE
    vol_roc             float     Volume Rate of Change (%)
    vol_delta           float     Volume Delta (buy - sell volume)
    cvd_slope           float     Cumulative Volume Delta slope
    m5_structure        str       M5 market structure (BULL/BEAR)
    m15_structure       str       M15 market structure
    h1_structure        str       H1 market structure
    h4_structure        str       H4 market structure

4.3 TradeWithMetrics (models/trade.py:207)
--------------------------------------------------------------------------------
  Main data structure for the flashcard UI. Wraps Trade with MFE/MAE
  metrics, R-level calculations, R-level crossing events, zone metadata,
  bookmap URL, and canonical outcome from trades_m5_r_win.

  Win Condition: canonical_winner from trades_m5_r_win (M5 ATR 1.1x),
                 fallback to pnl_r > 0

  Core Fields:
    trade               Trade       Core trade record
    temporal_win        int         1 if mfe_time < mae_time (legacy)
    mfe_points/bars/time/price/health   MFE event metrics
    mae_points/bars/time/price/health   MAE event metrics
    exit_points/exit_time_actual        Exit metrics (fixed 15:30 ET)
    entry_health        int         Health score at entry
    exit_health         int         Health score at exit
    zone_rank/tier/score               Zone metadata (L1-L5, T1-T3)
    bookmap_url         str         Bookmap snapshot URL

  Canonical Outcome Fields (from trades_m5_r_win):
    stop_analysis_price             Pre-calculated stop from DB
    stop_analysis_r_achieved        R achieved from DB
    stop_analysis_outcome           WIN/LOSS from DB
    stop_analysis_mfe_price         MFE price from stop analysis
    canonical_winner                is_winner from unified table
    canonical_outcome               WIN/LOSS from unified table
    canonical_pnl_r                 pnl_r from unified table
    canonical_outcome_method        atr_r_target or zone_buffer_fallback
    canonical_r1/r2/r3_price        Pre-calculated R-level prices

  R-Level Crossing Events (v2.2.0):
    r1_crossed/time/bars/health/health_delta/health_summary
    r2_crossed/time/bars/health/health_delta/health_summary
    r3_crossed/time/bars/health/health_delta/health_summary

  Computed Properties:
    default_stop_price  float   Prefer stop_analysis_price, fallback to
                                zone edge + 5% buffer calculation
    risk_per_share      float   abs(entry_price - default_stop_price)
    r1_price            float   entry + 1 * risk_per_share (LONG)
    r2_price            float   entry + 2 * risk_per_share
    r3_price            float   entry + 3 * risk_per_share
    mfe_r               float   MFE in R-multiples
    mae_r               float   MAE in R-multiples (negative)
    pnl_r               float   Canonical pnl_r, fallback to EOD calculation
    is_winner_r         bool    Canonical winner, fallback to pnl_r > 0
    outcome_r           str     WIN/LOSS/BREAKEVEN/UNKNOWN

4.4 Zone (models/trade.py:608)
--------------------------------------------------------------------------------
  Zone boundary data from zones table.

  Fields:
    zone_id             str       Unique zone identifier
    ticker              str       Stock symbol
    date                date      Trading date
    zone_high           float     Zone upper boundary
    zone_low            float     Zone lower boundary
    hvn_poc             float     High volume node POC price
    rank                str       L1-L5 quality ranking
    tier                str       T1-T3 tier classification
    score               float     Composite zone score
    is_filtered         bool      True if in zone_results (quality filtered)

4.5 TradeReview (models/trade.py:644)
--------------------------------------------------------------------------------
  User assessment record stored in trade_reviews table.

  Fields:
    trade_id              str     Trade identifier
    actual_outcome        str     winner/loser/breakeven
    notes                 str     Free-text observations
    accuracy              bool    Did trader predict correctly?
    tape_confirmation     bool    Was tape confirmation present?
    good_trade            bool    Was this a good setup?
    signal_aligned        bool    Were entry signals aligned?
    confirmation_required bool    Did trade need more confirmation?
    prior_candle_stop     bool    Stop at prior candle level
    two_candle_stop       bool    Stop at two candle level
    atr_stop              bool    Stop using ATR calculation
    zone_edge_stop        bool    Stop at zone edge
    entry_attempt         int     1st, 2nd, or 3rd attempt (1-3)
    with_trend            bool    Trade was with the trend
    counter_trend         bool    Trade was counter-trend
    stopped_by_wick       bool    Stopped out by wick (not body)

4.6 TradeAnalysis (models/trade.py:729)
--------------------------------------------------------------------------------
  Claude AI analysis record from trade_analysis table.

  Fields:
    trade_id            str       Trade identifier
    analysis_type       str       pre_trade or post_trade
    response_text       str       Claude's analysis response (markdown)
    prompt_text         str       The prompt sent to Claude
    created_at          datetime  Creation timestamp
    updated_at          datetime  Last update timestamp


5. MULTI-TIMEFRAME CHART ENGINE
================================================================================

5.1 CHART LAYOUT (charts.py:20)
--------------------------------------------------------------------------------
  build_review_chart() creates a 2-row, 2-column subplot layout:

    Row 1 (55% height): M5 execution chart (spans both columns)
    Row 2 (45% height): H1 market context (left) + M15 structure (right)

  Vertical spacing: 0.08, Horizontal spacing: 0.03

5.2 EVALUATE MODE (mode='evaluate')
--------------------------------------------------------------------------------
  - Candlestick traces for all three timeframes (max 120 bars each)
  - Trade zone rectangles with rank-based border colors
  - Zone midpoint horizontal line
  - Entry marker triangle (up for LONG, down for SHORT)
  - Bars sliced to entry time only (no future data visible)

5.3 REVEAL MODE (mode='reveal')
--------------------------------------------------------------------------------
  All evaluate mode elements PLUS:
  - R-level horizontal lines on M5:
      Entry (green, solid), Stop (red, dashed), 1R (light green, dotted),
      2R (lighter green, dotted), 3R (lime, dotted)
  - Exit marker triangle with P&L label ({exit_price} ({pnl_r}R))
  - MFE marker (blue triangle, +{mfe_r}R label)
  - MAE marker (orange triangle, {mae_r}R label)
  - R-level crossing diamond markers with health delta labels
  - Bars include entry through exit + 10 buffer bars + 60 context bars

5.4 SIMPLE CHART (charts.py:673)
--------------------------------------------------------------------------------
  build_simple_chart() provides a single-timeframe alternative for
  performance-sensitive contexts. 400px height, entry/exit vertical lines.

5.5 COLOR PALETTE
--------------------------------------------------------------------------------
  Candle Up:       #26a69a (teal green)
  Candle Down:     #ef5350 (red)
  Entry:           #00C853 (green)
  Exit:            #FF1744 (red)
  MFE:             #2196F3 (blue)
  MAE:             #FF9800 (orange)
  Stop:            #FF1744 (red)
  1R Target:       #4CAF50 (light green)
  2R Target:       #8BC34A (lighter green)
  3R Target:       #CDDC39 (lime)
  EOD Exit:        #9C27B0 (purple)
  Primary Zone:    #90bff9 (light blue, 15% opacity)
  Secondary Zone:  #faa1a4 (light red, 15% opacity)
  Background:      #1a1a2e (dark navy)
  Grid:            #2a2a4e (muted purple)


6. M1 RAMP-UP CHART
================================================================================

6.1 PURPOSE (rampup_chart.py:1)
--------------------------------------------------------------------------------
  Displays 1-minute candlestick chart with a vertical indicator table below
  each bar, similar to a TradingView-style ramp-up visualization. Shows
  the 45 M1 bars before entry to visualize pre-entry momentum.

6.2 DATA SOURCE
--------------------------------------------------------------------------------
  Pre-computed m1_indicator_bars table (populated by
  09_backtest/processor/secondary_analysis/m1_indicator_bars).

  Query: SELECT ... FROM m1_indicator_bars
         WHERE ticker = %s AND bar_date = %s AND bar_time < %s
         ORDER BY bar_time DESC LIMIT 45

6.3 CHART LAYOUT
--------------------------------------------------------------------------------
  Two-row subplot: 60% candlestick chart, 40% indicator table.
  Shared X-axes. Total height: 550px.

6.4 INDICATOR TABLE ROWS
--------------------------------------------------------------------------------
  7 indicator rows displayed as colored text annotations:

    Candle %    candle_range_pct    Good >=0.15, OK 0.12-0.15, Skip <0.12
    Vol Delta   vol_delta           Green if positive, red if negative
    Vol ROC     vol_roc             Green >=30%, Yellow 0-30%, Red <0%
    SMA         sma_spread/close    B=Bullish (spread>0), S=Bearish
    H1 Struct   h1_structure        Triangle up=BULL, down=BEAR, dash=NEUTRAL
    LONG        long_score          Green >=5, Yellow 3-4, Red 0-2 (out of 7)
    SHORT       short_score         Green >=5, Yellow 3-4, Red 0-2 (out of 7)

6.5 OVERLAY INDICATORS
--------------------------------------------------------------------------------
  SMA9 (blue line), SMA21 (orange line), VWAP (purple dotted line)
  overlaid on the candlestick chart.


7. INDICATOR REFINEMENT TAB
================================================================================

7.1 PURPOSE (indicator_refinement_tab.py:1)
--------------------------------------------------------------------------------
  Displays Continuation and Rejection scores for trade qualification
  based on the Epoch Indicator Model Specification v1.0.

7.2 CONTINUATION INDICATORS (EPCH1/3, 0-10 points)
--------------------------------------------------------------------------------
  CONT-01: MTF Alignment (0-4 pts)
    - H4, H1, M15, M5 structure aligned with trade direction
    - 1 point per aligned timeframe

  CONT-02: SMA Momentum (0-2 pts)
    - SMA spread aligned with direction + expanding
    - 1 point for aligned, 1 point for expanding

  CONT-03: Volume Thrust (0-2 pts)
    - Volume ROC strong + Volume Delta aligned with direction
    - 1 point per condition met

  CONT-04: Pullback Quality (0-2 pts)
    - In pullback + favorable delta ratio
    - 1 point per condition met

  Score Labels:
    STRONG   8-10
    GOOD     6-7
    WEAK     4-5
    AVOID    0-3

7.3 REJECTION INDICATORS (EPCH2/4, 0-11 points)
--------------------------------------------------------------------------------
  REJ-01: Structure Divergence (0-2 pts)
    - HTF aligned + LTF divergent (counter-trend exhaustion signal)

  REJ-02: SMA Exhaustion (0-3 pts)
    - SMA spread contracting + very tight + tight
    - 1 point per condition met

  REJ-03: Delta Absorption (0-2 pts)
    - Absorption ratio indicating exhaustion

  REJ-04: Volume Climax (0-2 pts)
    - Volume ROC in Q5 (>50%) + volume declining

  REJ-05: CVD Extreme (0-2 pts)
    - CVD slope extreme (normalized) indicating reversal

  Score Labels:
    STRONG   9-11
    GOOD     6-8
    WEAK     4-5
    AVOID    0-3

7.4 MONTE AI PROMPT GENERATION
--------------------------------------------------------------------------------
  Generates a structured analysis prompt including all continuation and
  rejection indicator values for copy-paste into Claude for trade analysis.


8. DOW AI INTEGRATION
================================================================================

8.1 ARCHITECTURE (components/dow_ai/)
--------------------------------------------------------------------------------
  DOW AI is a copy-paste prompt generation system, NOT an API integration.
  It generates structured prompts that the trader manually copies to
  Claude Desktop, receives analysis, and pastes the response back for
  storage in the trade_analysis table.

  Files:
    ui.py               (328 lines) Prompt display + copy/paste UI
    data_fetcher.py     (379 lines) Supplemental data fetching
    prompt_generator.py (981 lines) Prompt template population
    prediction_display.py (170 lines) Batch prediction display

8.2 DATA CONTEXT (data_fetcher.py:102)
--------------------------------------------------------------------------------
  DOWAIDataFetcher fetches 4 types of supplemental context:

  BarDataContext:
    - ATR values: M5, M15, H1, D1
    - Daily Camarilla: S6, S4, S3, R3, R4, R6
    - Weekly Camarilla: S3, R3
    - Options levels: op_01 through op_10

  HVNPOCContext:
    - 10 ranked HVN POC levels (poc_1 through poc_10)
    - Epoch start date

  MarketStructureContext:
    - Multi-timeframe directions: D1, H4, H1, M15, composite
    - Strong/weak levels per timeframe

  SetupContext:
    - Zone setup: direction, zone_id, hvn_poc, zone boundaries
    - Target: target_id, target_price, risk_reward

8.3 PRE-TRADE PROMPT (prompt_generator.py:27)
--------------------------------------------------------------------------------
  6-section structured prompt:

    TRADE CONTEXT:          Ticker, date, direction, model, entry, zone
    MARKET STRUCTURE:       M5/M15/H1/H4 structure alignment table
    INDICATOR SNAPSHOT:     VWAP, SMA9/21, Vol ROC, Vol Delta, Health
    M1 RAMP-UP:            15 M1 candle OHLCV + indicator table +
                           price action summary (candle types, momentum,
                           SMA config, VWAP position, H1 structure,
                           composite scores, candle quality)
    SUPPORTING LEVELS:     ATR, Camarilla, HVN POCs, Structure levels,
                           Options levels
    ANALYSIS REQUEST:      Entry quality, zone interaction, confirmation
                           signals, key insights, confidence rating

8.4 POST-TRADE PROMPT (prompt_generator.py:112)
--------------------------------------------------------------------------------
  6-section structured prompt:

    TRADE SUMMARY:         Outcome, P&L (R + points)
    EXECUTION:             Entry/exit prices and times, exit reason
    RISK MANAGEMENT:       Stop (M5 ATR 1.1x), R-levels, R achieved
    PERFORMANCE:           MFE/MAE (R + points), edge efficiency
    R-LEVEL CROSSINGS:     1R/2R/3R hit times, health at crossing
    INDICATOR COMPARISON:  Full event comparison table (Entry through Exit)
    SUPPORTING LEVELS:     Same as pre-trade
    REVIEW REQUEST:        Entry quality, R-level progression, exit timing,
                           structure degradation, refinement suggestions,
                           pattern recognition

8.5 AI PREDICTION DISPLAY (prediction_display.py:12)
--------------------------------------------------------------------------------
  Renders pre-computed predictions from ai_predictions table:
  - Decision: TRADE or NO_TRADE (color-coded green/red)
  - Confidence: HIGH/MEDIUM/LOW (color-coded)
  - Correctness badge (checkmark/cross based on actual outcome)
  - Extracted indicators: Candle %, Vol Delta, Vol ROC, SMA, H1 Structure
  - Outcome tracking: Actual outcome vs prediction


9. DATA LAYER
================================================================================

9.1 SUPABASE CLIENT (data/supabase_client.py)
--------------------------------------------------------------------------------
  SupabaseClient class with singleton pattern (get_supabase_client()).
  Lazy connection on first use. psycopg2 with RealDictCursor.

  Trade Fetching:
    fetch_trades()                  Filtered trade list with JOIN support
                                    for unreviewed/AI-validated filters
    fetch_trade_with_metrics()      Single trade with full context (events,
                                    zones, bookmap, canonical outcome)
    fetch_trades_with_metrics()     Batch fetch with ANY() optimization
    fetch_optimal_trade_events()    Event indicators dict keyed by type
    fetch_zones_for_trade()         Zones for ticker+date

  Trade Reviews:
    fetch_review()                  Get existing review by trade_id
    upsert_review()                 Insert or update (ON CONFLICT)

  AI Analysis:
    fetch_analysis()                Get analysis by trade_id + type
    fetch_all_analysis()            Both pre and post analysis
    upsert_analysis()               Insert or update analysis record

  Indicator Refinement:
    fetch_indicator_refinement()    Full refinement scores for a trade
    fetch_indicator_refinement_batch()  Batch fetch with ANY()

  AI Predictions:
    fetch_ai_prediction()           Pre-computed prediction from ai_predictions

  Utility:
    get_available_tickers()         Distinct tickers with optional date filter
    get_available_models()          Distinct models (EPCH1-4)
    get_trade_count()               Total trade count

9.2 POLYGON CLIENT (data/polygon_client.py)
--------------------------------------------------------------------------------
  PolygonClient class with singleton pattern (get_polygon_client()).

  BarData Container:
    ticker              str         Stock symbol
    trade_date          date        Trading date
    bars_5m             DataFrame   M5 OHLCV (index=timezone-aware datetime)
    bars_15m            DataFrame   M15 OHLCV
    bars_1h             DataFrame   H1 OHLCV
    fetch_time          datetime    When data was fetched
    is_valid            bool        All three timeframes have data

  Lookback Days per Timeframe:
    5m:   3 days lookback
    15m:  8 days lookback
    1h:   25 days lookback

  Methods:
    fetch_bars_for_trade()          All 3 timeframes for a symbol+date
    fetch_extended_bars()           Extended bars for reveal mode

9.3 BAR CACHE (data/cache_manager.py)
--------------------------------------------------------------------------------
  BarCache class manages Streamlit session state caching.
  Cache key: "{TICKER}_{YYYY-MM-DD}" (symbol+date).

  Key Insight: Trades on the same symbol/date share the same bar data.
  Cache per symbol+date, slice differently per trade.

  Methods:
    get_bars_for_trade()            Cache check + fetch on miss
    prefetch_for_trades()           Pre-fetch next 3 trades (PREFETCH_COUNT)
    slice_bars_to_time()            Pre-trade: slice bars <= entry_time
    slice_bars_for_reveal()         Post-trade: context + trade + buffer
    get_cache_stats()               Hit/miss statistics
    clear_cache()                   Reset cache

  Cache Statistics: Tracked in session state as {hits: N, misses: N}.

  Pre-Trade Slicing:
    - End at entry_time (include_end=True)
    - Max 120 bars per timeframe
    - Timezone-aware comparison

  Reveal Slicing:
    - context_bars=60 bars before entry
    - buffer_bars=10 bars after exit
    - Full trade window visible


10. DATABASE SCHEMA
================================================================================

10.1 TABLES OWNED BY TRAINING MODULE
--------------------------------------------------------------------------------

  trade_reviews (schema/01_trade_reviews.sql):
    id                UUID PK     gen_random_uuid()
    trade_id          VARCHAR(50) FK -> trades(trade_id) ON DELETE CASCADE
    actual_outcome    TEXT        CHECK IN (winner, loser, breakeven)
    notes             TEXT        Free-text observations
    good_trade        BOOLEAN     DEFAULT FALSE
    signal_aligned    BOOLEAN     DEFAULT FALSE
    confirmation_required BOOLEAN DEFAULT FALSE
    prior_candle_stop BOOLEAN     DEFAULT FALSE
    two_candle_stop   BOOLEAN     DEFAULT FALSE
    atr_stop          BOOLEAN     DEFAULT FALSE
    zone_edge_stop    BOOLEAN     DEFAULT FALSE
    entry_attempt     INTEGER     CHECK 1-3 or NULL
    with_trend        BOOLEAN     DEFAULT FALSE
    counter_trend     BOOLEAN     DEFAULT FALSE
    stopped_by_wick   BOOLEAN     DEFAULT FALSE
    reviewed_at       TIMESTAMPTZ DEFAULT NOW()
    created_at        TIMESTAMPTZ DEFAULT NOW()
    UNIQUE(trade_id)

    Indexes:
      idx_trade_reviews_trade_id
      idx_trade_reviews_reviewed_at DESC
      idx_trade_reviews_actual_outcome
      idx_trade_reviews_good_trade WHERE good_trade = TRUE

  trade_images (schema/02_trade_images.sql):
    trade_id          VARCHAR(50) PK FK -> trades(trade_id) ON DELETE CASCADE
    bookmap_url       TEXT        Supabase storage or external URL
    image_type        TEXT        CHECK IN (bookmap, dom, footprint, other)
    capture_time      TIME        When snapshot was captured
    notes             TEXT        Notes about the image
    created_at        TIMESTAMPTZ DEFAULT NOW()
    updated_at        TIMESTAMPTZ DEFAULT NOW() (trigger-updated)

  trade_analysis (schema/06_trade_analysis.sql):
    id                UUID PK     gen_random_uuid()
    trade_id          VARCHAR(50) FK -> trades(trade_id) ON DELETE CASCADE
    analysis_type     TEXT        CHECK IN (pre_trade, post_trade)
    prompt_text       TEXT        Prompt sent to Claude
    response_text     TEXT        NOT NULL, Claude's response (markdown)
    created_at        TIMESTAMPTZ DEFAULT NOW()
    updated_at        TIMESTAMPTZ DEFAULT NOW()
    UNIQUE(trade_id, analysis_type)

10.2 VIEWS (schema/03_views_and_functions.sql)
--------------------------------------------------------------------------------

  unreviewed_trades:
    Trades NOT in trade_reviews, joined with optimal_trade for MFE/MAE/
    entry health and trade_images for bookmap URL.

  reviewed_trades:
    Trades IN trade_reviews, joined with review flags and MFE/MAE metrics.

10.3 DATABASE FUNCTIONS (schema/03_views_and_functions.sql)
--------------------------------------------------------------------------------

  get_review_stats_by_flag():
    Returns win rate for each boolean flag (good_trade, signal_aligned,
    with_trend, counter_trend, stopped_by_wick).
    Output: flag_name, total_flagged, winners, losers, win_rate

  get_stop_placement_stats():
    Returns performance by stop type (prior_candle, two_candle, atr_stop,
    zone_edge) including avg MFE and avg MAE per type.
    Output: stop_type, total_count, winners, losers, win_rate, avg_mfe, avg_mae

  get_entry_attempt_stats():
    Returns performance by entry attempt number (1st, 2nd, 3rd).
    Output: entry_attempt, total_count, winners, losers, win_rate, avg_r

  get_review_summary():
    Returns aggregate review statistics.
    Output: total_reviews, good_trades, signal_aligned_trades,
            with_trend_trades, counter_trend_trades, reviews_today,
            reviews_this_week

10.4 TABLES READ (NOT OWNED)
--------------------------------------------------------------------------------
  trades              Core trade records (from backtest module)
  optimal_trade       Event snapshots (ENTRY, MFE, MAE, EXIT, R1-R3_CROSS)
  zones               Zone boundaries and rankings
  trades_m5_r_win     Canonical outcomes (M5 ATR 1.1x stop)
  bar_data            ATR values, Camarilla pivots, options levels
  hvn_pocs            High volume node POC levels (10 ranked)
  market_structure    Multi-timeframe structure directions
  setups              Primary/secondary zone setup configurations
  m1_indicator_bars   Pre-computed M1 indicator values
  ai_predictions      Pre-computed AI trade/no-trade predictions
  indicator_refinement Continuation/rejection indicator scores


11. SCHEMA MANAGEMENT
================================================================================

11.1 SCHEMA RUNNER (run_schema.py)
--------------------------------------------------------------------------------
  CLI utility to execute SQL schema files in order.

  Usage:
    python run_schema.py             Execute all schema files
    python run_schema.py --dry-run   Show SQL without executing

  Process:
    1. Find all .sql files in schema/ directory (sorted by filename)
    2. Execute each file sequentially with rollback on error
    3. Commit all changes atomically
    4. Verify: Check tables exist (trade_reviews, trade_images)
    5. Verify: Check views exist (unreviewed_trades, reviewed_trades)
    6. Verify: Check functions exist (get_calibration_stats,
       get_recent_calibration_stats, get_review_summary)


12. NAVIGATION AND FILTERS
================================================================================

12.1 SIDEBAR FILTERS (navigation.py:18)
--------------------------------------------------------------------------------
  render_sidebar_filters() returns a filter dict:

    date_from       date        Default: today - 30 days
    date_to         date        Default: today
    ticker          str|None    "All Tickers" = None, else specific ticker
    model           str|None    "All Models" = None, else EPCH1-4
    unreviewed_only bool        Only unreviewed trades
    ai_validated_only bool      Only trades with AI predictions

  Ticker options dynamically fetched from database based on date range.

12.2 QUEUE MANAGEMENT
--------------------------------------------------------------------------------
  - Load Trades: Fetches trades, shuffles randomly, initializes queue
  - Queue Progress: Metric + progress bar (reviewed/total)
  - Shuffle Button: Re-randomizes queue, resets to position 0
  - Jump to Trade: Number input to skip to specific position
  - Queue Completion: Shows "Session Complete" with Start Over / Load New

12.3 TRADE COUNTER (navigation.py:95)
--------------------------------------------------------------------------------
  Header showing "Trade N of M" with progress bar and trade info subheader
  (ticker, date, model, direction, zone type, trade_id).


13. STATS PANEL
================================================================================

13.1 MAIN METRICS (stats_panel.py:17)
--------------------------------------------------------------------------------
  Four-column metric display:

    P&L (R):     R-multiple with points delta, Winner/Loser badge
    MFE (R):     Maximum favorable excursion with bar count
    MAE (R):     Maximum adverse excursion with bar count
    Duration:    Trade duration in hours/minutes, "EOD 15:30" label

13.2 R-LEVELS ROW
--------------------------------------------------------------------------------
  Five-column display: Stop, Entry, 1R, 2R, 3R prices.
  Label: "R-Levels (Stop = M5 ATR 1.1x)"

13.3 R-LEVEL CROSSINGS ROW (v2.2.0)
--------------------------------------------------------------------------------
  Three-column display showing for each R-level crossed:
  - Time of crossing
  - Health score at crossing (X/10)
  - Health delta from entry (+/- change)

  Only displayed when at least one R-level was crossed.

13.4 FULL TRADE DETAILS (expandable)
--------------------------------------------------------------------------------
  Three sub-sections:
  - Trade Info: Model, zone type, direction, tier, rank
  - Entry/Exit: Prices, times, exit reason
  - Risk Metrics: Risk/share, stop price, outcome, win status
  - Health Metrics: Entry/MFE/MAE/Exit health scores
  - Zone Boundaries: High, POC, Low

13.5 EVENT INDICATORS TABLE (stats_panel.py:291)
--------------------------------------------------------------------------------
  HTML table with dynamic columns based on available events.

  Evaluate mode:  [ENTRY] column only
  Reveal mode:    [ENTRY] [1R] [2R] [3R] [MAE] [MFE] [EXIT] columns

  15 metric rows per event:
    Time, Price, R-Multiple, Points, Health, VWAP, SMA9, SMA21,
    SMA Spread, SMA Momentum, Vol ROC, M5/M15/H1/H4 Structure

  Color coding:
    Health:     Green >=8, Yellow >=6, Orange >=4, Red <4
    Structure:  Green if aligned with direction, Red if opposing
    Momentum:   Green WIDENING, Orange NARROWING


14. REVIEW WORKFLOW
================================================================================

14.1 REVIEW FORM LAYOUT
--------------------------------------------------------------------------------
  Five-column layout with categorized assessment flags:

    Accuracy:       accuracy, tape_confirmation
    Quality:        good_trade, signal_aligned, confirmation_required
    Stop Placement: prior_candle_stop, two_candle_stop, atr_stop, zone_edge_stop
    Context:        with_trend, counter_trend, stopped_by_wick
    Entry Attempt:  Selectbox (1st/2nd/3rd)

  Notes text area (80px height): "What did you learn from this trade?"

14.2 REVIEW PERSISTENCE
--------------------------------------------------------------------------------
  - Load: Existing review loaded into session state on trade display
  - Save: Upsert to trade_reviews (ON CONFLICT DO UPDATE)
  - Auto-save: Review saved automatically on "Next Trade" click
  - Outcome: Derived from canonical_winner (WIN/LOSS)

14.3 STATE RESET
--------------------------------------------------------------------------------
  On advancing to next trade:
  1. Save current review
  2. Increment current_trade_index
  3. Reset view_mode to 'pre_trade'
  4. Clear all review session state keys
  5. Trigger Streamlit rerun


15. CONFIGURATION SUMMARY
================================================================================

15.1 DATABASE CONNECTION (config.py:23)
--------------------------------------------------------------------------------
  Host:       db.pdbmcskznoaiybdiobje.supabase.co
  Port:       5432
  Database:   postgres
  User:       postgres
  SSL:        require

15.2 CHART THEME (config.py:52)
--------------------------------------------------------------------------------
  Background:       #1a1a2e
  Paper:            #1a1a2e
  Grid:             #2a2a4e
  Text:             #e0e0e0
  Text Muted:       #888888

15.3 ZONE RANK COLORS (config.py:98)
--------------------------------------------------------------------------------
  L5: #00C853 (Green, best)
  L4: #2196F3 (Blue)
  L3: #FFC107 (Yellow/Amber)
  L2: #9E9E9E (Gray)
  L1: #616161 (Dark gray)

15.4 INDICATOR REFINEMENT COLORS (config.py:115)
--------------------------------------------------------------------------------
  Continuation:     #4CAF50 (Green)
  Rejection:        #FF9800 (Orange)
  STRONG:           #00C853
  GOOD:             #8BC34A
  WEAK:             #FF9800
  AVOID:            #FF1744
  Aligned:          #00C853
  Divergent:        #FF1744
  Neutral:          #888888

15.5 TIME SETTINGS (config.py:152)
--------------------------------------------------------------------------------
  Display Timezone:   America/New_York (ET)
  Market Open Hour:   08:00 ET (pre-market)
  Market Close Hour:  20:00 ET (after-hours)


16. SYSTEM RELATIONSHIPS
================================================================================

16.1 DATA DEPENDENCIES
--------------------------------------------------------------------------------
  - trades table:         Created by 03_backtest module
  - optimal_trade table:  Created by 03_backtest module
  - zones table:          Created by 01_application zone pipeline
  - trades_m5_r_win:      Created by 03_backtest secondary processors
  - bar_data table:       Created by 01_application
  - hvn_pocs table:       Created by 01_application
  - market_structure:     Created by 01_application
  - setups table:         Created by 01_application zone pipeline
  - m1_indicator_bars:    Created by 03_backtest secondary processor
  - ai_predictions:       Created by 02_dow_ai module
  - indicator_refinement: Created by 03_backtest secondary processor

16.2 MODULE RELATIONSHIPS
--------------------------------------------------------------------------------
  - 01_application: Provides zones, setups, bar_data, hvn_pocs,
                    market_structure tables
  - 02_dow_ai:     Provides ai_predictions table
  - 03_backtest:   Provides trades, optimal_trade, trades_m5_r_win,
                    m1_indicator_bars, indicator_refinement tables
  - 05_system_analysis: Shares canonical win condition (trades_m5_r_win,
                        M5 ATR 1.1x) and health score framework

16.3 WIN CONDITION ALIGNMENT
--------------------------------------------------------------------------------
  Training module uses the same canonical outcome as System Analysis:
  - Source: trades_m5_r_win table
  - Stop: M5 ATR(14) x 1.1 close-based
  - Win: MFE >= 1R before stop hit
  - Loss: Stop hit before reaching 1R
  - Fallback: pnl_r > 0 from EOD exit if canonical not available


17. DEPENDENCIES
================================================================================

  Runtime:
    streamlit         >=1.28.0    Web application framework
    pandas            >=2.0.0     Data manipulation
    numpy             >=1.24.0    Numerical computation
    plotly            >=5.18.0    Interactive charting
    psycopg2-binary   >=2.9.9     PostgreSQL driver
    requests          >=2.31.0    HTTP client (Polygon API)
    pytz              >=2023.3    Timezone handling


18. FILE INVENTORY
================================================================================

18.1 ENTRY POINTS
--------------------------------------------------------------------------------
  app.py                           (53 lines)  CLI launcher
  streamlit_app.py                 (295 lines) Main Streamlit application

18.2 CONFIGURATION
--------------------------------------------------------------------------------
  config.py                        (158 lines) All settings
  requirements.txt                 (23 lines)  Dependencies

18.3 DATA MODELS
--------------------------------------------------------------------------------
  models/__init__.py               (5 lines)
  models/trade.py                  (752 lines) 6 dataclasses

18.4 DATA LAYER
--------------------------------------------------------------------------------
  data/__init__.py                 (7 lines)
  data/supabase_client.py          (832 lines) PostgreSQL client
  data/polygon_client.py           (259 lines) Polygon API client
  data/cache_manager.py            (253 lines) Bar data caching

18.5 UI COMPONENTS
--------------------------------------------------------------------------------
  components/__init__.py           (8 lines)
  components/flashcard_ui.py       (539 lines) Pre/post-trade state machine
  components/charts.py             (774 lines) Multi-timeframe chart builder
  components/stats_panel.py        (508 lines) Trade statistics display
  components/navigation.py         (218 lines) Sidebar filters/navigation
  components/bookmap_viewer.py     (76 lines)  Bookmap image display
  components/rampup_chart.py       (604 lines) M1 ramp-up chart
  components/indicator_refinement_tab.py (515 lines) Indicator scoring

18.6 DOW AI INTEGRATION
--------------------------------------------------------------------------------
  components/dow_ai/__init__.py    (20 lines)
  components/dow_ai/ui.py          (328 lines) Prompt display/copy UI
  components/dow_ai/data_fetcher.py (379 lines) Context data fetching
  components/dow_ai/prompt_generator.py (981 lines) Prompt templates
  components/dow_ai/prediction_display.py (170 lines) AI prediction UI

18.7 SCHEMA
--------------------------------------------------------------------------------
  run_schema.py                    (149 lines) Schema setup utility
  schema/01_trade_reviews.sql      (69 lines)  User review table
  schema/02_trade_images.sql       (43 lines)  Bookmap image table
  schema/03_views_and_functions.sql (367 lines) Views + 4 functions
  schema/05_migrate_trade_reviews.sql           Migration script
  schema/06_trade_analysis.sql     (41 lines)  AI analysis table

18.8 DOCUMENTATION
--------------------------------------------------------------------------------
  README.md                        (115 lines) User documentation
  CLAUDE.md                        (9 lines)   AI context

TOTAL: 24 Python files, 7,891 lines of Python code
       5 SQL schema files
       2 documentation files

================================================================================
END OF SPECIFICATIONS
================================================================================
