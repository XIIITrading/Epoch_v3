// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - Momentum Detector
// Version: 1.0
// Purpose: Identify efficient price movement where volume IS moving price (continuation signal)

//@version=5
indicator("[EPCH] Momentum", shorttitle="EPCH-04", overlay=true)

// ============================================================================
// COLOR SCHEME (Consistent Across Suite)
// ============================================================================
color_bull_strong = color.new(color.green, 0)
color_bear_strong = color.new(color.red, 0)
color_neutral     = color.new(color.gray, 50)
color_signal      = color.new(color.yellow, 0)

// Momentum-specific colors (bright, saturated)
color_momentum_bull = color.new(#00FF00, 0)  // Bright green
color_momentum_bear = color.new(#FF0000, 0)  // Bright red

// ============================================================================
// INPUT GROUP NAMES (Consistent Across Suite)
// ============================================================================
GRP_PARAMS = "Parameters"
GRP_THRESH = "Thresholds"
GRP_VISUAL = "Visual Settings"
GRP_ALERTS = "Alerts"

// ============================================================================
// INPUTS
// ============================================================================

// ATR Settings
atr_length = input.int(14, title="ATR Length", minval=5, maxval=50,
             group=GRP_PARAMS, tooltip="ATR calculation period")

atr_source = input.string("Auto", title="ATR Source", options=["Auto", "Manual"],
             group=GRP_PARAMS, tooltip="Auto calculates ATR, Manual uses fixed value")

manual_atr = input.float(0.50, title="Manual ATR", minval=0.01, maxval=100.0, step=0.01,
             group=GRP_PARAMS, tooltip="Manual ATR value (if Manual selected)")

// RVOL Settings
rvol_length = input.int(20, title="RVOL Length", minval=5, maxval=100,
              group=GRP_PARAMS, tooltip="RVOL lookback period")

// Threshold Settings
move_threshold = input.float(0.75, title="Move Threshold (ATR)", minval=0.3, maxval=2.0, step=0.05,
                 group=GRP_THRESH, tooltip="Minimum ATR multiplier for 'large move'")

rvol_threshold = input.float(1.5, title="RVOL Threshold", minval=1.1, maxval=3.0, step=0.1,
                 group=GRP_THRESH, tooltip="Minimum RVOL for momentum")

// Body vs Range
use_body = input.bool(true, title="Use Body (vs Range)", group=GRP_PARAMS,
           tooltip="Use candle body size (true) or full range (false)")

// Visual Settings
show_arrows = input.bool(false, title="Show Arrows", group=GRP_VISUAL,
              tooltip="Show momentum arrows in addition to candle color")

show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL,
             tooltip="Display info panel with current values")

// Alert Settings
alert_bull_momentum = input.bool(true, title="Alert Bullish Momentum", group=GRP_ALERTS,
                      tooltip="Alert on bullish momentum candles")

alert_bear_momentum = input.bool(true, title="Alert Bearish Momentum", group=GRP_ALERTS,
                      tooltip="Alert on bearish momentum candles")

// ============================================================================
// CALCULATIONS
// ============================================================================

// Step 1: ATR
atr_value = atr_source == "Auto" ? ta.atr(atr_length) : manual_atr

// Step 2: Price move size
move_size = use_body ? math.abs(close - open) : (high - low)

// Step 3: Move ratio (relative to ATR)
move_ratio = atr_value > 0 ? move_size / atr_value : 0

// Step 4: RVOL (inline calculation)
avg_volume = ta.sma(volume, rvol_length)
rvol = avg_volume > 0 ? volume / avg_volume : 0

// Step 5: Momentum detection
is_large_move = move_ratio >= move_threshold
is_high_volume = rvol >= rvol_threshold

is_momentum = is_large_move and is_high_volume

// Step 6: Direction
is_bull_momentum = is_momentum and close > open
is_bear_momentum = is_momentum and close < open

// Step 7: Momentum strength (for potential weighting)
momentum_strength = is_momentum ? (move_ratio * rvol) : 0

// Step 8: Consecutive momentum detection
var int bull_streak = 0
var int bear_streak = 0

if is_bull_momentum
    bull_streak += 1
    bear_streak := 0
else if is_bear_momentum
    bear_streak += 1
    bull_streak := 0
else
    bull_streak := 0
    bear_streak := 0

// ============================================================================
// OUTPUTS / PLOTS
// ============================================================================

// PRIMARY VISUAL: Candle coloring for momentum candles
barcolor(is_bull_momentum ? color_momentum_bull :
         is_bear_momentum ? color_momentum_bear : na,
         title="Momentum Candle Color")

// OPTIONAL: Arrows for additional clarity
plotshape(show_arrows and is_bull_momentum,
          title="Bullish Momentum Arrow",
          location=location.belowbar,
          style=shape.triangleup,
          color=color_momentum_bull,
          size=size.tiny)

plotshape(show_arrows and is_bear_momentum,
          title="Bearish Momentum Arrow",
          location=location.abovebar,
          style=shape.triangledown,
          color=color_momentum_bear,
          size=size.tiny)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(is_bull_momentum,
               title="Bullish Momentum",
               message="EPCH Momentum: Bullish momentum candle (high vol + large up move)")

alertcondition(is_bear_momentum,
               title="Bearish Momentum",
               message="EPCH Momentum: Bearish momentum candle (high vol + large down move)")

alertcondition(is_momentum,
               title="Any Momentum",
               message="EPCH Momentum: Momentum candle detected")

alertcondition(bull_streak >= 2,
               title="Bullish Momentum Streak",
               message="EPCH Momentum: Multiple consecutive bullish momentum candles")

alertcondition(bear_streak >= 2,
               title="Bearish Momentum Streak",
               message="EPCH Momentum: Multiple consecutive bearish momentum candles")

// ============================================================================
// DISPLAY PANEL (Info Box)
// ============================================================================
if show_panel
    var table panel = table.new(position.top_right, 2, 4,
                                bgcolor=color.new(color.black, 80),
                                border_width=1,
                                border_color=color.new(color.gray, 60))

    if barstate.islast
        // Row 0: Move ratio
        table.cell(panel, 0, 0, "Move", text_color=color.white, text_size=size.small)
        move_color = is_large_move ? color_signal : color_neutral
        table.cell(panel, 1, 0, str.tostring(move_ratio, "#.##") + " ATR",
                   text_color=move_color, text_size=size.small)

        // Row 1: RVOL
        table.cell(panel, 0, 1, "RVOL", text_color=color.white, text_size=size.small)
        rvol_color = is_high_volume ? color_signal : color_neutral
        table.cell(panel, 1, 1, str.tostring(rvol, "#.##") + "x",
                   text_color=rvol_color, text_size=size.small)

        // Row 2: ATR
        table.cell(panel, 0, 2, "ATR", text_color=color.white, text_size=size.small)
        table.cell(panel, 1, 2, str.tostring(atr_value, "#.####"),
                   text_color=color.white, text_size=size.small)

        // Row 3: Signal
        table.cell(panel, 0, 3, "Signal", text_color=color.white, text_size=size.small)
        signal_text = is_bull_momentum ? "▲ BULL MOM" :
                      is_bear_momentum ? "▼ BEAR MOM" : "—"
        signal_color = is_momentum ? color_signal : color_neutral
        table.cell(panel, 1, 3, signal_text, text_color=signal_color, text_size=size.small)

// ============================================================================
// EXPORT VALUES (for other indicators to reference)
// ============================================================================
plot(is_momentum ? 1 : 0, title="Momentum_Flag", display=display.none)
plot(is_bull_momentum ? 1 : 0, title="BullMomentum_Flag", display=display.none)
plot(is_bear_momentum ? 1 : 0, title="BearMomentum_Flag", display=display.none)
plot(momentum_strength, title="Momentum_Strength", display=display.none)

// ============================================================================
// END OF SCRIPT
// ============================================================================
