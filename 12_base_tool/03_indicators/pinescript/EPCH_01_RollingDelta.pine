// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - Rolling Delta
// Version: 1.0
// Purpose: Replace session-anchored CVD with rolling window delta for directional bias

//@version=5
indicator("[EPCH] Rolling Delta", shorttitle="EPCH-01", overlay=false)

// ============================================================================
// COLOR SCHEME (Consistent Across Suite)
// ============================================================================
color_bull_strong = color.new(color.green, 0)
color_bull_medium = color.new(color.green, 30)
color_bull_weak   = color.new(color.green, 60)
color_bear_strong = color.new(color.red, 0)
color_bear_medium = color.new(color.red, 30)
color_bear_weak   = color.new(color.red, 60)
color_neutral     = color.new(color.gray, 50)
color_signal      = color.new(color.yellow, 0)

// ============================================================================
// INPUT GROUP NAMES (Consistent Across Suite)
// ============================================================================
GRP_PARAMS = "Parameters"
GRP_VISUAL = "Visual Settings"
GRP_ALERTS = "Alerts"

// ============================================================================
// INPUTS
// ============================================================================
fast_length = input.int(10, title="Fast Length", minval=3, maxval=50,
              group=GRP_PARAMS, tooltip="Fast rolling window for entry timing")
slow_length = input.int(30, title="Slow Length", minval=10, maxval=100,
              group=GRP_PARAMS, tooltip="Slow rolling window for directional bias")

show_fast    = input.bool(true, title="Show Fast Delta", group=GRP_VISUAL,
               tooltip="Display fast delta histogram")
show_slow    = input.bool(true, title="Show Slow Delta", group=GRP_VISUAL,
               tooltip="Display slow delta line")
show_fill    = input.bool(true, title="Show Fill", group=GRP_VISUAL,
               tooltip="Fill between fast histogram and zero")
show_bias_bg = input.bool(false, title="Show Bias Background", group=GRP_VISUAL,
               tooltip="Background color based on slow delta")
show_panel   = input.bool(true, title="Show Info Panel", group=GRP_VISUAL,
               tooltip="Display info panel with current values")

alert_cross = input.bool(true, title="Alert on Zero Cross", group=GRP_ALERTS,
              tooltip="Alert on fast delta zero cross")

// ============================================================================
// CALCULATIONS
// ============================================================================

// Step 1: Calculate candle delta
// Bullish candle = positive delta, Bearish candle = negative delta, Doji = neutral
candle_delta = close > open ? volume : close < open ? -volume : 0.0

// Step 2: Rolling sums
fast_delta = math.sum(candle_delta, fast_length)
slow_delta = math.sum(candle_delta, slow_length)

// Step 3: Zero cross detection
fast_cross_up   = ta.crossover(fast_delta, 0)
fast_cross_down = ta.crossunder(fast_delta, 0)

// Step 4: Bias determination
bias = slow_delta > 0 ? 1 : slow_delta < 0 ? -1 : 0

// ============================================================================
// OUTPUTS / PLOTS
// ============================================================================

// Zero line
hline(0, "Zero", color=color_neutral, linestyle=hline.style_dashed)

// Primary: Fast delta as histogram
fast_color = fast_delta >= 0 ? color_bull_medium : color_bear_medium
plot(show_fast ? fast_delta : na,
     title="Fast Delta",
     style=plot.style_histogram,
     color=fast_color,
     linewidth=2)

// Fill between histogram and zero (visual enhancement)
zero_line = plot(show_fill ? 0 : na, title="Zero for Fill", color=color.new(color.white, 100), display=display.none)
fast_plot = plot(show_fill and show_fast ? fast_delta : na, title="Fast for Fill", color=color.new(color.white, 100), display=display.none)
fill(zero_line, fast_plot, color=fast_delta >= 0 ? color.new(color.green, 85) : color.new(color.red, 85), title="Delta Fill")

// Secondary: Slow delta as line
slow_color = slow_delta >= 0 ? color_bull_strong : color_bear_strong
plot(show_slow ? slow_delta : na,
     title="Slow Delta",
     style=plot.style_line,
     color=slow_color,
     linewidth=2)

// Background bias shading (optional)
bgcolor(show_bias_bg ? (slow_delta > 0 ? color_bull_weak : slow_delta < 0 ? color_bear_weak : na) : na,
        title="Bias Background")

// Cross markers
plotshape(fast_cross_up, title="Cross Up", location=location.bottom,
          style=shape.triangleup, color=color_bull_strong, size=size.tiny)
plotshape(fast_cross_down, title="Cross Down", location=location.top,
          style=shape.triangledown, color=color_bear_strong, size=size.tiny)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(fast_cross_up,
               title="Fast Delta Cross Up",
               message="EPCH Rolling Delta: Fast crossed above zero (bullish)")

alertcondition(fast_cross_down,
               title="Fast Delta Cross Down",
               message="EPCH Rolling Delta: Fast crossed below zero (bearish)")

alertcondition(fast_cross_up or fast_cross_down,
               title="Fast Delta Zero Cross",
               message="EPCH Rolling Delta: Fast delta crossed zero line")

// ============================================================================
// DISPLAY PANEL (Info Box)
// ============================================================================
if show_panel
    var table panel = table.new(position.top_right, 2, 3,
                                bgcolor=color.new(color.black, 80),
                                border_width=1,
                                border_color=color.new(color.gray, 60))

    if barstate.islast
        // Row 0: Fast Delta
        table.cell(panel, 0, 0, "Fast Δ", text_color=color.white, text_size=size.small)
        table.cell(panel, 1, 0, str.tostring(fast_delta, format.volume),
                   text_color=fast_delta >= 0 ? color_bull_strong : color_bear_strong,
                   text_size=size.small)

        // Row 1: Slow Delta
        table.cell(panel, 0, 1, "Slow Δ", text_color=color.white, text_size=size.small)
        table.cell(panel, 1, 1, str.tostring(slow_delta, format.volume),
                   text_color=slow_delta >= 0 ? color_bull_strong : color_bear_strong,
                   text_size=size.small)

        // Row 2: Bias
        table.cell(panel, 0, 2, "Bias", text_color=color.white, text_size=size.small)
        bias_text = bias > 0 ? "BULL" : bias < 0 ? "BEAR" : "NEUTRAL"
        bias_color = bias > 0 ? color_bull_strong : bias < 0 ? color_bear_strong : color_neutral
        table.cell(panel, 1, 2, bias_text, text_color=bias_color, text_size=size.small)

// ============================================================================
// END OF SCRIPT
// ============================================================================
