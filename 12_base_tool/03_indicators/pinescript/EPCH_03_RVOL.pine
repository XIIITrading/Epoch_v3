// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - Relative Volume (RVOL)
// Version: 1.0
// Purpose: Filter for significant volume candles - identifies institutional-level participation

//@version=5
indicator("[EPCH] RVOL", shorttitle="EPCH-03", overlay=false)

// ============================================================================
// COLOR SCHEME (Consistent Across Suite)
// ============================================================================
color_bull_strong = color.new(color.green, 0)
color_bear_strong = color.new(color.red, 0)
color_neutral     = color.new(color.gray, 50)
color_signal      = color.new(color.yellow, 0)

// RVOL-specific colors
color_elevated     = color.new(color.yellow, 30)
color_significant  = color.new(color.orange, 0)
color_institutional = color.new(color.purple, 0)

// ============================================================================
// INPUT GROUP NAMES (Consistent Across Suite)
// ============================================================================
GRP_PARAMS = "Parameters"
GRP_THRESH = "Thresholds"
GRP_VISUAL = "Visual Settings"
GRP_ALERTS = "Alerts"

// ============================================================================
// INPUTS
// ============================================================================

// Parameters
avg_length = input.int(20, title="Average Length", minval=5, maxval=100,
             group=GRP_PARAMS, tooltip="Lookback period for average volume calculation")

// Thresholds
threshold_1 = input.float(1.5, title="Elevated Threshold", minval=1.1, maxval=3.0, step=0.1,
              group=GRP_THRESH, tooltip="RVOL threshold for elevated volume")

threshold_2 = input.float(2.5, title="Significant Threshold", minval=1.5, maxval=5.0, step=0.1,
              group=GRP_THRESH, tooltip="RVOL threshold for significant volume")

threshold_3 = input.float(4.0, title="Institutional Threshold", minval=2.5, maxval=10.0, step=0.5,
              group=GRP_THRESH, tooltip="RVOL threshold for institutional volume")

// Visual Settings
show_rvol_pane = input.bool(true, title="Show RVOL Columns", group=GRP_VISUAL,
                 tooltip="Show RVOL as columns in the pane")

show_avg_line = input.bool(true, title="Show Average Line", group=GRP_VISUAL,
                tooltip="Show the 1.0x average reference line")

highlight_bg = input.bool(true, title="Highlight Background", group=GRP_VISUAL,
               tooltip="Background color for notable volume")

show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL,
             tooltip="Display info panel with current values")

// Alert Settings
alert_elevated = input.bool(false, title="Alert Elevated", group=GRP_ALERTS,
                 tooltip="Alert on elevated volume (may be noisy)")

alert_significant = input.bool(true, title="Alert Significant", group=GRP_ALERTS,
                    tooltip="Alert on significant volume")

alert_institutional = input.bool(true, title="Alert Institutional", group=GRP_ALERTS,
                      tooltip="Alert on institutional volume")

// ============================================================================
// CALCULATIONS
// ============================================================================

// Step 1: Calculate average volume
avg_volume = ta.sma(volume, avg_length)

// Step 2: Calculate RVOL (handle division by zero)
rvol = avg_volume > 0 ? volume / avg_volume : 0

// Step 3: Threshold classifications
is_elevated = rvol >= threshold_1 and rvol < threshold_2
is_significant = rvol >= threshold_2 and rvol < threshold_3
is_institutional = rvol >= threshold_3

// Step 4: Combined flag for any notable volume
is_notable = rvol >= threshold_1

// Step 5: Determine candle direction for context
is_bullish = close > open
is_bearish = close < open

// Step 6: New threshold breach detection (for alerts)
new_elevated = is_elevated and not (rvol[1] >= threshold_1 and rvol[1] < threshold_2)
new_significant = is_significant and not (rvol[1] >= threshold_2 and rvol[1] < threshold_3)
new_institutional = is_institutional and not (rvol[1] >= threshold_3)

// ============================================================================
// OUTPUTS / PLOTS
// ============================================================================

// RVOL column color based on threshold level
rvol_color = is_institutional ? color_institutional :
             is_significant ? color_significant :
             is_elevated ? color_elevated :
             color_neutral

// Direction-aware coloring option (shows bull/bear within volume level)
rvol_color_directional = is_institutional ? color_institutional :
                         is_significant ? color_significant :
                         is_elevated ? color_elevated :
                         is_bullish ? color.new(color.green, 60) :
                         is_bearish ? color.new(color.red, 60) :
                         color_neutral

// RVOL columns
plot(show_rvol_pane ? rvol : na,
     title="RVOL",
     style=plot.style_columns,
     color=rvol_color)

// Threshold lines
hline(threshold_1, "Elevated", color=color.new(color.yellow, 50), linestyle=hline.style_dotted)
hline(threshold_2, "Significant", color=color.new(color.orange, 50), linestyle=hline.style_dotted)
hline(threshold_3, "Institutional", color=color.new(color.purple, 50), linestyle=hline.style_dotted)
hline(1.0, "Average", color=color_neutral, linestyle=hline.style_dashed)

// Background highlighting
bgcolor(highlight_bg ?
        (is_institutional ? color.new(color.purple, 85) :
         is_significant ? color.new(color.orange, 85) :
         is_elevated ? color.new(color.yellow, 90) : na) : na,
        title="Volume Highlight")

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(new_elevated,
               title="Elevated Volume",
               message="EPCH RVOL: Elevated volume detected (>" + str.tostring(threshold_1) + "x)")

alertcondition(new_significant,
               title="Significant Volume",
               message="EPCH RVOL: Significant volume detected (>" + str.tostring(threshold_2) + "x)")

alertcondition(new_institutional,
               title="Institutional Volume",
               message="EPCH RVOL: Institutional volume detected (>" + str.tostring(threshold_3) + "x)")

alertcondition(is_notable,
               title="Notable Volume (Any)",
               message="EPCH RVOL: Notable volume on current bar")

// ============================================================================
// DISPLAY PANEL (Info Box)
// ============================================================================
if show_panel
    var table panel = table.new(position.top_right, 2, 3,
                                bgcolor=color.new(color.black, 80),
                                border_width=1,
                                border_color=color.new(color.gray, 60))

    if barstate.islast
        // Row 0: RVOL value
        table.cell(panel, 0, 0, "RVOL", text_color=color.white, text_size=size.small)
        table.cell(panel, 1, 0, str.tostring(rvol, "#.##") + "x",
                   text_color=rvol_color, text_size=size.small)

        // Row 1: Raw Volume
        table.cell(panel, 0, 1, "Volume", text_color=color.white, text_size=size.small)
        table.cell(panel, 1, 1, str.tostring(volume, format.volume),
                   text_color=color.white, text_size=size.small)

        // Row 2: Level classification
        table.cell(panel, 0, 2, "Level", text_color=color.white, text_size=size.small)
        level_text = is_institutional ? "INSTITUTIONAL" :
                     is_significant ? "SIGNIFICANT" :
                     is_elevated ? "ELEVATED" : "NORMAL"
        table.cell(panel, 1, 2, level_text, text_color=rvol_color, text_size=size.small)

// ============================================================================
// EXPORT VALUES (for other indicators to reference)
// ============================================================================
plot(rvol, title="RVOL_Export", display=display.none)
plot(is_notable ? 1 : 0, title="Notable_Flag", display=display.none)
plot(is_elevated ? 1 : is_significant ? 2 : is_institutional ? 3 : 0,
     title="Level_Export", display=display.none)

// ============================================================================
// END OF SCRIPT
// ============================================================================
