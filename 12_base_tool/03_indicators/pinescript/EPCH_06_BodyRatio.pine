// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - Body Ratio
// Version: 1.0
// Purpose: Simple candle conviction measurement - body vs wick analysis

//@version=5
indicator("[EPCH] Body Ratio", shorttitle="EPCH-06", overlay=false)

// ============================================================================
// COLOR SCHEME (Consistent Across Suite)
// ============================================================================
color_bull_strong = color.new(color.green, 0)
color_bull_weak   = color.new(color.green, 60)
color_bear_strong = color.new(color.red, 0)
color_bear_weak   = color.new(color.red, 60)
color_neutral     = color.new(color.gray, 50)
color_signal      = color.new(color.yellow, 0)
color_indecision  = color.new(color.orange, 20)

// ============================================================================
// INPUT GROUP NAMES (Consistent Across Suite)
// ============================================================================
GRP_PARAMS = "Parameters"
GRP_THRESH = "Thresholds"
GRP_VISUAL = "Visual Settings"
GRP_ALERTS = "Alerts"

// ============================================================================
// INPUTS
// ============================================================================

// Threshold Settings
strong_threshold = input.float(0.70, title="Strong Conviction Threshold", minval=0.5, maxval=0.9, step=0.05,
                   group=GRP_THRESH, tooltip="Body ratio for 'strong conviction' candles")

weak_threshold = input.float(0.30, title="Indecision Threshold", minval=0.1, maxval=0.5, step=0.05,
                 group=GRP_THRESH, tooltip="Body ratio for 'indecision' candles")

doji_threshold = input.float(0.05, title="Doji Threshold", minval=0.01, maxval=0.15, step=0.01,
                 group=GRP_THRESH, tooltip="Body ratio for doji detection")

// Visual Settings
show_histogram = input.bool(true, title="Show Histogram", group=GRP_VISUAL,
                 tooltip="Show body ratio as histogram")

show_markers = input.bool(true, title="Show Markers", group=GRP_VISUAL,
               tooltip="Show markers for strong/weak candles")

color_candles = input.bool(false, title="Color Candles", group=GRP_VISUAL,
                tooltip="Color candles by conviction level")

show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL,
             tooltip="Display info panel with current values")

// Alert Settings
alert_strong = input.bool(false, title="Alert Strong Conviction", group=GRP_ALERTS,
               tooltip="Alert on strong conviction candles")

alert_weak = input.bool(true, title="Alert Indecision", group=GRP_ALERTS,
             tooltip="Alert on indecision candles")

alert_doji = input.bool(true, title="Alert Doji", group=GRP_ALERTS,
             tooltip="Alert on doji candles")

// ============================================================================
// CALCULATIONS
// ============================================================================

// Step 1: Calculate components
body = math.abs(close - open)
range_size = high - low

// Step 2: Body ratio (handle zero range)
body_ratio = range_size > 0 ? body / range_size : 0.5

// Step 3: Classification
is_strong = body_ratio >= strong_threshold
is_weak = body_ratio <= weak_threshold
is_normal = not is_strong and not is_weak
is_doji = body_ratio <= doji_threshold

// Step 4: Direction with conviction
is_bullish = close > open
is_bearish = close < open

is_strong_bull = is_strong and is_bullish
is_strong_bear = is_strong and is_bearish
is_weak_bull = is_weak and is_bullish and not is_doji  // Hammer-like
is_weak_bear = is_weak and is_bearish and not is_doji  // Shooting star-like

// Step 5: Wick analysis
upper_wick = high - math.max(open, close)
lower_wick = math.min(open, close) - low

upper_wick_ratio = range_size > 0 ? upper_wick / range_size : 0
lower_wick_ratio = range_size > 0 ? lower_wick / range_size : 0

// Step 6: Pattern detection
is_hammer = is_weak and lower_wick_ratio > 0.6 and upper_wick_ratio < 0.1
is_shooting_star = is_weak and upper_wick_ratio > 0.6 and lower_wick_ratio < 0.1
is_spinning_top = is_weak and not is_hammer and not is_shooting_star and not is_doji

// ============================================================================
// OUTPUTS / PLOTS
// ============================================================================

// Histogram color based on conviction and direction
ratio_color = is_doji ? color_signal :
              is_strong_bull ? color_bull_strong :
              is_strong_bear ? color_bear_strong :
              is_weak ? color_indecision :
              is_bullish ? color_bull_weak :
              is_bearish ? color_bear_weak :
              color_neutral

// Body ratio histogram
plot(show_histogram ? body_ratio : na,
     title="Body Ratio",
     style=plot.style_columns,
     color=ratio_color)

// Threshold lines
hline(strong_threshold, "Strong", color=color.new(color.green, 50), linestyle=hline.style_dotted)
hline(weak_threshold, "Weak", color=color.new(color.orange, 50), linestyle=hline.style_dotted)
hline(0.5, "Neutral", color=color_neutral, linestyle=hline.style_dashed)
hline(doji_threshold, "Doji", color=color.new(color.yellow, 50), linestyle=hline.style_dotted)

// Markers for strong/weak candles
plotshape(show_markers and is_strong_bull,
          title="Strong Bull",
          location=location.bottom,
          style=shape.arrowup,
          color=color_bull_strong,
          size=size.tiny)

plotshape(show_markers and is_strong_bear,
          title="Strong Bear",
          location=location.top,
          style=shape.arrowdown,
          color=color_bear_strong,
          size=size.tiny)

plotshape(show_markers and is_doji,
          title="Doji",
          location=location.top,
          style=shape.xcross,
          color=color_signal,
          size=size.tiny)

plotshape(show_markers and is_hammer,
          title="Hammer",
          location=location.bottom,
          style=shape.diamond,
          color=color_bull_strong,
          size=size.tiny)

plotshape(show_markers and is_shooting_star,
          title="Shooting Star",
          location=location.top,
          style=shape.diamond,
          color=color_bear_strong,
          size=size.tiny)

// Candle coloring (optional, off by default to not conflict with other indicators)
barcolor(color_candles ? ratio_color : na,
         title="Conviction Color")

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(is_strong_bull,
               title="Strong Bullish Candle",
               message="EPCH Body Ratio: Strong bullish conviction candle")

alertcondition(is_strong_bear,
               title="Strong Bearish Candle",
               message="EPCH Body Ratio: Strong bearish conviction candle")

alertcondition(is_weak,
               title="Indecision Candle",
               message="EPCH Body Ratio: Low conviction/indecision candle (potential reversal)")

alertcondition(is_doji,
               title="Doji Candle",
               message="EPCH Body Ratio: Doji detected (strong indecision)")

alertcondition(is_hammer,
               title="Hammer Pattern",
               message="EPCH Body Ratio: Hammer pattern detected (bullish reversal)")

alertcondition(is_shooting_star,
               title="Shooting Star Pattern",
               message="EPCH Body Ratio: Shooting Star pattern detected (bearish reversal)")

// ============================================================================
// DISPLAY PANEL (Info Box)
// ============================================================================
if show_panel
    var table panel = table.new(position.top_right, 2, 4,
                                bgcolor=color.new(color.black, 80),
                                border_width=1,
                                border_color=color.new(color.gray, 60))

    if barstate.islast
        // Row 0: Body %
        table.cell(panel, 0, 0, "Body%", text_color=color.white, text_size=size.small)
        table.cell(panel, 1, 0, str.tostring(body_ratio * 100, "#") + "%",
                   text_color=ratio_color, text_size=size.small)

        // Row 1: Type
        table.cell(panel, 0, 1, "Type", text_color=color.white, text_size=size.small)
        type_text = is_doji ? "DOJI" :
                    is_hammer ? "HAMMER" :
                    is_shooting_star ? "SHOOT STAR" :
                    is_strong_bull ? "STRONG ▲" :
                    is_strong_bear ? "STRONG ▼" :
                    is_spinning_top ? "SPIN TOP" :
                    is_weak ? "WEAK" : "NORMAL"
        table.cell(panel, 1, 1, type_text, text_color=ratio_color, text_size=size.small)

        // Row 2: Wicks
        table.cell(panel, 0, 2, "Wicks", text_color=color.white, text_size=size.small)
        wick_text = "U:" + str.tostring(upper_wick_ratio * 100, "#") + "% L:" + str.tostring(lower_wick_ratio * 100, "#") + "%"
        table.cell(panel, 1, 2, wick_text, text_color=color.white, text_size=size.small)

        // Row 3: Signal
        table.cell(panel, 0, 3, "Signal", text_color=color.white, text_size=size.small)
        signal_text = is_strong ? "CONVICTION" :
                      is_doji ? "DOJI" :
                      is_hammer ? "REVERSAL ▲" :
                      is_shooting_star ? "REVERSAL ▼" :
                      is_weak ? "INDECISION" : "—"
        signal_color = is_strong or is_weak or is_doji ? color_signal : color_neutral
        table.cell(panel, 1, 3, signal_text, text_color=signal_color, text_size=size.small)

// ============================================================================
// EXPORT VALUES (for other indicators to reference)
// ============================================================================
plot(body_ratio, title="BodyRatio_Export", display=display.none)
plot(is_strong ? 1 : 0, title="Strong_Flag", display=display.none)
plot(is_weak ? 1 : 0, title="Weak_Flag", display=display.none)
plot(is_doji ? 1 : 0, title="Doji_Flag", display=display.none)
plot(is_hammer ? 1 : is_shooting_star ? -1 : 0, title="Pattern_Flag", display=display.none)

// ============================================================================
// END OF SCRIPT
// ============================================================================
