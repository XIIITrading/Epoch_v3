// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - Delta ROC (Rate of Change)
// Version: 1.0
// Purpose: Detect acceleration/deceleration in buying/selling pressure for early reversal signals

//@version=5
indicator("[EPCH] Delta ROC", shorttitle="EPCH-02", overlay=false)

// ============================================================================
// COLOR SCHEME (Consistent Across Suite)
// ============================================================================
color_bull_strong = color.new(color.green, 0)
color_bull_weak   = color.new(color.green, 60)
color_bear_strong = color.new(color.red, 0)
color_bear_weak   = color.new(color.red, 60)
color_neutral     = color.new(color.gray, 50)
color_signal      = color.new(color.yellow, 0)

// ============================================================================
// INPUT GROUP NAMES (Consistent Across Suite)
// ============================================================================
GRP_PARAMS = "Parameters"
GRP_THRESH = "Thresholds"
GRP_VISUAL = "Visual Settings"
GRP_ALERTS = "Alerts"

// ============================================================================
// INPUTS
// ============================================================================
delta_length = input.int(10, title="Delta Length", minval=3, maxval=50,
               group=GRP_PARAMS, tooltip="Rolling delta window (source for ROC)")

roc_method = input.string("Simple", title="ROC Method", options=["Simple", "Smoothed"],
             group=GRP_PARAMS, tooltip="Simple: direct difference. Smoothed: SMA crossover")

roc_lookback = input.int(5, title="ROC Lookback", minval=2, maxval=20,
               group=GRP_PARAMS, tooltip="Bars back for simple ROC calculation")

smooth_fast = input.int(5, title="Smooth Fast", minval=2, maxval=15,
              group=GRP_PARAMS, tooltip="Fast SMA period for smoothed method")

smooth_slow = input.int(15, title="Smooth Slow", minval=5, maxval=30,
              group=GRP_PARAMS, tooltip="Slow SMA period for smoothed method")

signal_smooth = input.int(3, title="Signal Smoothing", minval=2, maxval=10,
                group=GRP_VISUAL, tooltip="Signal line smoothing period")

div_lookback = input.int(5, title="Divergence Lookback", minval=3, maxval=15,
               group=GRP_THRESH, tooltip="Bars to look back for divergence detection")

show_histogram = input.bool(true, title="Show Histogram", group=GRP_VISUAL,
                 tooltip="Show ROC as histogram")

show_signal_line = input.bool(true, title="Show Signal Line", group=GRP_VISUAL,
                   tooltip="Show smoothed signal line")

show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL,
             tooltip="Display info panel with current values")

alert_cross = input.bool(true, title="Alert on Zero Cross", group=GRP_ALERTS,
              tooltip="Alert on ROC zero cross")

alert_divergence = input.bool(true, title="Alert on Divergence", group=GRP_ALERTS,
                   tooltip="Alert on price/ROC divergence")

// ============================================================================
// CALCULATIONS
// ============================================================================

// Step 1: Calculate rolling delta (same as Indicator 1)
candle_delta = close > open ? volume : close < open ? -volume : 0.0
rolling_delta = math.sum(candle_delta, delta_length)

// Step 2: Calculate ROC based on method
delta_roc = switch roc_method
    "Simple" => rolling_delta - rolling_delta[roc_lookback]
    "Smoothed" => ta.sma(rolling_delta, smooth_fast) - ta.sma(rolling_delta, smooth_slow)
    => rolling_delta - rolling_delta[roc_lookback]  // Default fallback

// Step 3: Signal line (smoothed ROC)
signal_line = ta.sma(delta_roc, signal_smooth)

// Step 4: Zero cross detection
roc_cross_up = ta.crossover(delta_roc, 0)
roc_cross_down = ta.crossunder(delta_roc, 0)

// Step 5: Divergence detection
// Bullish divergence: price makes lower low, ROC makes higher low
price_lowest = ta.lowest(low, div_lookback)
price_lowest_prev = ta.lowest(low, div_lookback)[div_lookback]
price_lower_low = price_lowest < price_lowest_prev

roc_lowest = ta.lowest(delta_roc, div_lookback)
roc_lowest_prev = ta.lowest(delta_roc, div_lookback)[div_lookback]
roc_higher_low = roc_lowest > roc_lowest_prev

bull_divergence = price_lower_low and roc_higher_low and delta_roc < 0

// Bearish divergence: price makes higher high, ROC makes lower high
price_highest = ta.highest(high, div_lookback)
price_highest_prev = ta.highest(high, div_lookback)[div_lookback]
price_higher_high = price_highest > price_highest_prev

roc_highest = ta.highest(delta_roc, div_lookback)
roc_highest_prev = ta.highest(delta_roc, div_lookback)[div_lookback]
roc_lower_high = roc_highest < roc_highest_prev

bear_divergence = price_higher_high and roc_lower_high and delta_roc > 0

// Step 6: ROC trend direction
roc_rising = delta_roc > delta_roc[1]
roc_falling = delta_roc < delta_roc[1]

// ============================================================================
// OUTPUTS / PLOTS
// ============================================================================

// Zero line
hline(0, "Zero", color=color_neutral, linestyle=hline.style_solid)

// ROC histogram with intensity coloring
roc_color = delta_roc >= 0 ?
            (roc_rising ? color_bull_strong : color_bull_weak) :
            (roc_falling ? color_bear_strong : color_bear_weak)

plot(show_histogram ? delta_roc : na,
     title="Delta ROC",
     style=plot.style_histogram,
     color=roc_color,
     linewidth=2)

// Signal line
plot(show_signal_line ? signal_line : na,
     title="Signal Line",
     style=plot.style_line,
     color=color.new(color.white, 30),
     linewidth=1)

// Cross markers
plotshape(roc_cross_up, title="ROC Cross Up", location=location.bottom,
          style=shape.circle, color=color_bull_strong, size=size.tiny)
plotshape(roc_cross_down, title="ROC Cross Down", location=location.top,
          style=shape.circle, color=color_bear_strong, size=size.tiny)

// Divergence markers
plotshape(bull_divergence, title="Bull Divergence", location=location.bottom,
          style=shape.diamond, color=color_signal, size=size.small)
plotshape(bear_divergence, title="Bear Divergence", location=location.top,
          style=shape.diamond, color=color_signal, size=size.small)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(roc_cross_up,
               title="Delta ROC Cross Up",
               message="EPCH Delta ROC: Buying pressure accelerating")

alertcondition(roc_cross_down,
               title="Delta ROC Cross Down",
               message="EPCH Delta ROC: Selling pressure accelerating")

alertcondition(bull_divergence,
               title="Bullish Divergence",
               message="EPCH Delta ROC: Bullish divergence detected (reversal warning)")

alertcondition(bear_divergence,
               title="Bearish Divergence",
               message="EPCH Delta ROC: Bearish divergence detected (reversal warning)")

alertcondition(roc_cross_up or roc_cross_down,
               title="Delta ROC Zero Cross",
               message="EPCH Delta ROC: Zero line crossed")

// ============================================================================
// DISPLAY PANEL (Info Box)
// ============================================================================
if show_panel
    var table panel = table.new(position.top_right, 2, 3,
                                bgcolor=color.new(color.black, 80),
                                border_width=1,
                                border_color=color.new(color.gray, 60))

    if barstate.islast
        // Row 0: ROC Value
        table.cell(panel, 0, 0, "ROC", text_color=color.white, text_size=size.small)
        table.cell(panel, 1, 0, str.tostring(delta_roc, format.volume),
                   text_color=delta_roc >= 0 ? color_bull_strong : color_bear_strong,
                   text_size=size.small)

        // Row 1: Trend
        table.cell(panel, 0, 1, "Trend", text_color=color.white, text_size=size.small)
        roc_trend = roc_rising ? "▲ Rising" : roc_falling ? "▼ Falling" : "— Flat"
        trend_color = roc_rising ? color_bull_strong : roc_falling ? color_bear_strong : color_neutral
        table.cell(panel, 1, 1, roc_trend, text_color=trend_color, text_size=size.small)

        // Row 2: Signal
        table.cell(panel, 0, 2, "Signal", text_color=color.white, text_size=size.small)
        signal_text = bull_divergence ? "BULL DIV" :
                      bear_divergence ? "BEAR DIV" :
                      roc_cross_up ? "CROSS UP" :
                      roc_cross_down ? "CROSS DN" : "—"
        signal_color = (bull_divergence or bear_divergence or roc_cross_up or roc_cross_down) ? color_signal : color_neutral
        table.cell(panel, 1, 2, signal_text, text_color=signal_color, text_size=size.small)

// ============================================================================
// END OF SCRIPT
// ============================================================================
