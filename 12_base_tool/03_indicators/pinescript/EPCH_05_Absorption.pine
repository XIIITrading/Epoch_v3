// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - Absorption Detector
// Version: 1.0
// Purpose: Identify inefficient price movement where volume is NOT moving price (reversal signal)

//@version=5
indicator("[EPCH] Absorption", shorttitle="EPCH-05", overlay=true)

// ============================================================================
// COLOR SCHEME (Consistent Across Suite)
// ============================================================================
color_bull_strong = color.new(color.green, 0)
color_bear_strong = color.new(color.red, 0)
color_neutral     = color.new(color.gray, 50)
color_signal      = color.new(color.yellow, 0)

// Absorption-specific colors
color_absorption_bull    = color.new(#FFD700, 0)  // Gold (buying absorption at lows)
color_absorption_bear    = color.new(#FF8C00, 0)  // Dark orange (selling absorption at highs)
color_absorption_neutral = color.new(#FFA500, 0)  // Orange (absorption, location unclear)

// ============================================================================
// INPUT GROUP NAMES (Consistent Across Suite)
// ============================================================================
GRP_PARAMS = "Parameters"
GRP_THRESH = "Thresholds"
GRP_VISUAL = "Visual Settings"
GRP_ALERTS = "Alerts"

// ============================================================================
// INPUTS
// ============================================================================

// ATR Settings
atr_length = input.int(14, title="ATR Length", minval=5, maxval=50,
             group=GRP_PARAMS, tooltip="ATR calculation period")

atr_source = input.string("Auto", title="ATR Source", options=["Auto", "Manual"],
             group=GRP_PARAMS, tooltip="Auto calculates ATR, Manual uses fixed value")

manual_atr = input.float(0.50, title="Manual ATR", minval=0.01, maxval=100.0, step=0.01,
             group=GRP_PARAMS, tooltip="Manual ATR value (if Manual selected)")

// RVOL Settings
rvol_length = input.int(20, title="RVOL Length", minval=5, maxval=100,
              group=GRP_PARAMS, tooltip="RVOL lookback period")

// Threshold Settings
move_threshold = input.float(0.30, title="Move Threshold (ATR)", minval=0.1, maxval=0.5, step=0.05,
                 group=GRP_THRESH, tooltip="Maximum ATR multiplier for 'small move'")

rvol_threshold = input.float(2.0, title="RVOL Threshold", minval=1.5, maxval=5.0, step=0.1,
                 group=GRP_THRESH, tooltip="Minimum RVOL for absorption")

body_ratio_max = input.float(0.35, title="Max Body Ratio", minval=0.1, maxval=0.5, step=0.05,
                 group=GRP_THRESH, tooltip="Maximum body ratio (wick analysis)")

location_lookback = input.int(10, title="Location Lookback", minval=5, maxval=30,
                    group=GRP_THRESH, tooltip="Bars to determine recent high/low")

location_tolerance = input.float(0.002, title="Location Tolerance", minval=0.001, maxval=0.01, step=0.001,
                     group=GRP_THRESH, tooltip="Proximity to high/low (0.002 = 0.2%)")

// Visual Settings
show_markers = input.bool(false, title="Show Markers", group=GRP_VISUAL,
               tooltip="Show absorption diamond markers (in addition to candle color)")

show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL,
             tooltip="Display info panel with current values")

// Alert Settings
alert_absorption = input.bool(true, title="Alert on Absorption", group=GRP_ALERTS,
                   tooltip="Alert on any absorption candle")

alert_at_extreme = input.bool(true, title="Alert at Extremes", group=GRP_ALERTS,
                   tooltip="Alert on absorption at high/low")

// ============================================================================
// CALCULATIONS
// ============================================================================

// Step 1: ATR
atr_value = atr_source == "Auto" ? ta.atr(atr_length) : manual_atr

// Step 2: Price move size (use body for absorption)
body_size = math.abs(close - open)
range_size = high - low

// Step 3: Move ratio (body relative to ATR)
move_ratio = atr_value > 0 ? body_size / atr_value : 0

// Step 4: Body ratio (body relative to range)
body_ratio = range_size > 0 ? body_size / range_size : 1

// Step 5: RVOL
avg_volume = ta.sma(volume, rvol_length)
rvol = avg_volume > 0 ? volume / avg_volume : 0

// Step 6: Absorption detection criteria
is_small_move = move_ratio <= move_threshold
is_high_volume = rvol >= rvol_threshold
has_wicks = body_ratio <= body_ratio_max

is_absorption = is_small_move and is_high_volume and has_wicks

// Step 7: Location context (is this at recent high or low?)
recent_high = ta.highest(high, location_lookback)
recent_low = ta.lowest(low, location_lookback)

at_high = high >= recent_high * (1 - location_tolerance)
at_low = low <= recent_low * (1 + location_tolerance)

absorption_at_high = is_absorption and at_high
absorption_at_low = is_absorption and at_low

// Step 8: Wick analysis for implied direction
upper_wick = high - math.max(open, close)
lower_wick = math.min(open, close) - low

bullish_absorption = is_absorption and lower_wick > upper_wick  // Buying the dip
bearish_absorption = is_absorption and upper_wick > lower_wick  // Selling the rip

// Step 9: Combined signal strength
absorption_strength = is_absorption ? (rvol / rvol_threshold) * ((body_ratio_max - body_ratio) / body_ratio_max) : 0

// ============================================================================
// OUTPUTS / PLOTS
// ============================================================================

// PRIMARY VISUAL: Candle coloring for absorption candles
absorption_color = absorption_at_low ? color_absorption_bull :
                   absorption_at_high ? color_absorption_bear :
                   is_absorption ? color_absorption_neutral : na

barcolor(absorption_color, title="Absorption Candle Color")

// OPTIONAL: Diamond markers for additional clarity
plotshape(show_markers and absorption_at_low,
          title="Bullish Absorption",
          location=location.belowbar,
          style=shape.diamond,
          color=color_absorption_bull,
          size=size.tiny)

plotshape(show_markers and absorption_at_high,
          title="Bearish Absorption",
          location=location.abovebar,
          style=shape.diamond,
          color=color_absorption_bear,
          size=size.tiny)

plotshape(show_markers and is_absorption and not absorption_at_high and not absorption_at_low,
          title="Neutral Absorption",
          location=location.abovebar,
          style=shape.diamond,
          color=color_absorption_neutral,
          size=size.tiny)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(is_absorption,
               title="Absorption Detected",
               message="EPCH Absorption: High volume absorption candle detected")

alertcondition(absorption_at_high,
               title="Absorption at High",
               message="EPCH Absorption: Selling absorption at recent high (bearish reversal signal)")

alertcondition(absorption_at_low,
               title="Absorption at Low",
               message="EPCH Absorption: Buying absorption at recent low (bullish reversal signal)")

alertcondition(absorption_at_high or absorption_at_low,
               title="Absorption at Extreme",
               message="EPCH Absorption: Absorption detected at price extreme")

// ============================================================================
// DISPLAY PANEL (Info Box)
// ============================================================================
if show_panel
    var table panel = table.new(position.top_right, 2, 5,
                                bgcolor=color.new(color.black, 80),
                                border_width=1,
                                border_color=color.new(color.gray, 60))

    if barstate.islast
        // Row 0: Body (ATR ratio)
        table.cell(panel, 0, 0, "Body", text_color=color.white, text_size=size.small)
        body_color = is_small_move ? color_signal : color_neutral
        table.cell(panel, 1, 0, str.tostring(move_ratio, "#.##") + " ATR",
                   text_color=body_color, text_size=size.small)

        // Row 1: RVOL
        table.cell(panel, 0, 1, "RVOL", text_color=color.white, text_size=size.small)
        rvol_color = is_high_volume ? color_signal : color_neutral
        table.cell(panel, 1, 1, str.tostring(rvol, "#.##") + "x",
                   text_color=rvol_color, text_size=size.small)

        // Row 2: Body %
        table.cell(panel, 0, 2, "Body%", text_color=color.white, text_size=size.small)
        bodypct_color = has_wicks ? color_signal : color_neutral
        table.cell(panel, 1, 2, str.tostring(body_ratio * 100, "#") + "%",
                   text_color=bodypct_color, text_size=size.small)

        // Row 3: Location
        table.cell(panel, 0, 3, "Location", text_color=color.white, text_size=size.small)
        loc_text = at_high ? "@ HIGH" : at_low ? "@ LOW" : "MID"
        loc_color = at_high ? color_bear_strong : at_low ? color_bull_strong : color_neutral
        table.cell(panel, 1, 3, loc_text, text_color=loc_color, text_size=size.small)

        // Row 4: Signal
        table.cell(panel, 0, 4, "Signal", text_color=color.white, text_size=size.small)
        signal_text = absorption_at_high ? "▼ SELL ABS" :
                      absorption_at_low ? "▲ BUY ABS" :
                      is_absorption ? "● ABSORB" : "—"
        signal_color = is_absorption ? color_absorption_neutral : color_neutral
        table.cell(panel, 1, 4, signal_text, text_color=signal_color, text_size=size.small)

// ============================================================================
// EXPORT VALUES (for other indicators to reference)
// ============================================================================
plot(is_absorption ? 1 : 0, title="Absorption_Flag", display=display.none)
plot(absorption_at_low ? 1 : 0, title="BullAbsorption_Flag", display=display.none)
plot(absorption_at_high ? 1 : 0, title="BearAbsorption_Flag", display=display.none)
plot(absorption_strength, title="Absorption_Strength", display=display.none)

// ============================================================================
// END OF SCRIPT
// ============================================================================
