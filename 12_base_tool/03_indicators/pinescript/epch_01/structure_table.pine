// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - Market Structure Table (Multi-Timeframe)
// Version: 2.0.0
// Purpose: Display Market Structure across M5, M15, H1 timeframes
//          Shows structure alignment for confluence analysis
//
// Matches Python calculation: 03_indicators/python/structure/market_structure.py
// Method:
//   - Fractal-based swing high/low detection per timeframe
//   - BULL: Higher high AND higher low
//   - BEAR: Lower high AND lower low
//   - NEUTRAL: Mixed signals or insufficient data

//@version=5
indicator("[EPCH] Structure Table MTF", shorttitle="STRUCT-MTF", overlay=false, max_labels_count=500, max_bars_back=500)

// ============================================================================
// COLOR SCHEME
// ============================================================================
color_bull       = color.new(#26a69a, 0)    // Green - bullish structure
color_bear       = color.new(#ef5350, 0)    // Red - bearish structure
color_neutral    = color.new(#ffeb3b, 0)    // Yellow - neutral
color_aligned    = color.new(#00C853, 0)    // Bright green - all aligned

// ============================================================================
// INPUTS
// ============================================================================
GRP_TF = "Timeframes"
GRP_PARAMS = "Parameters"
GRP_VISUAL = "Visual Settings"

i_tf1 = input.timeframe("5", title="Timeframe 1 (Fast)", group=GRP_TF, tooltip="Fastest timeframe (default M5)")
i_tf2 = input.timeframe("15", title="Timeframe 2 (Mid)", group=GRP_TF, tooltip="Middle timeframe (default M15)")
i_tf3 = input.timeframe("60", title="Timeframe 3 (Slow)", group=GRP_TF, tooltip="Slowest timeframe (default H1)")

i_fractal_len = input.int(5, title="Fractal Length", minval=3, maxval=15, group=GRP_PARAMS, tooltip="Total bars for fractal detection (default 5 = 2 bars each side)")

i_show_all_tf = input.bool(true, title="Show All TF Labels", group=GRP_VISUAL, tooltip="Show structure for all timeframes on each bar")
i_show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL, tooltip="Show summary panel in corner")
i_label_size = input.string("Small", title="Label Size", options=["Tiny", "Small", "Normal", "Large"], group=GRP_VISUAL)

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================
text_size(sz) =>
    switch sz
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        => size.small

get_structure_color(s) =>
    s == "BULL" ? color_bull : s == "BEAR" ? color_bear : color_neutral

get_structure_arrow(s) =>
    s == "BULL" ? "▲" : s == "BEAR" ? "▼" : "●"

// ============================================================================
// STRUCTURE CALCULATION FUNCTION
// Returns [structure, swing_high_1, swing_high_2, swing_low_1, swing_low_2]
// ============================================================================
calc_structure(float h, float l, int fractal_len) =>
    int p = fractal_len / 2

    // Swing high detection
    bool is_sh = true
    for i = 1 to p
        if h[p + i] >= h[p] or h[p - i] >= h[p]
            is_sh := false
            break

    // Swing low detection
    bool is_sl = true
    for i = 1 to p
        if l[p + i] <= l[p] or l[p - i] <= l[p]
            is_sl := false
            break

    // Track swings with var
    var float sh1 = na
    var float sh2 = na
    var float sl1 = na
    var float sl2 = na

    if is_sh
        sh2 := sh1
        sh1 := h[p]

    if is_sl
        sl2 := sl1
        sl1 := l[p]

    // Determine structure
    bool has_highs = not na(sh1) and not na(sh2)
    bool has_lows = not na(sl1) and not na(sl2)
    bool hh = has_highs ? sh1 > sh2 : false
    bool hl = has_lows ? sl1 > sl2 : false
    bool lh = has_highs ? sh1 < sh2 : false
    bool ll = has_lows ? sl1 < sl2 : false

    string struct_val = "NEUT"
    if hh and hl
        struct_val := "BULL"
    else if lh and ll
        struct_val := "BEAR"
    else if hh or hl
        struct_val := "BULL"
    else if lh or ll
        struct_val := "BEAR"

    [struct_val, sh1, sh2, sl1, sl2]

// ============================================================================
// CURRENT TIMEFRAME STRUCTURE
// ============================================================================
[struct_current, sh1_current, sh2_current, sl1_current, sl2_current] = calc_structure(high, low, i_fractal_len)

// ============================================================================
// MULTI-TIMEFRAME STRUCTURE via request.security
// ============================================================================
// TF1 (M5)
[struct_tf1, sh1_tf1, sh2_tf1, sl1_tf1, sl2_tf1] = request.security(syminfo.tickerid, i_tf1, calc_structure(high, low, i_fractal_len), lookahead=barmerge.lookahead_off)

// TF2 (M15)
[struct_tf2, sh1_tf2, sh2_tf2, sl1_tf2, sl2_tf2] = request.security(syminfo.tickerid, i_tf2, calc_structure(high, low, i_fractal_len), lookahead=barmerge.lookahead_off)

// TF3 (H1)
[struct_tf3, sh1_tf3, sh2_tf3, sl1_tf3, sl2_tf3] = request.security(syminfo.tickerid, i_tf3, calc_structure(high, low, i_fractal_len), lookahead=barmerge.lookahead_off)

// ============================================================================
// ALIGNMENT CHECK
// ============================================================================
bool all_bull = struct_tf1 == "BULL" and struct_tf2 == "BULL" and struct_tf3 == "BULL"
bool all_bear = struct_tf1 == "BEAR" and struct_tf2 == "BEAR" and struct_tf3 == "BEAR"
bool aligned = all_bull or all_bear
string alignment = all_bull ? "BULL" : all_bear ? "BEAR" : "MIXED"

// ============================================================================
// INVISIBLE PLOT (needed to create the pane)
// ============================================================================
plot(0, title="Base", color=color.new(color.black, 100), display=display.none)

// ============================================================================
// PER-BAR TEXT LABELS
// ============================================================================
string lbl_text = ""
color lbl_color = color_neutral

if i_show_all_tf
    // Show all three timeframes: TF3 | TF2 | TF1 (slow to fast)
    string arrow3 = get_structure_arrow(struct_tf3)
    string arrow2 = get_structure_arrow(struct_tf2)
    string arrow1 = get_structure_arrow(struct_tf1)
    lbl_text := arrow3 + "|" + arrow2 + "|" + arrow1

    // Color based on alignment
    if all_bull
        lbl_color := color_aligned
    else if all_bear
        lbl_color := color_bear
    else
        // Use color of majority or neutral
        int bull_count = (struct_tf1 == "BULL" ? 1 : 0) + (struct_tf2 == "BULL" ? 1 : 0) + (struct_tf3 == "BULL" ? 1 : 0)
        int bear_count = (struct_tf1 == "BEAR" ? 1 : 0) + (struct_tf2 == "BEAR" ? 1 : 0) + (struct_tf3 == "BEAR" ? 1 : 0)
        lbl_color := bull_count > bear_count ? color_bull : bear_count > bull_count ? color_bear : color_neutral
else
    // Just show current chart timeframe
    lbl_text := get_structure_arrow(struct_current)
    lbl_color := get_structure_color(struct_current)

if str.length(lbl_text) > 0
    label.new(bar_index, 0, lbl_text, style=label.style_label_center, color=color.new(color.black, 100), textcolor=lbl_color, size=text_size(i_label_size))

// ============================================================================
// INFO PANEL
// ============================================================================
var table info_panel = table.new(position.top_right, 3, 6, bgcolor=color.new(#1a1a2e, 10), border_width=1, border_color=color.new(color.gray, 60))

if barstate.islast and i_show_panel
    txt_size = size.small

    // Header row
    table.cell(info_panel, 0, 0, "TF", text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))
    table.cell(info_panel, 1, 0, "Structure", text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))
    table.cell(info_panel, 2, 0, "Swings", text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))

    // TF3 (H1) row
    table.cell(info_panel, 0, 1, i_tf3, text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 1, struct_tf3, text_color=get_structure_color(struct_tf3), text_size=txt_size)
    swing_str_tf3 = "H:" + str.tostring(sh1_tf3, format.mintick) + " L:" + str.tostring(sl1_tf3, format.mintick)
    table.cell(info_panel, 2, 1, swing_str_tf3, text_color=color.white, text_size=txt_size)

    // TF2 (M15) row
    table.cell(info_panel, 0, 2, i_tf2, text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 2, struct_tf2, text_color=get_structure_color(struct_tf2), text_size=txt_size)
    swing_str_tf2 = "H:" + str.tostring(sh1_tf2, format.mintick) + " L:" + str.tostring(sl1_tf2, format.mintick)
    table.cell(info_panel, 2, 2, swing_str_tf2, text_color=color.white, text_size=txt_size)

    // TF1 (M5) row
    table.cell(info_panel, 0, 3, i_tf1, text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 3, struct_tf1, text_color=get_structure_color(struct_tf1), text_size=txt_size)
    swing_str_tf1 = "H:" + str.tostring(sh1_tf1, format.mintick) + " L:" + str.tostring(sl1_tf1, format.mintick)
    table.cell(info_panel, 2, 3, swing_str_tf1, text_color=color.white, text_size=txt_size)

    // Alignment row
    table.cell(info_panel, 0, 4, "Align", text_color=color.white, text_size=txt_size)
    align_color = all_bull ? color_aligned : all_bear ? color_bear : color_neutral
    table.cell(info_panel, 1, 4, alignment, text_color=align_color, text_size=txt_size)
    align_status = aligned ? "✓ ALIGNED" : "✗ MIXED"
    table.cell(info_panel, 2, 4, align_status, text_color=align_color, text_size=txt_size)

    // Legend row
    table.cell(info_panel, 0, 5, "Legend", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 5, "H1|M15|M5", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 2, 5, "▲Bull ▼Bear ●Neut", text_color=color.white, text_size=txt_size)

// ============================================================================
// ALERTS
// ============================================================================
all_bull_start = all_bull and not all_bull[1]
all_bear_start = all_bear and not all_bear[1]
alignment_lost = not aligned and aligned[1]

alertcondition(all_bull_start, title="All TF Bullish", message="EPCH Structure: All timeframes aligned BULLISH")
alertcondition(all_bear_start, title="All TF Bearish", message="EPCH Structure: All timeframes aligned BEARISH")
alertcondition(alignment_lost, title="Alignment Lost", message="EPCH Structure: Multi-timeframe alignment LOST")
