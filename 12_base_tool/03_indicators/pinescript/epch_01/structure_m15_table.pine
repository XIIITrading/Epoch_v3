// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - Market Structure Table (M15)
// Version: 1.0.0
// Purpose: Display M15 Market Structure on each bar
//
// Method:
//   - Fractal-based swing high/low detection
//   - BULL: Higher high AND higher low
//   - BEAR: Lower high AND lower low
//   - NEUTRAL: Mixed signals or insufficient data

//@version=5
indicator("[EPCH] Structure M15", shorttitle="STRUCT-M15", overlay=false, max_labels_count=500, max_bars_back=500)

// ============================================================================
// COLOR SCHEME
// ============================================================================
color_bull       = color.new(#26a69a, 0)    // Green - bullish structure
color_bear       = color.new(#ef5350, 0)    // Red - bearish structure
color_neutral    = color.new(#ffeb3b, 0)    // Yellow - neutral

// ============================================================================
// INPUTS
// ============================================================================
GRP_TF = "Timeframe"
GRP_PARAMS = "Parameters"
GRP_VISUAL = "Visual Settings"

i_tf = input.timeframe("15", title="Timeframe", group=GRP_TF, tooltip="Structure timeframe (default M15)")
i_fractal_len = input.int(5, title="Fractal Length", minval=3, maxval=15, group=GRP_PARAMS, tooltip="Total bars for fractal detection (default 5 = 2 bars each side)")

i_show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL, tooltip="Show summary panel in corner")
i_label_size = input.string("Small", title="Label Size", options=["Tiny", "Small", "Normal", "Large"], group=GRP_VISUAL)

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================
text_size(sz) =>
    switch sz
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        => size.small

get_structure_color(s) =>
    s == "BULL" ? color_bull : s == "BEAR" ? color_bear : color_neutral

get_structure_arrow(s) =>
    s == "BULL" ? "▲" : s == "BEAR" ? "▼" : "●"

// ============================================================================
// STRUCTURE CALCULATION FUNCTION
// ============================================================================
calc_structure(float h, float l, int fractal_len) =>
    int p = fractal_len / 2

    bool is_sh = true
    for i = 1 to p
        if h[p + i] >= h[p] or h[p - i] >= h[p]
            is_sh := false
            break

    bool is_sl = true
    for i = 1 to p
        if l[p + i] <= l[p] or l[p - i] <= l[p]
            is_sl := false
            break

    var float sh1 = na
    var float sh2 = na
    var float sl1 = na
    var float sl2 = na

    if is_sh
        sh2 := sh1
        sh1 := h[p]

    if is_sl
        sl2 := sl1
        sl1 := l[p]

    bool has_highs = not na(sh1) and not na(sh2)
    bool has_lows = not na(sl1) and not na(sl2)
    bool hh = has_highs ? sh1 > sh2 : false
    bool hl = has_lows ? sl1 > sl2 : false
    bool lh = has_highs ? sh1 < sh2 : false
    bool ll = has_lows ? sl1 < sl2 : false

    string struct_val = "NEUT"
    if hh and hl
        struct_val := "BULL"
    else if lh and ll
        struct_val := "BEAR"
    else if hh or hl
        struct_val := "BULL"
    else if lh or ll
        struct_val := "BEAR"

    [struct_val, sh1, sh2, sl1, sl2]

// ============================================================================
// GET STRUCTURE FROM TIMEFRAME
// ============================================================================
[structure, sh1, sh2, sl1, sl2] = request.security(syminfo.tickerid, i_tf, calc_structure(high, low, i_fractal_len), lookahead=barmerge.lookahead_off)

bar_color = get_structure_color(structure)

// ============================================================================
// INVISIBLE PLOT (needed to create the pane)
// ============================================================================
plot(0, title="Base", color=color.new(color.black, 100), display=display.none)

// ============================================================================
// PER-BAR TEXT LABELS
// ============================================================================
string lbl_text = get_structure_arrow(structure)
label.new(bar_index, 0, lbl_text, style=label.style_label_center, color=color.new(color.black, 100), textcolor=bar_color, size=text_size(i_label_size))

// ============================================================================
// TITLE LABEL (Top Left)
// ============================================================================
var table title_table = table.new(position.top_left, 1, 1, bgcolor=color.new(color.black, 100), border_width=0)
if barstate.islast
    table.cell(title_table, 0, 0, "M15 Fractal", text_color=color.gray, text_size=size.small)

// ============================================================================
// INFO PANEL
// ============================================================================
var table info_panel = table.new(position.top_right, 2, 5, bgcolor=color.new(#1a1a2e, 10), border_width=1, border_color=color.new(color.gray, 60))

if barstate.islast and i_show_panel
    txt_size = size.small

    table.cell(info_panel, 0, 0, "TF", text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))
    table.cell(info_panel, 1, 0, i_tf + " (M15)", text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))

    table.cell(info_panel, 0, 1, "Structure", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 1, structure, text_color=bar_color, text_size=txt_size)

    table.cell(info_panel, 0, 2, "Swing High", text_color=color.white, text_size=txt_size)
    sh_str = not na(sh1) ? str.tostring(sh1, format.mintick) : "N/A"
    table.cell(info_panel, 1, 2, sh_str, text_color=color_bull, text_size=txt_size)

    table.cell(info_panel, 0, 3, "Swing Low", text_color=color.white, text_size=txt_size)
    sl_str = not na(sl1) ? str.tostring(sl1, format.mintick) : "N/A"
    table.cell(info_panel, 1, 3, sl_str, text_color=color_bear, text_size=txt_size)

    table.cell(info_panel, 0, 4, "Fractal", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 4, str.tostring(i_fractal_len) + " bars", text_color=color.white, text_size=txt_size)

// ============================================================================
// ALERTS
// ============================================================================
bull_start = structure == "BULL" and structure[1] != "BULL"
bear_start = structure == "BEAR" and structure[1] != "BEAR"

alertcondition(bull_start, title="M15 Bullish", message="EPCH Structure M15: Turned BULLISH")
alertcondition(bear_start, title="M15 Bearish", message="EPCH Structure M15: Turned BEARISH")
