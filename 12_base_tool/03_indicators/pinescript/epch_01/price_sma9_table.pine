// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - Price vs SMA9 Table (M2 Timeframe)
// Version: 1.0.0
// Purpose: Display Price position relative to 9 SMA on M2 timeframe
//
// Method:
//   - Calculate 9-period SMA on M2 timeframe
//   - Compare current price (close) to SMA9
//   - ABOVE: Price > SMA9 (bullish)
//   - BELOW: Price < SMA9 (bearish)
//   - AT: Price approximately equal to SMA9

//@version=5
indicator("[EPCH] Price vs SMA9", shorttitle="PRC-SMA9", overlay=false, max_labels_count=500, max_bars_back=500)

// ============================================================================
// COLOR SCHEME
// ============================================================================
color_above      = color.new(#26a69a, 0)    // Green - price above SMA9 (bullish)
color_below      = color.new(#ef5350, 0)    // Red - price below SMA9 (bearish)
color_neutral    = color.new(#ffeb3b, 0)    // Yellow - price at SMA9

// ============================================================================
// INPUTS
// ============================================================================
GRP_TF = "Timeframe"
GRP_PARAMS = "Parameters"
GRP_VISUAL = "Visual Settings"

i_tf = input.timeframe("2", title="Timeframe", group=GRP_TF, tooltip="Timeframe for SMA calculation (default M2)")
i_sma_length = input.int(9, title="SMA Length", minval=3, maxval=50, group=GRP_PARAMS, tooltip="SMA period (default 9)")
i_threshold_pct = input.float(0.05, title="Threshold %", minval=0.01, maxval=1.0, step=0.01, group=GRP_PARAMS, tooltip="Percentage threshold for 'AT' classification (default 0.05%)")

i_show_distance = input.bool(true, title="Show Distance", group=GRP_VISUAL, tooltip="Show distance from SMA as percentage")
i_show_signal = input.bool(true, title="Show Signal Arrow", group=GRP_VISUAL, tooltip="Show signal indicator")
i_show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL, tooltip="Show summary panel in corner")
i_label_size = input.string("Small", title="Label Size", options=["Tiny", "Small", "Normal", "Large"], group=GRP_VISUAL)

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================
text_size(sz) =>
    switch sz
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        => size.small

// ============================================================================
// SMA CALCULATION ON TIMEFRAME
// ============================================================================
calc_sma_position(float src, int len, float thresh_pct) =>
    float sma_val = ta.sma(src, len)
    float pct_diff = na
    string pos = "AT"

    if not na(sma_val) and sma_val > 0
        pct_diff := ((src - sma_val) / sma_val) * 100
        if pct_diff > thresh_pct
            pos := "ABOVE"
        else if pct_diff < -thresh_pct
            pos := "BELOW"
        else
            pos := "AT"

    [pos, sma_val, pct_diff]

// ============================================================================
// GET VALUES FROM TIMEFRAME
// ============================================================================
[position_str, sma9_value, distance_pct] = request.security(syminfo.tickerid, i_tf, calc_sma_position(close, i_sma_length, i_threshold_pct), lookahead=barmerge.lookahead_off)

// Get current close from the specified timeframe for display
tf_close = request.security(syminfo.tickerid, i_tf, close, lookahead=barmerge.lookahead_off)

// Color based on position
bar_color = position_str == "ABOVE" ? color_above : position_str == "BELOW" ? color_below : color_neutral

// Signal arrows
string signal_arrow = position_str == "ABOVE" ? "▲" : position_str == "BELOW" ? "▼" : "●"

// ============================================================================
// INVISIBLE PLOT (needed to create the pane)
// ============================================================================
plot(0, title="Base", color=color.new(color.black, 100), display=display.none)

// ============================================================================
// PER-BAR TEXT LABELS
// ============================================================================
string lbl_text = ""
if i_show_distance and not na(distance_pct)
    lbl_text := (distance_pct >= 0 ? "+" : "") + str.tostring(distance_pct, "#.##") + "%"

if i_show_signal
    if str.length(lbl_text) > 0
        lbl_text := lbl_text + "\n" + signal_arrow
    else
        lbl_text := signal_arrow

if str.length(lbl_text) > 0 and not na(sma9_value)
    label.new(bar_index, 0, lbl_text, style=label.style_label_center, color=color.new(color.black, 100), textcolor=bar_color, size=text_size(i_label_size))

// ============================================================================
// TITLE LABEL (Top Left)
// ============================================================================
var table title_table = table.new(position.top_left, 1, 1, bgcolor=color.new(color.black, 100), border_width=0)
if barstate.islast
    table.cell(title_table, 0, 0, "Price vs SMA9", text_color=color.gray, text_size=size.small)

// ============================================================================
// INFO PANEL
// ============================================================================
var table info_panel = table.new(position.top_right, 2, 6, bgcolor=color.new(#1a1a2e, 10), border_width=1, border_color=color.new(color.gray, 60))

if barstate.islast and i_show_panel
    txt_size = size.small

    table.cell(info_panel, 0, 0, "TF", text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))
    table.cell(info_panel, 1, 0, i_tf + " (M2)", text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))

    table.cell(info_panel, 0, 1, "Price", text_color=color.white, text_size=txt_size)
    price_str = not na(tf_close) ? str.tostring(tf_close, format.mintick) : "N/A"
    table.cell(info_panel, 1, 1, price_str, text_color=color.white, text_size=txt_size)

    table.cell(info_panel, 0, 2, "SMA" + str.tostring(i_sma_length), text_color=color.white, text_size=txt_size)
    sma_str = not na(sma9_value) ? str.tostring(sma9_value, format.mintick) : "N/A"
    table.cell(info_panel, 1, 2, sma_str, text_color=color.white, text_size=txt_size)

    table.cell(info_panel, 0, 3, "Distance", text_color=color.white, text_size=txt_size)
    dist_str = not na(distance_pct) ? ((distance_pct >= 0 ? "+" : "") + str.tostring(distance_pct, "#.##") + "%") : "N/A"
    table.cell(info_panel, 1, 3, dist_str, text_color=bar_color, text_size=txt_size)

    table.cell(info_panel, 0, 4, "Position", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 4, position_str, text_color=bar_color, text_size=txt_size)

    table.cell(info_panel, 0, 5, "Threshold", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 5, str.tostring(i_threshold_pct, "#.##") + "%", text_color=color.white, text_size=txt_size)

// ============================================================================
// ALERTS
// ============================================================================
above_start = position_str == "ABOVE" and position_str[1] != "ABOVE"
below_start = position_str == "BELOW" and position_str[1] != "BELOW"

alertcondition(above_start, title="Price Above SMA9", message="EPCH Price vs SMA9: Price moved ABOVE SMA9 (bullish)")
alertcondition(below_start, title="Price Below SMA9", message="EPCH Price vs SMA9: Price moved BELOW SMA9 (bearish)")
