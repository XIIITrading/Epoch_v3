// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - VWAP Table (Bar-by-Bar Text Row)
// Version: 1.4.0
// Purpose: Display VWAP vs Price as text values on each bar
//          Similar to Delta/CVD/POC display style - text only, no histograms
//
// Matches Python calculation: 03_indicators/python/core/vwap.py
// Formula: VWAP = Cumulative(TP * Volume) / Cumulative(Volume)
//          TP = (High + Low + Close) / 3

//@version=5
indicator("[EPCH] VWAP Table", shorttitle="VWAP-TBL", overlay=false, max_labels_count=500, max_bars_back=500)

// ============================================================================
// COLOR SCHEME
// ============================================================================
color_bull       = color.new(#26a69a, 0)
color_bear       = color.new(#ef5350, 0)
color_at_vwap    = color.new(#ffeb3b, 0)
color_neutral    = color.new(color.gray, 50)

// ============================================================================
// INPUTS
// ============================================================================
GRP_PARAMS = "Parameters"
GRP_VISUAL = "Visual Settings"

i_vwap_anchor = input.string("Session", title="VWAP Anchor", options=["Session", "Week", "Month"], group=GRP_PARAMS, tooltip="Anchor period for VWAP calculation")
i_at_threshold = input.float(0.05, title="'AT VWAP' Threshold %", minval=0.01, maxval=1.0, step=0.01, group=GRP_PARAMS, tooltip="Percentage threshold to consider price 'AT' VWAP")
i_session_start = input.session("0930-0935", title="Session Start Window", group=GRP_PARAMS, tooltip="Time window for session start (resets VWAP)")

i_show_pct = input.bool(false, title="Show % Instead of $", group=GRP_VISUAL, tooltip="Show percentage difference instead of absolute")
i_show_side = input.bool(true, title="Show Side Arrow", group=GRP_VISUAL, tooltip="Show ▲/▼ indicator")
i_show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL, tooltip="Show summary panel in corner")
i_label_size = input.string("Small", title="Label Size", options=["Tiny", "Small", "Normal", "Large"], group=GRP_VISUAL)

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================
text_size(sz) =>
    switch sz
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        => size.small

get_side_color(price, vwap, threshold_pct) =>
    if na(vwap) or vwap == 0
        color_neutral
    else
        diff_pct = math.abs((price - vwap) / vwap) * 100
        if diff_pct < threshold_pct
            color_at_vwap
        else if price > vwap
            color_bull
        else
            color_bear

// ============================================================================
// SESSION BREAK DETECTION
// ============================================================================
is_new_day = ta.change(time("D")) != 0
is_new_week = ta.change(time("W")) != 0
is_new_month = ta.change(time("M")) != 0

is_in_session_start = not na(time(timeframe.period, i_session_start))
was_in_session_start = not na(time(timeframe.period, i_session_start)[1])
session_just_started = is_in_session_start and not was_in_session_start

expected_bar_time_ms = timeframe.in_seconds(timeframe.period) * 1000
actual_gap_ms = time - time[1]
is_time_gap = actual_gap_ms > (expected_bar_time_ms * 3)

is_new_period = switch i_vwap_anchor
    "Session" => is_new_day or session_just_started or (is_time_gap and not barstate.isfirst)
    "Week"    => is_new_week
    "Month"   => is_new_month
    => is_new_day or session_just_started

// ============================================================================
// VWAP CALCULATION
// ============================================================================
typical_price = (high + low + close) / 3

var float cum_tp_vol = 0.0
var float cum_vol = 0.0

if is_new_period or barstate.isfirst
    cum_tp_vol := typical_price * volume
    cum_vol := volume
else
    cum_tp_vol += typical_price * volume
    cum_vol += volume

vwap_value = cum_vol > 0 ? cum_tp_vol / cum_vol : na
vwap_valid = not na(vwap_value) and vwap_value > 0 and math.abs(vwap_value - close) < close * 0.5
vwap_final = vwap_valid ? vwap_value : na

price_diff = vwap_valid ? close - vwap_final : na
price_pct = vwap_valid and vwap_final > 0 ? (price_diff / vwap_final) * 100 : na
bar_color = get_side_color(close, vwap_final, i_at_threshold)

// ============================================================================
// INVISIBLE PLOT (needed to create the pane, but shows nothing)
// ============================================================================
plot(0, title="Base", color=color.new(color.black, 100), display=display.none)

// ============================================================================
// PER-BAR TEXT LABELS (like Delta/CVD/POC row)
// ============================================================================
string lbl_text = ""
if vwap_valid
    if i_show_pct
        lbl_text := (price_pct >= 0 ? "+" : "") + str.tostring(price_pct, "#.##") + "%"
    else
        lbl_text := (price_diff >= 0 ? "+" : "") + str.tostring(price_diff, "#.##")
    if i_show_side
        string arrow = price_diff > 0 ? "▲" : price_diff < 0 ? "▼" : "●"
        lbl_text := lbl_text + "\n" + arrow

if vwap_valid and str.length(lbl_text) > 0
    label.new(bar_index, 0, lbl_text, style=label.style_label_center, color=color.new(color.black, 100), textcolor=bar_color, size=text_size(i_label_size))

// ============================================================================
// TITLE LABEL (Top Left)
// ============================================================================
var table title_table = table.new(position.top_left, 1, 1, bgcolor=color.new(color.black, 100), border_width=0)
if barstate.islast
    table.cell(title_table, 0, 0, "VWAP Analysis", text_color=color.gray, text_size=size.small)

// ============================================================================
// INFO PANEL
// ============================================================================
var table info_panel = table.new(position.top_right, 2, 4, bgcolor=color.new(#1a1a2e, 10), border_width=1, border_color=color.new(color.gray, 60))

if barstate.islast and i_show_panel
    txt_size = size.small
    table.cell(info_panel, 0, 0, "VWAP", text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))
    table.cell(info_panel, 1, 0, vwap_valid ? str.tostring(vwap_final, format.mintick) : "N/A", text_color=color.new(color.purple, 0), text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))
    table.cell(info_panel, 0, 1, "Close", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 1, str.tostring(close, format.mintick), text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 0, 2, "Diff", text_color=color.white, text_size=txt_size)
    diff_str = vwap_valid ? ((price_diff >= 0 ? "+" : "") + str.tostring(price_diff, "#.##")) : "N/A"
    table.cell(info_panel, 1, 2, diff_str, text_color=bar_color, text_size=txt_size)
    table.cell(info_panel, 0, 3, "Side", text_color=color.white, text_size=txt_size)
    side_text = not vwap_valid ? "N/A" : (price_diff > 0 ? "ABOVE" : price_diff < 0 ? "BELOW" : "AT")
    table.cell(info_panel, 1, 3, side_text, text_color=bar_color, text_size=txt_size)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(ta.crossover(close, vwap_final) and vwap_valid, title="Price Cross Above VWAP", message="EPCH VWAP: Price crossed ABOVE VWAP")
alertcondition(ta.crossunder(close, vwap_final) and vwap_valid, title="Price Cross Below VWAP", message="EPCH VWAP: Price crossed BELOW VWAP")
alertcondition(is_new_period, title="VWAP Reset", message="EPCH VWAP: Session reset - VWAP recalculating")
