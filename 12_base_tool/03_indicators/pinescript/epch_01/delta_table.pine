// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - Delta Table (Bar-by-Bar Text Row)
// Version: 1.1.0
// Purpose: Display Volume Delta as text values on each bar
//          Same style as VWAP Table - text only with arrows
//
// Calculation Method: Lower Timeframe Intrabar Analysis
// - Fetches 1-min bars within each chart bar
// - Classifies each intrabar as up/down based on close vs open
// - Sums to get net delta (matches TradingView's built-in method)
//
// Fallback: Bar Position Method (when LTF data unavailable)
//   bar_position = (close - low) / (high - low)
//   delta_multiplier = (2 * bar_position) - 1
//   bar_delta = volume * delta_multiplier

//@version=5
indicator("[EPCH] Delta Table", shorttitle="DELTA-TBL", overlay=false, max_labels_count=500, max_bars_back=500)

// ============================================================================
// COLOR SCHEME
// ============================================================================
color_bull       = color.new(#26a69a, 0)
color_bear       = color.new(#ef5350, 0)
color_neutral    = color.new(color.gray, 50)

// ============================================================================
// INPUTS
// ============================================================================
GRP_PARAMS = "Parameters"
GRP_VISUAL = "Visual Settings"

i_calc_method = input.string("Intrabar (Accurate)", title="Calculation Method", options=["Intrabar (Accurate)", "Bar Position (Fast)"], group=GRP_PARAMS, tooltip="Intrabar uses lower TF data like TradingView. Bar Position is the estimation method.")
i_ltf = input.timeframe("1", title="Lower Timeframe", group=GRP_PARAMS, tooltip="Timeframe for intrabar analysis (1 = 1 minute)")
i_show_rolling = input.bool(false, title="Show Rolling Delta", group=GRP_PARAMS, tooltip="Show rolling sum instead of per-bar delta")
i_rolling_period = input.int(5, title="Rolling Period", minval=2, maxval=50, group=GRP_PARAMS, tooltip="Number of bars for rolling delta calculation")
i_format = input.string("Auto", title="Number Format", options=["Auto", "Thousands (K)", "Raw"], group=GRP_PARAMS, tooltip="How to format large numbers")

i_show_side = input.bool(true, title="Show Side Arrow", group=GRP_VISUAL, tooltip="Show ▲/▼ indicator")
i_show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL, tooltip="Show summary panel in corner")
i_label_size = input.string("Small", title="Label Size", options=["Tiny", "Small", "Normal", "Large"], group=GRP_VISUAL)

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================
text_size(sz) =>
    switch sz
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        => size.small

format_delta(val, fmt) =>
    if na(val)
        "N/A"
    else
        abs_val = math.abs(val)
        string result = ""
        if fmt == "Thousands (K)" or (fmt == "Auto" and abs_val >= 1000)
            result := str.tostring(val / 1000, "#.#") + "K"
        else
            result := str.tostring(val, "#")
        result

// ============================================================================
// INTRABAR DELTA CALCULATION (TradingView Method)
// Fetches lower timeframe bars and classifies each as up/down volume
// ============================================================================
// Get lower timeframe OHLCV data as arrays
[ltf_open, ltf_close, ltf_volume] = request.security_lower_tf(syminfo.tickerid, i_ltf, [open, close, volume])

// Calculate delta from intrabar data
calc_intrabar_delta() =>
    float delta = 0.0
    if array.size(ltf_open) > 0
        var float prev_close = na
        for i = 0 to array.size(ltf_open) - 1
            float o = array.get(ltf_open, i)
            float c = array.get(ltf_close, i)
            float v = array.get(ltf_volume, i)
            if c > o
                delta += v
            else if c < o
                delta -= v
            else
                // Close == Open: use previous intrabar's direction
                if not na(prev_close)
                    if c > prev_close
                        delta += v
                    else if c < prev_close
                        delta -= v
                    // If equal to prev_close, volume is neutral (not added)
            prev_close := c
    delta

intrabar_delta = calc_intrabar_delta()

// ============================================================================
// BAR POSITION DELTA CALCULATION (Fallback/Fast Method)
// ============================================================================
calc_bar_position_delta() =>
    float br = high - low
    float delta = 0.0
    if br == 0
        delta := close >= open ? volume : -volume
    else
        float pos = (close - low) / br
        float mult = (2 * pos) - 1
        delta := volume * mult
    delta

bar_position_delta = calc_bar_position_delta()

// ============================================================================
// SELECT CALCULATION METHOD
// ============================================================================
float bar_delta = i_calc_method == "Intrabar (Accurate)" ? intrabar_delta : bar_position_delta

// Rolling delta calculation
var float[] delta_history = array.new_float(0)
if array.size(delta_history) >= i_rolling_period
    array.shift(delta_history)
array.push(delta_history, bar_delta)

float rolling_delta = array.sum(delta_history)

// Select which delta to display
float display_delta = i_show_rolling ? rolling_delta : bar_delta
bool is_bullish = display_delta > 0
bool is_bearish = display_delta < 0

bar_color = is_bullish ? color_bull : is_bearish ? color_bear : color_neutral

// ============================================================================
// INVISIBLE PLOT (needed to create the pane)
// ============================================================================
plot(0, title="Base", color=color.new(color.black, 100), display=display.none)

// ============================================================================
// PER-BAR TEXT LABELS
// ============================================================================
string lbl_text = format_delta(display_delta, i_format)
if i_show_side
    string arrow = is_bullish ? "▲" : is_bearish ? "▼" : "●"
    lbl_text := lbl_text + "\n" + arrow

label.new(bar_index, 0, lbl_text, style=label.style_label_center, color=color.new(color.black, 100), textcolor=bar_color, size=text_size(i_label_size))

// ============================================================================
// TITLE LABEL (Top Left)
// ============================================================================
var table title_table = table.new(position.top_left, 1, 1, bgcolor=color.new(color.black, 100), border_width=0)
if barstate.islast
    table.cell(title_table, 0, 0, "Delta Analysis", text_color=color.gray, text_size=size.small)

// ============================================================================
// INFO PANEL
// ============================================================================
var table info_panel = table.new(position.top_right, 2, 5, bgcolor=color.new(#1a1a2e, 10), border_width=1, border_color=color.new(color.gray, 60))

if barstate.islast and i_show_panel
    txt_size = size.small
    method_label = i_calc_method == "Intrabar (Accurate)" ? "Intrabar" : "BarPos"

    table.cell(info_panel, 0, 0, "Bar Δ", text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))
    table.cell(info_panel, 1, 0, format_delta(bar_delta, i_format), text_color=bar_delta >= 0 ? color_bull : color_bear, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))

    table.cell(info_panel, 0, 1, "Rolling Δ", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 1, format_delta(rolling_delta, i_format), text_color=rolling_delta >= 0 ? color_bull : color_bear, text_size=txt_size)

    table.cell(info_panel, 0, 2, "Volume", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 2, format_delta(volume, i_format), text_color=color.white, text_size=txt_size)

    table.cell(info_panel, 0, 3, "Method", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 3, method_label, text_color=color.white, text_size=txt_size)

    table.cell(info_panel, 0, 4, "Signal", text_color=color.white, text_size=txt_size)
    signal_text = is_bullish ? "BULLISH" : is_bearish ? "BEARISH" : "NEUTRAL"
    table.cell(info_panel, 1, 4, signal_text, text_color=bar_color, text_size=txt_size)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(ta.crossover(bar_delta, 0), title="Delta Cross Above Zero", message="EPCH Delta: Bar delta crossed ABOVE zero (bullish)")
alertcondition(ta.crossunder(bar_delta, 0), title="Delta Cross Below Zero", message="EPCH Delta: Bar delta crossed BELOW zero (bearish)")
alertcondition(ta.crossover(rolling_delta, 0), title="Rolling Delta Cross Above Zero", message="EPCH Delta: Rolling delta crossed ABOVE zero (bullish)")
alertcondition(ta.crossunder(rolling_delta, 0), title="Rolling Delta Cross Below Zero", message="EPCH Delta: Rolling delta crossed BELOW zero (bearish)")
