// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - CVD Slope Table (Bar-by-Bar Text Row)
// Version: 1.0.0
// Purpose: Display Cumulative Volume Delta slope/trend on each bar
//          Same style as VWAP/Delta/SMA Tables - text only with arrows
//
// Matches Python calculation: 03_indicators/python/core/cvd.py
// Process:
//   1. Calculate bar deltas (bar position method)
//   2. Cumulative sum for CVD series
//   3. Linear regression slope on last N bars (window)
//   4. Normalize by CVD range: normalized_slope = slope / cvd_range * window
//   5. Clamp to [-2, 2]
//   6. Classify: Rising (>0.1), Falling (<-0.1), Flat

//@version=5
indicator("[EPCH] CVD Slope Table", shorttitle="CVD-TBL", overlay=false, max_labels_count=500, max_bars_back=500)

// ============================================================================
// COLOR SCHEME
// ============================================================================
color_rising     = color.new(#26a69a, 0)    // Green - CVD rising (bullish)
color_falling    = color.new(#ef5350, 0)    // Red - CVD falling (bearish)
color_flat       = color.new(#ffeb3b, 0)    // Yellow - CVD flat
color_neutral    = color.new(color.gray, 50)

// ============================================================================
// INPUTS
// ============================================================================
GRP_PARAMS = "Parameters"
GRP_VISUAL = "Visual Settings"

i_window = input.int(15, title="Slope Window", minval=5, maxval=50, group=GRP_PARAMS, tooltip="Number of bars for slope calculation (default 15)")
i_rising_thresh = input.float(0.1, title="Rising Threshold", minval=0.01, maxval=1.0, step=0.05, group=GRP_PARAMS, tooltip="Slope above this = Rising (default 0.1)")
i_falling_thresh = input.float(-0.1, title="Falling Threshold", minval=-1.0, maxval=-0.01, step=0.05, group=GRP_PARAMS, tooltip="Slope below this = Falling (default -0.1)")

i_show_slope = input.bool(true, title="Show Slope Value", group=GRP_VISUAL, tooltip="Show the normalized slope value")
i_show_trend = input.bool(true, title="Show Trend Arrow", group=GRP_VISUAL, tooltip="Show trend indicator")
i_show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL, tooltip="Show summary panel in corner")
i_label_size = input.string("Small", title="Label Size", options=["Tiny", "Small", "Normal", "Large"], group=GRP_VISUAL)

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================
text_size(sz) =>
    switch sz
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        => size.small

// ============================================================================
// BAR DELTA CALCULATION (Bar Position Method - matches Python)
// ============================================================================
calc_bar_delta() =>
    float br = high - low
    float delta = 0.0
    if br == 0
        delta := close >= open ? volume : -volume
    else
        float pos = (close - low) / br
        float mult = (2 * pos) - 1
        delta := volume * mult
    delta

bar_delta = calc_bar_delta()

// ============================================================================
// CVD (Cumulative Volume Delta) CALCULATION
// ============================================================================
var float cvd = 0.0
cvd := cvd + bar_delta

// Store recent CVD values for slope calculation
var float[] cvd_history = array.new_float(0)
if array.size(cvd_history) >= i_window
    array.shift(cvd_history)
array.push(cvd_history, cvd)

// ============================================================================
// LINEAR REGRESSION SLOPE CALCULATION
// Uses least squares method: slope = sum((x - x_mean) * (y - y_mean)) / sum((x - x_mean)^2)
// ============================================================================
calc_linear_slope() =>
    int n = array.size(cvd_history)
    if n < 3
        0.0
    else
        float x_mean = (n - 1) / 2.0
        float y_sum = 0.0
        for i = 0 to n - 1
            y_sum += array.get(cvd_history, i)
        float y_mean = y_sum / n

        float numerator = 0.0
        float denominator = 0.0
        for i = 0 to n - 1
            float x_diff = i - x_mean
            float y_diff = array.get(cvd_history, i) - y_mean
            numerator += x_diff * y_diff
            denominator += x_diff * x_diff

        if denominator == 0
            0.0
        else
            numerator / denominator

raw_slope = calc_linear_slope()

// ============================================================================
// NORMALIZE SLOPE BY CVD RANGE (matches Python)
// ============================================================================
calc_normalized_slope() =>
    int n = array.size(cvd_history)
    if n < 3
        0.0
    else
        float cvd_min = array.min(cvd_history)
        float cvd_max = array.max(cvd_history)
        float cvd_range = cvd_max - cvd_min

        if cvd_range == 0
            0.0
        else
            float normalized = raw_slope / cvd_range * n
            // Clamp to [-2, 2]
            math.max(-2.0, math.min(2.0, normalized))

float normalized_slope = calc_normalized_slope()

// ============================================================================
// TREND CLASSIFICATION
// ============================================================================
string trend = "Flat"
if normalized_slope > i_rising_thresh
    trend := "Rising"
else if normalized_slope < i_falling_thresh
    trend := "Falling"
else
    trend := "Flat"

// Color based on trend
bar_color = trend == "Rising" ? color_rising : trend == "Falling" ? color_falling : color_flat

// Short labels for display
string trend_arrow = trend == "Rising" ? "▲" : trend == "Falling" ? "▼" : "●"

// ============================================================================
// INVISIBLE PLOT (needed to create the pane)
// ============================================================================
plot(0, title="Base", color=color.new(color.black, 100), display=display.none)

// ============================================================================
// PER-BAR TEXT LABELS
// ============================================================================
string lbl_text = ""
if i_show_slope and array.size(cvd_history) >= 3
    lbl_text := (normalized_slope >= 0 ? "+" : "") + str.tostring(normalized_slope, "#.##")

if i_show_trend
    if str.length(lbl_text) > 0
        lbl_text := lbl_text + "\n" + trend_arrow
    else
        lbl_text := trend_arrow

if str.length(lbl_text) > 0 and array.size(cvd_history) >= 3
    label.new(bar_index, 0, lbl_text, style=label.style_label_center, color=color.new(color.black, 100), textcolor=bar_color, size=text_size(i_label_size))

// ============================================================================
// TITLE LABEL (Top Left)
// ============================================================================
var table title_table = table.new(position.top_left, 1, 1, bgcolor=color.new(color.black, 100), border_width=0)
if barstate.islast
    table.cell(title_table, 0, 0, "CVD Slope", text_color=color.gray, text_size=size.small)

// ============================================================================
// INFO PANEL
// ============================================================================
var table info_panel = table.new(position.top_right, 2, 6, bgcolor=color.new(#1a1a2e, 10), border_width=1, border_color=color.new(color.gray, 60))

format_number(val) =>
    if na(val)
        "N/A"
    else if math.abs(val) >= 1000000
        str.tostring(val / 1000000, "#.##") + "M"
    else if math.abs(val) >= 1000
        str.tostring(val / 1000, "#.#") + "K"
    else
        str.tostring(val, "#.##")

if barstate.islast and i_show_panel
    txt_size = size.small

    table.cell(info_panel, 0, 0, "CVD", text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))
    table.cell(info_panel, 1, 0, format_number(cvd), text_color=cvd >= 0 ? color_rising : color_falling, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))

    table.cell(info_panel, 0, 1, "Bar Delta", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 1, format_number(bar_delta), text_color=bar_delta >= 0 ? color_rising : color_falling, text_size=txt_size)

    table.cell(info_panel, 0, 2, "Raw Slope", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 2, format_number(raw_slope), text_color=color.white, text_size=txt_size)

    table.cell(info_panel, 0, 3, "Norm Slope", text_color=color.white, text_size=txt_size)
    slope_str = (normalized_slope >= 0 ? "+" : "") + str.tostring(normalized_slope, "#.##")
    table.cell(info_panel, 1, 3, slope_str, text_color=bar_color, text_size=txt_size)

    table.cell(info_panel, 0, 4, "Trend", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 4, trend, text_color=bar_color, text_size=txt_size)

    table.cell(info_panel, 0, 5, "Window", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 5, str.tostring(i_window) + " bars", text_color=color.white, text_size=txt_size)

// ============================================================================
// ALERTS
// ============================================================================
rising_start = trend == "Rising" and trend[1] != "Rising"
falling_start = trend == "Falling" and trend[1] != "Falling"

alertcondition(rising_start, title="CVD Rising", message="EPCH CVD Slope: CVD is RISING (bullish momentum)")
alertcondition(falling_start, title="CVD Falling", message="EPCH CVD Slope: CVD is FALLING (bearish momentum)")
