// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - Volume ROC Table (Bar-by-Bar Text Row)
// Version: 1.0.0
// Purpose: Display Volume Rate of Change vs baseline average on each bar
//          Same style as VWAP/Delta/SMA Tables - text only with arrows
//
// Matches Python calculation: 03_indicators/python/core/volume_roc.py
// Formula:
//   baseline_avg = SMA(volume, N) shifted by 1 bar (excludes current bar)
//   ROC = ((current_volume - baseline_avg) / baseline_avg) * 100
//   Classification: > +20%: "Above Avg", < -20%: "Below Avg", else: "Average"

//@version=5
indicator("[EPCH] Volume ROC Table", shorttitle="VROC-TBL", overlay=false, max_labels_count=500, max_bars_back=500)

// ============================================================================
// COLOR SCHEME
// ============================================================================
color_above      = color.new(#26a69a, 0)    // Green - above average (healthy)
color_below      = color.new(#ef5350, 0)    // Red - below average
color_average    = color.new(#ffeb3b, 0)    // Yellow - average
color_neutral    = color.new(color.gray, 50)

// ============================================================================
// INPUTS
// ============================================================================
GRP_PARAMS = "Parameters"
GRP_VISUAL = "Visual Settings"

i_baseline_period = input.int(20, title="Baseline Period", minval=5, maxval=100, group=GRP_PARAMS, tooltip="Number of bars for baseline average (default 20)")
i_above_thresh = input.float(20.0, title="Above Avg Threshold (%)", minval=5.0, maxval=100.0, step=5.0, group=GRP_PARAMS, tooltip="ROC above this = Above Avg (default 20%)")
i_below_thresh = input.float(-20.0, title="Below Avg Threshold (%)", minval=-100.0, maxval=-5.0, step=5.0, group=GRP_PARAMS, tooltip="ROC below this = Below Avg (default -20%)")

i_show_roc = input.bool(true, title="Show ROC Value", group=GRP_VISUAL, tooltip="Show the ROC percentage")
i_show_signal = input.bool(true, title="Show Signal Arrow", group=GRP_VISUAL, tooltip="Show signal indicator")
i_show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL, tooltip="Show summary panel in corner")
i_label_size = input.string("Small", title="Label Size", options=["Tiny", "Small", "Normal", "Large"], group=GRP_VISUAL)

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================
text_size(sz) =>
    switch sz
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        => size.small

// ============================================================================
// VOLUME ROC CALCULATION (matches Python)
// ============================================================================
// Baseline average: average of previous N bars (not including current)
// In Pine, volume[1] is previous bar, so we want bars [1] to [N]
baseline_avg = ta.sma(volume[1], i_baseline_period)

// Current volume
current_vol = volume

// Calculate ROC
float roc = na
string signal = "Average"
if not na(baseline_avg) and baseline_avg > 0
    roc := ((current_vol - baseline_avg) / baseline_avg) * 100
    if roc > i_above_thresh
        signal := "Above Avg"
    else if roc < i_below_thresh
        signal := "Below Avg"
    else
        signal := "Average"

// Color based on signal
bar_color = signal == "Above Avg" ? color_above : signal == "Below Avg" ? color_below : color_average

// Short labels for display
string signal_arrow = signal == "Above Avg" ? "▲" : signal == "Below Avg" ? "▼" : "●"

// ============================================================================
// INVISIBLE PLOT (needed to create the pane)
// ============================================================================
plot(0, title="Base", color=color.new(color.black, 100), display=display.none)

// ============================================================================
// PER-BAR TEXT LABELS
// ============================================================================
string lbl_text = ""
if i_show_roc and not na(roc)
    lbl_text := (roc >= 0 ? "+" : "") + str.tostring(roc, "#.#") + "%"

if i_show_signal
    if str.length(lbl_text) > 0
        lbl_text := lbl_text + "\n" + signal_arrow
    else
        lbl_text := signal_arrow

if str.length(lbl_text) > 0 and not na(baseline_avg)
    label.new(bar_index, 0, lbl_text, style=label.style_label_center, color=color.new(color.black, 100), textcolor=bar_color, size=text_size(i_label_size))

// ============================================================================
// TITLE LABEL (Top Left)
// ============================================================================
var table title_table = table.new(position.top_left, 1, 1, bgcolor=color.new(color.black, 100), border_width=0)
if barstate.islast
    table.cell(title_table, 0, 0, "Volume ROC", text_color=color.gray, text_size=size.small)

// ============================================================================
// INFO PANEL
// ============================================================================
var table info_panel = table.new(position.top_right, 2, 6, bgcolor=color.new(#1a1a2e, 10), border_width=1, border_color=color.new(color.gray, 60))

format_volume(val) =>
    if na(val)
        "N/A"
    else if val >= 1000000
        str.tostring(val / 1000000, "#.##") + "M"
    else if val >= 1000
        str.tostring(val / 1000, "#.#") + "K"
    else
        str.tostring(val, "#")

if barstate.islast and i_show_panel
    txt_size = size.small

    table.cell(info_panel, 0, 0, "Volume", text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))
    table.cell(info_panel, 1, 0, format_volume(current_vol), text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))

    table.cell(info_panel, 0, 1, "Baseline", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 1, format_volume(baseline_avg), text_color=color.white, text_size=txt_size)

    table.cell(info_panel, 0, 2, "ROC", text_color=color.white, text_size=txt_size)
    roc_str = not na(roc) ? ((roc >= 0 ? "+" : "") + str.tostring(roc, "#.#") + "%") : "N/A"
    table.cell(info_panel, 1, 2, roc_str, text_color=bar_color, text_size=txt_size)

    table.cell(info_panel, 0, 3, "Signal", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 3, signal, text_color=bar_color, text_size=txt_size)

    table.cell(info_panel, 0, 4, "Period", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 4, str.tostring(i_baseline_period) + " bars", text_color=color.white, text_size=txt_size)

    table.cell(info_panel, 0, 5, "Thresholds", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 5, ">" + str.tostring(i_above_thresh, "#") + "% / <" + str.tostring(i_below_thresh, "#") + "%", text_color=color.white, text_size=txt_size)

// ============================================================================
// ALERTS
// ============================================================================
above_avg_start = signal == "Above Avg" and signal[1] != "Above Avg"
below_avg_start = signal == "Below Avg" and signal[1] != "Below Avg"

alertcondition(above_avg_start, title="Volume Above Average", message="EPCH Volume ROC: Volume is ABOVE AVERAGE (healthy)")
alertcondition(below_avg_start, title="Volume Below Average", message="EPCH Volume ROC: Volume is BELOW AVERAGE")
