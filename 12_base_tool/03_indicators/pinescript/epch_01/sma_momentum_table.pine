// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - SMA Momentum Table (Bar-by-Bar Text Row)
// Version: 1.1.0
// Purpose: Display SMA Spread Momentum with 5-Phase Color Scheme
//          Shows both spread direction AND momentum change
//
// Matches Python calculation: 03_indicators/python/core/sma.py
// Formula:
//   spread_now = SMA9 - SMA21 (current)
//   spread_prev = SMA9 - SMA21 (N bars ago)
//   ratio = abs(spread_now) / abs(spread_prev)
//   WIDENING if ratio > 1.1, NARROWING if ratio < 0.9, else FLAT
//
// 5-Phase Classification (combines direction + momentum):
//   1. Widening Positive  - Spread positive and widening (strong bullish trend)
//   2. Narrowing Negative - Spread positive but narrowing toward neutral (weakening bull)
//   3. Neutral            - Spread near zero or flat momentum
//   4. Narrowing Positive - Spread negative but narrowing toward neutral (weakening bear)
//   5. Widening Negative  - Spread negative and widening (strong bearish trend)

//@version=5
indicator("[EPCH] SMA Momentum Table", shorttitle="SMOM-TBL", overlay=false, max_labels_count=500, max_bars_back=500)

// ============================================================================
// 5-PHASE COLOR SCHEME
// ============================================================================
color_widen_pos   = color.new(#00C853, 0)    // Bright Green - Widening Positive (strong bull)
color_narrow_neg  = color.new(#4CAF50, 0)    // Light Green - Narrowing from Positive (weakening bull)
color_neutral     = color.new(#9E9E9E, 0)    // Gray - Neutral
color_narrow_pos  = color.new(#FF7043, 0)    // Orange - Narrowing from Negative (weakening bear)
color_widen_neg   = color.new(#FF1744, 0)    // Bright Red - Widening Negative (strong bear)

// ============================================================================
// INPUTS
// ============================================================================
GRP_PARAMS = "Parameters"
GRP_VISUAL = "Visual Settings"

i_fast_period = input.int(9, title="Fast SMA Period", minval=2, maxval=50, group=GRP_PARAMS, tooltip="Fast SMA period (default 9)")
i_slow_period = input.int(21, title="Slow SMA Period", minval=5, maxval=200, group=GRP_PARAMS, tooltip="Slow SMA period (default 21)")
i_lookback = input.int(10, title="Momentum Lookback", minval=1, maxval=50, group=GRP_PARAMS, tooltip="Bars to look back for momentum comparison (default 10)")
i_widen_thresh = input.float(1.1, title="Widening Threshold", minval=1.01, maxval=2.0, step=0.05, group=GRP_PARAMS, tooltip="Ratio above this = WIDENING (default 1.1 = 10% increase)")
i_narrow_thresh = input.float(0.9, title="Narrowing Threshold", minval=0.5, maxval=0.99, step=0.05, group=GRP_PARAMS, tooltip="Ratio below this = NARROWING (default 0.9 = 10% decrease)")

i_show_ratio = input.bool(true, title="Show Ratio Value", group=GRP_VISUAL, tooltip="Show the momentum ratio")
i_show_label = input.bool(true, title="Show Phase Label", group=GRP_VISUAL, tooltip="Show phase indicator")
i_show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL, tooltip="Show summary panel in corner")
i_label_size = input.string("Small", title="Label Size", options=["Tiny", "Small", "Normal", "Large"], group=GRP_VISUAL)

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================
text_size(sz) =>
    switch sz
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        => size.small

// ============================================================================
// SMA & MOMENTUM CALCULATION (matches Python)
// ============================================================================
sma_fast = ta.sma(close, i_fast_period)
sma_slow = ta.sma(close, i_slow_period)

// Current spread
spread_now = sma_fast - sma_slow

// Previous spread (lookback bars ago)
spread_prev = sma_fast[i_lookback] - sma_slow[i_lookback]

// Calculate ratio using absolute values
abs_now = math.abs(spread_now)
abs_prev = math.abs(spread_prev)

// Ratio calculation (protect against zero)
float ratio = na
string base_momentum = "FLAT"
if not na(abs_prev) and abs_prev > 0
    ratio := abs_now / abs_prev
    if ratio > i_widen_thresh
        base_momentum := "WIDENING"
    else if ratio < i_narrow_thresh
        base_momentum := "NARROWING"
    else
        base_momentum := "FLAT"

// Determine spread direction
bool spread_positive = spread_now > 0
bool spread_negative = spread_now < 0

// ============================================================================
// 5-PHASE CLASSIFICATION
// Phase 1: Widening Positive  - spread > 0, widening (strong bullish trend)
// Phase 2: Narrowing Negative - spread > 0, narrowing (weakening bull, heading toward neutral)
// Phase 3: Neutral            - spread ~0 or flat momentum
// Phase 4: Narrowing Positive - spread < 0, narrowing (weakening bear, heading toward neutral)
// Phase 5: Widening Negative  - spread < 0, widening (strong bearish trend)
// ============================================================================
string phase = "NEUTRAL"
color phase_color = color_neutral
string phase_arrow = "●"

if spread_positive and base_momentum == "WIDENING"
    phase := "W+"
    phase_color := color_widen_pos
    phase_arrow := "▲▲"
else if spread_positive and base_momentum == "NARROWING"
    phase := "N-"
    phase_color := color_narrow_neg
    phase_arrow := "▼"
else if spread_negative and base_momentum == "NARROWING"
    phase := "N+"
    phase_color := color_narrow_pos
    phase_arrow := "▲"
else if spread_negative and base_momentum == "WIDENING"
    phase := "W-"
    phase_color := color_widen_neg
    phase_arrow := "▼▼"
else
    phase := "="
    phase_color := color_neutral
    phase_arrow := "●"

// Full phase names for panel
string phase_full = ""
if phase == "W+"
    phase_full := "Widening +"
else if phase == "N-"
    phase_full := "Narrowing -"
else if phase == "N+"
    phase_full := "Narrowing +"
else if phase == "W-"
    phase_full := "Widening -"
else
    phase_full := "Neutral"

// ============================================================================
// INVISIBLE PLOT (needed to create the pane)
// ============================================================================
plot(0, title="Base", color=color.new(color.black, 100), display=display.none)

// ============================================================================
// PER-BAR TEXT LABELS
// ============================================================================
string lbl_text = ""
if i_show_ratio and not na(ratio)
    lbl_text := str.tostring(ratio, "#.##") + "x"

if i_show_label
    if str.length(lbl_text) > 0
        lbl_text := lbl_text + "\n" + phase_arrow
    else
        lbl_text := phase_arrow

if str.length(lbl_text) > 0 and not na(sma_fast) and not na(sma_slow)
    label.new(bar_index, 0, lbl_text, style=label.style_label_center, color=color.new(color.black, 100), textcolor=phase_color, size=text_size(i_label_size))

// ============================================================================
// TITLE LABEL (Top Left)
// ============================================================================
var table title_table = table.new(position.top_left, 1, 1, bgcolor=color.new(color.black, 100), border_width=0)
if barstate.islast
    table.cell(title_table, 0, 0, "SMA Momentum", text_color=color.gray, text_size=size.small)

// ============================================================================
// INFO PANEL
// ============================================================================
var table info_panel = table.new(position.top_right, 2, 8, bgcolor=color.new(#1a1a2e, 10), border_width=1, border_color=color.new(color.gray, 60))

if barstate.islast and i_show_panel
    txt_size = size.small

    table.cell(info_panel, 0, 0, "Phase", text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))
    table.cell(info_panel, 1, 0, phase_full, text_color=phase_color, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))

    table.cell(info_panel, 0, 1, "Spread", text_color=color.white, text_size=txt_size)
    spread_now_str = not na(spread_now) ? ((spread_now >= 0 ? "+" : "") + str.tostring(spread_now, "#.##")) : "N/A"
    spread_dir_color = spread_now >= 0 ? color_widen_pos : color_widen_neg
    table.cell(info_panel, 1, 1, spread_now_str, text_color=spread_dir_color, text_size=txt_size)

    table.cell(info_panel, 0, 2, "Prev Spread", text_color=color.white, text_size=txt_size)
    spread_prev_str = not na(spread_prev) ? ((spread_prev >= 0 ? "+" : "") + str.tostring(spread_prev, "#.##")) : "N/A"
    table.cell(info_panel, 1, 2, spread_prev_str, text_color=color.white, text_size=txt_size)

    table.cell(info_panel, 0, 3, "Ratio", text_color=color.white, text_size=txt_size)
    ratio_str = not na(ratio) ? str.tostring(ratio, "#.##") + "x" : "N/A"
    table.cell(info_panel, 1, 3, ratio_str, text_color=phase_color, text_size=txt_size)

    table.cell(info_panel, 0, 4, "Momentum", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 4, base_momentum, text_color=phase_color, text_size=txt_size)

    table.cell(info_panel, 0, 5, "Direction", text_color=color.white, text_size=txt_size)
    dir_str = spread_positive ? "POSITIVE" : spread_negative ? "NEGATIVE" : "NEUTRAL"
    table.cell(info_panel, 1, 5, dir_str, text_color=spread_dir_color, text_size=txt_size)

    table.cell(info_panel, 0, 6, "Lookback", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 6, str.tostring(i_lookback) + " bars", text_color=color.white, text_size=txt_size)

    // Legend
    table.cell(info_panel, 0, 7, "Legend", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 7, "▲▲W+ ▼N- ●= ▲N+ ▼▼W-", text_color=color.white, text_size=txt_size)

// ============================================================================
// ALERTS
// ============================================================================
widen_pos_start = phase == "W+" and phase[1] != "W+"
widen_neg_start = phase == "W-" and phase[1] != "W-"
narrow_neg_start = phase == "N-" and phase[1] != "N-"
narrow_pos_start = phase == "N+" and phase[1] != "N+"

alertcondition(widen_pos_start, title="Widening Positive", message="EPCH SMA Momentum: WIDENING POSITIVE (strong bullish trend)")
alertcondition(widen_neg_start, title="Widening Negative", message="EPCH SMA Momentum: WIDENING NEGATIVE (strong bearish trend)")
alertcondition(narrow_neg_start, title="Narrowing from Positive", message="EPCH SMA Momentum: NARROWING from positive (bull weakening)")
alertcondition(narrow_pos_start, title="Narrowing from Negative", message="EPCH SMA Momentum: NARROWING from negative (bear weakening)")
