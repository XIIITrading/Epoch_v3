// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - SMA Spread Table (Bar-by-Bar Text Row)
// Version: 1.0.0
// Purpose: Display SMA9 vs SMA21 spread as text values on each bar
//          Same style as VWAP/Delta Tables - text only with arrows
//
// Matches Python calculation: 03_indicators/python/core/sma.py
// Formula:
//   SMA9 = Average of last 9 closes
//   SMA21 = Average of last 21 closes
//   Spread = SMA9 - SMA21
//   Alignment = BULLISH if SMA9 > SMA21, else BEARISH

//@version=5
indicator("[EPCH] SMA Spread Table", shorttitle="SMA-TBL", overlay=false, max_labels_count=500, max_bars_back=500)

// ============================================================================
// COLOR SCHEME
// ============================================================================
color_bull       = color.new(#26a69a, 0)
color_bear       = color.new(#ef5350, 0)
color_neutral    = color.new(color.gray, 50)

// ============================================================================
// INPUTS
// ============================================================================
GRP_PARAMS = "Parameters"
GRP_VISUAL = "Visual Settings"

i_fast_period = input.int(9, title="Fast SMA Period", minval=2, maxval=50, group=GRP_PARAMS, tooltip="Fast SMA period (default 9)")
i_slow_period = input.int(21, title="Slow SMA Period", minval=5, maxval=200, group=GRP_PARAMS, tooltip="Slow SMA period (default 21)")
i_show_spread = input.bool(true, title="Show Spread Value", group=GRP_VISUAL, tooltip="Show the spread value (SMA9 - SMA21)")
i_show_side = input.bool(true, title="Show Side Arrow", group=GRP_VISUAL, tooltip="Show ▲/▼ indicator for alignment")
i_show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL, tooltip="Show summary panel in corner")
i_label_size = input.string("Small", title="Label Size", options=["Tiny", "Small", "Normal", "Large"], group=GRP_VISUAL)

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================
text_size(sz) =>
    switch sz
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        => size.small

// ============================================================================
// SMA CALCULATION (matches Python)
// ============================================================================
sma_fast = ta.sma(close, i_fast_period)
sma_slow = ta.sma(close, i_slow_period)

// Spread and alignment
spread = sma_fast - sma_slow
is_bullish = sma_fast > sma_slow
is_bearish = sma_fast < sma_slow
alignment = is_bullish ? "BULLISH" : is_bearish ? "BEARISH" : "NEUTRAL"

// Cross estimate (midpoint between SMAs)
cross_estimate = (sma_fast + sma_slow) / 2

// Color based on alignment
bar_color = is_bullish ? color_bull : is_bearish ? color_bear : color_neutral

// ============================================================================
// INVISIBLE PLOT (needed to create the pane)
// ============================================================================
plot(0, title="Base", color=color.new(color.black, 100), display=display.none)

// ============================================================================
// PER-BAR TEXT LABELS
// ============================================================================
string lbl_text = ""
if i_show_spread and not na(spread)
    lbl_text := (spread >= 0 ? "+" : "") + str.tostring(spread, "#.##")

if i_show_side
    string arrow = is_bullish ? "▲" : is_bearish ? "▼" : "●"
    if str.length(lbl_text) > 0
        lbl_text := lbl_text + "\n" + arrow
    else
        lbl_text := arrow

if str.length(lbl_text) > 0 and not na(sma_fast) and not na(sma_slow)
    label.new(bar_index, 0, lbl_text, style=label.style_label_center, color=color.new(color.black, 100), textcolor=bar_color, size=text_size(i_label_size))

// ============================================================================
// TITLE LABEL (Top Left)
// ============================================================================
var table title_table = table.new(position.top_left, 1, 1, bgcolor=color.new(color.black, 100), border_width=0)
if barstate.islast
    table.cell(title_table, 0, 0, "SMA Spread", text_color=color.gray, text_size=size.small)

// ============================================================================
// INFO PANEL
// ============================================================================
var table info_panel = table.new(position.top_right, 2, 5, bgcolor=color.new(#1a1a2e, 10), border_width=1, border_color=color.new(color.gray, 60))

if barstate.islast and i_show_panel
    txt_size = size.small

    table.cell(info_panel, 0, 0, "SMA" + str.tostring(i_fast_period), text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))
    table.cell(info_panel, 1, 0, str.tostring(sma_fast, format.mintick), text_color=color_bull, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))

    table.cell(info_panel, 0, 1, "SMA" + str.tostring(i_slow_period), text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 1, str.tostring(sma_slow, format.mintick), text_color=color_bear, text_size=txt_size)

    table.cell(info_panel, 0, 2, "Spread", text_color=color.white, text_size=txt_size)
    spread_str = not na(spread) ? ((spread >= 0 ? "+" : "") + str.tostring(spread, "#.##")) : "N/A"
    table.cell(info_panel, 1, 2, spread_str, text_color=bar_color, text_size=txt_size)

    table.cell(info_panel, 0, 3, "Cross Est", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 3, str.tostring(cross_estimate, format.mintick), text_color=color.white, text_size=txt_size)

    table.cell(info_panel, 0, 4, "Align", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 4, alignment, text_color=bar_color, text_size=txt_size)

// ============================================================================
// ALERTS
// ============================================================================
alertcondition(ta.crossover(sma_fast, sma_slow), title="SMA Bullish Cross", message="EPCH SMA: Fast SMA crossed ABOVE slow SMA (bullish)")
alertcondition(ta.crossunder(sma_fast, sma_slow), title="SMA Bearish Cross", message="EPCH SMA: Fast SMA crossed BELOW slow SMA (bearish)")
