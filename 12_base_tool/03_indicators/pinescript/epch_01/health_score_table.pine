// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © XIIITrading
//
// EPCH Indicator Suite - Health Score Table (Bar-by-Bar Text Row)
// Version: 2.0.0
// Purpose: Display combined Health Score on each bar
//          Aggregates all 10 EPCH indicators into single health view
//
// 10 Factors:
//   1. Delta Analysis (Volume Delta - bar position method)
//   2. VWAP Analysis (price vs VWAP)
//   3. SMA Spread (SMA9 vs SMA21 alignment)
//   4. SMA Momentum (spread widening/narrowing)
//   5. CVD Slope (cumulative delta slope)
//   6. Volume ROC (volume vs baseline)
//   7. M5 Fractal (5-min structure)
//   8. M15 Fractal (15-min structure)
//   9. H1 Fractal (1-hour structure)
//   10. Price vs SMA9 (M2 timeframe)
//
// Score Labels: 9-10: STRONG, 7-8: MODERATE, 4-6: WEAK, 0-3: CRITICAL

//@version=5
indicator("[EPCH] Health Score", shorttitle="HEALTH-TBL", overlay=false, max_labels_count=500, max_bars_back=500)

// ============================================================================
// COLOR SCHEME
// ============================================================================
color_strong     = color.new(#00C853, 0)    // Green - strong
color_moderate   = color.new(#FFC107, 0)    // Yellow - moderate
color_weak       = color.new(#FF9800, 0)    // Orange - weak
color_critical   = color.new(#FF1744, 0)    // Red - critical

// ============================================================================
// INPUTS
// ============================================================================
GRP_DIRECTION = "Trade Direction"
GRP_TOGGLES = "Factor Toggles"
GRP_PARAMS = "Parameters"
GRP_VISUAL = "Visual Settings"

i_direction = input.string("LONG", title="Trade Direction", options=["LONG", "SHORT"], group=GRP_DIRECTION, tooltip="Direction to evaluate health for")

// Factor toggles
i_use_delta = input.bool(true, title="1. Delta Analysis", group=GRP_TOGGLES)
i_use_vwap = input.bool(true, title="2. VWAP Analysis", group=GRP_TOGGLES)
i_use_sma_spread = input.bool(true, title="3. SMA Spread", group=GRP_TOGGLES)
i_use_sma_mom = input.bool(true, title="4. SMA Momentum", group=GRP_TOGGLES)
i_use_cvd = input.bool(true, title="5. CVD Slope", group=GRP_TOGGLES)
i_use_vol_roc = input.bool(true, title="6. Volume ROC", group=GRP_TOGGLES)
i_use_m5 = input.bool(true, title="7. M5 Fractal", group=GRP_TOGGLES)
i_use_m15 = input.bool(true, title="8. M15 Fractal", group=GRP_TOGGLES)
i_use_h1 = input.bool(true, title="9. H1 Fractal", group=GRP_TOGGLES)
i_use_price_sma9 = input.bool(true, title="10. Price vs SMA9 (M2)", group=GRP_TOGGLES)

// Structure params
i_fractal_len = input.int(5, title="Fractal Length", minval=3, maxval=15, group=GRP_PARAMS)
// Volume ROC params
i_vol_baseline = input.int(20, title="Volume Baseline", minval=5, maxval=50, group=GRP_PARAMS)
i_vol_thresh = input.float(20.0, title="Vol ROC Threshold (%)", minval=5.0, maxval=50.0, group=GRP_PARAMS)
// CVD params
i_cvd_window = input.int(15, title="CVD Window", minval=5, maxval=50, group=GRP_PARAMS)
i_cvd_thresh = input.float(0.1, title="CVD Slope Threshold", minval=0.01, maxval=0.5, group=GRP_PARAMS)
// SMA params
i_sma_fast = input.int(9, title="Fast SMA", minval=2, maxval=50, group=GRP_PARAMS)
i_sma_slow = input.int(21, title="Slow SMA", minval=5, maxval=200, group=GRP_PARAMS)
i_mom_lookback = input.int(10, title="Momentum Lookback", minval=1, maxval=50, group=GRP_PARAMS)
// Price vs SMA9 params
i_sma9_tf = input.timeframe("2", title="SMA9 Timeframe", group=GRP_PARAMS, tooltip="Timeframe for Price vs SMA9 (default M2)")

i_show_score = input.bool(true, title="Show Score", group=GRP_VISUAL)
i_show_label = input.bool(true, title="Show Label", group=GRP_VISUAL)
i_show_panel = input.bool(true, title="Show Info Panel", group=GRP_VISUAL)
i_label_size = input.string("Small", title="Label Size", options=["Tiny", "Small", "Normal", "Large"], group=GRP_VISUAL)

// ============================================================================
// HELPER FUNCTIONS
// ============================================================================
text_size(sz) =>
    switch sz
        "Tiny"   => size.tiny
        "Small"  => size.small
        "Normal" => size.normal
        "Large"  => size.large
        => size.small

// ============================================================================
// CALCULATIONS
// ============================================================================
is_long = i_direction == "LONG"

// --- STRUCTURE CALCULATION FUNCTION (used for M5, M15, H1) ---
calc_structure(float h, float l, int fractal_len) =>
    int p_val = fractal_len / 2

    bool is_sh = true
    for i = 1 to p_val
        if h[p_val + i] >= h[p_val] or h[p_val - i] >= h[p_val]
            is_sh := false
            break

    bool is_sl = true
    for i = 1 to p_val
        if l[p_val + i] <= l[p_val] or l[p_val - i] <= l[p_val]
            is_sl := false
            break

    var float sh1 = na
    var float sh2 = na
    var float sl1 = na
    var float sl2 = na

    if is_sh
        sh2 := sh1
        sh1 := h[p_val]

    if is_sl
        sl2 := sl1
        sl1 := l[p_val]

    bool has_highs = not na(sh1) and not na(sh2)
    bool has_lows = not na(sl1) and not na(sl2)
    bool hh = has_highs ? sh1 > sh2 : false
    bool hl = has_lows ? sl1 > sl2 : false
    bool lh = has_highs ? sh1 < sh2 : false
    bool ll = has_lows ? sl1 < sl2 : false

    string struct_val = "NEUT"
    if hh and hl
        struct_val := "BULL"
    else if lh and ll
        struct_val := "BEAR"
    else if hh or hl
        struct_val := "BULL"
    else if lh or ll
        struct_val := "BEAR"

    struct_val

// --- 7. M5 FRACTAL STRUCTURE ---
structure_m5 = request.security(syminfo.tickerid, "5", calc_structure(high, low, i_fractal_len), lookahead=barmerge.lookahead_off)
bool m5_healthy = is_long ? structure_m5 == "BULL" : structure_m5 == "BEAR"

// --- 8. M15 FRACTAL STRUCTURE ---
structure_m15 = request.security(syminfo.tickerid, "15", calc_structure(high, low, i_fractal_len), lookahead=barmerge.lookahead_off)
bool m15_healthy = is_long ? structure_m15 == "BULL" : structure_m15 == "BEAR"

// --- 9. H1 FRACTAL STRUCTURE ---
structure_h1 = request.security(syminfo.tickerid, "60", calc_structure(high, low, i_fractal_len), lookahead=barmerge.lookahead_off)
bool h1_healthy = is_long ? structure_h1 == "BULL" : structure_h1 == "BEAR"

// --- 6. VOLUME ROC ---
float vol_baseline_avg = ta.sma(volume[1], i_vol_baseline)
float vol_roc = vol_baseline_avg > 0 ? ((volume - vol_baseline_avg) / vol_baseline_avg) * 100 : 0
bool volume_roc_healthy = vol_roc > i_vol_thresh

// --- 1. DELTA ANALYSIS (Volume Delta - Bar Position Method) ---
float bar_range = high - low
float bar_delta = bar_range == 0 ? (close >= open ? volume : -volume) : volume * ((2 * (close - low) / bar_range) - 1)
bool delta_healthy = is_long ? bar_delta > 0 : bar_delta < 0

// --- 5. CVD SLOPE ---
var float cvd = 0.0
cvd := cvd + bar_delta

var float[] cvd_history = array.new_float(0)
if array.size(cvd_history) >= i_cvd_window
    array.shift(cvd_history)
array.push(cvd_history, cvd)

calc_cvd_slope() =>
    int n = array.size(cvd_history)
    if n < 3
        0.0
    else
        float x_mean = (n - 1) / 2.0
        float y_sum = 0.0
        for i = 0 to n - 1
            y_sum += array.get(cvd_history, i)
        float y_mean = y_sum / n
        float numerator = 0.0
        float denominator = 0.0
        for i = 0 to n - 1
            float x_diff = i - x_mean
            float y_diff = array.get(cvd_history, i) - y_mean
            numerator += x_diff * y_diff
            denominator += x_diff * x_diff
        if denominator == 0
            0.0
        else
            float raw_slope = numerator / denominator
            float cvd_min = array.min(cvd_history)
            float cvd_max = array.max(cvd_history)
            float cvd_range = cvd_max - cvd_min
            if cvd_range == 0
                0.0
            else
                math.max(-2.0, math.min(2.0, raw_slope / cvd_range * n))

float cvd_slope = calc_cvd_slope()
bool cvd_healthy = is_long ? cvd_slope > i_cvd_thresh : cvd_slope < -i_cvd_thresh

// --- 3. SMA SPREAD (Alignment) ---
float sma_fast = ta.sma(close, i_sma_fast)
float sma_slow = ta.sma(close, i_sma_slow)
bool sma_spread_healthy = is_long ? sma_fast > sma_slow : sma_fast < sma_slow

// --- 4. SMA MOMENTUM ---
float spread_now = sma_fast - sma_slow
float spread_prev = sma_fast[i_mom_lookback] - sma_slow[i_mom_lookback]
float abs_now = math.abs(spread_now)
float abs_prev = math.abs(spread_prev)
float mom_ratio = abs_prev > 0 ? abs_now / abs_prev : 1.0
string sma_momentum = mom_ratio > 1.1 ? "WIDENING" : mom_ratio < 0.9 ? "NARROWING" : "FLAT"
bool sma_momentum_healthy = sma_momentum == "WIDENING"

// --- 2. VWAP ANALYSIS ---
var float cum_tp_vol = 0.0
var float cum_vol = 0.0
bool new_session = ta.change(time("D")) != 0
if new_session
    cum_tp_vol := 0.0
    cum_vol := 0.0

float tp = (high + low + close) / 3
cum_tp_vol := cum_tp_vol + tp * volume
cum_vol := cum_vol + volume
float vwap_val = cum_vol > 0 ? cum_tp_vol / cum_vol : close
bool vwap_healthy = is_long ? close > vwap_val : close < vwap_val

// --- 10. PRICE VS SMA9 (M2 Timeframe) ---
calc_price_vs_sma9() =>
    float sma9_val = ta.sma(close, 9)
    string pos = "AT"
    if not na(sma9_val) and sma9_val > 0
        float pct_diff = ((close - sma9_val) / sma9_val) * 100
        if pct_diff > 0.05
            pos := "ABOVE"
        else if pct_diff < -0.05
            pos := "BELOW"
    [pos, sma9_val]

[price_sma9_pos, sma9_value] = request.security(syminfo.tickerid, i_sma9_tf, calc_price_vs_sma9(), lookahead=barmerge.lookahead_off)
bool price_sma9_healthy = is_long ? price_sma9_pos == "ABOVE" : price_sma9_pos == "BELOW"

// ============================================================================
// HEALTH SCORE CALCULATION
// ============================================================================
int score = 0
int max_score = 0

if i_use_delta
    max_score += 1
    if delta_healthy
        score += 1

if i_use_vwap
    max_score += 1
    if vwap_healthy
        score += 1

if i_use_sma_spread
    max_score += 1
    if sma_spread_healthy
        score += 1

if i_use_sma_mom
    max_score += 1
    if sma_momentum_healthy
        score += 1

if i_use_cvd
    max_score += 1
    if cvd_healthy
        score += 1

if i_use_vol_roc
    max_score += 1
    if volume_roc_healthy
        score += 1

if i_use_m5
    max_score += 1
    if m5_healthy
        score += 1

if i_use_m15
    max_score += 1
    if m15_healthy
        score += 1

if i_use_h1
    max_score += 1
    if h1_healthy
        score += 1

if i_use_price_sma9
    max_score += 1
    if price_sma9_healthy
        score += 1

// Dynamic thresholds based on max_score
float pct_strong = 0.9
float pct_moderate = 0.7
float pct_weak = 0.4

int thresh_strong = math.ceil(max_score * pct_strong)
int thresh_moderate = math.ceil(max_score * pct_moderate)
int thresh_weak = math.ceil(max_score * pct_weak)

string health_label = score >= thresh_strong ? "STRONG" : score >= thresh_moderate ? "MODERATE" : score >= thresh_weak ? "WEAK" : "CRITICAL"
bar_color = score >= thresh_strong ? color_strong : score >= thresh_moderate ? color_moderate : score >= thresh_weak ? color_weak : color_critical

// ============================================================================
// INVISIBLE PLOT (needed to create the pane)
// ============================================================================
plot(0, title="Base", color=color.new(color.black, 100), display=display.none)

// ============================================================================
// PER-BAR TEXT LABELS
// ============================================================================
string lbl_text = ""
if i_show_score
    lbl_text := str.tostring(score) + "/" + str.tostring(max_score)

if i_show_label
    string short_label = health_label == "STRONG" ? "STR" : health_label == "MODERATE" ? "MOD" : health_label == "WEAK" ? "WK" : "CRT"
    if str.length(lbl_text) > 0
        lbl_text := lbl_text + "\n" + short_label
    else
        lbl_text := short_label

if str.length(lbl_text) > 0
    label.new(bar_index, 0, lbl_text, style=label.style_label_center, color=color.new(color.black, 100), textcolor=bar_color, size=text_size(i_label_size))

// ============================================================================
// TITLE LABEL (Top Left)
// ============================================================================
var table title_table = table.new(position.top_left, 1, 1, bgcolor=color.new(color.black, 100), border_width=0)
if barstate.islast
    table.cell(title_table, 0, 0, "Health Score", text_color=color.gray, text_size=size.small)

// ============================================================================
// INFO PANEL
// ============================================================================
var table info_panel = table.new(position.top_right, 3, 13, bgcolor=color.new(#1a1a2e, 10), border_width=1, border_color=color.new(color.gray, 60))

if barstate.islast and i_show_panel
    txt_size = size.small
    color_ok = color.new(#26a69a, 0)
    color_fail = color.new(#ef5350, 0)
    color_disabled = color.new(color.gray, 50)

    table.cell(info_panel, 0, 0, "Health", text_color=color.white, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))
    table.cell(info_panel, 1, 0, str.tostring(score) + "/" + str.tostring(max_score), text_color=bar_color, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))
    table.cell(info_panel, 2, 0, health_label, text_color=bar_color, text_size=txt_size, bgcolor=color.new(#2a2a4e, 0))

    table.cell(info_panel, 0, 1, "Direction", text_color=color.white, text_size=txt_size)
    table.cell(info_panel, 1, 1, i_direction, text_color=is_long ? color_ok : color_fail, text_size=txt_size)
    table.cell(info_panel, 2, 1, "", text_size=txt_size)

    // 1. Delta Analysis
    table.cell(info_panel, 0, 2, "1. Delta", text_color=i_use_delta ? color.white : color_disabled, text_size=txt_size)
    if i_use_delta
        delta_str = bar_delta >= 0 ? "+" + str.tostring(bar_delta / 1000, "#.#") + "K" : str.tostring(bar_delta / 1000, "#.#") + "K"
        table.cell(info_panel, 1, 2, delta_str, text_color=delta_healthy ? color_ok : color_fail, text_size=txt_size)
        table.cell(info_panel, 2, 2, delta_healthy ? "+" : "-", text_color=delta_healthy ? color_ok : color_fail, text_size=txt_size)
    else
        table.cell(info_panel, 1, 2, "OFF", text_color=color_disabled, text_size=txt_size)
        table.cell(info_panel, 2, 2, "", text_size=txt_size)

    // 2. VWAP Analysis
    table.cell(info_panel, 0, 3, "2. VWAP", text_color=i_use_vwap ? color.white : color_disabled, text_size=txt_size)
    if i_use_vwap
        vwap_str = close > vwap_val ? "Above" : "Below"
        table.cell(info_panel, 1, 3, vwap_str, text_color=vwap_healthy ? color_ok : color_fail, text_size=txt_size)
        table.cell(info_panel, 2, 3, vwap_healthy ? "+" : "-", text_color=vwap_healthy ? color_ok : color_fail, text_size=txt_size)
    else
        table.cell(info_panel, 1, 3, "OFF", text_color=color_disabled, text_size=txt_size)
        table.cell(info_panel, 2, 3, "", text_size=txt_size)

    // 3. SMA Spread
    table.cell(info_panel, 0, 4, "3. SMA Sprd", text_color=i_use_sma_spread ? color.white : color_disabled, text_size=txt_size)
    if i_use_sma_spread
        sma_align_str = sma_fast > sma_slow ? "BULL" : "BEAR"
        table.cell(info_panel, 1, 4, sma_align_str, text_color=sma_spread_healthy ? color_ok : color_fail, text_size=txt_size)
        table.cell(info_panel, 2, 4, sma_spread_healthy ? "+" : "-", text_color=sma_spread_healthy ? color_ok : color_fail, text_size=txt_size)
    else
        table.cell(info_panel, 1, 4, "OFF", text_color=color_disabled, text_size=txt_size)
        table.cell(info_panel, 2, 4, "", text_size=txt_size)

    // 4. SMA Momentum
    table.cell(info_panel, 0, 5, "4. SMA Mom", text_color=i_use_sma_mom ? color.white : color_disabled, text_size=txt_size)
    if i_use_sma_mom
        table.cell(info_panel, 1, 5, sma_momentum, text_color=sma_momentum_healthy ? color_ok : color_fail, text_size=txt_size)
        table.cell(info_panel, 2, 5, sma_momentum_healthy ? "+" : "-", text_color=sma_momentum_healthy ? color_ok : color_fail, text_size=txt_size)
    else
        table.cell(info_panel, 1, 5, "OFF", text_color=color_disabled, text_size=txt_size)
        table.cell(info_panel, 2, 5, "", text_size=txt_size)

    // 5. CVD Slope
    table.cell(info_panel, 0, 6, "5. CVD Slp", text_color=i_use_cvd ? color.white : color_disabled, text_size=txt_size)
    if i_use_cvd
        table.cell(info_panel, 1, 6, str.tostring(cvd_slope, "#.##"), text_color=cvd_healthy ? color_ok : color_fail, text_size=txt_size)
        table.cell(info_panel, 2, 6, cvd_healthy ? "+" : "-", text_color=cvd_healthy ? color_ok : color_fail, text_size=txt_size)
    else
        table.cell(info_panel, 1, 6, "OFF", text_color=color_disabled, text_size=txt_size)
        table.cell(info_panel, 2, 6, "", text_size=txt_size)

    // 6. Volume ROC
    table.cell(info_panel, 0, 7, "6. Vol ROC", text_color=i_use_vol_roc ? color.white : color_disabled, text_size=txt_size)
    if i_use_vol_roc
        table.cell(info_panel, 1, 7, str.tostring(vol_roc, "#.#") + "%", text_color=volume_roc_healthy ? color_ok : color_fail, text_size=txt_size)
        table.cell(info_panel, 2, 7, volume_roc_healthy ? "+" : "-", text_color=volume_roc_healthy ? color_ok : color_fail, text_size=txt_size)
    else
        table.cell(info_panel, 1, 7, "OFF", text_color=color_disabled, text_size=txt_size)
        table.cell(info_panel, 2, 7, "", text_size=txt_size)

    // 7. M5 Fractal
    table.cell(info_panel, 0, 8, "7. M5 Frac", text_color=i_use_m5 ? color.white : color_disabled, text_size=txt_size)
    if i_use_m5
        table.cell(info_panel, 1, 8, structure_m5, text_color=m5_healthy ? color_ok : color_fail, text_size=txt_size)
        table.cell(info_panel, 2, 8, m5_healthy ? "+" : "-", text_color=m5_healthy ? color_ok : color_fail, text_size=txt_size)
    else
        table.cell(info_panel, 1, 8, "OFF", text_color=color_disabled, text_size=txt_size)
        table.cell(info_panel, 2, 8, "", text_size=txt_size)

    // 8. M15 Fractal
    table.cell(info_panel, 0, 9, "8. M15 Frac", text_color=i_use_m15 ? color.white : color_disabled, text_size=txt_size)
    if i_use_m15
        table.cell(info_panel, 1, 9, structure_m15, text_color=m15_healthy ? color_ok : color_fail, text_size=txt_size)
        table.cell(info_panel, 2, 9, m15_healthy ? "+" : "-", text_color=m15_healthy ? color_ok : color_fail, text_size=txt_size)
    else
        table.cell(info_panel, 1, 9, "OFF", text_color=color_disabled, text_size=txt_size)
        table.cell(info_panel, 2, 9, "", text_size=txt_size)

    // 9. H1 Fractal
    table.cell(info_panel, 0, 10, "9. H1 Frac", text_color=i_use_h1 ? color.white : color_disabled, text_size=txt_size)
    if i_use_h1
        table.cell(info_panel, 1, 10, structure_h1, text_color=h1_healthy ? color_ok : color_fail, text_size=txt_size)
        table.cell(info_panel, 2, 10, h1_healthy ? "+" : "-", text_color=h1_healthy ? color_ok : color_fail, text_size=txt_size)
    else
        table.cell(info_panel, 1, 10, "OFF", text_color=color_disabled, text_size=txt_size)
        table.cell(info_panel, 2, 10, "", text_size=txt_size)

    // 10. Price vs SMA9
    table.cell(info_panel, 0, 11, "10. Prc/SMA9", text_color=i_use_price_sma9 ? color.white : color_disabled, text_size=txt_size)
    if i_use_price_sma9
        table.cell(info_panel, 1, 11, price_sma9_pos, text_color=price_sma9_healthy ? color_ok : color_fail, text_size=txt_size)
        table.cell(info_panel, 2, 11, price_sma9_healthy ? "+" : "-", text_color=price_sma9_healthy ? color_ok : color_fail, text_size=txt_size)
    else
        table.cell(info_panel, 1, 11, "OFF", text_color=color_disabled, text_size=txt_size)
        table.cell(info_panel, 2, 11, "", text_size=txt_size)

    // Thresholds info row
    table.cell(info_panel, 0, 12, "Thresh", text_color=color.gray, text_size=size.tiny)
    table.cell(info_panel, 1, 12, "S:" + str.tostring(thresh_strong) + " M:" + str.tostring(thresh_moderate) + " W:" + str.tostring(thresh_weak), text_color=color.gray, text_size=size.tiny)
    table.cell(info_panel, 2, 12, "", text_size=size.tiny)

// ============================================================================
// ALERTS
// ============================================================================
strong_start = health_label == "STRONG" and health_label[1] != "STRONG"
weak_start = health_label == "WEAK" and health_label[1] != "WEAK"
critical_start = health_label == "CRITICAL" and health_label[1] != "CRITICAL"

alertcondition(strong_start, title="Health Strong", message="EPCH Health: Score entered STRONG territory")
alertcondition(weak_start, title="Health Weak", message="EPCH Health: Score dropped to WEAK territory")
alertcondition(critical_start, title="Health Critical", message="EPCH Health: Score dropped to CRITICAL territory")
