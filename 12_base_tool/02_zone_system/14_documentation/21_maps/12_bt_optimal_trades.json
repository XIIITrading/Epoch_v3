{
  "_comment": "Epoch Trading System - Optimal Trade Analysis Cell Map",
  "_version": "4.0.0",
  "_organization": "XIII Trading LLC",
  "_module": "09_backtest/processor/optimal_trade",
  "_description": "Cell mappings for simplified optimal trade analysis (4-Row View)",
  "_directory": "02_zone_system/09_backtest/processor/optimal_trade/",

  "input_worksheets": {
    "backtest": "backtest",
    "exit_events": "exit_events"
  },
  "output_worksheet": "optimal_trade",

  "architecture": {
    "type": "simplified",
    "description": "4 rows per trade - one for each key moment (ENTRY, MFE, MAE, EXIT)",
    "row_count": "N trades x 4 = 4N rows",
    "purpose": "Capture indicator state at key moments for pattern discovery",
    "total_columns": 28,
    "column_range": "A-AB"
  },

  "source_inputs": {
    "backtest": {
      "_description": "Trade context and actual outcome (v2.3 format)",
      "_columns": "A-U",
      "key_columns": {
        "trade_id": "A",
        "date": "B",
        "ticker": "C",
        "model": "D",
        "direction": "F",
        "exit_reason": "Q",
        "pnl_r": "S",
        "win": "U"
      }
    },
    "exit_events": {
      "_description": "Bar-by-bar events filtered to ENTRY, MFE, MAE, EXIT (v3.2 format)",
      "_columns": "A-AF",
      "key_columns": {
        "trade_id": "A",
        "event_seq": "B",
        "event_time": "C",
        "bars_from_entry": "D",
        "event_type": "F",
        "price_at_event": "I",
        "r_at_event": "J",
        "health_score": "K",
        "health_delta": "L",
        "vwap": "M",
        "sma9": "N",
        "sma21": "O",
        "vol_roc": "Q",
        "vol_delta": "R",
        "cvd_slope": "S",
        "sma_spread": "T",
        "sma_momentum": "U",
        "m5_structure": "V",
        "m15_structure": "W",
        "h1_structure": "X",
        "h4_structure": "Y",
        "health_summary": "AC"
      }
    }
  },

  "optimal_trade_output": {
    "_description": "Simplified analysis view (v4.0: 28 columns, 4 rows per trade)",
    "_total_columns": 28,
    "_column_range": "A-AB",
    "header_row": 1,
    "data_start_row": 2,

    "trade_identification": {
      "_columns": "A-F",
      "_count": 6,
      "_source": "backtest",
      "A": {"header": "Trade_ID", "type": "string", "description": "Join key (4 rows per trade)"},
      "B": {"header": "Date", "type": "date", "description": "Trade date"},
      "C": {"header": "Ticker", "type": "string", "description": "Symbol"},
      "D": {"header": "Direction", "type": "string", "description": "LONG or SHORT"},
      "E": {"header": "Model", "type": "string", "description": "Entry model (EPCH1-4)"},
      "F": {"header": "Win", "type": "integer", "description": "1=Win, 0=Loss"}
    },

    "event_identification": {
      "_columns": "G-K",
      "_count": 5,
      "_source": "exit_events",
      "_note": "Identifies which key moment this row represents",
      "G": {"header": "Event_Type", "type": "string", "values": ["ENTRY", "MFE", "MAE", "EXIT"], "description": "Key moment type"},
      "H": {"header": "Event_Time", "type": "time", "description": "Time of this event"},
      "I": {"header": "Bars_From_Entry", "type": "integer", "description": "M5 bars since entry"},
      "J": {"header": "Price_At_Event", "type": "float", "description": "Price at this moment"},
      "K": {"header": "R_At_Event", "type": "float", "description": "R-multiple at this moment"}
    },

    "health_metrics": {
      "_columns": "L-N",
      "_count": 3,
      "_source": "exit_events",
      "L": {"header": "Health_Score", "type": "integer", "description": "Health score (0-10) at this moment"},
      "M": {"header": "Health_Delta", "type": "integer", "description": "Change from entry health"},
      "N": {"header": "Health_Summary", "type": "string", "values": ["IMPROVING", "DEGRADING", "STABLE"], "description": "Health trend"}
    },

    "indicator_values": {
      "_columns": "O-R",
      "_count": 4,
      "_source": "exit_events",
      "O": {"header": "VWAP", "type": "float", "description": "VWAP value at this moment"},
      "P": {"header": "SMA9", "type": "float", "description": "SMA9 value"},
      "Q": {"header": "SMA21", "type": "float", "description": "SMA21 value"},
      "R": {"header": "SMA_Spread", "type": "float", "description": "SMA9 - SMA21"}
    },

    "sma_volume_analysis": {
      "_columns": "S-U",
      "_count": 3,
      "_source": "exit_events",
      "S": {"header": "SMA_Momentum", "type": "string", "values": ["WIDENING", "NARROWING", "FLAT"], "description": "SMA spread direction"},
      "T": {"header": "Vol_ROC", "type": "float", "description": "Volume rate of change %"},
      "U": {"header": "Vol_Delta", "type": "float", "description": "Bar delta value"}
    },

    "cvd": {
      "_columns": "V",
      "_count": 1,
      "_source": "exit_events",
      "V": {"header": "CVD_Slope", "type": "float", "description": "Cumulative volume delta slope"}
    },

    "structure": {
      "_columns": "W-Z",
      "_count": 4,
      "_source": "exit_events",
      "W": {"header": "M5_Structure", "type": "string", "values": ["BULL", "BEAR", "NEUTRAL"], "description": "M5 market structure"},
      "X": {"header": "M15_Structure", "type": "string", "values": ["BULL", "BEAR", "NEUTRAL"], "description": "M15 market structure"},
      "Y": {"header": "H1_Structure", "type": "string", "values": ["BULL", "BEAR", "NEUTRAL"], "description": "H1 market structure"},
      "Z": {"header": "H4_Structure", "type": "string", "values": ["BULL", "BEAR", "NEUTRAL"], "description": "H4 market structure"}
    },

    "trade_outcome": {
      "_columns": "AA-AB",
      "_count": 2,
      "_source": "backtest",
      "_note": "Repeated on every row for filtering",
      "AA": {"header": "Actual_R", "type": "float", "description": "Final R achieved"},
      "AB": {"header": "Exit_Reason", "type": "string", "description": "Why trade exited (Target/Stop/CHoCH/EOD)"}
    }
  },

  "event_types": {
    "ENTRY": {
      "description": "First moment - trade entry",
      "r_at_event": "Always 0",
      "bars_from_entry": "Always 0",
      "health_delta": "Always 0"
    },
    "MFE": {
      "description": "Maximum Favorable Excursion - best R achieved",
      "r_at_event": "Highest R during trade",
      "key_insight": "Indicator state when trade was most profitable"
    },
    "MAE": {
      "description": "Maximum Adverse Excursion - worst R achieved",
      "r_at_event": "Lowest R during trade (often negative)",
      "key_insight": "Indicator state when trade was least profitable"
    },
    "EXIT": {
      "description": "Final moment - trade exit",
      "r_at_event": "Same as Actual_R",
      "key_insight": "Compare to MFE to understand what was left on table"
    }
  },

  "key_analysis_columns": {
    "_description": "Most important columns for pattern discovery",
    "G_Event_Type": "Filter to compare indicator states at different moments",
    "K_R_At_Event": "R-multiple at this specific moment",
    "L_Health_Score": "Health (0-10) - key exit timing indicator",
    "S_SMA_Momentum": "WIDENING/NARROWING/FLAT - trend strength",
    "W_M5_Structure": "Short-term structure alignment",
    "AA_Actual_R": "Final trade result for correlation analysis"
  },

  "analysis_queries": {
    "excel_filters": [
      "Filter Event_Type = 'MFE', analyze avg Health_Score",
      "Filter Event_Type = 'EXIT', compare Health to MFE rows",
      "Filter M5_Structure = 'BULL' at ENTRY, calculate win rate",
      "Filter Health_Score >= 7 at EXIT, see avg Actual_R"
    ],
    "pivot_tables": [
      "Rows: Event_Type, Values: Avg Health_Score",
      "Rows: Health_Score (filter EXIT), Values: Avg Actual_R",
      "Rows: SMA_Momentum (filter MFE), Values: Count",
      "Rows: M5_Structure (filter ENTRY), Columns: Win, Values: Count"
    ],
    "pattern_discovery": [
      "Compare indicator states at MFE vs EXIT - what changed?",
      "Identify health score threshold for optimal exits",
      "Find structure patterns that predict MFE timing",
      "Correlate volume indicators with MFE capture rate"
    ]
  },

  "summary_statistics": {
    "_description": "Per-event-type statistics written below data",
    "sections": [
      "DATA OVERVIEW (trades, rows, win rate)",
      "ENTRY EVENT STATISTICS",
      "MFE EVENT STATISTICS",
      "MAE EVENT STATISTICS",
      "EXIT EVENT STATISTICS",
      "CROSS-EVENT COMPARISONS",
      "KEY INSIGHTS"
    ],
    "per_event_metrics": {
      "avg_health_score": "Average health at this event type",
      "avg_bars_from_entry": "Average timing",
      "avg_r_at_event": "Average R at this moment",
      "health_distribution": "Weak/Moderate/Strong breakdown",
      "structure_breakdown": "M5 BULL/BEAR/NEUTRAL with win rates",
      "sma_momentum_breakdown": "WIDENING/NARROWING/FLAT with outcomes"
    }
  },

  "data_flow": {
    "backtest": "Trade ID, Date, Ticker, Direction, Model, Win, Actual_R, Exit_Reason",
    "exit_events": "Filter to ENTRY/MFE/MAE/EXIT events only, extract 13 indicators",
    "optimal_trade": "4 rows per trade with full indicator snapshot at each moment"
  },

  "workflow_order": {
    "1": "backtest_runner.py -> populates 'backtest'",
    "2": "entry_runner.py -> populates 'entry_events'",
    "3": "exit_runner.py -> populates 'exit_events'",
    "4": "optimal_runner.py -> populates 'optimal_trade'"
  },

  "version_history": {
    "v4.0.0": "Simplified to 4 rows per trade, 28 columns (A-AB), removed decay analysis",
    "v3.1.0": "Added decay analysis columns (AC-AL) - 45 columns",
    "v3.0.0": "Expanded analysis view (1 row per bar) - 35 columns"
  }
}
