{
  "_comment": "Epoch Trading System - Trade Bars Cell Map",
  "_version": "1.0.0",
  "_organization": "XIII Trading LLC",
  "_module": "09_backtest/processor/trade_bars",
  "_description": "Cell mappings for bar-by-bar trade analysis",
  "_directory": "02_zone_system/09_backtest/processor/trade_bars/",

  "input_worksheets": {
    "backtest": "backtest"
  },
  "output_worksheet": "trade_bars",

  "architecture": {
    "type": "bar_by_bar",
    "description": "One row per M5 bar within each trade (entry_time to exit_time)",
    "row_count": "Variable - depends on trade duration",
    "purpose": "Granular visibility into trade progression for analysis and rule development",
    "total_columns": 25,
    "column_range": "A-Y"
  },

  "source_inputs": {
    "backtest": {
      "_description": "Trade context (v2.3 format)",
      "_columns": "A-U",
      "key_columns": {
        "trade_id": "A",
        "date": "B",
        "ticker": "C",
        "direction": "F",
        "entry_price": "I",
        "entry_time": "J",
        "stop_price": "K",
        "exit_time": "P"
      }
    },
    "polygon_api": {
      "_description": "External API for bar data and structure",
      "m5_bars": "Fetched per trade (entry_time to exit_time)",
      "m15_structure": "Fetched per trade date",
      "h1_structure": "Fetched per trade date",
      "h4_structure": "Fetched per trade date"
    }
  },

  "trade_bars_output": {
    "_description": "Bar-by-bar trade analysis (v1.0: 25 columns, variable rows per trade)",
    "_total_columns": 25,
    "_column_range": "A-Y",
    "header_row": 1,
    "data_start_row": 2,

    "trade_bar_identification": {
      "_columns": "A-E",
      "_count": 5,
      "A": {"header": "trade_id", "type": "string", "description": "Trade identifier (e.g., AAPL_121923_EPCH1_0945)"},
      "B": {"header": "event_seq", "type": "integer", "description": "Sequence within trade (0, 1, 2, ...)"},
      "C": {"header": "event_time", "type": "datetime", "description": "Bar open timestamp"},
      "D": {"header": "bars_from_entry", "type": "integer", "description": "0 for entry bar, increments each bar"},
      "E": {"header": "event_type", "type": "string", "values": ["ENTRY", "IN_TRADE", "EXIT"], "description": "Event type for this bar"}
    },

    "ohlcv": {
      "_columns": "F-J",
      "_count": 5,
      "_source": "Polygon API M5 bars",
      "F": {"header": "open_price", "type": "float", "description": "Bar open price"},
      "G": {"header": "high_price", "type": "float", "description": "Bar high price"},
      "H": {"header": "low_price", "type": "float", "description": "Bar low price"},
      "I": {"header": "close_price", "type": "float", "description": "Bar close price"},
      "J": {"header": "volume", "type": "integer", "description": "Bar volume"}
    },

    "r_value": {
      "_columns": "K",
      "_count": 1,
      "_calculation": "LONG: (close - entry) / (entry - stop), SHORT: (entry - close) / (stop - entry)",
      "K": {"header": "r_at_event", "type": "float", "description": "R-multiple at bar close"}
    },

    "health_score": {
      "_columns": "L",
      "_count": 1,
      "_source": "10-factor DOW_AI methodology",
      "L": {"header": "health_score", "type": "integer", "description": "0-10 health score at bar"}
    },

    "price_indicators": {
      "_columns": "M-O",
      "_count": 3,
      "_source": "indicator_calc.py",
      "M": {"header": "vwap", "type": "float", "description": "VWAP at bar"},
      "N": {"header": "sma9", "type": "float", "description": "9-period SMA at bar"},
      "O": {"header": "sma21", "type": "float", "description": "21-period SMA at bar"}
    },

    "volume_indicators": {
      "_columns": "P-R",
      "_count": 3,
      "_source": "indicator_calc.py",
      "P": {"header": "vol_roc", "type": "float", "description": "Volume ROC % (vs 20-bar avg)"},
      "Q": {"header": "vol_delta", "type": "float", "description": "Bar delta (volume * position multiplier)"},
      "R": {"header": "cvd_slope", "type": "float", "description": "CVD slope (normalized -1 to 1)"}
    },

    "sma_analysis": {
      "_columns": "S-T",
      "_count": 2,
      "_source": "indicator_calc.py",
      "S": {"header": "sma_spread", "type": "float", "description": "SMA9 - SMA21"},
      "T": {"header": "sma_momentum", "type": "string", "values": ["WIDENING", "NARROWING", "FLAT"], "description": "SMA spread direction"}
    },

    "structure": {
      "_columns": "U-X",
      "_count": 4,
      "_source": "structure_analyzer.py",
      "U": {"header": "m5_structure", "type": "string", "values": ["BULL", "BEAR", "NEUTRAL"], "description": "M5 market structure"},
      "V": {"header": "m15_structure", "type": "string", "values": ["BULL", "BEAR", "NEUTRAL"], "description": "M15 market structure"},
      "W": {"header": "h1_structure", "type": "string", "values": ["BULL", "BEAR", "NEUTRAL"], "description": "H1 market structure"},
      "X": {"header": "h4_structure", "type": "string", "values": ["BULL", "BEAR", "NEUTRAL"], "description": "H4 market structure"}
    },

    "health_summary": {
      "_columns": "Y",
      "_count": 1,
      "_source": "health_calculator.py",
      "Y": {"header": "health_summary", "type": "string", "values": ["STRONG", "MODERATE", "WEAK", "CRITICAL"], "description": "Health label based on score"}
    }
  },

  "event_types": {
    "ENTRY": {
      "description": "First bar of the trade",
      "bars_from_entry": "Always 0",
      "event_seq": "0"
    },
    "IN_TRADE": {
      "description": "All bars between entry and exit",
      "bars_from_entry": "1, 2, 3, ...",
      "event_seq": "1, 2, 3, ..."
    },
    "EXIT": {
      "description": "Last bar of the trade",
      "bars_from_entry": "Total bars - 1",
      "event_seq": "Total bars - 1"
    }
  },

  "same_bar_trade_handling": {
    "description": "When entry_time == exit_time (trade opens and closes on same bar)",
    "row_1": {"event_seq": 0, "event_type": "ENTRY"},
    "row_2": {"event_seq": 1, "event_type": "EXIT"},
    "note": "Both rows have identical bar data"
  },

  "health_score_methodology": {
    "_description": "10-factor DOW_AI health score",
    "factors": {
      "1": {"name": "H4 Structure", "points": 1},
      "2": {"name": "H1 Structure", "points": 1},
      "3": {"name": "M15 Structure", "points": 1},
      "4": {"name": "M5 Structure", "points": 1},
      "5": {"name": "Volume ROC", "points": 1, "threshold": ">+20%"},
      "6": {"name": "Volume Delta", "points": 1, "method": "bar_position"},
      "7": {"name": "CVD Direction", "points": 1, "threshold": "+/-0.1 slope"},
      "8": {"name": "SMA Alignment", "points": 1},
      "9": {"name": "SMA Spread Momentum", "points": 1},
      "10": {"name": "VWAP Location", "points": 1}
    },
    "labels": {
      "STRONG": "8-10 points",
      "MODERATE": "6-7 points",
      "WEAK": "4-5 points",
      "CRITICAL": "0-3 points"
    }
  },

  "r_calculation": {
    "LONG": "(close_price - entry_price) / (entry_price - stop_price)",
    "SHORT": "(entry_price - close_price) / (stop_price - entry_price)"
  },

  "key_analysis_columns": {
    "_description": "Most important columns for analysis",
    "E_event_type": "Filter to specific trade phases",
    "K_r_at_event": "Track R progression during trade",
    "L_health_score": "Monitor health changes bar-by-bar",
    "T_sma_momentum": "Track trend strength changes",
    "U_m5_structure": "Detect structure flips"
  },

  "analysis_queries": {
    "excel_filters": [
      "Filter event_type = 'ENTRY', analyze starting health scores",
      "Filter bars_from_entry = 5, compare winning vs losing trades",
      "Filter health_score < 5, see where trades weakened",
      "Filter trade_id = specific trade for full progression"
    ],
    "pivot_tables": [
      "Rows: bars_from_entry, Values: Avg health_score",
      "Rows: health_summary, Values: Avg r_at_event",
      "Rows: m5_structure, Values: Count",
      "Rows: event_type, Values: Avg r_at_event"
    ],
    "pattern_discovery": [
      "Track how health decays during losing trades",
      "Identify when structure flips against trade",
      "Find optimal bars_from_entry for exit rules",
      "Correlate volume indicators with R changes"
    ]
  },

  "summary_statistics": {
    "_description": "Summary written below data",
    "sections": [
      "DATA OVERVIEW (rows, trades, avg bars/trade)",
      "EVENT BREAKDOWN (ENTRY/IN_TRADE/EXIT counts)",
      "HEALTH ANALYSIS (avg score, distribution)",
      "R-VALUE ANALYSIS (avg, max, min)",
      "M5 STRUCTURE BREAKDOWN (BULL/BEAR/NEUTRAL counts)"
    ]
  },

  "data_flow": {
    "backtest": "Trade ID, ticker, date, direction, entry/exit times, entry/stop prices",
    "polygon_api": "M5 bars for trade window, M15/H1/H4 structure data",
    "trade_bars": "One row per M5 bar with full indicator snapshot"
  },

  "workflow_order": {
    "1": "backtest_runner.py -> populates 'backtest'",
    "2": "trade_bars_runner.py -> populates 'trade_bars'"
  },

  "module_files": {
    "trade_bars_runner.py": "Main entry point, CLI runner",
    "trade_bars_builder.py": "Core logic - builds bar rows",
    "trade_bars_writer.py": "Excel batch writer",
    "trade_bars_config.py": "Column mappings and constants",
    "m5_fetcher.py": "M5 bar data from Polygon API",
    "indicator_calc.py": "Technical indicator calculations",
    "health_calculator.py": "10-factor health score",
    "structure_analyzer.py": "Multi-timeframe structure",
    "credentials.py": "Polygon API key"
  },

  "version_history": {
    "v1.0.0": "Initial release - 25 columns (A-Y), bar-by-bar analysis"
  }
}
