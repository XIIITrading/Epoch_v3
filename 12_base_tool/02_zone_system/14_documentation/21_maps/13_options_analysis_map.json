{
  "_comment": "Epoch Trading System - Options Analysis Cell Map",
  "_version": "1.0.0",
  "_organization": "XIII Trading LLC",
  "_module": "09_backtest/processor/options_analysis",
  "_description": "Cell mappings for options analysis - Stage 5 of Backtest Pipeline",
  "_directory": "02_zone_system/09_backtest/processor/options_analysis/",

  "input_worksheets": {
    "backtest": "backtest"
  },
  "output_worksheet": "options_analysis",

  "architecture": {
    "type": "1:1",
    "description": "1 row per trade - options overlay on completed backtest trades",
    "purpose": "Analyze hypothetical options trades based on equity entry/exit signals",
    "total_columns": 22,
    "column_range": "A-V"
  },

  "source_input": {
    "backtest": {
      "_description": "Completed trades from backtest worksheet (v2.3 format)",
      "_columns": "A-U",
      "key_columns": {
        "trade_id": "A",
        "date": "B",
        "ticker": "C",
        "model": "D",
        "zone_type": "E",
        "direction": "F",
        "zone_high": "G",
        "zone_low": "H",
        "entry_price": "I",
        "entry_time": "J",
        "stop_price": "K",
        "target_3r": "L",
        "target_calc": "M",
        "target_used": "N",
        "exit_price": "O",
        "exit_time": "P",
        "exit_reason": "Q",
        "pnl_dollars": "R",
        "pnl_r": "S",
        "risk": "T",
        "win": "U"
      }
    }
  },

  "options_analysis_output": {
    "_description": "Options analysis results (v1.0: 22 columns)",
    "_total_columns": 22,
    "_column_range": "A-V",
    "header_row": 1,
    "data_start_row": 2,

    "trade_identification": {
      "_columns": "A-F",
      "_count": 6,
      "_source": "backtest",
      "A": {"header": "Trade_ID", "type": "string", "description": "Join key to backtest worksheet"},
      "B": {"header": "Ticker", "type": "string", "description": "Underlying symbol (e.g., AAPL)"},
      "C": {"header": "Direction", "type": "string", "description": "LONG or SHORT"},
      "D": {"header": "Entry_Date", "type": "date", "description": "Trade date (YYYY-MM-DD)"},
      "E": {"header": "Entry_Time", "type": "time", "description": "Equity entry time"},
      "F": {"header": "Entry_Price", "type": "float", "format": "$#,##0.00", "description": "Underlying entry price"}
    },

    "contract_selection": {
      "_columns": "G-J",
      "_count": 4,
      "_source": "polygon_api",
      "_note": "Selected options contract details",
      "G": {"header": "Options_Ticker", "type": "string", "description": "Full options ticker (e.g., O:AAPL250117C00175000)"},
      "H": {"header": "Strike", "type": "float", "format": "$#,##0.00", "description": "Selected strike price"},
      "I": {"header": "Expiration", "type": "date", "description": "Contract expiration date (YYYY-MM-DD)"},
      "J": {"header": "Contract_Type", "type": "string", "values": ["CALL", "PUT"], "description": "CALL for LONG trades, PUT for SHORT trades"}
    },

    "options_trade_data": {
      "_columns": "K-N",
      "_count": 4,
      "_source": "polygon_api",
      "_note": "Entry and exit prices from options bars",
      "K": {"header": "Option_Entry_Price", "type": "float", "format": "$#,##0.00", "description": "Options premium at entry (15-second bar close)"},
      "L": {"header": "Option_Entry_Time", "type": "time", "description": "Matched options bar timestamp"},
      "M": {"header": "Option_Exit_Price", "type": "float", "format": "$#,##0.00", "description": "Options premium at exit (5-minute bar close)"},
      "N": {"header": "Option_Exit_Time", "type": "time", "description": "Matched options bar timestamp"}
    },

    "pnl_metrics": {
      "_columns": "O-R",
      "_count": 4,
      "_source": "derived",
      "_note": "Calculated P&L metrics for options trade",
      "O": {"header": "PnL_Dollars", "type": "float", "format": "$#,##0.00", "description": "Dollar P&L per contract ((exit - entry) * 100)"},
      "P": {"header": "PnL_Percent", "type": "float", "format": "0.00%", "description": "Percentage return on premium"},
      "Q": {"header": "Option_R", "type": "float", "format": "0.00", "description": "R-multiple for options trade"},
      "R": {"header": "Net_Return", "type": "float", "format": "0.00%", "description": "Net return percentage (same as PnL_Percent)"}
    },

    "comparison_metrics": {
      "_columns": "S-U",
      "_count": 3,
      "_source": "derived",
      "_note": "Compare options performance to underlying",
      "S": {"header": "Underlying_R", "type": "float", "format": "0.00", "description": "Original underlying trade R-multiple"},
      "T": {"header": "R_Multiplier", "type": "float", "format": "0.00", "description": "Option_R / Underlying_R (>1 = options outperformed)"},
      "U": {"header": "Win", "type": "integer", "values": [0, 1], "description": "1=Win (P&L > 0), 0=Loss"}
    },

    "status": {
      "_columns": "V",
      "_count": 1,
      "_source": "derived",
      "V": {"header": "Status", "type": "string", "description": "Processing status"}
    }
  },

  "status_codes": {
    "SUCCESS": "Trade processed successfully with options data",
    "INVALID_DATA": "Missing required trade data (price, date, ticker)",
    "NO_CHAIN": "No options chain available for this underlying",
    "NO_CONTRACT": "No suitable contract found matching selection criteria",
    "NO_ENTRY_BARS": "No 15-second bars available at entry time",
    "NO_EXIT_BARS": "No 5-minute bars available at exit time",
    "NO_MATCHING_BARS": "Could not match bars to entry/exit times"
  },

  "r_calculation": {
    "_description": "How Options R is calculated",
    "formula": "Options R = Options Dollar P&L / (Underlying Risk * 100)",
    "example": {
      "option_entry": "$5.00",
      "option_exit": "$7.50",
      "underlying_risk": "$2.00",
      "calculation": "((7.50 - 5.00) * 100) / (2.00 * 100) = 250 / 200 = 1.25R"
    },
    "interpretation": {
      "positive_r": "Options trade was profitable",
      "negative_r": "Options trade was a loss",
      "r_multiplier_gt_1": "Options outperformed underlying equity trade",
      "r_multiplier_lt_1": "Options underperformed underlying equity trade"
    }
  },

  "contract_selection_logic": {
    "_description": "How options contracts are selected",
    "selection_method": "FIRST_ITM",
    "methods_available": ["FIRST_ITM", "ATM", "FIRST_OTM"],
    "contract_type_logic": {
      "LONG_trade": "Buy CALL option",
      "SHORT_trade": "Buy PUT option"
    },
    "strike_selection": {
      "FIRST_ITM": {
        "LONG_calls": "Highest strike below entry price",
        "SHORT_puts": "Lowest strike above entry price"
      },
      "ATM": "Strike closest to entry price",
      "FIRST_OTM": {
        "LONG_calls": "Lowest strike above entry price",
        "SHORT_puts": "Highest strike below entry price"
      }
    },
    "expiration_selection": "First expiration at least 2 days after exit date"
  },

  "bar_timeframes": {
    "entry": {
      "multiplier": 15,
      "timespan": "second",
      "description": "15-second bars to match S15 equity entry precision"
    },
    "exit": {
      "multiplier": 5,
      "timespan": "minute",
      "description": "5-minute bars to match M5 equity exit timeframe"
    }
  },

  "api_integration": {
    "provider": "Polygon.io",
    "endpoints": {
      "options_chain": "/v3/snapshot/options/{underlyingAsset}",
      "options_bars": "/v2/aggs/ticker/{optionsTicker}/range/{multiplier}/{timespan}/{from}/{to}"
    },
    "rate_limiting": {
      "delay_between_calls": "0.25 seconds",
      "retries": 3,
      "retry_delay": "2.0 seconds"
    }
  },

  "data_flow": {
    "step_1": "Read completed trades from backtest worksheet",
    "step_2": "For each trade, fetch options chain from Polygon API",
    "step_3": "Select appropriate contract (CALL for LONG, PUT for SHORT)",
    "step_4": "Fetch 15-second bars for entry timing",
    "step_5": "Fetch 5-minute bars for exit timing",
    "step_6": "Match bars to entry/exit times",
    "step_7": "Calculate P&L, R-multiple, Net Returns",
    "step_8": "Write results to options_analysis worksheet"
  },

  "workflow_order": {
    "1": "backtest_runner.py -> populates 'backtest'",
    "2": "entry_runner.py -> populates 'entry_events'",
    "3": "exit_runner.py -> populates 'exit_events'",
    "4": "optimal_runner.py -> populates 'optimal_trade'",
    "5": "options_runner.py -> populates 'options_analysis'"
  },

  "module_files": {
    "options_runner.py": "Main orchestrator - reads trades, coordinates analysis, writes results",
    "options_fetcher.py": "Polygon API client - fetches options chains and OHLC bars",
    "contract_selector.py": "Contract selection logic (modifiable strike/expiration rules)",
    "options_calculator.py": "P&L calculations - R-multiple, Net Returns, summary stats",
    "options_events_writer.py": "Excel output writer - 22 columns to options_analysis worksheet",
    "options_config.py": "Configuration settings - API params, file paths, defaults"
  },

  "key_analysis_columns": {
    "_description": "Most important columns for options analysis",
    "Q_Option_R": "Options trade R-multiple - compare to underlying R",
    "T_R_Multiplier": "Leverage ratio - how much options amplified returns",
    "P_PnL_Percent": "Net return on options premium",
    "U_Win": "Binary outcome for filtering winners/losers"
  },

  "summary_statistics": {
    "_description": "Summary stats written below data",
    "location": "Starting 2 rows below last data row",
    "metrics": [
      "Total Trades",
      "Successful (with options data)",
      "Failed (no options data)",
      "Wins / Losses / Win Rate",
      "Total P&L ($)",
      "Avg P&L ($ and %)",
      "Total R / Avg R / Best R / Worst R",
      "Avg R Multiplier",
      "Trades Outperformed Underlying"
    ]
  },

  "version_history": {
    "v1.0.0": "Initial release - 22 columns (A-V), Polygon API integration, FIRST_ITM selection"
  }
}
