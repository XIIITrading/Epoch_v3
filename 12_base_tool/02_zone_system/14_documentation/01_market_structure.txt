================================================================================
EPOCH TRADING SYSTEM - MODULE 01: MARKET STRUCTURE
XIII Trading LLC | Documentation v1.0
================================================================================

PURPOSE
-------
Determines Bull/Bear market direction for SPY, QQQ, DIA across four timeframes
(D1, H4, H1, M15) using fractal-based structure analysis. Outputs direction,
strong levels (invalidation), weak levels (continuation), and weighted composite
to Excel for real-time monitoring.

DIRECTORY
---------
02_zone_system/01_market_structure/

================================================================================
FILE INVENTORY
================================================================================

FILE: epoch_market_structure_config.py
--------------------------------------
Role: Central configuration hub - ALL system settings live here.

Contains:
  - POLYGON_API_KEY, POLYGON_BASE_URL
  - TIMEFRAMES dict: D1/H4/H1/M15/M1 with polygon_timespan, multiplier, 
    bars_needed, weight
  - FRACTAL_LENGTH = 5 (bars each side for fractal detection)
  - EXCEL_FILEPATH: C:\XIIITradingSystems\Epoch\epoch_v1.xlsm
  - WORKSHEET_NAME: 'market_overview'
  - MARKET_TICKERS: SPY(row 29), QQQ(row 30), DIA(row 31)
  - COLUMNS dict: Maps data fields to Excel columns B-R
  - DATA_LOOKBACK_DAYS: D1=250, H4=100, H1=50, M15=15, M1=2
  - API rate limiting: 0.25s delay, 3 retries, 2s retry delay

Key Functions:
  - get_cell_reference(row, column) -> "B29"
  - get_ticker_row(ticker) -> row number
  - format_ticker_id(ticker) -> "SPY_112525"
  - format_price(price) -> "580.50" or "NULL"
  - calculate_weighted_direction(results) -> "Bull+", "Bull", "Bear+", "Bear"

Weighting Logic (calculate_weighted_direction):
  D1: 1.5, H4: 1.5, H1: 1.0, M15: 0.5
  Bull+ if bull_score >= 3.5
  Bear+ if bear_score >= 3.5
  Tie uses M15 as tiebreaker, defaults to Bear

Request this file for: API settings, timeframe configs, Excel mappings,
weighting adjustments, ticker row assignments.

--------------------------------------------------------------------------------

FILE: polygon_data_fetcher.py
-----------------------------
Role: Polygon.io API integration for OHLC bar retrieval.

Class: PolygonDataFetcher
  __init__(api_key=None): Uses config key if not provided
  
  _rate_limit(): Enforces API_RATE_LIMIT_DELAY between calls
  
  _make_request(url, params) -> dict or None:
    - Handles retries, rate limit 429 responses
    - Returns None on failure
  
  fetch_bars(ticker, timeframe, from_date, to_date) -> DataFrame:
    - Builds URL: /v2/aggs/ticker/{ticker}/range/{mult}/{timespan}/{from}/{to}
    - Returns columns: timestamp, open, high, low, close, volume
    - Converts timestamp from ms to datetime
  
  fetch_bars_for_structure(ticker, timeframe) -> DataFrame:
    - Auto-calculates date range from DATA_LOOKBACK_DAYS
    - Validates minimum bars (bars_needed from config)
    - Returns None if insufficient data

Request this file for: API call issues, data retrieval problems, adding new
data sources, modifying fetch logic.

--------------------------------------------------------------------------------

FILE: market_structure_calculator.py
------------------------------------
Role: Core algorithm - fractal detection, BOS/ChoCH identification, direction.

Class: MarketStructureCalculator
  __init__(fractal_length=None): Defaults to config.FRACTAL_LENGTH (5)
  
  _detect_fractals(df) -> (bullish_series, bearish_series):
    - Bullish fractal: local LOW (bars before/after have higher lows)
    - Bearish fractal: local HIGH (bars before/after have lower highs)
    - Uses p = length/2 bars each side
  
  _calculate_structure(df) -> DataFrame with added columns:
    - bullish_fractal, bearish_fractal (bool)
    - upper_fractal_value, lower_fractal_value (float)
    - upper_crossed, lower_crossed (bool)
    - structure: 1=Bull, -1=Bear, 0=Neutral
    - structure_label: 'BOS', 'ChoCH', or ''
    - bull_continuation_high, bear_continuation_low (tracking extremes)
  
  calculate(df) -> dict:
    Returns:
      direction: 1, -1, or 0
      direction_label: 'BULL', 'BEAR', 'NEUTRAL', 'ERROR'
      strong_level: Invalidation level (ChoCH trigger)
        - Bull: lower_fractal_value (support)
        - Bear: upper_fractal_value (resistance)
      weak_level: Continuation level
        - Bull: highest high since structure turned bullish
        - Bear: lowest low since structure turned bearish
      last_structure_break: Index of last BOS/ChoCH
      last_structure_label: 'BOS' or 'ChoCH'
      df: Full calculated DataFrame

Structure Break Logic:
  - Close > upper_fractal triggers bullish break
  - Close < lower_fractal triggers bearish break
  - BOS: Break in same direction as current structure
  - ChoCH: Break reversing current structure

Request this file for: Structure calculation issues, fractal detection tuning,
strong/weak level logic, adding new structure indicators.

--------------------------------------------------------------------------------

FILE: market_structure_runner.py
--------------------------------
Role: Main execution script - orchestrates fetch, calculate, Excel write.

Functions:
  connect_to_workbook() -> xlwings workbook
  
  fetch_ticker_data(ticker, fetcher) -> dict[timeframe: DataFrame]:
    - Fetches D1, H4, H1, M15 for one ticker
    - Returns None if any timeframe fails
  
  fetch_scan_price_data(ticker, fetcher) -> DataFrame:
    - Fetches M1 data for most recent price (includes pre-market)
  
  calculate_all_structures(ticker, data, calculator) -> dict[timeframe: result]:
    - Runs calculator.calculate() on each timeframe
  
  get_scan_price(df_m1) -> float:
    - Returns last close from M1 data
  
  write_ticker_results(ws, ticker, scan_price, results, composite):
    - Writes to Excel row based on ticker
    - Column mapping:
      B: ticker_id (SPY_112525)
      C: ticker
      D: datetime
      E: scan_price
      F-H: D1 (dir, strong, weak)
      I-K: H4 (dir, strong, weak)
      L-N: H1 (dir, strong, weak)
      O-Q: M15 (dir, strong, weak)
      R: composite
  
  run():
    - Main workflow: connect -> init components -> process tickers -> save

Execution Flow:
  1. Connect to Excel workbook
  2. Initialize PolygonDataFetcher and MarketStructureCalculator
  3. For each ticker in [SPY, QQQ, DIA]:
     a. Fetch D1/H4/H1/M15 data
     b. Calculate structure for each timeframe
     c. Calculate weighted composite
     d. Fetch M1 for scan price (fallback to D1)
     e. Write all results to ticker's row
  4. Save workbook

Request this file for: Workflow modifications, adding tickers, Excel output
changes, execution sequencing issues.

================================================================================
EXCEL OUTPUT STRUCTURE
================================================================================

Worksheet: market_overview
Rows: 29 (SPY), 30 (QQQ), 31 (DIA)

Column Layout:
  B: Ticker ID (SPY_112525 format)
  C: Ticker symbol
  D: Run datetime
  E: Scan price (M1 close)
  F: D1 Direction (Bull/Bear/Neutral/ERROR)
  G: D1 Strong Level
  H: D1 Weak Level
  I-K: H4 (same pattern)
  L-N: H1 (same pattern)
  O-Q: M15 (same pattern)
  R: Composite (Bull+/Bull/Bear+/Bear)

================================================================================
KEY CONCEPTS
================================================================================

FRACTAL DETECTION
- Bearish fractal: Bar with highest high among 5 surrounding bars (local peak)
- Bullish fractal: Bar with lowest low among 5 surrounding bars (local trough)
- Detection requires 2 bars before and 2 bars after the pivot bar

STRUCTURE BREAKS
- BOS (Break of Structure): Price breaks fractal in direction of trend
- ChoCH (Change of Character): Price breaks fractal against current trend

STRONG vs WEAK LEVELS
- Strong Level: If broken, triggers ChoCH (structure reversal)
  - Bull market: Last bullish fractal low (support)
  - Bear market: Last bearish fractal high (resistance)
- Weak Level: Continuation target
  - Bull market: Highest high since bullish structure began
  - Bear market: Lowest low since bearish structure began

WEIGHTED COMPOSITE
- Combines all timeframes with weights: D1(1.5), H4(1.5), H1(1.0), M15(0.5)
- Max possible score: 4.5
- Bull+/Bear+: Score >= 3.5 in that direction
- Ties resolved by M15, default Bear if still tied

================================================================================
DEPENDENCIES
================================================================================

Python Packages:
  - pandas, numpy (data handling)
  - requests (API calls)
  - xlwings (Excel integration)

External:
  - Polygon.io API (requires valid API key)
  - Excel workbook: C:\XIIITradingSystems\Epoch\epoch_v1.xlsm
  - Worksheet 'market_overview' with rows 29-31 available

================================================================================
COMMON MODIFICATION SCENARIOS
================================================================================

Add new ticker:
  -> epoch_market_structure_config.py: Add to MARKET_TICKERS, TICKER_ORDER

Change timeframe weights:
  -> epoch_market_structure_config.py: TIMEFRAMES dict (weight key)
  -> epoch_market_structure_config.py: calculate_weighted_direction()

Adjust fractal sensitivity:
  -> epoch_market_structure_config.py: FRACTAL_LENGTH

Change Excel output location:
  -> epoch_market_structure_config.py: EXCEL_FILEPATH, WORKSHEET_NAME, COLUMNS

Modify structure logic:
  -> market_structure_calculator.py: _calculate_structure()

Add new data source:
  -> Create new fetcher class following polygon_data_fetcher.py pattern

================================================================================
END OF DOCUMENTATION
================================================================================