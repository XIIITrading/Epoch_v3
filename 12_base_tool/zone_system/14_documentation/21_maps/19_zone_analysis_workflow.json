{
  "_comment": "Epoch Trading System - Master Workflow Map",
  "_version": "1.0.0",
  "_organization": "XIII Trading LLC",
  "_description": "Complete system workflow mapping all modules, worksheets, columns, and data flows",
  "_generated": "2025-12-24",
  "_purpose": "Single source of truth for the entire Epoch zone analysis pipeline",

  "system_overview": {
    "name": "Epoch Trading System",
    "version": "1.1",
    "architecture": "Excel-Python hybrid with Polygon API integration",
    "workbook": "epoch_v1.xlsm",
    "base_directory": "C:\\XIIITradingSystems\\Epoch\\02_zone_system",
    "total_modules": 10,
    "total_worksheets": 10,
    "api_provider": "Polygon.io"
  },

  "module_registry": {
    "01_market_structure": {
      "version": "1.0",
      "purpose": "SPY/QQQ/DIA market direction analysis",
      "directory": "01_market_structure/",
      "map_file": "01_market_structure_map.json"
    },
    "02_ticker_structure": {
      "version": "1.0",
      "purpose": "Dynamic ticker structure analysis (up to 10 tickers)",
      "directory": "02_ticker_structure/",
      "map_file": "02_ticker_structure_map.json"
    },
    "03_bar_data": {
      "version": "1.0",
      "purpose": "OHLC, ATR, Options levels, Camarilla pivots",
      "directory": "03_bar_data/",
      "map_file": "03_bar_data_map.json"
    },
    "04_hvn_identifier": {
      "version": "1.1",
      "purpose": "High Volume Node POC identification",
      "directory": "04_hvn_identifier/",
      "map_file": "04_hvn_identifier_map.json"
    },
    "05_raw_zones": {
      "version": "1.0",
      "purpose": "Confluence zone calculation and ranking (L1-L5)",
      "directory": "05_raw_zones/",
      "map_file": "05_raw_zones_map.json"
    },
    "06_zone_results": {
      "version": "1.1",
      "purpose": "Filtered actionable zones with tier classification",
      "directory": "06_zone_results/",
      "map_file": "06_zone_results_map.json"
    },
    "07_setup_analysis": {
      "version": "1.1",
      "purpose": "Bull/bear setup identification and R:R calculation",
      "directory": "07_setup_analysis/",
      "map_file": "07_setup_analysis_map.json"
    },
    "08_visualization": {
      "version": "1.1",
      "purpose": "Chart generation and summary export",
      "directory": "08_visualization/",
      "map_file": "08_visualization_map.json"
    },
    "09_backtest": {
      "version": "2.3",
      "purpose": "End-of-day backtesting (EPCH1-4 models)",
      "directory": "09_backtest/",
      "map_file": "09_backtest_map.json",
      "subsystems": {
        "entry_events": {
          "version": "4.1.0",
          "purpose": "Entry enrichment with DOW_AI health scoring",
          "map_file": "10_bt_entry_events_map.json"
        },
        "exit_events": {
          "version": "3.2.0",
          "purpose": "Event tracking during trades",
          "map_file": "11_bt_exit_events_map.json"
        },
        "optimal_trade": {
          "version": "3.1.0",
          "purpose": "Expanded bar-by-bar analysis with decay",
          "map_file": "12_bt_optimal_trades.json"
        },
        "options_analysis": {
          "version": "1.0.0",
          "purpose": "Hypothetical options trade analysis",
          "map_file": "13_options_analysis_map.json"
        }
      }
    },
    "10_results_analysis": {
      "version": "1.2",
      "purpose": "Backtest results analysis and export",
      "directory": "10_results_analysis/",
      "map_file": "16_results_analysis_map.json"
    }
  },

  "worksheet_registry": {
    "market_overview": {
      "purpose": "Market and ticker structure with levels",
      "written_by": ["01_market_structure", "02_ticker_structure"],
      "read_by": ["04_hvn_identifier", "05_raw_zones", "07_setup_analysis", "08_visualization", "09_backtest"],
      "sections": {
        "index_structure": {"rows": "29-31", "columns": "B-R", "description": "SPY/QQQ/DIA market direction"},
        "ticker_structure": {"rows": "36-45", "columns": "B-S", "description": "10 dynamic tickers with structure"}
      }
    },
    "bar_data": {
      "purpose": "OHLC, HVN POCs, ATR, Camarilla levels",
      "written_by": ["03_bar_data", "04_hvn_identifier"],
      "read_by": ["05_raw_zones", "06_zone_results", "07_setup_analysis", "08_visualization"],
      "sections": {
        "ticker_structure": {"rows": "4-13", "columns": "B-E", "description": "Ticker metadata and price"},
        "monthly_metrics": {"rows": "17-26", "columns": "B-L", "description": "Monthly OHLC"},
        "weekly_metrics": {"rows": "31-40", "columns": "B-L", "description": "Weekly OHLC"},
        "daily_metrics": {"rows": "45-54", "columns": "B-L", "description": "Daily OHLC"},
        "time_hvn": {"rows": "59-68", "columns": "B-O", "description": "HVN POC1-10"},
        "on_options_metrics": {"rows": "73-82", "columns": "B-T", "description": "ON levels, Options, ATR"},
        "add_metrics": {"rows": "86-95", "columns": "B-V", "description": "Camarilla pivots"}
      }
    },
    "raw_zones": {
      "purpose": "All calculated zones (L1-L5) with scores",
      "written_by": ["05_raw_zones"],
      "read_by": ["06_zone_results"],
      "columns": {"range": "A-M", "count": 13},
      "key_columns": {
        "A": "ticker_id", "B": "ticker", "C": "date", "D": "price", "E": "direction",
        "F": "zone_id", "G": "hvn_poc", "H": "zone_high", "I": "zone_low",
        "J": "overlaps", "K": "score", "L": "rank", "M": "confluences"
      }
    },
    "zone_results": {
      "purpose": "Filtered actionable zones with setups",
      "written_by": ["06_zone_results", "07_setup_analysis"],
      "read_by": ["08_visualization", "09_backtest"],
      "columns": {"range": "A-T", "count": 20},
      "key_columns": {
        "A-M": "Zone data (from raw_zones)",
        "N": "tier (T1/T2/T3)",
        "O": "epch_bull", "P": "epch_bear",
        "Q": "epch_bull_price", "R": "epch_bear_price",
        "S": "epch_bull_target", "T": "epch_bear_target"
      }
    },
    "Analysis": {
      "purpose": "Primary/secondary setups and PineScript strings",
      "written_by": ["07_setup_analysis"],
      "read_by": ["08_visualization", "09_backtest"],
      "sections": {
        "primary_section": {"rows": "31-40", "columns": "B-L", "description": "Primary setups with tier"},
        "secondary_section": {"rows": "31-40", "columns": "N-X", "description": "Secondary setups with tier"},
        "setup_strings": {"rows": "44-53", "columns": "B-C", "description": "PineScript strings"}
      }
    },
    "backtest": {
      "purpose": "Trade log with outcomes",
      "written_by": ["09_backtest"],
      "read_by": ["entry_events", "exit_events", "optimal_trade", "options_analysis", "10_results_analysis"],
      "columns": {"range": "A-U", "count": 21},
      "key_columns": {
        "A": "trade_id", "B": "date", "C": "ticker", "D": "model", "E": "zone_type",
        "F": "direction", "G": "zone_high", "H": "zone_low", "I": "entry_price",
        "J": "entry_time", "K": "stop_price", "L": "target_3r", "M": "target_calc",
        "N": "target_used", "O": "exit_price", "P": "exit_time", "Q": "exit_reason",
        "R": "pnl_dollars", "S": "pnl_r", "T": "risk", "U": "win"
      }
    },
    "entry_events": {
      "purpose": "Entry enrichment with DOW_AI health scoring",
      "written_by": ["entry_events processor"],
      "read_by": ["exit_events", "optimal_trade", "10_results_analysis"],
      "columns": {"range": "A-AR", "count": 44},
      "key_columns": {
        "A": "Trade_ID (join key)",
        "B-I": "VWAP analysis (8 cols)",
        "J-M": "SMA analysis (4 cols)",
        "N-V": "Volume analysis (9 cols)",
        "W-AF": "Multi-timeframe structure (10 cols)",
        "AG-AJ": "Health score (4 cols)",
        "AK-AN": "Alignment flags (4 cols)",
        "AO-AQ": "Processing metadata (3 cols)",
        "AR": "Win"
      }
    },
    "exit_events": {
      "purpose": "Event tracking during trades",
      "written_by": ["exit_events processor"],
      "read_by": ["optimal_trade", "10_results_analysis"],
      "columns": {"range": "A-AF", "count": 32},
      "architecture": "many:1 (multiple events per trade)",
      "key_columns": {
        "A": "Trade_ID", "B": "Event_Seq",
        "C-E": "Timing (3 cols)",
        "F-H": "Event details (3 cols)",
        "I-L": "Position at event (4 cols)",
        "M-O": "Price indicators (3 cols)",
        "P-S": "Volume analysis (4 cols)",
        "T-U": "SMA analysis (2 cols)",
        "V-Y": "Structure (4 cols)",
        "Z-AB": "Swing levels (3 cols)",
        "AC-AE": "Refined events (3 cols)",
        "AF": "Win"
      }
    },
    "optimal_trade": {
      "purpose": "Expanded bar-by-bar analysis for exit optimization",
      "written_by": ["optimal_trade processor"],
      "read_by": ["10_results_analysis"],
      "columns": {"range": "A-AS", "count": 45},
      "architecture": "expanded (1 row per bar per trade)",
      "key_columns": {
        "A-E": "Trade identification (5 cols)",
        "F-J": "Entry conditions (5 cols)",
        "K-R": "Bar data (8 cols)",
        "S-W": "Current state (5 cols)",
        "X-AB": "Comparison metrics (5 cols)",
        "AC-AL": "Decay analysis (10 cols)",
        "AM-AS": "Trade outcome (7 cols)"
      }
    },
    "options_analysis": {
      "purpose": "Hypothetical options trade analysis",
      "written_by": ["options_analysis processor"],
      "read_by": ["10_results_analysis"],
      "columns": {"range": "A-V", "count": 22},
      "key_columns": {
        "A-F": "Trade identification (6 cols)",
        "G-J": "Contract selection (4 cols)",
        "K-N": "Options trade data (4 cols)",
        "O-R": "P&L metrics (4 cols)",
        "S-U": "Comparison metrics (3 cols)",
        "V": "Status"
      }
    }
  },

  "execution_pipeline": {
    "pre_market_analysis": {
      "order": [1, 2, 3, 4, 5, 6, 7, 8],
      "stages": {
        "1": {
          "module": "01_market_structure",
          "script": "market_structure_runner.py",
          "input": "Polygon API (SPY, QQQ, DIA)",
          "output": "market_overview rows 29-31",
          "description": "Analyze index market direction"
        },
        "2": {
          "module": "02_ticker_structure",
          "script": "ticker_structure_runner.py",
          "input": "market_overview C36:C45 (tickers)",
          "output": "market_overview rows 36-45",
          "description": "Analyze ticker market direction"
        },
        "3": {
          "module": "03_bar_data",
          "script": "bar_data_runner.py",
          "input": "market_overview C36:C45 (tickers)",
          "output": "bar_data all sections",
          "description": "Fetch OHLC, calculate ATR, Camarilla"
        },
        "4": {
          "module": "04_hvn_identifier",
          "script": "hvn_runner.py",
          "input": "market_overview C36:C45, S36:S45",
          "output": "bar_data rows 59-68",
          "description": "Calculate HVN POC1-10"
        },
        "5": {
          "module": "05_raw_zones",
          "script": "raw_zones_runner.py",
          "input": "bar_data (all levels)",
          "output": "raw_zones worksheet",
          "description": "Calculate confluence zones L1-L5"
        },
        "6": {
          "module": "06_zone_results",
          "script": "zone_results_runner.py",
          "input": "raw_zones, bar_data (ATR)",
          "output": "zone_results A-N",
          "description": "Filter and tier-classify zones"
        },
        "7": {
          "module": "07_setup_analysis",
          "script": "setup_analysis_runner.py",
          "input": "zone_results, bar_data, market_overview",
          "output": "zone_results O-T, Analysis B31:X40",
          "description": "Identify bull/bear setups, calc targets"
        },
        "8": {
          "module": "08_visualization",
          "script": "visualization_runner.py",
          "input": "zone_results, Analysis, bar_data",
          "output": "PDF charts, summary tables",
          "description": "Generate charts and export"
        }
      }
    },
    "post_market_backtest": {
      "order": [1, 2, 3, 4, 5, 6],
      "stages": {
        "1": {
          "module": "09_backtest",
          "script": "bt_runner.py",
          "input": "zone_results, Analysis",
          "output": "backtest worksheet",
          "description": "Execute trades, log results"
        },
        "2": {
          "module": "09_backtest/entry_events",
          "script": "entry_runner.py",
          "input": "backtest worksheet",
          "output": "entry_events worksheet (44 cols)",
          "description": "Enrich entries with DOW_AI health"
        },
        "3": {
          "module": "09_backtest/exit_events",
          "script": "exit_runner.py",
          "input": "backtest, entry_events",
          "output": "exit_events worksheet (32 cols)",
          "description": "Track events during trades"
        },
        "4": {
          "module": "09_backtest/optimal_trade",
          "script": "optimal_runner.py",
          "input": "backtest, entry_events, exit_events",
          "output": "optimal_trade worksheet (45 cols)",
          "description": "Expanded bar-by-bar analysis"
        },
        "5": {
          "module": "09_backtest/options_analysis",
          "script": "options_runner.py",
          "input": "backtest worksheet",
          "output": "options_analysis worksheet (22 cols)",
          "description": "Analyze options equivalents"
        },
        "6": {
          "module": "10_results_analysis",
          "script": "results_runner.py",
          "input": "backtest, entry_events, exit_events, optimal_trade",
          "output": "JSON export, daily summary, SQLite",
          "description": "Aggregate and export results"
        }
      }
    }
  },

  "column_summary": {
    "total_unique_columns": 280,
    "by_worksheet": {
      "market_overview": 18,
      "bar_data": 22,
      "raw_zones": 13,
      "zone_results": 20,
      "Analysis": 22,
      "backtest": 21,
      "entry_events": 44,
      "exit_events": 32,
      "optimal_trade": 45,
      "options_analysis": 22
    }
  },

  "health_score_methodology": {
    "_description": "DOW_AI 10-factor health scoring (0-10)",
    "factors": {
      "1": {"id": "H4_STRUCTURE", "weight": 1, "logic": "LONG: H4=BULL | SHORT: H4=BEAR"},
      "2": {"id": "H1_STRUCTURE", "weight": 1, "logic": "LONG: H1=BULL | SHORT: H1=BEAR"},
      "3": {"id": "M15_STRUCTURE", "weight": 1, "logic": "LONG: M15=BULL | SHORT: M15=BEAR"},
      "4": {"id": "M5_STRUCTURE", "weight": 1, "logic": "LONG: M5=BULL | SHORT: M5=BEAR"},
      "5": {"id": "VOL_ROC", "weight": 1, "logic": "Vol_ROC > +20%"},
      "6": {"id": "VOL_DELTA", "weight": 1, "logic": "LONG: Delta > 0 | SHORT: Delta < 0"},
      "7": {"id": "CVD", "weight": 1, "logic": "LONG: Slope > 0.1 | SHORT: Slope < -0.1"},
      "8": {"id": "SMA_ALIGN", "weight": 1, "logic": "LONG: SMA9 > SMA21 | SHORT: SMA9 < SMA21"},
      "9": {"id": "SMA_MOMENTUM", "weight": 1, "logic": "SMA_Spread = WIDENING"},
      "10": {"id": "VWAP", "weight": 1, "logic": "LONG: Price > VWAP | SHORT: Price < VWAP"}
    },
    "labels": {
      "8-10": "STRONG",
      "6-7": "MODERATE",
      "4-5": "WEAK",
      "0-3": "CRITICAL"
    }
  },

  "tier_classification": {
    "_description": "Quality tier mapping from L-ranks",
    "mapping": {
      "L1": "T1",
      "L2": "T1",
      "L3": "T2",
      "L4": "T3",
      "L5": "T3"
    },
    "descriptions": {
      "T1": "Lower Quality (L1-L2)",
      "T2": "Medium Quality (L3)",
      "T3": "High Quality (L4-L5)"
    }
  },

  "entry_models": {
    "EPCH1": {"zone_type": "PRIMARY", "entry_type": "Continuation", "description": "Price traverses through primary zone"},
    "EPCH2": {"zone_type": "PRIMARY", "entry_type": "Rejection", "description": "Price rejects from primary zone"},
    "EPCH3": {"zone_type": "SECONDARY", "entry_type": "Continuation", "description": "Price traverses through secondary zone"},
    "EPCH4": {"zone_type": "SECONDARY", "entry_type": "Rejection", "description": "Price rejects from secondary zone"}
  },

  "exit_types": {
    "STOP": "Stop loss triggered (zone boundary + $0.05)",
    "TARGET_3R": "3R target hit",
    "TARGET_CALC": "Calculated target hit",
    "CHOCH": "Change of Character (M5 structure reversal)",
    "EOD": "End of Day forced exit (15:50 ET)"
  },

  "api_configuration": {
    "provider": "Polygon.io",
    "rate_limiting": {
      "delay_between_calls": 0.25,
      "max_retries": 3,
      "retry_delay": 2.0,
      "request_timeout": 30
    },
    "endpoints": {
      "aggregates": "/v2/aggs/ticker/{ticker}/range/{multiplier}/{timespan}/{from}/{to}",
      "options_chain": "/v3/snapshot/options/{underlyingAsset}",
      "options_bars": "/v2/aggs/ticker/{optionsTicker}/range/{multiplier}/{timespan}/{from}/{to}"
    }
  },

  "trading_session": {
    "timezone": "America/New_York",
    "entry_start": "09:30",
    "entry_end": "15:30",
    "force_exit": "15:50"
  },

  "data_lookback_periods": {
    "D1": {"days": 250, "description": "Daily bars"},
    "H4": {"days": 100, "description": "4-hour bars"},
    "H1": {"days": 50, "description": "Hourly bars"},
    "M15": {"days": 15, "description": "15-minute bars"},
    "M5": {"days": 5, "description": "5-minute bars"},
    "M1": {"days": 2, "description": "1-minute bars"}
  },

  "join_keys": {
    "backtest_to_entry_events": {"key": "trade_id", "relationship": "1:1"},
    "backtest_to_exit_events": {"key": "trade_id", "relationship": "1:many"},
    "backtest_to_optimal_trade": {"key": "trade_id", "relationship": "1:many"},
    "backtest_to_options_analysis": {"key": "trade_id", "relationship": "1:1"},
    "exit_events_uniqueness": {"key": "(trade_id, event_seq)", "relationship": "unique"}
  },

  "outputs": {
    "pre_market": {
      "pdf_charts": "08_visualization/pre_market_report_{date}.pdf",
      "summary_tables": "Analysis worksheet B2:AC12, B14:V24"
    },
    "post_market": {
      "json_export": "10_results_analysis/exports/epoch_analysis_{date}.json",
      "daily_summary": "10_results_analysis/exports/{date}_daily_summary.txt",
      "sqlite_database": "10_results_analysis/epoch_history.db"
    }
  },

  "version_summary": {
    "01_market_structure": "1.0",
    "02_ticker_structure": "1.0",
    "03_bar_data": "1.0",
    "04_hvn_identifier": "1.1",
    "05_raw_zones": "1.0",
    "06_zone_results": "1.1",
    "07_setup_analysis": "1.1",
    "08_visualization": "1.1",
    "09_backtest": "2.3",
    "09_backtest/entry_events": "4.1.0",
    "09_backtest/exit_events": "3.2.0",
    "09_backtest/optimal_trade": "3.1.0",
    "09_backtest/options_analysis": "1.0.0",
    "10_results_analysis": "1.2"
  },

  "documentation_files": {
    "maps": {
      "01_market_structure_map.json": "Market structure cell mappings",
      "02_ticker_structure_map.json": "Ticker structure cell mappings",
      "03_bar_data_map.json": "Bar data cell mappings",
      "04_hvn_identifier_map.json": "HVN identifier cell mappings",
      "05_raw_zones_map.json": "Raw zones cell mappings",
      "06_zone_results_map.json": "Zone results cell mappings",
      "07_setup_analysis_map.json": "Setup analysis cell mappings",
      "08_visualization_map.json": "Visualization cell mappings",
      "09_backtest_map.json": "Backtest cell mappings",
      "10_bt_entry_events_map.json": "Entry events cell mappings",
      "11_bt_exit_events_map.json": "Exit events cell mappings",
      "12_bt_optimal_trades.json": "Optimal trade cell mappings",
      "13_options_analysis_map.json": "Options analysis cell mappings",
      "16_results_analysis_map.json": "Results analysis cell mappings",
      "19_zone_analysis_workflow.json": "THIS FILE - Master workflow map"
    },
    "text_docs": {
      "01_market_structure.txt": "Market structure documentation",
      "02_ticker_structure.txt": "Ticker structure documentation",
      "03_bar_data.txt": "Bar data documentation",
      "04_hvn_identify.txt": "HVN identifier documentation",
      "05_raw_zones.txt": "Raw zones documentation",
      "06_zone_results.txt": "Zone results documentation",
      "07_setup_analysis.txt": "Setup analysis documentation",
      "13_options_analysis.txt": "Options analysis documentation"
    }
  }
}
