{
  "_comment": "Epoch Trading System - Backtest Exit Events Cell Map",
  "_version": "3.2.0",
  "_organization": "XIII Trading LLC",
  "_module": "09_backtest/processor/exit_events",
  "_description": "Cell mappings for exit events tracking subsystem (DOW_AI aligned + Win column)",
  "_directory": "02_zone_system/09_backtest/processor/exit_events/",

  "input_worksheets": {
    "backtest": "backtest",
    "entry_events": "entry_events"
  },
  "output_worksheet": "exit_events",

  "backtest_input": {
    "_description": "Trade data read from backtest worksheet",
    "_columns": "A-U",
    "key_columns": {
      "trade_id": "A",
      "date": "B",
      "ticker": "C",
      "direction": "F",
      "entry_price": "I",
      "entry_time": "J",
      "exit_price": "O",
      "exit_time": "P",
      "win": "U"
    }
  },

  "entry_events_input": {
    "_description": "Entry health scores (source of truth) - v4.1 format",
    "_columns": "A, AG",
    "key_columns": {
      "trade_id": "A",
      "health_score": "AG"
    }
  },

  "exit_events_output": {
    "_description": "Event tracking data (v3.2: DOW_AI aligned + Win column)",
    "_total_columns": 32,
    "_column_range": "A-AF",
    "header_row": 1,
    "data_start_row": 2,

    "core_identification": {
      "_columns": "A-E",
      "_count": 5,
      "A": {"header": "Trade_ID", "type": "string", "description": "Join key (NOT UNIQUE - multiple events per trade)"},
      "B": {"header": "Event_Seq", "type": "integer", "description": "Sequence within trade (1, 2, 3...)"},
      "C": {"header": "Event_Time", "type": "time", "description": "Timestamp when event occurred"},
      "D": {"header": "Bars_From_Entry", "type": "integer", "description": "M5 bars since entry"},
      "E": {"header": "Bars_From_MFE", "type": "integer", "description": "M5 bars since MFE"}
    },

    "event_details": {
      "_columns": "F-H",
      "_count": 3,
      "F": {"header": "Event_Type", "type": "string", "description": "Type of event (see event_types)"},
      "G": {"header": "From_State", "type": "string", "description": "Previous state value"},
      "H": {"header": "To_State", "type": "string", "description": "New state value"}
    },

    "position_at_event": {
      "_columns": "I-L",
      "_count": 4,
      "I": {"header": "Price_at_Event", "type": "float", "description": "Close price when event occurred"},
      "J": {"header": "R_at_Event", "type": "float", "description": "R-multiple at event time"},
      "K": {"header": "Health_Score", "type": "integer", "description": "Health score at event (0-10, DOW_AI)"},
      "L": {"header": "Health_Delta", "type": "integer", "description": "Change from entry health"}
    },

    "price_indicators": {
      "_columns": "M-O",
      "_count": 3,
      "M": {"header": "VWAP", "type": "float", "description": "VWAP at event time"},
      "N": {"header": "SMA9", "type": "float", "description": "SMA9 at event time"},
      "O": {"header": "SMA21", "type": "float", "description": "SMA21 at event time"}
    },

    "volume_analysis": {
      "_columns": "P-S",
      "_count": 4,
      "P": {"header": "Volume", "type": "integer", "description": "Volume of event bar"},
      "Q": {"header": "Vol_ROC", "type": "float", "description": "Volume ROC % vs 20-bar avg"},
      "R": {"header": "Vol_Delta", "type": "float", "description": "Bar delta (bar_position method)"},
      "S": {"header": "CVD_Slope", "type": "float", "description": "Normalized CVD slope"}
    },

    "sma_analysis": {
      "_columns": "T-U",
      "_count": 2,
      "T": {"header": "SMA_Spread", "type": "float", "description": "SMA9 - SMA21"},
      "U": {"header": "SMA_Momentum", "type": "string", "description": "WIDENING/NARROWING/FLAT"}
    },

    "multi_timeframe_structure": {
      "_columns": "V-Y",
      "_count": 4,
      "V": {"header": "M5_Structure", "type": "string", "description": "BULL/BEAR/NEUTRAL"},
      "W": {"header": "M15_Structure", "type": "string", "description": "BULL/BEAR/NEUTRAL"},
      "X": {"header": "H1_Structure", "type": "string", "description": "BULL/BEAR/NEUTRAL"},
      "Y": {"header": "H4_Structure", "type": "string", "description": "BULL/BEAR/NEUTRAL"}
    },

    "swing_levels": {
      "_columns": "Z-AB",
      "_count": 3,
      "Z": {"header": "Swing_High", "type": "float", "description": "Current M5 swing high"},
      "AA": {"header": "Swing_Low", "type": "float", "description": "Current M5 swing low"},
      "AB": {"header": "Bars_Since_Swing", "type": "integer", "description": "Bars since last swing"}
    },

    "refined_exit_events": {
      "_columns": "AC-AE",
      "_count": 3,
      "_new_in": "v3.1.0",
      "AC": {"header": "Health_Summary", "type": "string", "description": "IMPROVING/DEGRADING/STABLE"},
      "AD": {"header": "Event_Priority", "type": "string", "description": "HIGH/MEDIUM/LOW"},
      "AE": {"header": "Indicator_Changed", "type": "string", "description": "Comma-separated indicator IDs that changed"}
    },

    "trade_outcome": {
      "_columns": "AF",
      "_count": 1,
      "_new_in": "v3.2.0",
      "AF": {"header": "Win", "type": "integer", "description": "Trade outcome (1=Win, 0=Loss from backtest)"}
    }
  },

  "health_score_methodology": {
    "_description": "10 binary factors evaluated for health score (0-10) - DOW_AI aligned",
    "factors": {
      "1_h4_structure": "LONG: H4=BULL | SHORT: H4=BEAR",
      "2_h1_structure": "LONG: H1=BULL | SHORT: H1=BEAR",
      "3_m15_structure": "LONG: M15=BULL | SHORT: M15=BEAR",
      "4_m5_structure": "LONG: M5=BULL | SHORT: M5=BEAR",
      "5_vol_roc": "Vol_ROC > +20% (Above Avg)",
      "6_vol_delta": "LONG: Vol_Delta > 0 | SHORT: Vol_Delta < 0",
      "7_cvd": "LONG: CVD_Slope > 0.1 | SHORT: CVD_Slope < -0.1",
      "8_sma_align": "LONG: SMA9 > SMA21 | SHORT: SMA9 < SMA21",
      "9_sma_momentum": "SMA_Momentum = WIDENING",
      "10_vwap": "LONG: Price > VWAP | SHORT: Price < VWAP"
    },
    "labels": {
      "8-10": "STRONG",
      "6-7": "MODERATE",
      "4-5": "WEAK",
      "0-3": "CRITICAL"
    },
    "indicator_identifiers": [
      "H4_STRUCTURE", "H1_STRUCTURE", "M15_STRUCTURE", "M5_STRUCTURE",
      "VOL_ROC", "VOL_DELTA", "CVD", "SMA_ALIGN", "SMA_MOMENTUM", "VWAP"
    ]
  },

  "event_types": {
    "active_v3": {
      "core": {
        "ENTRY": "First event for every trade (event_seq = 1) - Priority: HIGH",
        "EXIT": "Final event for every trade - Priority: HIGH",
        "MFE": "Final Maximum Favorable Excursion (single event at trade exit) - Priority: HIGH",
        "MAE": "Final Maximum Adverse Excursion (single event at trade exit) - Priority: HIGH"
      },
      "health_events": {
        "HEALTH_CHANGE": "Health score changed by 1+ points - Priority: LOW/MEDIUM",
        "HEALTH_STRONG": "Score crossed from <8 to 8+ - Priority: HIGH",
        "HEALTH_WEAK": "Score crossed from >3 to 3 or below - Priority: HIGH",
        "HEALTH_CRITICAL": "Score crossed to 0 - Priority: HIGH"
      },
      "volume_events": {
        "VOLUME_ALIGNED": "All 3 volume factors support trade - Priority: MEDIUM",
        "VOLUME_OPPOSED": "All 3 volume factors oppose trade - Priority: MEDIUM"
      },
      "structure_flip_events": {
        "M5_FLIP_BULL": "M5 structure flipped bullish - Priority: HIGH",
        "M5_FLIP_BEAR": "M5 structure flipped bearish - Priority: HIGH",
        "M15_FLIP_BULL": "M15 structure flipped bullish - Priority: HIGH",
        "M15_FLIP_BEAR": "M15 structure flipped bearish - Priority: HIGH",
        "H1_FLIP_BULL": "H1 structure flipped bullish - Priority: HIGH",
        "H1_FLIP_BEAR": "H1 structure flipped bearish - Priority: HIGH",
        "H4_FLIP_BULL": "H4 structure flipped bullish - Priority: HIGH",
        "H4_FLIP_BEAR": "H4 structure flipped bearish - Priority: HIGH"
      }
    },
    "deprecated_v3": {
      "_description": "These event types retained for backward compatibility but no longer fire",
      "vwap_events": ["VWAP_LOST", "VWAP_REGAIN"],
      "sma_events": ["SMA9_LOST", "SMA9_REGAIN", "SMA21_LOST", "SMA21_REGAIN", "SMA_CROSS_BULL", "SMA_CROSS_BEAR"],
      "swing_events": ["HIGHER_HIGH", "LOWER_HIGH", "HIGHER_LOW", "LOWER_LOW"],
      "volume_legacy": ["VOLUME_SPIKE", "VOLUME_DRY", "VOLUME_NORMAL"]
    }
  },

  "event_priority_rules": {
    "HIGH": ["ENTRY", "EXIT", "MFE", "MAE", "HEALTH_STRONG", "HEALTH_WEAK", "HEALTH_CRITICAL", "*_FLIP_*"],
    "MEDIUM": ["HEALTH_CHANGE (delta >= 2)", "VOLUME_ALIGNED", "VOLUME_OPPOSED"],
    "LOW": ["HEALTH_CHANGE (delta = 1)"]
  },

  "mfe_mae_behavior": {
    "_description": "MFE and MAE now fire ONCE per trade at exit (not on every new extreme)",
    "event_order": "Chronological - whichever extreme occurred first appears first before EXIT",
    "example_long_trade": ["ENTRY", "HEALTH_CHANGE", "...", "MAE", "MFE", "EXIT"],
    "example_short_trade": ["ENTRY", "HEALTH_CHANGE", "...", "MFE", "MAE", "EXIT"]
  },

  "health_delta_interpretation": {
    "positive": "Conditions improved since entry",
    "zero": "Conditions unchanged",
    "negative": "Conditions degraded since entry"
  },

  "data_relationship": {
    "_description": "exit_events has many:1 relationship with backtest via trade_id",
    "join_key": "trade_id",
    "relationship": "many:1",
    "uniqueness": "(trade_id, event_seq) is unique"
  },

  "xlookup_formulas": {
    "_description": "Excel formulas to join with backtest and entry_events data",
    "from_backtest": {
      "get_ticker": "=XLOOKUP(A2, backtest!A:A, backtest!C:C)",
      "get_date": "=XLOOKUP(A2, backtest!A:A, backtest!B:B)",
      "get_direction": "=XLOOKUP(A2, backtest!A:A, backtest!F:F)",
      "get_entry_price": "=XLOOKUP(A2, backtest!A:A, backtest!I:I)",
      "get_pnl_r": "=XLOOKUP(A2, backtest!A:A, backtest!S:S)",
      "get_win": "=XLOOKUP(A2, backtest!A:A, backtest!U:U)",
      "get_exit_reason": "=XLOOKUP(A2, backtest!A:A, backtest!Q:Q)"
    },
    "from_entry_events": {
      "get_entry_health": "=XLOOKUP(A2, entry_events!A:A, entry_events!AG:AG)",
      "get_health_label": "=XLOOKUP(A2, entry_events!A:A, entry_events!AJ:AJ)",
      "get_m5_structure_at_entry": "=XLOOKUP(A2, entry_events!A:A, entry_events!W:W)",
      "get_h4_structure_at_entry": "=XLOOKUP(A2, entry_events!A:A, entry_events!Z:Z)"
    },
    "filter_high_priority": "=FILTER(A:AF,AD:AD=\"HIGH\")"
  },

  "workflow_order": {
    "1": "backtest_runner.py → populates 'backtest'",
    "2": "entry_runner.py → populates 'entry_events'",
    "3": "exit_runner.py → populates 'exit_events'"
  },

  "version_history": {
    "v3.2.0": "Added Win column (AF) from backtest - 32 columns",
    "v3.1.0": "Added health_summary, event_priority, indicator_changed - 31 columns",
    "v3.0.0": "DOW_AI aligned with full volume/SMA/structure tracking - 28 columns",
    "v2.0.0": "Lean architecture (removed date/ticker/direction) - 18 columns"
  }
}
