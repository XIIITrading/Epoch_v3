# DOW AI v1.2 - Complete Implementation Specification
## XIII Trading LLC | EPOCH Trading System
## Generated: 2026-01-24

---

# TABLE OF CONTENTS

1. [Executive Summary](#1-executive-summary)
2. [Baseline Performance (v1.0)](#2-baseline-performance-v10)
3. [Critical Bug Fixes](#3-critical-bug-fixes)
4. [New Direction Rules](#4-new-direction-rules)
5. [Indicator Logic Updates](#5-indicator-logic-updates)
6. [Prompt Template v1.2](#6-prompt-template-v12)
7. [Code Changes Required](#7-code-changes-required)
8. [Validation & Testing](#8-validation--testing)
9. [Success Metrics](#9-success-metrics)
10. [Future Roadmap](#10-future-roadmap)

---

# 1. EXECUTIVE SUMMARY

## Purpose
This document provides complete specifications for upgrading the EPOCH DOW AI Trading Assistant from v1.0 (baseline) to v1.2. The upgrade addresses critical logic bugs, adds direction-aware indicator interpretation, and introduces composite scoring to improve prediction accuracy.

## Key Changes in v1.2
1. **CRITICAL FIX**: Vol Delta status logic inverted for SHORT trades
2. **NEW**: Direction-specific interpretation rules in prompt
3. **NEW**: Composite Alignment Score calculation
4. **UPDATED**: Candle range threshold interpretation
5. **NEW**: Critical conflict detection rules
6. **UPDATED**: Confidence level assignment logic

## Expected Impact
| Metric | v1.0 Baseline | v1.2 Target |
|--------|---------------|-------------|
| Overall Accuracy | 53.8% | 60-65% |
| SHORT Accuracy | 57.2% | 65-68% |
| LONG Accuracy | 50.2% | 56-60% |
| False Positive Rate | 53.4% | <45% |

---

# 2. BASELINE PERFORMANCE (v1.0)

## Overall Metrics
```
Total Predictions:        3,579
Overall Accuracy:         53.8% (1,925 correct)
Actual Trade Win Rate:    43.8%

Prediction Distribution:
  - TRADE:                1,296 (36.2%)
  - NO_TRADE:             2,283 (63.8%)
```

## Confusion Matrix
```
                        Actual WIN    Actual LOSS
Predicted TRADE:            604           692
Predicted NO_TRADE:         962          1,321

Precision (TRADE):     46.6%
Recall (WIN detection): 38.6%
NO_TRADE on Losses:    65.6%
```

## Direction Performance
```
Direction     Total    Accuracy    Win Rate    NO_TRADE Rate
------------------------------------------------------------
LONG          1,757      50.2%       46.5%         48.5%
SHORT         1,822      57.3%       41.1%         78.5%
```

## Model Performance
```
Model    Direction    Accuracy    Win Rate
------------------------------------------
EPCH1    LONG          45.1%       37.4%
EPCH1    SHORT         64.4%       25.6%
EPCH2    LONG          52.0%       47.2%
EPCH2    SHORT         57.3%       41.8%
EPCH3    LONG          49.3%       34.2%
EPCH3    SHORT         58.5%       41.5%
EPCH4    LONG          48.6%       48.1%
EPCH4    SHORT         56.1%       42.2%
```

## Critical Issues Identified
1. Vol Delta status INVERTED for SHORT trades
2. No direction-specific indicator interpretation
3. SMA/H1 alignment not explicitly weighted
4. Candle range SKIP threshold too aggressive for LONGs

---

# 3. CRITICAL BUG FIXES

## 3.1 Vol Delta Status Logic (CRITICAL)

### Current Buggy Logic
**Location**: `batch_analyzer/prompts/batch_prompt.py` (lines 79-82)
**Location**: `entry_qualifier/ai/compact_prompt.py` (lines 137-140)

```python
# CURRENT BUGGY CODE - DO NOT USE
if trade.direction == 'LONG':
    vol_delta_status = "FAVORABLE" if vol_delta > 0 else "NEUTRAL"
else:  # SHORT
    # BUG: Positive delta labeled FAVORABLE for shorts
    vol_delta_status = "FAVORABLE" if vol_delta > 0 else "WEAK"
```

### Evidence of Bug Impact
```
SHORT Trades with POSITIVE Vol Delta (buying pressure):
- Status: FAVORABLE (WRONG - should be WEAK)
- Win Rate: 43.1-45.6%
- Model recommends TRADE during buying pressure

SHORT Trades with NEGATIVE Vol Delta (selling pressure):
- Status: WEAK (WRONG - should be FAVORABLE)
- Win Rate: 37.2%
- Model recommends NO_TRADE during ideal conditions
```

### Corrected Logic (v1.2)
```python
def get_vol_delta_status(vol_delta: float, direction: str) -> str:
    """
    Direction-aware volume delta status assignment.
    
    Vol Delta measures net buying/selling pressure:
    - Positive = More buying pressure (closes near highs)
    - Negative = More selling pressure (closes near lows)
    
    Args:
        vol_delta: Average volume delta over lookback period
        direction: Trade direction ('LONG' or 'SHORT')
    
    Returns:
        Status string: 'FAVORABLE', 'NEUTRAL', or 'WEAK'
    """
    # Thresholds based on historical analysis
    STRONG_THRESHOLD = 100000   # Strong directional pressure
    WEAK_THRESHOLD = 50000      # Moderate directional pressure
    
    if direction == 'LONG':
        # For LONG: Positive delta (buying) = good, Negative (selling) = bad
        if vol_delta > STRONG_THRESHOLD:
            return "FAVORABLE"
        elif vol_delta > WEAK_THRESHOLD:
            return "NEUTRAL"
        elif vol_delta < -STRONG_THRESHOLD:
            return "WEAK"
        else:
            return "NEUTRAL"
    
    else:  # SHORT
        # For SHORT: Negative delta (selling) = good, Positive (buying) = bad
        if vol_delta < -STRONG_THRESHOLD:
            return "FAVORABLE"
        elif vol_delta < -WEAK_THRESHOLD:
            return "NEUTRAL"
        elif vol_delta > STRONG_THRESHOLD:
            return "WEAK"
        else:
            return "NEUTRAL"
```

---

# 4. NEW DIRECTION RULES

## 4.1 Direction-Specific Interpretation Matrix

### LONG Trade Interpretation
| Indicator | Value | Interpretation | Weight |
|-----------|-------|----------------|--------|
| Vol Delta | Positive (>100K) | FAVORABLE - Buyers active | High |
| Vol Delta | Negative (<-100K) | WEAK - Sellers dominating | High |
| SMA Config | BULL | ALIGNED - Trend support | Medium |
| SMA Config | BEAR | COUNTER - Trend opposition | Medium |
| H1 Structure | BULL | STRONG SUPPORT | High |
| H1 Structure | BEAR | STRONG OPPOSITION | High |
| H1 Structure | NEUT | Neutral | Low |

### SHORT Trade Interpretation
| Indicator | Value | Interpretation | Weight |
|-----------|-------|----------------|--------|
| Vol Delta | Negative (<-100K) | FAVORABLE - Sellers active | High |
| Vol Delta | Positive (>100K) | WEAK - Buyers dominating | High |
| SMA Config | BEAR | ALIGNED - Trend support | Medium |
| SMA Config | BULL | COUNTER - Trend opposition | Medium |
| H1 Structure | BEAR | STRONG SUPPORT | High |
| H1 Structure | BULL | STRONG OPPOSITION (31.8% WR!) | Critical |
| H1 Structure | NEUT | Neutral | Low |

## 4.2 Critical Conflict Rules

These combinations should trigger strong NO_TRADE bias:

### Rule 1: H1 Bull + SHORT Direction
```
Condition: direction == 'SHORT' AND h1_structure == 'BULL'
Historical Win Rate: 31.8%
Action: Strong NO_TRADE bias unless ALL other factors aligned
Confidence: Reduce by TWO levels if TRADE recommended
```

### Rule 2: H1 Bear + LONG Direction
```
Condition: direction == 'LONG' AND h1_structure == 'BEAR'
Historical Win Rate: 55.3%
Action: NO_TRADE bias, require strong volume confirmation
Confidence: Reduce by ONE level if TRADE recommended
```

### Rule 3: Vol Delta Opposes Direction
```
Condition (LONG): direction == 'LONG' AND vol_delta < -100000
Condition (SHORT): direction == 'SHORT' AND vol_delta > 100000
Action: Strong NO_TRADE signal
Override: Only if H1 structure strongly aligned AND SMA aligned
```

### Rule 4: Triple Conflict
```
Condition: SMA counter + H1 counter + Vol Delta opposes
Action: AUTOMATIC NO_TRADE with HIGH confidence
No override permitted
```

## 4.3 Composite Alignment Score

### Calculation Logic
```python
def calculate_alignment_score(
    direction: str,
    sma_config: str,
    h1_structure: str,
    vol_delta: float,
    vol_delta_threshold: float = 100000
) -> int:
    """
    Calculate composite alignment score for trade direction.
    
    Score Range: -3 to +3
    - Positive scores favor TRADE
    - Negative scores favor NO_TRADE
    - Zero is neutral
    
    Args:
        direction: 'LONG' or 'SHORT'
        sma_config: 'BULL', 'BEAR', or 'NEUT'
        h1_structure: 'BULL', 'BEAR', or 'NEUT'
        vol_delta: Average volume delta value
        vol_delta_threshold: Threshold for significant delta
    
    Returns:
        Integer alignment score from -3 to +3
    """
    score = 0
    
    if direction == 'LONG':
        # SMA alignment for LONG
        if sma_config == 'BULL':
            score += 1
        elif sma_config == 'BEAR':
            score -= 1
        
        # H1 alignment for LONG (weighted heavier)
        if h1_structure == 'BULL':
            score += 1
        elif h1_structure == 'BEAR':
            score -= 1
        
        # Vol Delta alignment for LONG
        if vol_delta > vol_delta_threshold:
            score += 1
        elif vol_delta < -vol_delta_threshold:
            score -= 1
    
    else:  # SHORT
        # SMA alignment for SHORT
        if sma_config == 'BEAR':
            score += 1
        elif sma_config == 'BULL':
            score -= 1
        
        # H1 alignment for SHORT (weighted heavier)
        if h1_structure == 'BEAR':
            score += 1
        elif h1_structure == 'BULL':
            score -= 1  # Critical: 31.8% win rate when opposed
        
        # Vol Delta alignment for SHORT
        if vol_delta < -vol_delta_threshold:
            score += 1
        elif vol_delta > vol_delta_threshold:
            score -= 1
    
    return score
```

### Score Interpretation
```
Score   Interpretation              Recommended Action
------------------------------------------------------
+3      Strongly Aligned            TRADE (HIGH confidence)
+2      Well Aligned                TRADE (MEDIUM-HIGH confidence)
+1      Slightly Aligned            TRADE (MEDIUM confidence)
 0      Neutral/Mixed               NO_TRADE (MEDIUM confidence)
-1      Slightly Opposed            NO_TRADE (MEDIUM confidence)
-2      Moderately Opposed          NO_TRADE (HIGH confidence)
-3      Strongly Opposed            NO_TRADE (HIGH confidence)
```

---

# 5. INDICATOR LOGIC UPDATES

## 5.1 Candle Range Status (Revised)

### Current Logic
```python
# Current thresholds
GOOD_THRESHOLD = 0.15
OK_THRESHOLD = 0.12
# Below 0.12 = SKIP
```

### Baseline Findings (Paradox Discovered)
```
SKIP + LONG:  54.7% win rate (HIGHEST across all combinations!)
GOOD + LONG:  41.5% win rate
SKIP + SHORT: 42.6% win rate
GOOD + SHORT: 41.5% win rate
```

### Updated Logic (v1.2)
```python
def get_candle_status(avg_candle_range: float, direction: str) -> tuple[str, str]:
    """
    Direction-aware candle range status.
    
    Key Finding: Low volatility (SKIP) LONG trades show 54.7% win rate,
    suggesting consolidation before breakout potential.
    
    Args:
        avg_candle_range: Average candle range percentage over lookback
        direction: Trade direction
    
    Returns:
        Tuple of (status, interpretation)
    """
    if direction == 'LONG':
        if avg_candle_range >= 0.15:
            return ("GOOD", "Active volatility")
        elif avg_candle_range >= 0.12:
            return ("OK", "Moderate volatility")
        else:
            # REVISED: Low volatility LONGs show 54.7% WR
            return ("LOW", "Consolidation - potential breakout")
    
    else:  # SHORT
        if avg_candle_range >= 0.15:
            return ("GOOD", "Active volatility")
        elif avg_candle_range >= 0.12:
            return ("OK", "Moderate volatility")
        else:
            return ("SKIP", "Insufficient momentum for short")
```

### Prompt Guidance Update
```markdown
## Candle Range Interpretation (Direction-Specific)

### For LONG Trades:
- GOOD (≥0.15%): Active market, normal entry conditions
- OK (0.12-0.15%): Acceptable entry conditions
- LOW (<0.12%): Consolidation phase - historically shows 54.7% win rate
  * May indicate coiling before breakout
  * Do NOT automatically skip - evaluate other factors

### For SHORT Trades:
- GOOD (≥0.15%): Active selling, favorable for shorts
- OK (0.12-0.15%): Acceptable entry conditions
- SKIP (<0.12%): Insufficient downward momentum
  * Only 42.6% historical win rate
  * Require strong alignment to override
```

## 5.2 Volume ROC Status

### Current Logic (Unchanged)
```python
ELEVATED_THRESHOLD = 30  # percent

def get_vol_roc_status(avg_vol_roc: float) -> str:
    if avg_vol_roc >= 30:
        return "ELEVATED"
    else:
        return "NORMAL"
```

### Enhanced Interpretation (v1.2)
```markdown
## Volume ROC Interpretation

ELEVATED (≥30%):
- High participation, increased institutional activity
- For aligned trades: Confirms conviction
- For counter-trend trades: May indicate reversal OR trap
- Weight: CONTEXTUAL - combine with direction alignment

NORMAL (<30%):
- Standard market conditions
- Neither confirms nor denies setup
- Weight: LOW
```

## 5.3 SMA Configuration

### Logic (Unchanged)
```python
# Retrieved from entry_indicators table
# Values: "BULL", "BEAR", "NEUT"
```

### Enhanced Interpretation (v1.2)
```markdown
## SMA Configuration Interpretation

### For LONG Trades:
- BULL: Aligned (+1 to alignment score)
  * SMA 9 > SMA 21, price above both
  * Trend supports upward movement
  
- BEAR: Counter-trend (-1 to alignment score)
  * SMA 9 < SMA 21, price below both
  * Headwind for long entries
  * Historical: 42.5% win rate (vs 49.8% for BULL)

- NEUT: Neutral (0 to alignment score)
  * Mixed or transitioning
  * Rely on other indicators

### For SHORT Trades:
- BEAR: Aligned (+1 to alignment score)
  * Historical: 38.7% win rate
  
- BULL: Counter-trend (-1 to alignment score)
  * Historical: 44.0% win rate
  * NOTE: Counter-trend shorts into BULL SMA can work
  * Require H1 BEAR confirmation
```

## 5.4 H1 Structure

### Logic (Unchanged)
```python
# Retrieved from entry_indicators table
# Values: "BULL", "BEAR", "NEUT"
```

### Enhanced Interpretation (v1.2) - CRITICAL
```markdown
## H1 Structure Interpretation (HIGHEST WEIGHT INDICATOR)

### For LONG Trades:
- BULL: Strong support (+1 to alignment score)
  * Historical: 62.5% win rate (BEST combination)
  * Higher highs/higher lows on H1
  * Strong TRADE signal when aligned
  
- BEAR: Strong opposition (-1 to alignment score)
  * Historical: 55.3% win rate (still above baseline)
  * Counter-trend - require volume confirmation
  
- NEUT: Neutral (0 to alignment score)
  * Historical: 41.3% win rate
  * Rely heavily on other factors

### For SHORT Trades:
- BEAR: Strong support (+1 to alignment score)
  * Historical: 57.8% win rate
  * Lower highs/lower lows on H1
  * Strong TRADE signal when aligned
  
- BULL: CRITICAL OPPOSITION (-1 to alignment score)
  * Historical: 31.8% win rate (WORST combination!)
  * STRONG NO_TRADE SIGNAL
  * Override only with exceptional circumstances
  
- NEUT: Neutral (0 to alignment score)
  * Historical: 39.0% win rate
```

---

# 6. PROMPT TEMPLATE v1.2

## 6.1 System Prompt Structure

```markdown
# EPOCH DOW AI Trading Assistant v1.2
## XIII Trading LLC - Entry Qualification System

You are an AI trading assistant for the EPOCH trading methodology. Your role is to analyze pre-trade indicators and recommend TRADE or NO_TRADE decisions with appropriate confidence levels.

---

## CORE METHODOLOGY

The EPOCH system uses zone-based entries with four models:
- EPCH1: Primary Continuation (with-trend at primary zones)
- EPCH2: Primary Reversal (rejection at primary zones)
- EPCH3: Secondary Continuation (with-trend at secondary zones)
- EPCH4: Secondary Reversal (rejection at secondary zones)

---

## INDICATOR INTERPRETATION RULES

### 1. Volume Delta (DIRECTION-SPECIFIC - CRITICAL)

Volume Delta measures net buying vs selling pressure:
- POSITIVE delta = More buying pressure (closes near highs)
- NEGATIVE delta = More selling pressure (closes near lows)

**For LONG trades:**
| Vol Delta | Status | Meaning |
|-----------|--------|---------|
| > +100,000 | FAVORABLE | Strong buying supports long |
| +50,000 to +100,000 | NEUTRAL | Moderate buying |
| -50,000 to +50,000 | NEUTRAL | Balanced pressure |
| < -100,000 | WEAK | Strong selling opposes long |

**For SHORT trades:**
| Vol Delta | Status | Meaning |
|-----------|--------|---------|
| < -100,000 | FAVORABLE | Strong selling supports short |
| -100,000 to -50,000 | NEUTRAL | Moderate selling |
| -50,000 to +50,000 | NEUTRAL | Balanced pressure |
| > +100,000 | WEAK | Strong buying opposes short |

### 2. SMA Configuration (DIRECTION-SPECIFIC)

**For LONG trades:**
- BULL = ALIGNED (trend supports entry)
- BEAR = COUNTER (trend opposes entry)
- NEUT = Neutral

**For SHORT trades:**
- BEAR = ALIGNED (trend supports entry)
- BULL = COUNTER (trend opposes entry)
- NEUT = Neutral

### 3. H1 Structure (HIGHEST WEIGHT - DIRECTION-SPECIFIC)

**For LONG trades:**
- BULL = STRONG SUPPORT (62.5% historical win rate)
- BEAR = OPPOSITION (55.3% win rate - still tradeable with volume)
- NEUT = Neutral (41.3% win rate)

**For SHORT trades:**
- BEAR = STRONG SUPPORT (57.8% historical win rate)
- BULL = CRITICAL OPPOSITION (31.8% win rate - STRONG NO_TRADE)
- NEUT = Neutral (39.0% win rate)

### 4. Candle Range (DIRECTION-SPECIFIC)

**For LONG trades:**
- GOOD (≥0.15%): Active volatility
- OK (0.12-0.15%): Acceptable
- LOW (<0.12%): Consolidation - 54.7% win rate (potential breakout)

**For SHORT trades:**
- GOOD (≥0.15%): Active volatility
- OK (0.12-0.15%): Acceptable
- SKIP (<0.12%): Insufficient momentum - 42.6% win rate

### 5. Volume ROC

- ELEVATED (≥30%): High participation - contextual interpretation
- NORMAL (<30%): Standard conditions

---

## ALIGNMENT SCORE CALCULATION

Calculate the composite alignment score (-3 to +3):

```
For LONG:
  SMA BULL = +1, SMA BEAR = -1, else 0
  H1 BULL = +1, H1 BEAR = -1, else 0
  Vol Delta > +100K = +1, Vol Delta < -100K = -1, else 0

For SHORT:
  SMA BEAR = +1, SMA BULL = -1, else 0
  H1 BEAR = +1, H1 BULL = -1, else 0
  Vol Delta < -100K = +1, Vol Delta > +100K = -1, else 0
```

**Score Interpretation:**
| Score | Action | Confidence |
|-------|--------|------------|
| +3 | TRADE | HIGH |
| +2 | TRADE | MEDIUM-HIGH |
| +1 | TRADE | MEDIUM |
| 0 | NO_TRADE | MEDIUM |
| -1 | NO_TRADE | MEDIUM |
| -2 | NO_TRADE | HIGH |
| -3 | NO_TRADE | HIGH |

---

## CRITICAL CONFLICT RULES (AUTOMATIC NO_TRADE)

### Rule 1: H1 BULL + SHORT Direction
- Historical win rate: 31.8%
- Action: NO_TRADE unless exceptional circumstances
- This is the worst-performing combination in backtesting

### Rule 2: Triple Conflict
- Condition: SMA counter + H1 counter + Vol Delta opposes
- Action: AUTOMATIC NO_TRADE (HIGH confidence)
- No override permitted

### Rule 3: Vol Delta Strong Opposition
- LONG with Vol Delta < -100,000
- SHORT with Vol Delta > +100,000
- Action: NO_TRADE unless H1 strongly aligned

---

## DECISION FRAMEWORK

1. **Calculate Alignment Score** using the formula above

2. **Check Critical Conflicts:**
   - If H1 BULL + SHORT → Strong NO_TRADE bias
   - If Triple Conflict → Automatic NO_TRADE
   - If Vol Delta strongly opposes → NO_TRADE unless H1 aligned

3. **Apply Model Context:**
   - EPCH1/EPCH3 (Continuation): Require trend alignment
   - EPCH2/EPCH4 (Reversal): H1 structure critical for rejection

4. **Consider Historical Win Rate:**
   - Factor in ticker/direction/model historical performance
   - Adjust confidence based on sample size

5. **Make Decision:**
   - Score ≥ +1 AND no critical conflicts → TRADE
   - Score ≤ 0 OR critical conflict present → NO_TRADE

---

## OUTPUT FORMAT

Respond with EXACTLY this format:

```
**[TRADE/NO_TRADE]** | Confidence: **[HIGH/MEDIUM/LOW]**

ALIGNMENT SCORE: [score] ([breakdown])

INDICATORS:
- Candle %: [value] ([status])
- Vol Delta: [value] ([status for direction])
- Vol ROC: [value] ([status])
- SMA: [value] ([aligned/counter/neutral] for [direction])
- H1 Struct: [value] ([support/opposition/neutral] for [direction])

SNAPSHOT: [2-3 sentence analysis explaining the decision, highlighting key factors]
```

---

## EXAMPLES

### Example 1: Strong LONG Setup
```
Trade: NVDA LONG | Model: EPCH2 | Zone: Primary
Indicators: Candle 0.17%, Vol Delta +450,000, Vol ROC 25%, SMA BULL, H1 BULL

**TRADE** | Confidence: **HIGH**

ALIGNMENT SCORE: +3 (SMA aligned +1, H1 support +1, Vol Delta favorable +1)

INDICATORS:
- Candle %: 0.17% (GOOD)
- Vol Delta: +450,000 (FAVORABLE for LONG)
- Vol ROC: 25% (NORMAL)
- SMA: BULL (ALIGNED for LONG)
- H1 Struct: BULL (STRONG SUPPORT for LONG - 62.5% historical WR)

SNAPSHOT: Fully aligned setup with all three factors supporting the long entry. Strong buying pressure confirmed by positive vol delta, trend support from both SMA and H1 structure. Primary zone rejection with high conviction.
```

### Example 2: Critical Conflict (SHORT into H1 BULL)
```
Trade: AMD SHORT | Model: EPCH4 | Zone: Secondary
Indicators: Candle 0.14%, Vol Delta +200,000, Vol ROC 35%, SMA BEAR, H1 BULL

**NO_TRADE** | Confidence: **HIGH**

ALIGNMENT SCORE: -1 (SMA aligned +1, H1 opposition -1, Vol Delta weak -1)

INDICATORS:
- Candle %: 0.14% (OK)
- Vol Delta: +200,000 (WEAK for SHORT - buying pressure)
- Vol ROC: 35% (ELEVATED)
- SMA: BEAR (ALIGNED for SHORT)
- H1 Struct: BULL (CRITICAL OPPOSITION for SHORT - 31.8% historical WR!)

SNAPSHOT: Critical conflict detected. H1 BULL structure with SHORT direction historically shows only 31.8% win rate. Additionally, strong positive vol delta indicates active buying pressure opposing the short. Despite bearish SMA alignment, the combination of H1 opposition and buying pressure creates unacceptable risk.
```

### Example 3: Mixed Signals
```
Trade: TSLA LONG | Model: EPCH2 | Zone: Primary
Indicators: Candle 0.08%, Vol Delta -50,000, Vol ROC 15%, SMA BEAR, H1 BULL

**NO_TRADE** | Confidence: **MEDIUM**

ALIGNMENT SCORE: 0 (SMA counter -1, H1 support +1, Vol Delta neutral 0)

INDICATORS:
- Candle %: 0.08% (LOW - consolidation)
- Vol Delta: -50,000 (NEUTRAL for LONG)
- Vol ROC: 15% (NORMAL)
- SMA: BEAR (COUNTER for LONG)
- H1 Struct: BULL (SUPPORT for LONG)

SNAPSHOT: Mixed signals with H1 bullish structure conflicting with bearish SMA configuration. Low candle range indicates consolidation but not necessarily negative for longs (54.7% historical WR). However, the SMA/H1 divergence and neutral vol delta create insufficient conviction for entry. Wait for SMA alignment or stronger volume confirmation.
```
```

## 6.2 Batch Analysis Prompt Additions

Add this section to the batch analyzer prompt for processing historical trades:

```markdown
## BATCH ANALYSIS MODE

When analyzing historical trades in batch mode:

1. Apply all rules consistently across all trades
2. Calculate alignment score for each trade
3. Flag trades with critical conflicts
4. Track prediction accuracy by:
   - Alignment score bucket
   - Direction
   - Model type
   - Ticker

Output includes standard decision format plus:
- Alignment score breakdown
- Conflict flags (if any)
- Direction-specific indicator statuses
```

---

# 7. CODE CHANGES REQUIRED

## 7.1 File: `batch_analyzer/prompts/batch_prompt.py`

### Change 1: Vol Delta Status Function (Lines ~79-82)
```python
# REMOVE THIS:
if trade.direction == 'LONG':
    vol_delta_status = "FAVORABLE" if vol_delta > 0 else "NEUTRAL"
else:  # SHORT
    vol_delta_status = "FAVORABLE" if vol_delta > 0 else "WEAK"

# REPLACE WITH:
def get_vol_delta_status(vol_delta: float, direction: str) -> str:
    """Direction-aware volume delta status."""
    STRONG_THRESHOLD = 100000
    WEAK_THRESHOLD = 50000
    
    if direction == 'LONG':
        if vol_delta > STRONG_THRESHOLD:
            return "FAVORABLE"
        elif vol_delta < -STRONG_THRESHOLD:
            return "WEAK"
        else:
            return "NEUTRAL"
    else:  # SHORT
        if vol_delta < -STRONG_THRESHOLD:
            return "FAVORABLE"
        elif vol_delta > STRONG_THRESHOLD:
            return "WEAK"
        else:
            return "NEUTRAL"

vol_delta_status = get_vol_delta_status(vol_delta, trade.direction)
```

### Change 2: Add Alignment Score Calculation
```python
def calculate_alignment_score(
    direction: str,
    sma_config: str,
    h1_structure: str,
    vol_delta: float
) -> int:
    """Calculate composite alignment score (-3 to +3)."""
    score = 0
    VOL_THRESHOLD = 100000
    
    if direction == 'LONG':
        score += 1 if sma_config == 'BULL' else (-1 if sma_config == 'BEAR' else 0)
        score += 1 if h1_structure == 'BULL' else (-1 if h1_structure == 'BEAR' else 0)
        score += 1 if vol_delta > VOL_THRESHOLD else (-1 if vol_delta < -VOL_THRESHOLD else 0)
    else:  # SHORT
        score += 1 if sma_config == 'BEAR' else (-1 if sma_config == 'BULL' else 0)
        score += 1 if h1_structure == 'BEAR' else (-1 if h1_structure == 'BULL' else 0)
        score += 1 if vol_delta < -VOL_THRESHOLD else (-1 if vol_delta > VOL_THRESHOLD else 0)
    
    return score
```

### Change 3: Add Critical Conflict Detection
```python
def detect_critical_conflicts(
    direction: str,
    sma_config: str,
    h1_structure: str,
    vol_delta: float
) -> list[str]:
    """Detect critical conflict conditions."""
    conflicts = []
    VOL_THRESHOLD = 100000
    
    # Rule 1: H1 BULL + SHORT (31.8% win rate)
    if direction == 'SHORT' and h1_structure == 'BULL':
        conflicts.append("H1_BULL_SHORT_CONFLICT")
    
    # Rule 2: H1 BEAR + LONG (counter-trend)
    if direction == 'LONG' and h1_structure == 'BEAR':
        conflicts.append("H1_BEAR_LONG_CONFLICT")
    
    # Rule 3: Vol Delta strong opposition
    if direction == 'LONG' and vol_delta < -VOL_THRESHOLD:
        conflicts.append("VOL_DELTA_OPPOSES_LONG")
    if direction == 'SHORT' and vol_delta > VOL_THRESHOLD:
        conflicts.append("VOL_DELTA_OPPOSES_SHORT")
    
    # Rule 4: Triple conflict
    sma_counter = (direction == 'LONG' and sma_config == 'BEAR') or \
                  (direction == 'SHORT' and sma_config == 'BULL')
    h1_counter = (direction == 'LONG' and h1_structure == 'BEAR') or \
                 (direction == 'SHORT' and h1_structure == 'BULL')
    vol_opposes = (direction == 'LONG' and vol_delta < -VOL_THRESHOLD) or \
                  (direction == 'SHORT' and vol_delta > VOL_THRESHOLD)
    
    if sma_counter and h1_counter and vol_opposes:
        conflicts.append("TRIPLE_CONFLICT")
    
    return conflicts
```

### Change 4: Update Candle Status for Direction
```python
def get_candle_status(avg_candle_range: float, direction: str) -> str:
    """Direction-aware candle range status."""
    if avg_candle_range >= 0.15:
        return "GOOD"
    elif avg_candle_range >= 0.12:
        return "OK"
    else:
        # Different interpretation based on direction
        if direction == 'LONG':
            return "LOW"  # Consolidation - 54.7% WR historically
        else:
            return "SKIP"  # Insufficient momentum for shorts
```

## 7.2 File: `entry_qualifier/ai/compact_prompt.py`

Apply the same changes as above (lines ~137-140 and surrounding logic).

## 7.3 File: `batch_analyzer/analyzer.py` (or equivalent)

### Add Alignment Score to Output
```python
# In the trade analysis loop, add:
alignment_score = calculate_alignment_score(
    direction=trade.direction,
    sma_config=indicators.sma_alignment,
    h1_structure=indicators.h1_structure,
    vol_delta=indicators.avg_vol_delta
)

conflicts = detect_critical_conflicts(
    direction=trade.direction,
    sma_config=indicators.sma_alignment,
    h1_structure=indicators.h1_structure,
    vol_delta=indicators.avg_vol_delta
)

# Include in prompt context
prompt_context['alignment_score'] = alignment_score
prompt_context['conflicts'] = conflicts
prompt_context['vol_delta_status'] = get_vol_delta_status(
    indicators.avg_vol_delta, 
    trade.direction
)
```

## 7.4 File: `batch_analyzer/diagnostics/` (New Files)

Create new diagnostic output files to track v1.2 specific metrics:

### `07_alignment_score_analysis.txt`
```python
# Generate analysis of predictions by alignment score bucket
# Track: accuracy, win rate, sample size for each score -3 to +3
```

### `08_conflict_detection_analysis.txt`
```python
# Track how often each conflict type is detected
# Measure accuracy of NO_TRADE when conflicts present
```

---

# 8. VALIDATION & TESTING

## 8.1 Unit Tests

### Test: Vol Delta Status Logic
```python
def test_vol_delta_status_long():
    """Test vol delta status for LONG direction."""
    assert get_vol_delta_status(150000, 'LONG') == "FAVORABLE"
    assert get_vol_delta_status(75000, 'LONG') == "NEUTRAL"
    assert get_vol_delta_status(-150000, 'LONG') == "WEAK"
    assert get_vol_delta_status(-25000, 'LONG') == "NEUTRAL"

def test_vol_delta_status_short():
    """Test vol delta status for SHORT direction."""
    assert get_vol_delta_status(-150000, 'SHORT') == "FAVORABLE"
    assert get_vol_delta_status(-75000, 'SHORT') == "NEUTRAL"
    assert get_vol_delta_status(150000, 'SHORT') == "WEAK"
    assert get_vol_delta_status(25000, 'SHORT') == "NEUTRAL"
```

### Test: Alignment Score Calculation
```python
def test_alignment_score_fully_aligned_long():
    """Test fully aligned LONG setup."""
    score = calculate_alignment_score(
        direction='LONG',
        sma_config='BULL',
        h1_structure='BULL',
        vol_delta=150000
    )
    assert score == 3

def test_alignment_score_fully_opposed_short():
    """Test fully opposed SHORT setup."""
    score = calculate_alignment_score(
        direction='SHORT',
        sma_config='BULL',
        h1_structure='BULL',
        vol_delta=150000
    )
    assert score == -3

def test_alignment_score_mixed():
    """Test mixed signals."""
    score = calculate_alignment_score(
        direction='LONG',
        sma_config='BEAR',
        h1_structure='BULL',
        vol_delta=50000  # Below threshold
    )
    assert score == 0  # -1 + 1 + 0
```

### Test: Critical Conflict Detection
```python
def test_h1_bull_short_conflict():
    """Test H1 BULL + SHORT conflict detection."""
    conflicts = detect_critical_conflicts(
        direction='SHORT',
        sma_config='BEAR',
        h1_structure='BULL',
        vol_delta=-50000
    )
    assert "H1_BULL_SHORT_CONFLICT" in conflicts

def test_triple_conflict():
    """Test triple conflict detection."""
    conflicts = detect_critical_conflicts(
        direction='LONG',
        sma_config='BEAR',
        h1_structure='BEAR',
        vol_delta=-150000
    )
    assert "TRIPLE_CONFLICT" in conflicts
```

## 8.2 Integration Test

### Re-run Batch Analysis
```bash
# Run v1.2 batch analysis on same dataset
python run_batch.py --version 1.2 --include-processed

# Compare against v1.0 baseline
python compare_versions.py --baseline v1.0 --current v1.2
```

### Comparison Metrics
Track these metrics between v1.0 and v1.2:
1. Overall prediction accuracy
2. Direction-specific accuracy (LONG, SHORT)
3. Model-specific accuracy (EPCH1-4)
4. False positive rate
5. False negative rate
6. Accuracy by alignment score bucket
7. Conflict detection rate and accuracy

## 8.3 Validation Criteria

### Minimum Success Criteria for v1.2
- [ ] Overall accuracy ≥ 58% (vs 53.8% baseline)
- [ ] SHORT accuracy ≥ 62% (vs 57.2% baseline)
- [ ] LONG accuracy ≥ 54% (vs 50.2% baseline)
- [ ] False positive rate ≤ 48% (vs 53.4% baseline)
- [ ] No regression in any model type
- [ ] Alignment score shows monotonic accuracy relationship

### Stretch Goals
- [ ] Overall accuracy ≥ 62%
- [ ] SHORT accuracy ≥ 65%
- [ ] H1 BULL + SHORT conflict detection prevents 80%+ of those trades

---

# 9. SUCCESS METRICS

## 9.1 Primary Metrics

| Metric | v1.0 Baseline | v1.2 Target | Stretch |
|--------|---------------|-------------|---------|
| Overall Accuracy | 53.8% | 60% | 65% |
| SHORT Accuracy | 57.2% | 65% | 68% |
| LONG Accuracy | 50.2% | 56% | 60% |
| Precision (TRADE) | 46.6% | 55% | 60% |
| Recall (WIN) | 38.6% | 45% | 50% |

## 9.2 Secondary Metrics

| Metric | v1.0 | v1.2 Target |
|--------|------|-------------|
| False Positives | 692 | <550 |
| False Negatives | 962 | <850 |
| HIGH conf accuracy | 52.1% | >65% |
| Score +3 win rate | N/A | >70% |
| Score -3 accuracy | N/A | >85% |

## 9.3 Risk Metrics

| Conflict Type | Detection Rate | NO_TRADE Accuracy |
|---------------|----------------|-------------------|
| H1 BULL + SHORT | >95% | >85% |
| Triple Conflict | 100% | >90% |
| Vol Delta Opposition | >90% | >75% |

---

# 10. FUTURE ROADMAP

## 10.1 Version Plan

### v1.2 (Current)
- Fix vol delta logic bug
- Add direction rules
- Implement alignment score
- Add conflict detection

### v1.3 (Planned)
- Model-specific indicator weightings
- Ticker-specific threshold tuning
- Vol Delta Rate of Change indicator
- Historical context integration (prior day structure)

### v1.4 (Planned)
- Dynamic threshold optimization
- Time-of-day adjustments
- News/catalyst integration
- Multi-ticker correlation analysis

### v2.0 (Future)
- Machine learning model integration
- Real-time adaptation
- Confidence calibration
- Automated parameter tuning

## 10.2 Indicator Expansion Candidates

### Recommended for Testing
1. **Vol Delta ROC**: Rate of change of delta to detect acceleration
2. **H1/SMA Divergence Duration**: How long structure has been in conflict
3. **Zone Distance**: Distance from zone POC vs edge
4. **Prior Day Structure**: H4 structure context from previous session
5. **Options Flow**: If accessible, put/call imbalances

### Data Requirements
- Vol Delta ROC: Calculate from existing delta values
- Divergence Duration: Track state changes over time
- Zone Distance: Calculate from zone bounds
- Prior Day: Store H4 structure from previous session
- Options Flow: Requires new data source

## 10.3 Model-Specific Tuning (v1.3 Preview)

Based on baseline data, different models may need different weightings:

| Model | Primary Factor | Secondary Factor | Notes |
|-------|----------------|------------------|-------|
| EPCH1 | H1 Structure | SMA Alignment | Continuation requires trend |
| EPCH2 | Vol Delta | H1 Structure | Rejection needs volume confirmation |
| EPCH3 | H1 Structure | Vol Delta | Secondary continuation |
| EPCH4 | H1 Structure | Vol Delta | Secondary rejection |

---

# APPENDIX A: QUICK REFERENCE

## Vol Delta Status Quick Reference
```
LONG + Positive Delta = FAVORABLE
LONG + Negative Delta = WEAK
SHORT + Negative Delta = FAVORABLE
SHORT + Positive Delta = WEAK
```

## Alignment Score Quick Reference
```
+3 = Fully Aligned → TRADE HIGH
+2 = Well Aligned → TRADE MEDIUM-HIGH
+1 = Slightly Aligned → TRADE MEDIUM
 0 = Neutral → NO_TRADE MEDIUM
-1 = Slightly Opposed → NO_TRADE MEDIUM
-2 = Moderately Opposed → NO_TRADE HIGH
-3 = Fully Opposed → NO_TRADE HIGH
```

## Critical Conflicts Quick Reference
```
H1 BULL + SHORT = 31.8% WR → Strong NO_TRADE
Triple Conflict = Automatic NO_TRADE
Vol Delta Strong Opposition = NO_TRADE unless H1 aligned
```

---

# APPENDIX B: FILE LOCATIONS

## Files to Modify
```
batch_analyzer/prompts/batch_prompt.py     # Lines 79-82 (vol delta)
entry_qualifier/ai/compact_prompt.py       # Lines 137-140 (vol delta)
batch_analyzer/analyzer.py                 # Add alignment score
```

## New Files to Create
```
batch_analyzer/utils/alignment.py          # Alignment score functions
batch_analyzer/utils/conflicts.py          # Conflict detection functions
batch_analyzer/diagnostics/07_alignment_score_analysis.txt
batch_analyzer/diagnostics/08_conflict_detection_analysis.txt
```

## Configuration Files to Update
```
config/thresholds.yaml                     # Add vol delta thresholds
config/prompt_version.yaml                 # Update to v1.2
```

---

# APPENDIX C: CHANGE LOG

## v1.2 Changes from v1.0
1. **CRITICAL FIX**: Vol delta status logic for SHORT trades
2. **NEW**: Direction-specific interpretation rules
3. **NEW**: Composite alignment score (-3 to +3)
4. **NEW**: Critical conflict detection
5. **UPDATED**: Candle range interpretation for LONGs
6. **UPDATED**: Prompt template with full decision framework
7. **NEW**: Diagnostic files for alignment and conflict tracking

---

*Document Generated: 2026-01-24*
*Version: DOW AI v1.2 Specification*
*Author: Claude AI (Anthropic)*
*For: XIII Trading LLC - EPOCH Trading System*