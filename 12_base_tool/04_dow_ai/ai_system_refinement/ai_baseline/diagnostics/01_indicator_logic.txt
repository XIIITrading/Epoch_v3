================================================================================
EPOCH DOW AI - INDICATOR LOGIC & CALCULATIONS DIAGNOSTIC
Generated: 2026-01-24 11:30:54
================================================================================

PURPOSE: Document the exact logic used for each indicator so Claude can identify
errors, inconsistencies, or improvements in the calculation methodology.

================================================================================
1. CANDLE RANGE PERCENTAGE
================================================================================

CALCULATION:
    candle_range_pct = ((high - low) / close) * 100

5-BAR AVERAGE:
    avg_candle_range = sum(last_5_bars.candle_range_pct) / 5

STATUS ASSIGNMENT:
    if avg_candle_range >= 0.15:
        status = "GOOD"      # Strong volatility, tradeable
    elif avg_candle_range >= 0.12:
        status = "OK"        # Marginal volatility
    else:
        status = "SKIP"      # Insufficient volatility

THRESHOLDS:
    GOOD threshold: 0.15%
    OK threshold:   0.12%
    SKIP: below 0.12%

QUESTIONS FOR REVIEW:
- Are these thresholds optimal based on historical win rates?
- Should thresholds differ by ticker or model type?

================================================================================
2. VOLUME DELTA
================================================================================

CALCULATION (Bar Position Method):
    bar_range = high - low
    position = (2 * (close - low) / bar_range) - 1  # Range: -1 to +1
    raw_delta = position * volume

    # Position meaning:
    # +1 = close at high (all buying pressure)
    # -1 = close at low (all selling pressure)
    #  0 = close at midpoint (neutral)

5-BAR AVERAGE:
    avg_vol_delta = sum(last_5_bars.vol_delta) / 5

STATUS ASSIGNMENT (CURRENT LOGIC - POTENTIAL BUG):

    For LONG trades:
        if avg_vol_delta > 0:
            status = "FAVORABLE"   # Buyers dominating - CORRECT
        else:
            status = "NEUTRAL"

    For SHORT trades:
        if avg_vol_delta > 0:
            status = "FAVORABLE"   # *** BUG: Buyers dominating is NOT favorable for shorts ***
        else:
            status = "WEAK"

EXPECTED CORRECT LOGIC FOR SHORT TRADES:
    For SHORT trades:
        if avg_vol_delta < 0:
            status = "FAVORABLE"   # Sellers dominating - supports short
        elif avg_vol_delta > some_threshold:
            status = "WEAK"        # Strong buying - opposes short
        else:
            status = "NEUTRAL"

BUG LOCATION:
    File: batch_analyzer/prompts/batch_prompt.py, lines 79-82
    File: entry_qualifier/ai/compact_prompt.py, lines 137-140

    Both contain the comment "# SHORT - paradox: positive delta is favorable"
    This is INCORRECT logic that misleads the AI model.

IMPACT ANALYSIS:
- For SHORT trades with positive vol_delta, the model receives "FAVORABLE" signal
- This contradicts the fundamental meaning of vol_delta (positive = buying pressure)
- Model may recommend SHORT entries during buying pressure (wrong)

================================================================================
3. VOLUME ROC (Rate of Change)
================================================================================

CALCULATION:
    vol_roc = ((current_volume - avg_volume) / avg_volume) * 100

    Where avg_volume = rolling average of prior N bars

5-BAR AVERAGE:
    avg_vol_roc = sum(last_5_bars.vol_roc) / 5

STATUS ASSIGNMENT:
    if avg_vol_roc >= 30:
        status = "ELEVATED"    # Volume surge, increased activity
    else:
        status = "NORMAL"

THRESHOLD:
    ELEVATED threshold: 30%

QUESTIONS FOR REVIEW:
- Should vol_roc status consider direction?
  (e.g., elevated volume during trend = good, against trend = bad)
- Is 30% the optimal threshold?

================================================================================
4. SMA CONFIGURATION
================================================================================

SOURCE:
    Retrieved from entry_indicators table: sma_alignment field

VALUES:
    "BULL" - SMA 9 > SMA 21, price above both (bullish alignment)
    "BEAR" - SMA 9 < SMA 21, price below both (bearish alignment)
    "NEUT" - Mixed or no clear alignment

EXPECTED LOGIC:
    LONG trades:  BULL = favorable, BEAR = unfavorable
    SHORT trades: BEAR = favorable, BULL = unfavorable

CURRENT IMPLEMENTATION:
    Passed directly to model without direction-specific interpretation
    Model must infer alignment quality from context

================================================================================
5. H1 STRUCTURE
================================================================================

SOURCE:
    Retrieved from entry_indicators table: h1_structure field
    Calculated from H1 timeframe fractal analysis

VALUES:
    "BULL" - Higher highs and higher lows on H1
    "BEAR" - Lower highs and lower lows on H1
    "NEUT" - No clear structure

EXPECTED LOGIC:
    LONG trades:  BULL = aligned, BEAR = counter-trend
    SHORT trades: BEAR = aligned, BULL = counter-trend

CURRENT IMPLEMENTATION:
    Passed directly to model without direction-specific interpretation

================================================================================
SUMMARY OF LOGIC ISSUES IDENTIFIED
================================================================================

CRITICAL:
1. Vol Delta status for SHORT trades is inverted (positive = FAVORABLE is wrong)

POTENTIAL IMPROVEMENTS:
2. SMA/H1 structure not explicitly labeled as aligned/counter to direction
3. Vol ROC doesn't consider direction context
4. No composite "alignment score" combining all direction-sensitive indicators

================================================================================
