================================================================================
APP.PY INTEGRATION - OPTIONS ANALYSIS TAB UPDATE
================================================================================
File: 06_app_integration.txt
Purpose: Define changes needed in app.py to integrate all new components
Location: C:\XIIITradingSystems\Epoch\02_zone_system\12_system_analysis\app.py
================================================================================

OVERVIEW
--------
This document details all changes needed in app.py to integrate the new
options stop analysis components. The goal is to make the Options Analysis
tab match the structure and flow of the Metrics Overview tab.

================================================================================
CURRENT OPTIONS TAB STRUCTURE (Lines 594-730)
================================================================================

```python
with tab_options:
    st.header("Options Analysis")
    st.markdown("*Options trade performance from entry to 15:30 ET*")

    # Load options data
    with st.spinner("Loading options MFE/MAE data..."):
        options_data = load_options_mfe_mae_potential(...)

    if options_data:
        # CALC-O01: Options Win Rate by Model
        # CALC-O02: Options MFE/MAE Distribution
        # CALC-O03: Options MFE/MAE Sequence Analysis
        # CALC-O04: Options vs Underlying Comparison
        # Monte AI - Options Analysis
```

================================================================================
NEW OPTIONS TAB STRUCTURE
================================================================================

```python
with tab_options:
    st.header("Options Analysis")
    st.markdown("*Options trade performance from entry to 15:30 ET*")

    # Initialize stop type session state
    initialize_op_stop_type_state()

    # Load options data
    with st.spinner("Loading options MFE/MAE data..."):
        options_data = load_options_mfe_mae_potential(...)

    if options_data:
        # =================================================================
        # CALC-O09: Options Stop Type Analysis (NEW - First Section)
        # =================================================================

        # =================================================================
        # OPTIONS STOP TYPE SELECTOR (NEW)
        # =================================================================

        # =================================================================
        # CALC-O01: Options Win Rate by Model (MODIFIED)
        # =================================================================

        # =================================================================
        # CALC-O02: Options MFE/MAE Distribution (Unchanged)
        # =================================================================

        # =================================================================
        # CALC-O03: Options MFE/MAE Sequence Analysis (Unchanged)
        # =================================================================

        # =================================================================
        # CALC-O05: Options Simulated Outcomes (NEW)
        # =================================================================

        # =================================================================
        # CALC-O04: Options vs Underlying Comparison (Unchanged)
        # =================================================================

        # =================================================================
        # Monte AI - Options Analysis (UPDATED)
        # =================================================================
```

================================================================================
DETAILED CHANGES
================================================================================

STEP 1: ADD NEW IMPORTS
-----------------------
Add at the top of app.py (around line 120-150):

```python
# OPTIONS STOP ANALYSIS IMPORTS (NEW)
from calculations.options.op_stop_analysis import (
    render_op_stop_analysis_section
)
from calculations.options.op_stop_selector import (
    initialize_op_stop_type_state,
    render_op_stop_type_selector,
    store_op_stop_analysis_results,
    get_selected_op_stop_outcomes,
    get_op_stop_type_display_name,
    DEFAULT_OPTIONS_STOP_TYPE
)
from calculations.options.op_win_rate_by_model import (
    calculate_options_win_rate_by_model,
    render_options_model_summary_table,
    render_options_model_win_loss_chart,
    render_options_model_breakdown,
    # NEW FUNCTIONS
    calculate_options_win_rate_by_model_with_stop,
    render_options_model_breakdown_with_stop
)
from calculations.options.op_simulated_outcomes import (
    render_simulated_outcomes_section
)
# Update Monte AI import
from monte_ai.options_prompt_generator import (
    generate_options_overview_prompt,
    get_options_prompt_stats
)
```

STEP 2: REPLACE OPTIONS TAB CONTENT
-----------------------------------
Replace lines 594-730 with the following:

```python
    # ==========================================================================
    # Tab 2: Options Analysis (CALC-O01 through CALC-O05)
    # ==========================================================================
    with tab_options:
        st.header("Options Analysis")
        st.markdown("*Options trade performance from entry to 15:30 ET*")

        # Initialize options stop type session state
        initialize_op_stop_type_state()

        # Load options data
        with st.spinner("Loading options MFE/MAE data..."):
            options_data = load_options_mfe_mae_potential(
                date_from=date_from,
                date_to=date_to,
                models=None,  # Full system view
                directions=None,
                contract_types=None
            )

        if not options_data:
            st.warning("No options data available. Ensure the op_mfe_mae_potential table is populated.")
            st.info("""
            **To populate op_mfe_mae_potential table:**
            ```bash
            cd C:\\XIIITradingSystems\\Epoch\\02_zone_system\\09_backtest\\processor\\secondary_analysis\\op_mfe_mae
            python op_mfe_mae_runner.py --schema  # Create table first
            python op_mfe_mae_runner.py           # Full calculation
            ```
            """)
        else:
            st.sidebar.markdown(f"**Options trades:** {len(options_data):,}")

            # =================================================================
            # CALC-O09: Options Stop Type Analysis (NEW)
            # =================================================================
            # Analyzes different stop levels to find best risk-adjusted returns
            # This is the foundation for downstream CALC-O01 analysis

            op_stop_analysis_results = render_op_stop_analysis_section(
                options_data=options_data,
                target_pct=50.0  # Default target: 50% gain
            )

            # Store results in session state for downstream use
            store_op_stop_analysis_results(op_stop_analysis_results)

            st.markdown("---")

            # =================================================================
            # OPTIONS STOP TYPE SELECTOR (NEW)
            # =================================================================
            # Bridges CALC-O09 and CALC-O01
            # User selects which stop level to use for win/loss determination

            selected_stop_type = render_op_stop_type_selector()
            selected_stop_name = get_op_stop_type_display_name(selected_stop_type, short=True)

            # Get outcomes for selected stop type
            selected_outcomes = get_selected_op_stop_outcomes()

            st.markdown("---")

            # =================================================================
            # CALC-O01: Options Win Rate by Model (MODIFIED)
            # =================================================================
            # Now uses stop-based outcomes instead of simple exit_pct > 0
            # Win = Target reached before selected stop hit

            if selected_outcomes:
                options_model_stats = render_options_model_breakdown_with_stop(
                    selected_outcomes,
                    selected_stop_name
                )
            else:
                # Fallback to original if stop analysis not available
                st.warning("Stop analysis not available. Showing raw exit-based results.")
                st.subheader("Options Win Rate by Model")
                st.markdown("*Win = Exit% > 0 at 15:30 ET*")
                options_model_stats = calculate_options_win_rate_by_model(options_data)

                col1, col2 = st.columns([1, 1])
                with col1:
                    st.markdown("**Summary Table**")
                    render_options_model_summary_table(options_model_stats)
                with col2:
                    st.markdown("**Win/Loss Distribution**")
                    render_options_model_win_loss_chart(options_model_stats)

            st.markdown("---")

            # =================================================================
            # CALC-O02: Options MFE/MAE Distribution
            # =================================================================
            st.subheader("Options MFE/MAE Distribution")
            st.markdown("*How much do options move from entry to 15:30 ET?*")

            # Calculate summary stats
            options_mfe_mae_stats = calculate_options_mfe_mae_summary(options_data)
            render_options_mfe_mae_summary_cards(options_mfe_mae_stats)

            st.markdown("---")

            # Histograms side by side
            col1, col2 = st.columns(2)

            with col1:
                st.markdown("**Options MFE Distribution**")
                render_options_mfe_histogram(options_data)

            with col2:
                st.markdown("**Options MAE Distribution**")
                render_options_mae_histogram(options_data)

            st.markdown("---")

            # Scatter plot
            st.markdown("**Options MFE vs MAE (Above diagonal = favorable)**")
            render_options_mfe_mae_scatter(options_data)

            st.markdown("---")

            # Model breakdown
            st.markdown("**Options MFE/MAE by Model and Contract Type**")
            render_options_model_mfe_mae_table(options_data)

            st.markdown("---")

            # =================================================================
            # CALC-O03: Options MFE/MAE Sequence Analysis
            # =================================================================
            options_sequence_stats = render_options_sequence_analysis_section(options_data)

            st.markdown("---")

            # =================================================================
            # CALC-O05: Options Simulated Outcomes (NEW)
            # =================================================================
            simulated_results = render_simulated_outcomes_section(options_data)

            st.markdown("---")

            # =================================================================
            # CALC-O04: Options vs Underlying Comparison
            # =================================================================
            options_leverage_stats = render_options_vs_underlying_section(options_data)

            st.markdown("---")

            # =================================================================
            # Monte AI - Options Analysis (UPDATED)
            # =================================================================
            st.subheader("Monte AI - Options Analysis")
            st.markdown("*Copy the prompt below to analyze options performance with Claude*")

            # Note about default stop type
            st.info(
                "**Monte AI Prompt Note:** The generated prompt always uses the default stop type "
                "(25% Stop) for consistency, regardless of your selection above. "
                "This ensures reproducible analysis across sessions."
            )

            # Get model stats for default stop type (for prompt consistency)
            default_outcomes = op_stop_analysis_results.get('results', {}).get(DEFAULT_OPTIONS_STOP_TYPE, [])
            default_model_stats = calculate_options_win_rate_by_model_with_stop(default_outcomes) if default_outcomes else options_model_stats

            # Generate comprehensive prompt
            options_mfe_mae_by_model = calculate_options_mfe_mae_by_model(options_data)

            options_prompt = generate_options_overview_prompt(
                mfe_mae_stats=options_mfe_mae_stats,
                model_stats=default_model_stats,
                sequence_stats=options_sequence_stats,
                leverage_stats=options_leverage_stats,
                stop_analysis=op_stop_analysis_results,
                simulated_stats=simulated_results,
                filters={
                    "date_from": date_from,
                    "date_to": date_to,
                    "models": selected_models,
                    "directions": selected_directions
                },
                stop_name="25%"
            )

            # Show prompt stats
            prompt_stats = get_options_prompt_stats(options_prompt)
            st.caption(f"Prompt: {prompt_stats['characters']:,} chars, ~{prompt_stats['estimated_tokens']:,} tokens")

            # Expandable prompt
            with st.expander("View/Copy Options Analysis Prompt", expanded=False):
                st.text_area(
                    "Options Monte AI Prompt",
                    value=options_prompt,
                    height=500,
                    key="options_monte_ai_prompt_full"
                )
                st.markdown("*Copy the above prompt and paste into Claude for analysis*")
```

================================================================================
SIDE-BY-SIDE COMPARISON
================================================================================

METRICS OVERVIEW TAB               |  OPTIONS ANALYSIS TAB (NEW)
-----------------------------------|-----------------------------------
CALC-009: Stop Type Analysis       |  CALC-O09: Options Stop Analysis
Stop Type Selector                 |  Options Stop Selector
CALC-001: Win Rate by Model        |  CALC-O01: Options Win Rate
CALC-002: MFE/MAE Distribution     |  CALC-O02: Options MFE/MAE Dist
CALC-003: MFE/MAE Sequence         |  CALC-O03: Options Sequence
CALC-004: Simulated Outcomes       |  CALC-O05: Options Simulated
(no equivalent)                    |  CALC-O04: Options vs Underlying
Monte AI                           |  Monte AI (Options)

================================================================================
FILE CREATION CHECKLIST
================================================================================

Before running the updated app.py, ensure these files exist:

1. calculations/options/op_stop_analysis/__init__.py
2. calculations/options/op_stop_analysis/stop_types.py
3. calculations/options/op_stop_analysis/stop_calculator.py
4. calculations/options/op_stop_analysis/outcome_simulator.py
5. calculations/options/op_stop_analysis/results_aggregator.py
6. calculations/options/op_stop_analysis/ui_components.py
7. calculations/options/op_stop_selector.py
8. calculations/options/op_simulated_outcomes.py

Update existing files:
9. calculations/options/op_win_rate_by_model.py (add new functions)
10. monte_ai/options_prompt_generator.py (update prompt)

================================================================================
TESTING CHECKLIST
================================================================================

After implementing changes, test:

[ ] 1. Options tab loads without errors
[ ] 2. CALC-O09 displays stop analysis table and charts
[ ] 3. Stop selector dropdown works and updates session state
[ ] 4. CALC-O01 uses selected stop outcomes
[ ] 5. CALC-O02 displays MFE/MAE histograms and scatter
[ ] 6. CALC-O03 displays sequence analysis
[ ] 7. CALC-O05 displays simulated outcomes grid
[ ] 8. CALC-O04 displays leverage comparison
[ ] 9. Monte AI prompt includes all new data
[ ] 10. Sidebar shows options trade count

================================================================================
FALLBACK HANDLING
================================================================================

The implementation includes fallback behavior:

1. If stop analysis fails:
   - CALC-O01 falls back to simple exit_pct > 0 win definition
   - Warning shown to user

2. If no time data available:
   - Sequence analysis shows 0s or N/A
   - Simulated outcomes assumes conservative outcomes

3. If options data is empty:
   - Clear warning with instructions to populate table
   - No calculations attempted

================================================================================
QUESTIONS FOR REVIEW
================================================================================

1. SECTION ORDERING:
   Current order matches Metrics Overview (stop analysis first).
   Should CALC-O04 (Options vs Underlying) be moved earlier or later?

2. TARGET PARAMETER:
   CALC-O09 uses 50% target as default.
   Should this be configurable in the UI?

3. ERROR HANDLING:
   Current implementation shows warnings and falls back gracefully.
   Should we add more detailed error messages?

4. PERFORMANCE:
   Multiple calculations running sequentially.
   Should we add progress indicators between sections?

================================================================================
