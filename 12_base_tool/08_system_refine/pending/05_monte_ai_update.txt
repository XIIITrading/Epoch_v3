================================================================================
MONTE AI UPDATE FOR OPTIONS ANALYSIS
================================================================================
File: 05_monte_ai_update.txt
Purpose: Update Monte AI prompt generator to include stop analysis data
Mirrors: monte_ai integration in Metrics Overview
================================================================================

OVERVIEW
--------
Update the options prompt generator to include the new stop analysis data,
making the Options Analysis prompt match the comprehensiveness of the
Metrics Overview prompt.

================================================================================
CURRENT IMPLEMENTATION
================================================================================

Location: monte_ai/options_prompt_generator.py

Current Functions:
- generate_options_overview_prompt() - Generates the main prompt
- get_options_prompt_stats() - Returns character/token counts

Current Prompt Includes:
- MFE/MAE summary stats
- Model win rate stats
- Sequence analysis (P(MFE First))
- Leverage comparison stats
- Filter information

Missing (to be added):
- Stop analysis results
- Selected stop type
- Simulated outcomes
- Optimal parameters

================================================================================
UPDATED FILE SPECIFICATION
================================================================================

Location: C:\XIIITradingSystems\Epoch\02_zone_system\12_system_analysis\
          monte_ai\options_prompt_generator.py

-----------------------------------------------------------------------------
UPDATED generate_options_overview_prompt()
-----------------------------------------------------------------------------

```python
"""
================================================================================
EPOCH TRADING SYSTEM - MODULE 12: INDICATOR ANALYSIS
Monte AI - Options Prompt Generator
XIII Trading LLC
================================================================================

PURPOSE:
    Generate comprehensive analysis prompts for options trading data.
    Includes stop analysis, MFE/MAE, sequence, and simulated outcomes.

USAGE:
    from monte_ai.options_prompt_generator import (
        generate_options_overview_prompt,
        get_options_prompt_stats
    )

    prompt = generate_options_overview_prompt(
        mfe_mae_stats=mfe_mae_stats,
        model_stats=model_stats,
        sequence_stats=sequence_stats,
        leverage_stats=leverage_stats,
        stop_analysis=stop_analysis,      # NEW
        simulated_stats=simulated_stats,  # NEW
        filters=filters
    )

================================================================================
"""

from typing import Dict, Any, Optional
import pandas as pd


# =============================================================================
# PROMPT SECTIONS
# =============================================================================
def _format_stop_analysis_section(stop_analysis: Dict[str, Any]) -> str:
    """Format the stop analysis section for the prompt."""
    if not stop_analysis:
        return ""

    best_stop = stop_analysis.get('best_stop', {})
    summary = stop_analysis.get('summary', pd.DataFrame())
    total_trades = stop_analysis.get('total_trades', 0)

    section = """
## Stop Type Analysis (CALC-O09)
Foundation analysis comparing different options stop levels.

### Summary
- **Best Stop Type:** {best_stop}
- **Best Expectancy:** {expectancy:+.3f}R
- **Best Win Rate:** {win_rate:.1f}%
- **Trades Analyzed:** {total_trades:,}

### Stop Type Comparison
| Stop Type | Stop % | Trades | Win Rate | Stop Hit % | Expectancy |
|-----------|--------|--------|----------|------------|------------|
""".format(
        best_stop=best_stop.get('stop_type', 'N/A'),
        expectancy=best_stop.get('expectancy', 0),
        win_rate=best_stop.get('win_rate', 0),
        total_trades=total_trades
    )

    # Add table rows
    if isinstance(summary, pd.DataFrame) and not summary.empty:
        for _, row in summary.iterrows():
            section += "| {stop_type} | {stop_pct:.0f}% | {n} | {wr:.1f}% | {sh:.1f}% | {exp:+.3f}R |\n".format(
                stop_type=row.get('Stop Type', 'N/A'),
                stop_pct=row.get('Stop %', 0),
                n=row.get('n', 0),
                wr=row.get('Win Rate %', 0),
                sh=row.get('Stop Hit %', 0),
                exp=row.get('Expectancy', 0)
            )

    section += """
### Key Insights
- Tighter stops (10-15%) have higher stop-out rates but limit losses
- Wider stops (30-50%) reduce stop-outs but increase average loss when hit
- The best stop type balances win rate against stop frequency
"""

    return section


def _format_model_stats_section(model_stats: pd.DataFrame, stop_name: str = None) -> str:
    """Format the model statistics section."""
    if model_stats is None or (isinstance(model_stats, pd.DataFrame) and model_stats.empty):
        return ""

    stop_info = f" (Using {stop_name} Stop)" if stop_name else ""

    section = f"""
## Win Rate by Model{stop_info} (CALC-O01)
Performance breakdown by entry model.

| Model | Wins | Losses | Win Rate | Avg R |
|-------|------|--------|----------|-------|
"""

    if isinstance(model_stats, pd.DataFrame):
        for _, row in model_stats.iterrows():
            section += "| {model} | {wins} | {losses} | {wr:.1f}% | {ar:+.2f}R |\n".format(
                model=row.get('Model', 'N/A'),
                wins=int(row.get('Wins', 0)),
                losses=int(row.get('Losses', 0)),
                wr=row.get('Win%', 0) if 'Win%' in row else row.get('Win Rate %', 0),
                ar=row.get('Avg R', 0) if 'Avg R' in row else row.get('Avg Exit%', 0)
            )

    return section


def _format_mfe_mae_section(mfe_mae_stats: Dict[str, Any]) -> str:
    """Format the MFE/MAE distribution section."""
    if not mfe_mae_stats:
        return ""

    section = """
## MFE/MAE Distribution (CALC-O02)
Raw options price movement from entry to 15:30 ET.

### Summary Statistics
- **Median MFE:** {med_mfe:.1f}%
- **Median MAE:** {med_mae:.1f}%
- **MFE/MAE Ratio:** {ratio:.2f}
- **Total Options Trades:** {n:,}

### Thresholds
- MFE > 25%: {mfe_25:.1f}% of trades
- MFE > 50%: {mfe_50:.1f}% of trades
- MAE Range (25th-75th): {mae_q25:.1f}% - {mae_q75:.1f}%

### Interpretation
- MFE shows how much profit was *available* during the trade
- MAE shows how much drawdown occurred during the trade
- Higher MFE/MAE ratio indicates more favorable movement patterns
""".format(
        med_mfe=mfe_mae_stats.get('median_mfe_pct', 0),
        med_mae=mfe_mae_stats.get('median_mae_pct', 0),
        ratio=mfe_mae_stats.get('median_mfe_mae_ratio', 0),
        n=mfe_mae_stats.get('total_trades', 0),
        mfe_25=mfe_mae_stats.get('pct_mfe_above_25', 0),
        mfe_50=mfe_mae_stats.get('pct_mfe_above_50', 0),
        mae_q25=mfe_mae_stats.get('mae_pct_q25', 0),
        mae_q75=mfe_mae_stats.get('mae_pct_q75', 0)
    )

    return section


def _format_sequence_section(sequence_stats: Dict[str, Any]) -> str:
    """Format the sequence analysis section."""
    if not sequence_stats:
        return ""

    section = """
## MFE/MAE Sequence Analysis (CALC-O03)
Monte Carlo baseline - when does favorable/adverse movement occur?

### Key Metrics
- **P(MFE First):** {p_mfe:.1%}
- **MFE First Count:** {mfe_count:,}
- **MAE First Count:** {mae_count:,}

### Timing Statistics
- **Median Time to MFE:** {time_mfe:.0f} minutes
- **Median Time to MAE:** {time_mae:.0f} minutes
- **MFE under 30 min:** {mfe_30:.1f}%
- **MFE under 60 min:** {mfe_60:.1f}%

### Interpretation
- P(MFE First) > 50% suggests favorable movement tends to occur before adverse
- Faster time to MFE indicates quicker profit opportunities
- This is the baseline probability without stop/target considerations
""".format(
        p_mfe=sequence_stats.get('mfe_first_rate', 0),
        mfe_count=sequence_stats.get('mfe_first_count', 0),
        mae_count=sequence_stats.get('mae_first_count', 0),
        time_mfe=sequence_stats.get('median_time_to_mfe', 0),
        time_mae=sequence_stats.get('median_time_to_mae', 0),
        mfe_30=sequence_stats.get('pct_mfe_under_30min', 0),
        mfe_60=sequence_stats.get('pct_mfe_under_60min', 0)
    )

    return section


def _format_simulated_section(simulated_stats: Dict[str, Any]) -> str:
    """Format the simulated outcomes section."""
    if not simulated_stats:
        return ""

    optimal = simulated_stats.get('optimal', {})

    section = """
## Simulated Outcomes (CALC-O05)
Grid search for optimal stop/target parameters.

### Optimal Parameters
- **Optimal Stop:** {stop:.0f}%
- **Optimal Target:** {target:.0f}%
- **Win Rate at Optimal:** {wr:.1f}%
- **Expectancy at Optimal:** {exp:+.2f}R
- **Risk:Reward Ratio:** {rr:.1f}:1

### Interpretation
- These parameters maximize expectancy across the tested grid
- Actual trading should consider transaction costs and slippage
- Different models may have different optimal parameters
""".format(
        stop=optimal.get('stop_pct', 25),
        target=optimal.get('target_pct', 50),
        wr=optimal.get('win_rate', 0),
        exp=optimal.get('expectancy', 0),
        rr=optimal.get('r_ratio', 2.0)
    )

    return section


def _format_leverage_section(leverage_stats: Dict[str, Any]) -> str:
    """Format the options vs underlying section."""
    if not leverage_stats:
        return ""

    section = """
## Options vs Underlying (CALC-O04)
Leverage and performance comparison.

### Summary
- Data from leverage comparison analysis
- Shows how options amplify underlying movement

{stats_text}
""".format(
        stats_text=str(leverage_stats) if leverage_stats else "No leverage data available"
    )

    return section


# =============================================================================
# MAIN PROMPT GENERATOR
# =============================================================================
def generate_options_overview_prompt(
    mfe_mae_stats: Dict[str, Any] = None,
    model_stats: pd.DataFrame = None,
    sequence_stats: Dict[str, Any] = None,
    leverage_stats: Dict[str, Any] = None,
    stop_analysis: Dict[str, Any] = None,
    simulated_stats: Dict[str, Any] = None,
    filters: Dict[str, Any] = None,
    stop_name: str = None
) -> str:
    """
    Generate comprehensive options analysis prompt for Claude.

    Parameters:
    -----------
    mfe_mae_stats : Dict
        Output from calculate_options_mfe_mae_summary()
    model_stats : pd.DataFrame
        Output from calculate_options_win_rate_by_model() or _with_stop()
    sequence_stats : Dict
        Output from calculate_options_sequence_summary()
    leverage_stats : Dict
        Output from calculate_options_vs_underlying_summary()
    stop_analysis : Dict
        Output from render_op_stop_analysis_section() (NEW)
    simulated_stats : Dict
        Output from render_simulated_outcomes_section() (NEW)
    filters : Dict
        Current filter settings
    stop_name : str
        Display name of selected stop type (NEW)

    Returns:
    --------
    str
        Complete prompt for Claude analysis
    """
    # Header
    prompt = """# Epoch Options Analysis - Monte AI Prompt

## Overview
You are analyzing options trading performance data from the Epoch Trading System.
This analysis covers options trades from entry to 15:30 ET.

## Data Context
"""

    # Add filter context
    if filters:
        prompt += f"""
- **Date Range:** {filters.get('date_from', 'N/A')} to {filters.get('date_to', 'N/A')}
- **Models:** {', '.join(filters.get('models', ['All'])) if filters.get('models') else 'All'}
- **Directions:** {', '.join(filters.get('directions', ['All'])) if filters.get('directions') else 'All'}
"""

    # Add note about default stop type
    prompt += """
**Note:** This analysis uses the default stop type (25% Stop) for consistency.
The user may have selected a different stop type in the UI for visualization,
but this prompt uses the default for reproducible analysis.
"""

    # Add sections
    prompt += _format_stop_analysis_section(stop_analysis)
    prompt += _format_model_stats_section(model_stats, stop_name or "25%")
    prompt += _format_mfe_mae_section(mfe_mae_stats)
    prompt += _format_sequence_section(sequence_stats)
    prompt += _format_simulated_section(simulated_stats)
    prompt += _format_leverage_section(leverage_stats)

    # Analysis request
    prompt += """
---

## Analysis Request

Based on the data above, please provide:

1. **Stop Strategy Recommendation**
   - Which stop level appears optimal for options trading?
   - How does this compare to typical options stop recommendations?
   - Are there model-specific considerations?

2. **Target Strategy Recommendation**
   - What target level maximizes expectancy?
   - Is there a "sweet spot" for risk:reward?
   - How quickly should we expect to reach targets?

3. **Model Comparison**
   - Which entry models perform best for options?
   - Are there significant differences between models?
   - Any models to avoid for options trading?

4. **Key Risk Factors**
   - What is the typical MAE (drawdown) before profit?
   - How often are stops being hit?
   - What is the sequence probability telling us?

5. **Actionable Recommendations**
   - Specific stop/target parameters to use
   - Position sizing considerations
   - Any warnings or cautions

Please be specific and quantitative in your analysis.
"""

    return prompt


def get_options_prompt_stats(prompt: str) -> Dict[str, int]:
    """
    Calculate statistics about the generated prompt.

    Returns:
    --------
    Dict with 'characters', 'words', 'estimated_tokens'
    """
    chars = len(prompt)
    words = len(prompt.split())
    # Rough estimate: ~4 characters per token
    tokens = chars // 4

    return {
        'characters': chars,
        'words': words,
        'estimated_tokens': tokens
    }
```

================================================================================
INTEGRATION WITH APP.PY
================================================================================

In the Options Analysis tab, update the Monte AI section:

```python
# After all calculations are complete...

# =================================================================
# Monte AI - Options Analysis (UPDATED)
# =================================================================
st.subheader("Monte AI - Options Analysis")
st.markdown("*Copy the prompt below to analyze options performance with Claude*")

# Get stop analysis for prompt (using DEFAULT stop type)
from calculations.options.op_stop_selector import DEFAULT_OPTIONS_STOP_TYPE
default_stop_outcomes = op_stop_analysis_results.get('results', {}).get(DEFAULT_OPTIONS_STOP_TYPE, [])
default_model_stats = calculate_options_win_rate_by_model_with_stop(default_stop_outcomes)

# Generate prompt with all new data
options_prompt = generate_options_overview_prompt(
    mfe_mae_stats=options_mfe_mae_stats,
    model_stats=default_model_stats,
    sequence_stats=options_sequence_stats,
    leverage_stats=options_leverage_stats,
    stop_analysis=op_stop_analysis_results,      # NEW
    simulated_stats=simulated_results,            # NEW
    filters={
        "date_from": date_from,
        "date_to": date_to,
        "models": selected_models,
        "directions": selected_directions
    },
    stop_name="25%"  # Default stop name
)

# Show prompt stats
prompt_stats = get_options_prompt_stats(options_prompt)
st.caption(f"Prompt: {prompt_stats['characters']:,} chars, ~{prompt_stats['estimated_tokens']:,} tokens")

# Expandable prompt
with st.expander("View/Copy Options Analysis Prompt", expanded=False):
    st.text_area(
        "Options Monte AI Prompt",
        value=options_prompt,
        height=500,
        key="options_monte_ai_prompt_full"
    )
    st.markdown("*Copy the above prompt and paste into Claude for analysis*")
```

================================================================================
PROMPT COMPARISON
================================================================================

CURRENT PROMPT STRUCTURE:
-------------------------
1. Overview
2. MFE/MAE Summary
3. Model Win Rate (simple)
4. Sequence Analysis
5. Leverage Comparison
6. Analysis Request

UPDATED PROMPT STRUCTURE:
-------------------------
1. Overview + Context Note
2. **Stop Type Analysis (NEW)**
3. Model Win Rate (with stop)
4. MFE/MAE Distribution
5. Sequence Analysis
6. **Simulated Outcomes (NEW)**
7. Leverage Comparison
8. **Expanded Analysis Request**

================================================================================
QUESTIONS FOR REVIEW
================================================================================

1. PROMPT LENGTH:
   The updated prompt is longer. Is this acceptable, or should we trim?
   Options:
   a) Include everything (current plan)
   b) Make sections collapsible/optional
   c) Generate multiple focused prompts

2. DEFAULT STOP:
   Prompt always uses 25% stop for consistency.
   Should we note what the user selected in the UI?

3. ANALYSIS REQUESTS:
   Current request is quite detailed.
   Should we make it more focused or keep comprehensive?

================================================================================
