# MONTE AI INTEGRATION - INDICATOR ANALYSIS
## Claude Code Implementation Instructions
### Epoch Trading System - Monte AI Research Assistant

**Document Version:** 1.0  
**Created:** 2026-01-03  
**Author:** Monte AI / Silva  
**Target Application:** 12_indicator_analysis  

---

## 1. OBJECTIVE

Create a dedicated Monte AI prompt generator for the Indicator Analysis tab that synthesizes results from CALC-005 through CALC-008 into actionable recommendations for DOW AI configuration updates.

### Purpose
1. **Analysis Synthesis** - Combine findings from all CALC modules
2. **DOW AI Recommendations** - Generate specific configuration changes
3. **Research Documentation** - Create exportable analysis reports
4. **Continuous Improvement** - Track findings over time

---

## 2. PROJECT CONTEXT

### Directory Structure
```
C:\XIIITradingSystems\Epoch\02_zone_system\12_indicator_analysis\
â”œâ”€â”€ monte_ai/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ ui.py                              # EXISTING - Main Monte AI UI
â”‚   â”œâ”€â”€ prompt_generator.py                # EXISTING - Base prompt generation
â”‚   â”œâ”€â”€ prompts.py                         # EXISTING - Base templates
â”‚   â”œâ”€â”€ data_collector.py                  # EXISTING - Data aggregation
â”‚   â”œâ”€â”€ indicator_prompts.py               # NEW FILE - Indicator-specific templates
â”‚   â””â”€â”€ indicator_prompt_generator.py      # NEW FILE - Indicator prompt generation
â””â”€â”€ app.py                                 # UPDATE - Wire Monte AI section
```

### Integration Points

Monte AI for Indicator Analysis needs access to:
- CALC-005 results (Health Score correlation)
- CALC-006 results (Factor importance)
- CALC-007 results (Progression analysis)
- CALC-008 results (Rejection dynamics)
- Raw entry_indicators data for custom queries

---

## 3. IMPLEMENTATION

### File: monte_ai/indicator_prompts.py

```python
"""
Monte AI Prompt Templates for Indicator Analysis

Specialized prompts for analyzing CALC-005 through CALC-008 results
and generating DOW AI configuration recommendations.
"""

# =============================================================================
# SYSTEM PROMPT FOR INDICATOR ANALYSIS
# =============================================================================

INDICATOR_ANALYSIS_SYSTEM_PROMPT = """You are Monte, an AI research assistant specializing in quantitative trading system analysis for XIII Trading LLC's Epoch Trading System.

## Your Current Task
Analyze the indicator analysis results (CALC-005 through CALC-008) and provide:
1. Key findings synthesis
2. Statistical validation assessment
3. DOW AI configuration recommendations
4. Areas requiring further investigation

## Context
The Epoch Trading System uses a 10-factor Health Score to evaluate trade setups:

STRUCTURE FACTORS (4 points):
- H4 Structure: 4-hour timeframe trend alignment
- H1 Structure: 1-hour timeframe trend alignment  
- M15 Structure: 15-minute timeframe trend alignment
- M5 Structure: 5-minute timeframe trend alignment

VOLUME FACTORS (3 points):
- Volume ROC: Volume above 20% baseline threshold
- Volume Delta: Rolling 5-bar delta aligned with direction
- CVD Slope: Cumulative volume delta trend aligned

PRICE FACTORS (3 points):
- SMA Alignment: SMA9 vs SMA21 position
- SMA Momentum: Spread widening (ratio > 1.1)
- VWAP Position: Price vs VWAP alignment

ENTRY MODELS:
- EPCH01: Continuation at primary zone (trade WITH trend)
- EPCH02: Rejection at primary zone (trade AGAINST trend - mean reversion)
- EPCH03: Continuation at secondary zone
- EPCH04: Rejection at secondary zone

## Analysis Framework
When analyzing results, consider:
1. Statistical significance (n â‰¥ 30 required)
2. Effect size (lift > 5pp considered meaningful)
3. Model-specific patterns (continuation vs rejection)
4. Practical implementation complexity

## Output Format
Provide structured recommendations with:
- Finding (what the data shows)
- Confidence level (HIGH/MEDIUM/LOW based on sample size)
- Recommendation (specific action for DOW AI)
- Priority (P1/P2/P3)
"""


# =============================================================================
# ANALYSIS TEMPLATES
# =============================================================================

CALC_005_ANALYSIS_TEMPLATE = """
## CALC-005: Health Score Correlation Analysis

### Data Summary
{data_summary}

### Key Questions
1. Does Health Score have meaningful predictive value (r > 0.1)?
2. What is the win rate spread between STRONG (8-10) and CRITICAL (0-3)?
3. What is the optimal filtering threshold?
4. Is the relationship consistent across models?

### Required Output
- Correlation assessment and statistical significance
- Lift analysis by health bucket
- Recommended Health Score threshold for DOW AI
- Model-specific observations
"""

CALC_006_ANALYSIS_TEMPLATE = """
## CALC-006: Individual Factor Predictiveness

### Data Summary
{data_summary}

### Key Questions
1. Which factors have the highest lift (healthy vs unhealthy)?
2. Which factors are "dead" (lift < 2pp)?
3. Are there factor groups that outperform others?
4. Are any factors redundant (highly correlated)?

### Required Output
- Ranked factor importance list
- Weight adjustment recommendations for DOW AI
- Factors to potentially remove
- Factor interaction observations
"""

CALC_007_ANALYSIS_TEMPLATE = """
## CALC-007: Indicator Progression Analysis

### Data Summary
{data_summary}

### Key Questions
1. Do winners and losers start with different indicator states?
2. What indicator changes predict trade failure?
3. What early warning signals have highest lift?
4. At what point do winner/loser paths diverge?

### Required Output
- Entry state differences between winners/losers
- Best early warning signal specification
- Exit signal recommendation for DOW AI
- Timing observations
"""

CALC_008_ANALYSIS_TEMPLATE = """
## CALC-008: Rejection Dynamics Analysis

### Data Summary
{data_summary}

### Key Questions
1. Is Health Score inverted for rejection trades (EPCH02/04)?
2. Which factors have opposite meaning for rejection vs continuation?
3. Do rejection trades reach MFE faster?
4. What exhaustion indicators predict rejection success?

### Required Output
- Inversion verdict (does rejection need different scoring?)
- List of factors to invert for rejection trades
- Recommended exhaustion indicators
- Dual scoring system recommendation (if warranted)
"""

SYNTHESIS_ANALYSIS_TEMPLATE = """
## Comprehensive Indicator Analysis Synthesis

You have been provided with results from all four indicator analyses:
- CALC-005: Health Score correlation
- CALC-006: Factor importance
- CALC-007: Progression patterns
- CALC-008: Rejection dynamics

### Combined Data Summary
{data_summary}

### Synthesis Questions
1. What is the overall verdict on the Health Score system's effectiveness?
2. Which specific changes would have the highest impact on system performance?
3. What is the recommended implementation priority order?
4. What additional data or analysis is needed?

### Required Output
1. **Executive Summary** (3-5 bullet points)
2. **DOW AI Configuration Changes** (specific, implementable changes)
3. **Model-Specific Adjustments**
4. **Statistical Confidence Assessment**
5. **Next Steps / Further Research**
"""


# =============================================================================
# DATA FORMATTING TEMPLATES
# =============================================================================

CALC_005_DATA_FORMAT = """
### Health Score Correlation Statistics
- Total Trades: {total_trades}
- Overall Win Rate: {overall_win_rate:.1f}%
- Correlation Coefficient: r = {correlation:.3f} (p = {pvalue:.4f})
- Optimal Threshold: â‰¥ {optimal_threshold} (lift: +{optimal_lift:.1f}pp)

### Win Rate by Bucket
| Bucket | Trades | Win Rate | Lift vs Baseline |
|--------|--------|----------|------------------|
{bucket_table}

### Model-Direction Breakdown
{model_breakdown}
"""

CALC_006_DATA_FORMAT = """
### Factor Importance Ranking
| Rank | Factor | Group | Healthy Win% | Unhealthy Win% | Lift |
|------|--------|-------|--------------|----------------|------|
{factor_table}

### Factor Group Summary
| Group | Avg Lift | Best Factor |
|-------|----------|-------------|
{group_summary}

### Top Factors
{top_factors}

### Dead Factors (lift < 2pp)
{dead_factors}
"""

CALC_007_DATA_FORMAT = """
### Progression Path Summary
| Outcome | Entry HS | Peak HS | Delta |
|---------|----------|---------|-------|
| Winners | {winner_entry:.1f} | {winner_peak:.1f} | {winner_delta:+.1f} |
| Losers | {loser_entry:.1f} | {loser_peak:.1f} | {loser_delta:+.1f} |

### Early Warning Signals
| Indicator | Threshold | Window | Loser Hit% | Winner Hit% | Lift |
|-----------|-----------|--------|------------|-------------|------|
{warning_table}

### Best Warning Signal
{best_warning}
"""

CALC_008_DATA_FORMAT = """
### Time-to-MFE Comparison
| Model Type | Trades | Median Min | â‰¤5min | â‰¤15min |
|------------|--------|------------|-------|--------|
{time_table}

### Health Score Inversion Test
| Model Type | Correlation | STRONG Win% | CRITICAL Win% | Inverted? |
|------------|-------------|-------------|---------------|-----------|
{inversion_table}

### Factor Inversion Results
| Factor | Continuation Lift | Rejection Lift | Inverted |
|--------|-------------------|----------------|----------|
{factor_inversion_table}

### Inverted Factors
{inverted_factors}

### Verdict
{verdict}
"""
```

---

### File: monte_ai/indicator_prompt_generator.py

```python
"""
Monte AI Indicator Analysis Prompt Generator

Generates analysis prompts for CALC-005 through CALC-008 results.
"""

import pandas as pd
from typing import Dict, List, Optional, Any
from dataclasses import dataclass

from .indicator_prompts import (
    INDICATOR_ANALYSIS_SYSTEM_PROMPT,
    CALC_005_ANALYSIS_TEMPLATE,
    CALC_006_ANALYSIS_TEMPLATE,
    CALC_007_ANALYSIS_TEMPLATE,
    CALC_008_ANALYSIS_TEMPLATE,
    SYNTHESIS_ANALYSIS_TEMPLATE,
    CALC_005_DATA_FORMAT,
    CALC_006_DATA_FORMAT,
    CALC_007_DATA_FORMAT,
    CALC_008_DATA_FORMAT
)


@dataclass
class IndicatorAnalysisPrompt:
    """Generated prompt with metadata."""
    system_prompt: str
    user_prompt: str
    analysis_type: str
    data_summary: str
    estimated_tokens: int


def estimate_tokens(text: str) -> int:
    """Estimate token count (rough approximation)."""
    return len(text.split()) * 1.3


def format_bucket_table(bucket_df: pd.DataFrame) -> str:
    """Format health bucket data as markdown table."""
    if bucket_df is None or bucket_df.empty:
        return "No bucket data available"
    
    rows = []
    for _, row in bucket_df.iterrows():
        lift = row.get('lift', 0)
        lift_str = f"+{lift:.1f}pp" if lift > 0 else f"{lift:.1f}pp"
        rows.append(
            f"| {row.get('bucket', 'N/A')} | {row.get('trades', 0)} | "
            f"{row.get('win_rate', 0):.1f}% | {lift_str} |"
        )
    return "\n".join(rows)


def format_factor_table(factor_df: pd.DataFrame) -> str:
    """Format factor importance data as markdown table."""
    if factor_df is None or factor_df.empty:
        return "No factor data available"
    
    rows = []
    for i, row in factor_df.iterrows():
        lift = row.get('lift', 0)
        lift_str = f"+{lift:.1f}pp" if lift > 0 else f"{lift:.1f}pp"
        rows.append(
            f"| {i+1} | {row.get('factor', 'N/A')} | {row.get('group', 'N/A')} | "
            f"{row.get('healthy_win_rate', 0):.1f}% | {row.get('unhealthy_win_rate', 0):.1f}% | {lift_str} |"
        )
    return "\n".join(rows)


def format_warning_table(warnings: List) -> str:
    """Format early warning signals as markdown table."""
    if not warnings:
        return "No significant warning signals identified"
    
    rows = []
    for w in warnings[:5]:  # Top 5
        rows.append(
            f"| {w.indicator} | â‰¤{w.threshold} | {w.bars_window} bars | "
            f"{w.hit_rate_losers:.1f}% | {w.hit_rate_winners:.1f}% | +{w.lift:.1f}pp |"
        )
    return "\n".join(rows)


# =============================================================================
# PROMPT GENERATORS BY ANALYSIS TYPE
# =============================================================================

def generate_calc_005_prompt(result) -> IndicatorAnalysisPrompt:
    """
    Generate prompt for CALC-005 Health Score Correlation analysis.
    
    Parameters:
        result: HealthCorrelationResult from CALC-005
    
    Returns:
        IndicatorAnalysisPrompt ready for Claude
    """
    # Format data summary
    bucket_table = format_bucket_table(result.bucket_distribution)
    
    # Model breakdown (simplified)
    model_breakdown = "See detailed breakdown in analysis results."
    if hasattr(result, 'model_direction_breakdown') and result.model_direction_breakdown is not None:
        model_breakdown = result.model_direction_breakdown.to_string()[:500] + "..."
    
    data_summary = CALC_005_DATA_FORMAT.format(
        total_trades=result.total_trades,
        overall_win_rate=result.overall_win_rate,
        correlation=result.correlation_coefficient,
        pvalue=result.correlation_pvalue,
        optimal_threshold=result.optimal_threshold,
        optimal_lift=result.optimal_threshold_lift,
        bucket_table=bucket_table,
        model_breakdown=model_breakdown
    )
    
    user_prompt = CALC_005_ANALYSIS_TEMPLATE.format(data_summary=data_summary)
    
    full_prompt = f"{INDICATOR_ANALYSIS_SYSTEM_PROMPT}\n\n{user_prompt}"
    
    return IndicatorAnalysisPrompt(
        system_prompt=INDICATOR_ANALYSIS_SYSTEM_PROMPT,
        user_prompt=user_prompt,
        analysis_type="CALC-005: Health Score Correlation",
        data_summary=data_summary,
        estimated_tokens=int(estimate_tokens(full_prompt))
    )


def generate_calc_006_prompt(result) -> IndicatorAnalysisPrompt:
    """
    Generate prompt for CALC-006 Factor Importance analysis.
    
    Parameters:
        result: FactorImportanceResult from CALC-006
    
    Returns:
        IndicatorAnalysisPrompt ready for Claude
    """
    factor_table = format_factor_table(result.ranked_by_lift)
    
    # Group summary
    group_summary = ""
    if hasattr(result, 'group_summary') and result.group_summary is not None:
        for _, row in result.group_summary.iterrows():
            group_summary += f"| {row['group']} | +{row['avg_lift']:.1f}pp | {row['best_factor']} |\n"
    
    data_summary = CALC_006_DATA_FORMAT.format(
        factor_table=factor_table,
        group_summary=group_summary,
        top_factors=", ".join(result.top_factors) if result.top_factors else "None identified",
        dead_factors=", ".join(result.dead_factors) if result.dead_factors else "None identified"
    )
    
    user_prompt = CALC_006_ANALYSIS_TEMPLATE.format(data_summary=data_summary)
    
    return IndicatorAnalysisPrompt(
        system_prompt=INDICATOR_ANALYSIS_SYSTEM_PROMPT,
        user_prompt=user_prompt,
        analysis_type="CALC-006: Factor Importance",
        data_summary=data_summary,
        estimated_tokens=int(estimate_tokens(INDICATOR_ANALYSIS_SYSTEM_PROMPT + user_prompt))
    )


def generate_calc_007_prompt(result) -> IndicatorAnalysisPrompt:
    """
    Generate prompt for CALC-007 Indicator Progression analysis.
    
    Parameters:
        result: IndicatorProgressionResult from CALC-007
    
    Returns:
        IndicatorAnalysisPrompt ready for Claude
    """
    # Extract progression data
    winner_entry = result.winner_path.entry_snapshot.avg_health_score if result.winner_path else 0
    winner_peak = result.winner_path.peak_snapshot.avg_health_score if result.winner_path else 0
    winner_delta = result.winner_path.health_delta_to_peak if result.winner_path else 0
    
    loser_entry = result.loser_path.entry_snapshot.avg_health_score if result.loser_path else 0
    loser_peak = result.loser_path.peak_snapshot.avg_health_score if result.loser_path else 0
    loser_delta = result.loser_path.health_delta_to_peak if result.loser_path else 0
    
    warning_table = format_warning_table(result.early_warnings)
    
    best_warning = "None identified"
    if result.best_warning:
        bw = result.best_warning
        best_warning = (
            f"{bw.indicator} drop of {bw.threshold} within {bw.bars_window} bars "
            f"catches {bw.hit_rate_losers:.0f}% of losers with {bw.hit_rate_winners:.0f}% false positives"
        )
    
    data_summary = CALC_007_DATA_FORMAT.format(
        winner_entry=winner_entry,
        winner_peak=winner_peak,
        winner_delta=winner_delta,
        loser_entry=loser_entry,
        loser_peak=loser_peak,
        loser_delta=loser_delta,
        warning_table=warning_table,
        best_warning=best_warning
    )
    
    user_prompt = CALC_007_ANALYSIS_TEMPLATE.format(data_summary=data_summary)
    
    return IndicatorAnalysisPrompt(
        system_prompt=INDICATOR_ANALYSIS_SYSTEM_PROMPT,
        user_prompt=user_prompt,
        analysis_type="CALC-007: Indicator Progression",
        data_summary=data_summary,
        estimated_tokens=int(estimate_tokens(INDICATOR_ANALYSIS_SYSTEM_PROMPT + user_prompt))
    )


def generate_calc_008_prompt(result) -> IndicatorAnalysisPrompt:
    """
    Generate prompt for CALC-008 Rejection Dynamics analysis.
    
    Parameters:
        result: RejectionDynamicsResult from CALC-008
    
    Returns:
        IndicatorAnalysisPrompt ready for Claude
    """
    # Time comparison table
    time_table = result.time_comparison.to_string(index=False) if result.time_comparison is not None else "No data"
    
    # Inversion table
    ci = result.continuation_inversion
    ri = result.rejection_inversion
    inversion_table = f"""| Continuation | {ci.correlation:.3f} | {ci.strong_win_rate:.1f}% | {ci.critical_win_rate:.1f}% | {'YES' if ci.is_inverted else 'No'} |
| Rejection | {ri.correlation:.3f} | {ri.strong_win_rate:.1f}% | {ri.critical_win_rate:.1f}% | {'YES' if ri.is_inverted else 'No'} |"""
    
    # Factor inversion table
    factor_rows = []
    for fi in result.factor_inversions:
        factor_rows.append(
            f"| {fi.factor_name} | {fi.continuation_lift:+.1f}pp | {fi.rejection_lift:+.1f}pp | "
            f"{'ðŸ”„ YES' if fi.is_inverted else 'No'} |"
        )
    factor_inversion_table = "\n".join(factor_rows)
    
    verdict = (
        "âš ï¸ REJECTION TRADES REQUIRE DIFFERENT SCORING" if result.rejection_requires_different_scoring
        else "âœ“ Current scoring system appears valid for both model types"
    )
    
    data_summary = CALC_008_DATA_FORMAT.format(
        time_table=time_table,
        inversion_table=inversion_table,
        factor_inversion_table=factor_inversion_table,
        inverted_factors=", ".join(result.inverted_factors) if result.inverted_factors else "None",
        verdict=verdict
    )
    
    user_prompt = CALC_008_ANALYSIS_TEMPLATE.format(data_summary=data_summary)
    
    return IndicatorAnalysisPrompt(
        system_prompt=INDICATOR_ANALYSIS_SYSTEM_PROMPT,
        user_prompt=user_prompt,
        analysis_type="CALC-008: Rejection Dynamics",
        data_summary=data_summary,
        estimated_tokens=int(estimate_tokens(INDICATOR_ANALYSIS_SYSTEM_PROMPT + user_prompt))
    )


def generate_synthesis_prompt(
    calc_005_result=None,
    calc_006_result=None,
    calc_007_result=None,
    calc_008_result=None
) -> IndicatorAnalysisPrompt:
    """
    Generate comprehensive synthesis prompt combining all CALC results.
    
    Parameters:
        calc_005_result: HealthCorrelationResult (optional)
        calc_006_result: FactorImportanceResult (optional)
        calc_007_result: IndicatorProgressionResult (optional)
        calc_008_result: RejectionDynamicsResult (optional)
    
    Returns:
        IndicatorAnalysisPrompt with synthesis template
    """
    sections = []
    
    if calc_005_result:
        sections.append(f"""
### CALC-005: Health Score Correlation
- Correlation: r = {calc_005_result.correlation_coefficient:.3f}
- Optimal Threshold: â‰¥{calc_005_result.optimal_threshold} (lift: +{calc_005_result.optimal_threshold_lift:.1f}pp)
- STRONG vs CRITICAL spread: {calc_005_result.bucket_distribution[calc_005_result.bucket_distribution['bucket']=='STRONG']['win_rate'].values[0] - calc_005_result.bucket_distribution[calc_005_result.bucket_distribution['bucket']=='CRITICAL']['win_rate'].values[0]:.1f}pp
""")
    
    if calc_006_result:
        sections.append(f"""
### CALC-006: Factor Importance
- Top Factors: {', '.join(calc_006_result.top_factors) if calc_006_result.top_factors else 'None'}
- Dead Factors: {', '.join(calc_006_result.dead_factors) if calc_006_result.dead_factors else 'None'}
""")
    
    if calc_007_result and calc_007_result.best_warning:
        bw = calc_007_result.best_warning
        sections.append(f"""
### CALC-007: Progression Analysis
- Best Early Warning: {bw.indicator} â‰¤{bw.threshold} within {bw.bars_window} bars
- Signal captures {bw.hit_rate_losers:.0f}% of losers, {bw.hit_rate_winners:.0f}% false positive rate
""")
    
    if calc_008_result:
        sections.append(f"""
### CALC-008: Rejection Dynamics
- Verdict: {'Different scoring needed' if calc_008_result.rejection_requires_different_scoring else 'Unified scoring OK'}
- Inverted Factors: {', '.join(calc_008_result.inverted_factors) if calc_008_result.inverted_factors else 'None'}
""")
    
    data_summary = "\n".join(sections) if sections else "No analysis results available"
    
    user_prompt = SYNTHESIS_ANALYSIS_TEMPLATE.format(data_summary=data_summary)
    
    return IndicatorAnalysisPrompt(
        system_prompt=INDICATOR_ANALYSIS_SYSTEM_PROMPT,
        user_prompt=user_prompt,
        analysis_type="Synthesis: All Indicator Analyses",
        data_summary=data_summary,
        estimated_tokens=int(estimate_tokens(INDICATOR_ANALYSIS_SYSTEM_PROMPT + user_prompt))
    )
```

---

### File: Update monte_ai/ui.py

Add indicator analysis Monte AI section:

```python
# Add at end of file or create new function:

def render_indicator_analysis_monte_ai(
    calc_005_result=None,
    calc_006_result=None,
    calc_007_result=None,
    calc_008_result=None
):
    """
    Render Monte AI section for Indicator Analysis tab.
    
    Parameters:
        calc_005_result: HealthCorrelationResult (optional)
        calc_006_result: FactorImportanceResult (optional)
        calc_007_result: IndicatorProgressionResult (optional)
        calc_008_result: RejectionDynamicsResult (optional)
    """
    import streamlit as st
    from .indicator_prompt_generator import (
        generate_calc_005_prompt,
        generate_calc_006_prompt,
        generate_calc_007_prompt,
        generate_calc_008_prompt,
        generate_synthesis_prompt
    )
    
    st.subheader("ðŸ¤– Monte AI - Indicator Analysis")
    st.markdown("*Generate analysis prompts for Claude*")
    
    # Analysis type selector
    analysis_options = ["Synthesis (All)", "CALC-005", "CALC-006", "CALC-007", "CALC-008"]
    selected_analysis = st.selectbox("Select Analysis Type", analysis_options)
    
    # Generate button
    if st.button("Generate Analysis Prompt", type="primary"):
        try:
            if selected_analysis == "Synthesis (All)":
                prompt = generate_synthesis_prompt(
                    calc_005_result, calc_006_result, calc_007_result, calc_008_result
                )
            elif selected_analysis == "CALC-005" and calc_005_result:
                prompt = generate_calc_005_prompt(calc_005_result)
            elif selected_analysis == "CALC-006" and calc_006_result:
                prompt = generate_calc_006_prompt(calc_006_result)
            elif selected_analysis == "CALC-007" and calc_007_result:
                prompt = generate_calc_007_prompt(calc_007_result)
            elif selected_analysis == "CALC-008" and calc_008_result:
                prompt = generate_calc_008_prompt(calc_008_result)
            else:
                st.warning(f"No results available for {selected_analysis}")
                return
            
            # Display prompt info
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("Analysis Type", prompt.analysis_type)
            with col2:
                st.metric("Estimated Tokens", f"{prompt.estimated_tokens:,}")
            with col3:
                st.metric("Data Summary Length", f"{len(prompt.data_summary):,} chars")
            
            # Full prompt text area
            full_prompt = f"{prompt.system_prompt}\n\n---\n\n{prompt.user_prompt}"
            
            st.text_area(
                "Generated Prompt",
                value=full_prompt,
                height=400,
                key="indicator_monte_prompt"
            )
            
            # Action buttons
            col1, col2, col3 = st.columns(3)
            
            with col1:
                st.download_button(
                    label="ðŸ“¥ Download Prompt",
                    data=full_prompt,
                    file_name=f"monte_ai_{selected_analysis.lower().replace(' ', '_')}.txt",
                    mime="text/plain"
                )
            
            with col2:
                if st.button("ðŸ“‹ Copy to Clipboard"):
                    st.code(full_prompt[:100] + "...")
                    st.info("Use Ctrl+A, Ctrl+C in the text area above to copy")
            
            with col3:
                st.markdown("[Open Claude â†’](https://claude.ai)")
            
        except Exception as e:
            st.error(f"Error generating prompt: {e}")
            import traceback
            st.code(traceback.format_exc())
```

---

## 4. UPDATE app.py

Wire Monte AI into the Indicator Analysis tab:

```python
# At the bottom of the Indicator Analysis tab (tab2), after all CALC sub-tabs:

with tab2:  # Indicator Analysis tab
    # ... existing CALC-005 through CALC-008 sub-tabs ...
    
    # Monte AI Section
    st.divider()
    
    from monte_ai.ui import render_indicator_analysis_monte_ai
    
    # Collect results from CALC modules (if they exist)
    calc_005_result = st.session_state.get('calc_005_result', None)
    calc_006_result = st.session_state.get('calc_006_result', None)
    calc_007_result = st.session_state.get('calc_007_result', None)
    calc_008_result = st.session_state.get('calc_008_result', None)
    
    render_indicator_analysis_monte_ai(
        calc_005_result=calc_005_result,
        calc_006_result=calc_006_result,
        calc_007_result=calc_007_result,
        calc_008_result=calc_008_result
    )
```

**Note:** Update each CALC render function to store results in session state:

```python
# In render_calc_005_section():
result = analyze_health_correlation(df)
st.session_state['calc_005_result'] = result

# Similarly for other CALC modules
```

---

## 5. FILE CREATION SUMMARY

| File | Action | Purpose |
|------|--------|---------|
| `monte_ai/indicator_prompts.py` | CREATE | Prompt templates for indicator analysis |
| `monte_ai/indicator_prompt_generator.py` | CREATE | Prompt generation logic |
| `monte_ai/ui.py` | MODIFY | Add render_indicator_analysis_monte_ai() |
| `app.py` | MODIFY | Wire Monte AI section, add session state storage |

---

## 6. EXPECTED USAGE

1. **Run all CALC analyses** in the Indicator Analysis tab
2. **Scroll to Monte AI section**
3. **Select analysis type** (individual or synthesis)
4. **Click Generate** to create prompt
5. **Copy/download** the generated prompt
6. **Paste into Claude** for analysis

---

## 7. SAMPLE GENERATED PROMPT

```
You are Monte, an AI research assistant specializing in quantitative 
trading system analysis for XIII Trading LLC's Epoch Trading System.

[... system context ...]

---

## Comprehensive Indicator Analysis Synthesis

### CALC-005: Health Score Correlation
- Correlation: r = 0.182
- Optimal Threshold: â‰¥6 (lift: +5.3pp)
- STRONG vs CRITICAL spread: 15.4pp

### CALC-006: Factor Importance
- Top Factors: VWAP Position, H4 Structure, CVD Slope
- Dead Factors: SMA Momentum, M5 Structure

### CALC-007: Progression Analysis
- Best Early Warning: health_score â‰¤-1.5 within 5 bars
- Signal captures 68% of losers, 24% false positive rate

### CALC-008: Rejection Dynamics
- Verdict: Different scoring needed
- Inverted Factors: CVD Slope, Volume Delta, SMA Alignment

### Synthesis Questions
1. What is the overall verdict on the Health Score system's effectiveness?
2. Which specific changes would have the highest impact?
3. What is the recommended implementation priority order?
4. What additional data or analysis is needed?

### Required Output
1. Executive Summary (3-5 bullet points)
2. DOW AI Configuration Changes
3. Model-Specific Adjustments
4. Statistical Confidence Assessment
5. Next Steps / Further Research
```

---

## 8. NOTES FOR CLAUDE CODE

1. **Session State**: Store CALC results in st.session_state so Monte AI can access them.

2. **Token Estimation**: Rough estimate using word count * 1.3. Not precise but useful.

3. **Error Handling**: Handle None results gracefully - some CALC modules may not have run.

4. **Download Format**: Plain text (.txt) for easy paste into Claude.

5. **Modular Design**: Each CALC has its own prompt generator for flexibility.

6. **Synthesis Mode**: Combines all available results into single comprehensive prompt.

---

**END OF DOCUMENT 7**