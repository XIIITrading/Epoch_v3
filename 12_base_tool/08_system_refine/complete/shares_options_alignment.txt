================================================================================
EPOCH SYSTEM REFINEMENT - Shares/Options Win Condition Alignment
================================================================================
Created: 2026-01-08
Status: PENDING
Priority: Medium
Module: 12_indicator_analysis
================================================================================

OVERVIEW
--------
The Options Analysis tab and Metrics Overview (Shares) tab use different win
condition definitions, making direct comparison unreliable. This document
outlines the adjustments needed to align the two analyses.

================================================================================
CURRENT STATE
================================================================================

SHARES (Metrics Overview Tab):
- Source: trades table, is_winner field
- Win Condition: is_winner = 1 (pre-calculated boolean)
- Issue: is_winner field is noted as "unreliable" - populated from backtester
         exit logic that may have bugs or inconsistent criteria
- May include: stop-based exits, target-based exits, EOD exits with unclear
               win/loss assignment

OPTIONS (Options Analysis Tab):
- Source: op_mfe_mae_potential table, exit_pct field
- Win Condition: exit_pct > 0 (option price at 15:30 ET > entry price)
- Clean Definition: Pure price comparison at fixed time

OBSERVED DISCREPANCIES (2025-12-15 to 2026-01-07):
-------------------------------------------------
Model   | Shares Win% | Options Win% | Delta
--------|-------------|--------------|--------
EPCH01  | 30.6%       | 47.8%        | +17.2%
EPCH02  | 46.4%       | 43.7%        | -2.7%
EPCH03  | 32.4%       | 38.6%        | +6.2%
EPCH04  | 34.1%       | 44.6%        | +10.5%

Trade counts: Shares = 1,412, Options = 1,320 (92 gap due to options liquidity)

================================================================================
REQUIRED CHANGES
================================================================================

PART 1: Add EOD Win Rate to Metrics Overview
--------------------------------------------
Location: 02_zone_system/12_indicator_analysis/calculations/win_rate_by_model.py

Change: Add a new calculation that uses mfe_mae_potential.exit_pct for shares
        win rate, matching the options methodology.

New Metrics to Add:
- EOD Win Rate: % of trades where underlying exit_pct > 0 at 15:30 ET
- Show alongside existing is_winner-based win rate for comparison
- Label clearly: "EOD Win Rate (exit > entry at 15:30)"

Implementation:
1. In win_rate_by_model.py, add function:
   calculate_eod_win_rate_by_model(mfe_mae_data)
   - Input: mfe_mae_potential data (already loaded in app.py)
   - Calculate: exit_pct > 0 for each trade
   - Group by model
   - Return DataFrame with: Model, EOD_Wins, EOD_Losses, EOD_Win%

2. In app.py Metrics Overview tab:
   - Add section showing EOD Win Rate alongside existing Win Rate
   - Label: "EOD Win Rate (Comparable to Options)"

PART 2: Update Monte AI Prompts
-------------------------------
Location: 02_zone_system/12_indicator_analysis/monte_ai/prompts.py

Change: Update SYSTEM_CONTEXT and data formatting to:
1. Clarify the two win rate definitions
2. Include both metrics in the prompt
3. Add guidance on when to use each metric

Add to Prompt Context:
```
WIN RATE DEFINITIONS:
- is_winner Win Rate: Based on trades.is_winner field (may be unreliable)
- EOD Win Rate: Based on exit_pct > 0 at 15:30 ET (comparable to options)

For apples-to-apples comparison with Options Analysis, use EOD Win Rate.
```

PART 3: Remove Leverage from Shares Analysis
--------------------------------------------
Confirm: Leverage calculations should ONLY appear in Options Analysis tab.
         Shares analysis has no leverage concept.

Current State: Verified - no leverage in Metrics Overview tab.
Action: None needed, already correct.

PART 4: Update Monte AI Options Prompts
---------------------------------------
Location: 02_zone_system/12_indicator_analysis/monte_ai/options_prompts.py

Change: Add cross-reference section explaining relationship to shares data.

Add to OPTIONS_CONTEXT:
```
COMPARISON TO UNDERLYING (SHARES) ANALYSIS:
- Options win rate uses exit_pct > 0 (same as shares EOD Win Rate)
- Options trade count may be lower due to liquidity/data gaps
- Leverage metrics are OPTIONS-ONLY (not applicable to shares)
- For direct comparison, use EOD Win Rate from Metrics Overview tab
```

================================================================================
IMPLEMENTATION STEPS
================================================================================

STEP 1: Create EOD win rate calculation
- File: calculations/win_rate_by_model.py
- Add: calculate_eod_win_rate_by_model() function
- Test: Verify output matches options methodology

STEP 2: Update app.py Metrics Overview section
- Add: Call to calculate_eod_win_rate_by_model()
- Add: Display section for EOD Win Rate table
- Add: Clear labeling distinguishing the two metrics

STEP 3: Update Monte AI prompts
- File: monte_ai/prompts.py
- Add: WIN RATE DEFINITIONS section
- Add: EOD Win Rate data to formatted output

STEP 4: Update Monte AI options prompts
- File: monte_ai/options_prompts.py
- Add: Cross-reference section for shares comparison

STEP 5: Test and validate
- Run app with both tabs
- Compare EOD Win Rate (shares) to Options Win Rate
- Verify closer alignment with shared methodology

================================================================================
EXPECTED OUTCOME
================================================================================

After implementation:
- Shares and Options tabs will have comparable win rate metrics
- Users can directly compare EOD Win Rate (shares) to Options Win Rate
- Monte AI prompts will clearly explain the difference
- Both analyses use: "Win = exit_pct > 0 at 15:30 ET"

The remaining difference will be:
- Trade count gap (92 trades) due to options liquidity
- This is expected and acceptable

================================================================================
TESTING CHECKLIST
================================================================================

[ ] EOD Win Rate calculation produces sensible results
[ ] EOD Win Rate is displayed in Metrics Overview tab
[ ] Labels clearly distinguish is_winner vs EOD win rate
[ ] Monte AI prompt includes both win rate definitions
[ ] Options prompt includes cross-reference guidance
[ ] App runs without errors after changes
[ ] EOD Win Rate aligns closer to Options Win Rate by model

================================================================================
NOTES
================================================================================

- The is_winner field should be investigated separately for data quality
- Consider deprecating is_winner-based win rate if EOD proves more reliable
- Future: May want to add EOD Win Rate to trades table as calculated field

================================================================================
