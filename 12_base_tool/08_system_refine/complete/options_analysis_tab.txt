# OPTIONS ANALYSIS TAB - IMPLEMENTATION PLAN
## Claude Code Implementation Instructions
### Epoch Trading System - Options MFE/MAE Analysis
### XIII Trading LLC

**Document Version:** 1.0
**Created:** 2026-01-08
**Author:** Claude Code / Silva
**Target Applications:**
- `02_zone_system/09_backtest/processor/secondary_analysis/op_mfe_mae/` (NEW)
- `02_zone_system/12_indicator_analysis/` (UPDATE)

---

## 1. OBJECTIVE

Create a complete options MFE/MAE analysis pipeline that mirrors the existing share-based `mfe_mae/` secondary analysis, plus an Options Analysis tab in the Indicator Analysis dashboard.

### Purpose
1. **Data Collection** - Calculate MFE/MAE in POINTS for options trades (Entry -> 15:30 Exit)
2. **Performance Analysis** - Compare options performance to underlying share performance
3. **Monte AI Integration** - Generate analysis prompts for Claude (same format as Metrics Overview)
4. **Decision Support** - Inform options trading strategy and sizing

---

## 2. PROJECT CONTEXT

### Source of Truth
- `trades` table - All trade entries with trade_id, ticker, direction, entry_time, entry_price, model
- `options_analysis` table - Options contract selection (options_ticker, strike, expiration, contract_type)
- `mfe_mae_potential` table - Underlying share MFE/MAE for comparison

### Key Principle
**Mirror the share-based mfe_mae/ pattern exactly** - same events (Entry, MFE, MAE, 15:30 Exit), same calculation methodology, but measuring OPTIONS price movement in POINTS (not R-multiples).

### Sample Data (from options_analysis)
```json
{
  "trade_id": "WDC_121825_EPCH4_0931",
  "ticker": "WDC",
  "direction": "LONG",
  "entry_date": "2025-12-18",
  "entry_time": "09:31:00",
  "entry_price": "176.98",
  "options_ticker": "O:WDC260102C00175000",
  "strike": "175.00",
  "expiration": "2026-01-02",
  "contract_type": "CALL"
}
```

---

## 3. IMPLEMENTATION - PART 1: SECONDARY ANALYSIS MODULE

### 3.1 Directory Structure

Create new directory:
```
C:\XIIITradingSystems\Epoch\02_zone_system\09_backtest\processor\secondary_analysis\op_mfe_mae\
├── __init__.py
├── config.py                      # Configuration (DB, API, parameters)
├── options_bar_fetcher.py         # Fetch 1-minute options bars from Polygon
├── op_mfe_mae_calc.py             # Core MFE/MAE calculation logic
├── op_mfe_mae_runner.py           # CLI runner
├── schema/
│   └── op_mfe_mae_potential.sql   # Table creation SQL
└── docs/
    ├── AI_READABLE.txt            # AI context document
    └── HUMAN_READABLE.txt         # Teaching document
```

### 3.2 Database Schema

**File:** `schema/op_mfe_mae_potential.sql`

```sql
-- ============================================================================
-- EPOCH TRADING SYSTEM - OPTIONS MFE/MAE POTENTIAL TABLE
-- Stores options price excursions from entry to 15:30 ET
-- ============================================================================

CREATE TABLE IF NOT EXISTS public.op_mfe_mae_potential (
    -- Primary Key
    trade_id VARCHAR(50) PRIMARY KEY,

    -- Trade Metadata (from trades table)
    date DATE NOT NULL,
    ticker VARCHAR(10) NOT NULL,
    direction VARCHAR(10),
    model VARCHAR(20),

    -- Options Contract Info (from options_analysis table)
    options_ticker VARCHAR(30) NOT NULL,
    strike NUMERIC(10, 2),
    expiration DATE,
    contract_type VARCHAR(10),  -- CALL or PUT

    -- Entry Event
    entry_time TIME,
    option_entry_price NUMERIC(10, 4),

    -- MFE Event (Max Favorable Excursion)
    mfe_points NUMERIC(10, 4),          -- Favorable movement in points (always positive)
    mfe_price NUMERIC(10, 4),           -- Option price at MFE
    mfe_time TIME,                      -- When MFE occurred
    mfe_pct NUMERIC(10, 4),             -- MFE as % of entry price

    -- MAE Event (Max Adverse Excursion)
    mae_points NUMERIC(10, 4),          -- Adverse movement in points (always positive)
    mae_price NUMERIC(10, 4),           -- Option price at MAE
    mae_time TIME,                      -- When MAE occurred
    mae_pct NUMERIC(10, 4),             -- MAE as % of entry price

    -- Exit Event (15:30 ET)
    exit_price NUMERIC(10, 4),          -- Option price at 15:30 ET
    exit_time TIME DEFAULT '15:30:00',  -- Always 15:30
    exit_points NUMERIC(10, 4),         -- Exit - Entry in points (can be negative)
    exit_pct NUMERIC(10, 4),            -- Exit P&L as % of entry price

    -- Comparison to Underlying (from mfe_mae_potential)
    underlying_mfe_pct NUMERIC(10, 4),
    underlying_mae_pct NUMERIC(10, 4),
    underlying_exit_pct NUMERIC(10, 4),

    -- Metadata
    bars_analyzed INT,
    eod_cutoff TIME DEFAULT '15:30:00',
    created_at TIMESTAMPTZ DEFAULT NOW(),

    -- Foreign Key
    CONSTRAINT op_mfe_mae_potential_trade_fkey
        FOREIGN KEY (trade_id) REFERENCES trades(trade_id) ON DELETE CASCADE
);

-- Indexes for common queries
CREATE INDEX IF NOT EXISTS idx_op_mfe_mae_date ON op_mfe_mae_potential(date DESC);
CREATE INDEX IF NOT EXISTS idx_op_mfe_mae_ticker ON op_mfe_mae_potential(ticker);
CREATE INDEX IF NOT EXISTS idx_op_mfe_mae_model ON op_mfe_mae_potential(model);
CREATE INDEX IF NOT EXISTS idx_op_mfe_mae_contract_type ON op_mfe_mae_potential(contract_type);

-- Comment
COMMENT ON TABLE op_mfe_mae_potential IS 'Options MFE/MAE from entry to 15:30 ET - mirrors mfe_mae_potential for shares';
```

### 3.3 Configuration

**File:** `config.py`

```python
"""
EPOCH TRADING SYSTEM - OPTIONS MFE/MAE CONFIGURATION
"""

from datetime import time
from pathlib import Path

# =============================================================================
# MODULE PATHS
# =============================================================================
MODULE_DIR = Path(__file__).parent
SCHEMA_DIR = MODULE_DIR / "schema"
DOCS_DIR = MODULE_DIR / "docs"

# =============================================================================
# SUPABASE CONFIGURATION
# =============================================================================
SUPABASE_HOST = "db.pdbmcskznoaiybdiobje.supabase.co"
SUPABASE_PORT = 5432
SUPABASE_DATABASE = "postgres"
SUPABASE_USER = "postgres"
SUPABASE_PASSWORD = "guid-saltation-covet"

DB_CONFIG = {
    "host": SUPABASE_HOST,
    "port": SUPABASE_PORT,
    "database": SUPABASE_DATABASE,
    "user": SUPABASE_USER,
    "password": SUPABASE_PASSWORD,
    "sslmode": "require"
}

# =============================================================================
# POLYGON API CONFIGURATION
# =============================================================================
POLYGON_API_KEY = "f4vzZl0gWXkv9hiKJprpsVRqbwrydf4_"
POLYGON_BASE_URL = "https://api.polygon.io"

API_DELAY = 0.0  # No delay for unlimited tier
API_RETRIES = 3
API_RETRY_DELAY = 1.0
REQUEST_TIMEOUT = 30

# =============================================================================
# TRADING SESSION TIMES (Eastern Time)
# =============================================================================
MARKET_OPEN = time(9, 30)
EOD_CUTOFF = time(15, 30)
MARKET_CLOSE = time(16, 0)

# =============================================================================
# BAR CONFIGURATION
# =============================================================================
BAR_MULTIPLIER = 1
BAR_TIMESPAN = "minute"  # 1-minute bars for granular MFE/MAE

# =============================================================================
# TABLE CONFIGURATION
# =============================================================================
SOURCE_TRADES_TABLE = "trades"
SOURCE_OPTIONS_TABLE = "options_analysis"
SOURCE_MFE_MAE_TABLE = "mfe_mae_potential"  # For underlying comparison
TARGET_TABLE = "op_mfe_mae_potential"

# =============================================================================
# CALCULATION PARAMETERS
# =============================================================================
MIN_OPTION_PRICE = 0.01  # Skip options priced below this

# =============================================================================
# LOGGING
# =============================================================================
VERBOSE = True
```

### 3.4 Options Bar Fetcher

**File:** `options_bar_fetcher.py`

Pattern from: `mfe_mae/m1_fetcher.py` + `options_analysis/fetcher.py`

Key functionality:
- Fetch 1-minute bars for options contracts from Polygon
- Convert timestamps to Eastern Time
- Cache results by options_ticker + date
- Handle O: prefix for options tickers

```python
"""
EPOCH TRADING SYSTEM - OPTIONS 1-MINUTE BAR FETCHER
Fetches 1-minute bars for options contracts from Polygon.io API.
"""

# Implementation mirrors m1_fetcher.py but for options tickers
# Key differences:
# - URL uses options ticker format: /v2/aggs/ticker/{options_ticker}/range/1/minute/{date}/{date}
# - Options tickers must have O: prefix
# - Lower volume = fewer bars (handle gracefully)

class OptionsBarFetcher:
    """
    Fetches 1-minute options bar data from Polygon.io API.
    Mirrors M1Fetcher pattern but for options contracts.
    """

    def fetch_trading_day(self, options_ticker: str, trade_date,
                          start_time: time = None,
                          end_time: time = None) -> pd.DataFrame:
        """
        Fetch 1-minute bars for an options contract.

        Args:
            options_ticker: Full options ticker (e.g., O:WDC260102C00175000)
            trade_date: Trading date
            start_time: Optional start time filter (ET)
            end_time: Optional end time filter (ET), defaults to 15:30

        Returns:
            DataFrame with columns: timestamp, open, high, low, close, volume
        """
        # Implementation similar to M1Fetcher.fetch_trading_day()
        pass
```

### 3.5 Core Calculator

**File:** `op_mfe_mae_calc.py`

Pattern from: `mfe_mae/mfe_mae_potential_calc.py`

Key functionality:
- Query trades that exist in options_analysis but not in op_mfe_mae_potential
- Join with options_analysis to get options_ticker
- Fetch 1-minute options bars
- Calculate MFE/MAE in POINTS (not R)
- Calculate percentages for comparison
- Join with mfe_mae_potential for underlying comparison

```python
"""
EPOCH TRADING SYSTEM - OPTIONS MFE/MAE CALCULATOR
Calculates MFE/MAE in POINTS for options trades.
"""

@dataclass
class OpMFEMAEResult:
    """Result of options MFE/MAE calculation."""
    trade_id: str
    date: date
    ticker: str
    direction: str
    model: str

    # Options contract
    options_ticker: str
    strike: float
    expiration: date
    contract_type: str

    # Entry
    entry_time: time
    option_entry_price: float

    # MFE (always positive - favorable movement)
    mfe_points: float      # |best_price - entry_price|
    mfe_price: float
    mfe_time: time
    mfe_pct: float         # mfe_points / entry_price * 100

    # MAE (always positive - adverse movement)
    mae_points: float      # |entry_price - worst_price|
    mae_price: float
    mae_time: time
    mae_pct: float         # mae_points / entry_price * 100

    # Exit (15:30)
    exit_price: float
    exit_time: time
    exit_points: float     # exit_price - entry_price (can be negative)
    exit_pct: float        # exit_points / entry_price * 100

    # Underlying comparison
    underlying_mfe_pct: Optional[float]
    underlying_mae_pct: Optional[float]
    underlying_exit_pct: Optional[float]

    # Metadata
    bars_analyzed: int


class OpMFEMAECalculator:
    """
    Calculates options MFE/MAE potential (entry to 15:30 ET).
    """

    def get_trades_needing_calculation(self, conn, limit: int = None) -> pd.DataFrame:
        """
        Query trades that:
        1. Exist in trades table
        2. Have options data in options_analysis table
        3. Do NOT exist in op_mfe_mae_potential yet
        """
        query = """
            SELECT
                t.trade_id,
                t.date,
                t.ticker,
                t.direction,
                t.model,
                t.entry_time,
                o.options_ticker,
                o.strike,
                o.expiration,
                o.contract_type,
                o.option_entry_price,
                o.option_entry_time
            FROM trades t
            INNER JOIN options_analysis o ON t.trade_id = o.trade_id
            LEFT JOIN op_mfe_mae_potential m ON t.trade_id = m.trade_id
            WHERE m.trade_id IS NULL
              AND o.options_ticker IS NOT NULL
              AND o.option_entry_price IS NOT NULL
              AND o.status = 'SUCCESS'
            ORDER BY t.date, t.ticker
        """
        # Execute and return DataFrame

    def calculate_single_trade(self, trade: Dict, bars_df: pd.DataFrame) -> Optional[OpMFEMAEResult]:
        """
        Calculate MFE/MAE for a single options trade.

        MFE/MAE Logic (measuring in POINTS):

        For ALL options (CALL or PUT, regardless of direction):
            - We BUY options, so we want price to go UP
            - MFE = highest_high - entry_price (favorable = price increase)
            - MAE = entry_price - lowest_low (adverse = price decrease)

        Note: Unlike shares where LONG/SHORT changes the calculation,
        for options we always buy (no shorting), so UP is always good.
        """
        # Implementation follows mfe_mae_potential_calc.py pattern
        # but with simplified direction logic (always buying options)
```

### 3.6 CLI Runner

**File:** `op_mfe_mae_runner.py`

Pattern from: `mfe_mae/mfe_mae_potential_runner.py`

```bash
# Usage:
python op_mfe_mae_runner.py              # Full batch run
python op_mfe_mae_runner.py --dry-run    # Calculate but don't save
python op_mfe_mae_runner.py --limit 50   # Process max 50 trades
python op_mfe_mae_runner.py --schema     # Create database table
```

---

## 4. IMPLEMENTATION - PART 2: OPTIONS ANALYSIS TAB

### 4.1 Directory Updates

```
C:\XIIITradingSystems\Epoch\02_zone_system\12_indicator_analysis\
├── calculations/
│   └── options/                        # NEW DIRECTORY
│       ├── __init__.py
│       ├── op_win_rate_by_model.py     # CALC-O01: Options win rate by model
│       ├── op_mfe_mae_stats.py         # CALC-O02: Options MFE/MAE distribution
│       ├── op_mfe_mae_sequence.py      # CALC-O03: MFE vs MAE timing
│       └── op_vs_underlying.py         # CALC-O04: Options vs underlying comparison
│
├── components/
│   ├── options_summary_cards.py        # NEW: Options-specific summary cards
│   └── options_charts.py               # NEW: Options-specific charts
│
├── monte_ai/
│   ├── options_prompts.py              # NEW: Options analysis prompt templates
│   └── options_prompt_generator.py     # NEW: Options prompt generator
│
├── data/
│   └── supabase_client.py              # UPDATE: Add fetch_op_mfe_mae_potential()
│
└── app.py                              # UPDATE: Add Options Analysis tab
```

### 4.2 Calculation Modules (CALC-O01 to CALC-O04)

#### CALC-O01: Options Win Rate by Model
Mirrors CALC-001 but for options trades.

```python
# calculations/options/op_win_rate_by_model.py
"""
CALC-O01: Options Win Rate by Model
Win = exit_points > 0 (option closed higher than entry)
"""

def calculate_options_win_rate(df: pd.DataFrame) -> pd.DataFrame:
    """
    Calculate win rate by model for options trades.

    Win Definition: exit_pct > 0 (option closed higher than opened)

    Returns DataFrame with columns:
    - model, direction, trades, wins, losses, win_rate
    - Comparison to underlying win rate
    """
```

#### CALC-O02: Options MFE/MAE Distribution
Mirrors CALC-002 but for options percentage movements.

```python
# calculations/options/op_mfe_mae_stats.py
"""
CALC-O02: Options MFE/MAE Distribution Analysis
All metrics in percentage of entry price.
"""

def calculate_op_mfe_mae_summary(df: pd.DataFrame) -> Dict:
    """
    Calculate MFE/MAE statistics for options.

    Returns:
        median_mfe_pct, median_mae_pct, mfe_mae_ratio
        mfe_pct_q25, mfe_pct_q75, mae_pct_q25, mae_pct_q75
        total_trades
    """
```

#### CALC-O03: Options MFE/MAE Sequence
Mirrors CALC-003 - which happens first, MFE or MAE?

```python
# calculations/options/op_mfe_mae_sequence.py
"""
CALC-O03: Options MFE/MAE Sequence Analysis
Does favorable movement happen before adverse movement?
"""

def calculate_op_sequence_stats(df: pd.DataFrame) -> Dict:
    """
    Analyze timing sequence of MFE vs MAE.

    Returns:
        pct_mfe_first: % of trades where MFE occurred before MAE
        avg_time_to_mfe: Average minutes from entry to MFE
        avg_time_to_mae: Average minutes from entry to MAE
    """
```

#### CALC-O04: Options vs Underlying Comparison
NEW calculation - compares options leverage effectiveness.

```python
# calculations/options/op_vs_underlying.py
"""
CALC-O04: Options vs Underlying Performance Comparison
How do options amplify/dampen underlying movements?
"""

def calculate_options_leverage(df: pd.DataFrame) -> Dict:
    """
    Compare options performance to underlying.

    Returns:
        mfe_leverage: options_mfe_pct / underlying_mfe_pct (how much options amplify MFE)
        mae_leverage: options_mae_pct / underlying_mae_pct (how much options amplify MAE)
        exit_leverage: options_exit_pct / underlying_exit_pct (overall P&L amplification)
        win_rate_diff: options_win_rate - underlying_win_rate
    """
```

### 4.3 Tab Integration in app.py

```python
# In app.py, add new tab after existing tabs:

tab1, tab2, tab3, tab_options = st.tabs([
    "Metrics Overview",
    "Indicator Analysis",
    "Archived Analysis",
    "Options Analysis"  # NEW TAB
])

with tab_options:
    st.header("Options Analysis")
    st.markdown("*Options MFE/MAE analysis mirroring share-based metrics*")

    # Load options data
    op_mfe_mae_data = load_op_mfe_mae_potential(date_from, date_to, selected_models)

    if op_mfe_mae_data.empty:
        st.warning("No options MFE/MAE data available. Run op_mfe_mae_runner.py first.")
    else:
        # Sub-tabs for each calculation
        op_tab1, op_tab2, op_tab3, op_tab4 = st.tabs([
            "CALC-O01: Win Rate",
            "CALC-O02: MFE/MAE Distribution",
            "CALC-O03: MFE/MAE Sequence",
            "CALC-O04: vs Underlying"
        ])

        with op_tab1:
            render_calc_o01_section(op_mfe_mae_data)

        # ... remaining tabs ...

        # Monte AI Section
        st.divider()
        render_options_monte_ai(
            calc_o01_result=calc_o01_result,
            calc_o02_result=calc_o02_result,
            calc_o03_result=calc_o03_result,
            calc_o04_result=calc_o04_result
        )
```

### 4.4 Monte AI Integration

**File:** `monte_ai/options_prompts.py`

```python
"""
Monte AI Prompt Templates for Options Analysis
"""

OPTIONS_ANALYSIS_SYSTEM_PROMPT = """You are Monte, an AI research assistant...

CONTEXT: OPTIONS ANALYSIS
The Epoch Trading System is transitioning to options as the primary trading vehicle.
This analysis examines options MFE/MAE behavior from entry to 15:30 ET.

Key Metrics:
- MFE%: Maximum favorable price movement (option price UP)
- MAE%: Maximum adverse price movement (option price DOWN)
- Exit%: Final P&L at 15:30 ET

Contract Types:
- CALL for LONG underlying direction
- PUT for SHORT underlying direction
- Currently using First ITM or ATM strikes
"""

OPTIONS_METRICS_OVERVIEW_TEMPLATE = """
## Options Metrics Overview Analysis

### Current Filter Context
{filter_context}

### CALC-O01: Options Win Rate by Model
{calc_o01_data}

### CALC-O02: Options MFE/MAE Distribution
{calc_o02_data}

### CALC-O03: Options MFE/MAE Sequence
{calc_o03_data}

### CALC-O04: Options vs Underlying Comparison
{calc_o04_data}

### Analysis Questions
1. Which model-direction combinations show the best options MFE/MAE ratio?
2. How effective is options leverage (amplification of underlying moves)?
3. Does MFE typically occur before MAE in options? (favorable timing)
4. Where should options stops be placed based on MAE distribution?
5. Are there model-specific recommendations for options trading?

### Required Output
1. **Key Findings** (3-5 bullet points)
2. **Leverage Effectiveness Assessment**
3. **Stop Placement Recommendations** (based on MAE percentiles)
4. **Model-Specific Observations**
5. **Comparison to Share Trading**
"""
```

---

## 5. EXECUTION SEQUENCE

### Phase 1: Secondary Analysis Module
1. Create `op_mfe_mae/` directory structure
2. Create `config.py` with DB and API configuration
3. Create `schema/op_mfe_mae_potential.sql`
4. Create `options_bar_fetcher.py` (pattern from m1_fetcher.py)
5. Create `op_mfe_mae_calc.py` (core calculation logic)
6. Create `op_mfe_mae_runner.py` (CLI interface)
7. Run `--schema` to create database table
8. Run with `--limit 10 --dry-run` to test
9. Run full batch to populate table

### Phase 2: Options Analysis Tab
1. Create `calculations/options/` directory
2. Implement CALC-O01 through CALC-O04
3. Update `supabase_client.py` with `fetch_op_mfe_mae_potential()`
4. Create `components/options_*.py` files
5. Create `monte_ai/options_*.py` files
6. Update `app.py` to add Options Analysis tab
7. Test with existing data

### Phase 3: Documentation
1. Create `docs/AI_READABLE.txt`
2. Create `docs/HUMAN_READABLE.txt`

---

## 6. CRITICAL IMPLEMENTATION NOTES

### 6.1 MFE/MAE Calculation for Options

Unlike shares where direction matters:
- **Shares LONG**: MFE = high - entry, MAE = entry - low
- **Shares SHORT**: MFE = entry - low, MAE = high - entry

For options (we always BUY, never short):
- **ALL OPTIONS**: MFE = high - entry (want price UP), MAE = entry - low (price DOWN is bad)

The contract_type (CALL/PUT) doesn't change the MFE/MAE logic because:
- CALL for bullish underlying = we want CALL price to go UP
- PUT for bearish underlying = we want PUT price to go UP

### 6.2 Data Flow

```
trades (source of truth)
    ↓
options_analysis (contract selection, 1412 records exist)
    ↓
Polygon API (1-minute options bars)
    ↓
op_mfe_mae_potential (NEW - calculated MFE/MAE in points/%)
    ↓
Options Analysis Tab (Streamlit dashboard)
    ↓
Monte AI (analysis prompts)
```

### 6.3 Join Strategy

When querying for calculation:
```sql
SELECT t.*, o.options_ticker, o.strike, o.expiration, o.contract_type, o.option_entry_price
FROM trades t
INNER JOIN options_analysis o ON t.trade_id = o.trade_id
LEFT JOIN op_mfe_mae_potential m ON t.trade_id = m.trade_id
WHERE m.trade_id IS NULL  -- Not yet calculated
  AND o.status = 'SUCCESS'  -- Has valid options data
```

---

## 7. DEPENDENCIES

### Existing Files to Reference
- `mfe_mae/mfe_mae_potential_calc.py` - Core calculation pattern
- `mfe_mae/m1_fetcher.py` - Bar fetcher pattern
- `mfe_mae/config.py` - Configuration pattern
- `options_analysis/fetcher.py` - Options API patterns
- `12_indicator_analysis/app.py` - Tab integration pattern
- `12_indicator_analysis/monte_ai/prompts.py` - Monte AI pattern

### Python Packages Required
- psycopg2-binary (database)
- pandas (data manipulation)
- requests (API calls)
- pytz (timezone handling)
- streamlit (dashboard)
- plotly (charts)

---

## 8. TESTING CHECKLIST

- [ ] Schema creates successfully in Supabase
- [ ] Can fetch 1-minute options bars from Polygon
- [ ] MFE/MAE calculations produce expected values
- [ ] Dry run processes trades without errors
- [ ] Full run populates op_mfe_mae_potential table
- [ ] Options Analysis tab loads without errors
- [ ] All CALC-O modules render correctly
- [ ] Monte AI generates valid prompts
- [ ] Underlying comparison data populates correctly

---

**END OF DOCUMENT**
