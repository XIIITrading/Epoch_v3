# DOW AI OPTIONS INTEGRATION - IMPLEMENTATION PLAN
## Claude Code Implementation Instructions
### Epoch Trading System - DOW AI Options Enhancement
### XIII Trading LLC

**Document Version:** 1.0
**Created:** 2026-01-08
**Author:** Claude Code / Silva
**Target Application:** `04_dow_ai/`
**Prerequisites:** Options Analysis Tab implementation must be complete first

---

## 1. OBJECTIVE

Enhance DOW AI to provide options-specific guidance during live trading, including:
1. **Options Levels** - Recommended strike prices and expirations
2. **Position Sizing** - Contract quantity recommendations based on risk
3. **Entry/Exit Recommendations** - Options-specific timing and price guidance

### Purpose
- Extend DOW AI from share-focused to options-focused trading assistant
- Leverage options MFE/MAE data to inform recommendations
- Provide actionable options guidance during live trading sessions

---

## 2. PROJECT CONTEXT

### Current DOW AI Architecture

```
C:\XIIITradingSystems\Epoch\04_dow_ai\
├── __init__.py
├── main.py                 # Entry point
├── cli.py                  # Click CLI interface
├── config.py               # Configuration (API keys, paths, models)
├── launcher.bat            # Windows launcher
├── launcher.ps1            # PowerShell launcher
│
├── data/                   # Data loading
│   └── [Excel/Supabase readers]
│
├── analysis/               # Analysis modules
│   └── [Market structure, indicators]
│
├── calculations/           # Calculation logic
│   └── [Health score, structure analysis]
│
├── output/                 # Generated outputs
└── debug/                  # Debug logs
```

### Current DOW AI Commands (from cli.py)
```bash
python main.py entry NVDA long secondary   # Entry analysis
python main.py exit TSLA sell primary      # Exit analysis
python main.py models                      # List available models
```

### Data Sources Available
- `trades` - Trade records with entry/exit data
- `options_analysis` - Options contract data (existing 1412 records)
- `op_mfe_mae_potential` - Options MFE/MAE data (after Phase 1 implementation)
- `mfe_mae_potential` - Underlying MFE/MAE for comparison
- Polygon API - Real-time options chains, Greeks, pricing

---

## 3. ENHANCEMENT SCOPE

### 3.1 New CLI Commands

```bash
# New options-specific commands
python main.py options NVDA long           # Get options recommendations for trade
python main.py options-chain AAPL          # View options chain with recommendations
python main.py options-size TSLA 500       # Size calculation for $500 risk

# Enhanced existing commands (add options output)
python main.py entry NVDA long secondary --options   # Entry + options recommendations
```

### 3.2 New Output Sections

When `--options` flag is used or `options` command is called:

```
===============================================================================
DOW AI OPTIONS ANALYSIS - NVDA LONG
===============================================================================

RECOMMENDED CONTRACT:
  Type: CALL
  Strike: $145 (First ITM, $0.85 from current)
  Expiration: 2026-01-17 (9 DTE)
  Current Bid/Ask: $4.20 / $4.35
  Delta: 0.58 | Theta: -0.12 | IV: 42.3%

POSITION SIZING (Based on $500 Risk):
  Max Loss per Contract: $435 (full premium)
  Recommended Contracts: 1
  Total Capital Required: $435
  Risk as % of Premium: 100%

OPTIONS METRICS (From Historical Analysis):
  Model EPCH1 LONG CALL Performance:
    Win Rate: 52.3% (n=87)
    Median MFE%: +18.4%
    Median MAE%: -12.1%
    MFE/MAE Ratio: 1.52

ENTRY RECOMMENDATION:
  Entry Price Target: $4.25 (mid-market)
  Max Entry Price: $4.35 (ask)

EXIT GUIDANCE (Based on MFE/MAE Analysis):
  Take Profit Target: +20% ($5.10)
  Stop Loss Level: -15% ($3.61)
  Time Stop: 15:30 ET same day

===============================================================================
```

---

## 4. IMPLEMENTATION PHASES

### Phase 1: Data Integration (Prerequisites)
**Status:** Depends on Options Analysis Tab completion

Required before DOW AI enhancement:
- [ ] `op_mfe_mae_potential` table populated
- [ ] Options MFE/MAE statistics calculated
- [ ] Model-specific options performance metrics available

### Phase 2: Options Data Module

**New File:** `data/options_loader.py`

```python
"""
DOW AI - Options Data Loader
Loads options chain and historical performance data.
"""

import psycopg2
from datetime import date
from typing import Optional, Dict, List
from dataclasses import dataclass

@dataclass
class OptionsRecommendation:
    """Recommended options contract."""
    contract_type: str          # CALL or PUT
    strike: float
    expiration: date
    options_ticker: str
    bid: Optional[float]
    ask: Optional[float]
    delta: Optional[float]
    theta: Optional[float]
    implied_volatility: Optional[float]
    selection_method: str       # "FIRST_ITM", "ATM", "FIRST_OTM"


@dataclass
class OptionsPerformanceStats:
    """Historical options performance for model-direction."""
    model: str
    direction: str
    contract_type: str
    total_trades: int
    win_rate: float
    median_mfe_pct: float
    median_mae_pct: float
    mfe_mae_ratio: float
    median_exit_pct: float


class OptionsDataLoader:
    """Loads options data from Polygon and Supabase."""

    def __init__(self, api_key: str, db_config: dict):
        self.api_key = api_key
        self.db_config = db_config

    def get_options_chain(self, ticker: str, direction: str) -> List[OptionsRecommendation]:
        """
        Fetch current options chain and select recommended contracts.

        Args:
            ticker: Underlying symbol
            direction: 'long' or 'short'

        Returns:
            List of recommended contracts (First ITM, ATM, First OTM)
        """
        # Uses existing options_analysis/fetcher.py pattern
        # Returns CALL for long, PUT for short
        pass

    def get_performance_stats(self, model: str, direction: str) -> Optional[OptionsPerformanceStats]:
        """
        Get historical options performance for model-direction combination.

        Args:
            model: Entry model (EPCH1, EPCH2, etc.)
            direction: 'long' or 'short'

        Returns:
            OptionsPerformanceStats from op_mfe_mae_potential
        """
        query = """
            SELECT
                model,
                direction,
                contract_type,
                COUNT(*) as total_trades,
                AVG(CASE WHEN exit_pct > 0 THEN 1.0 ELSE 0.0 END) * 100 as win_rate,
                PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY mfe_pct) as median_mfe_pct,
                PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY mae_pct) as median_mae_pct,
                PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY exit_pct) as median_exit_pct
            FROM op_mfe_mae_potential
            WHERE model = %s AND UPPER(direction) = UPPER(%s)
            GROUP BY model, direction, contract_type
        """
        # Execute and return stats
        pass

    def calculate_size(self, risk_amount: float, premium: float,
                       stop_pct: Optional[float] = None) -> Dict:
        """
        Calculate position size based on risk.

        Args:
            risk_amount: Dollar amount willing to risk
            premium: Option premium (ask price)
            stop_pct: Optional stop loss percentage (default: full premium)

        Returns:
            {
                'contracts': int,
                'total_cost': float,
                'max_loss': float,
                'risk_per_contract': float
            }
        """
        pass
```

### Phase 3: Analysis Enhancement

**New File:** `analysis/options_analysis.py`

```python
"""
DOW AI - Options Analysis Module
Generates options-specific trading recommendations.
"""

from dataclasses import dataclass
from typing import Optional
from data.options_loader import OptionsDataLoader, OptionsRecommendation, OptionsPerformanceStats


@dataclass
class OptionsAnalysisResult:
    """Complete options analysis for DOW AI output."""
    # Recommendation
    recommended_contract: OptionsRecommendation
    alternative_contracts: list

    # Sizing
    contracts_recommended: int
    total_cost: float
    max_loss: float

    # Historical performance
    performance_stats: Optional[OptionsPerformanceStats]

    # Entry/Exit guidance
    entry_target: float
    entry_max: float
    take_profit_pct: float
    take_profit_price: float
    stop_loss_pct: float
    stop_loss_price: float

    # Confidence
    confidence_level: str  # HIGH, MEDIUM, LOW (based on sample size)
    sample_size: int


class OptionsAnalyzer:
    """Analyzes options opportunities and generates recommendations."""

    def __init__(self, loader: OptionsDataLoader):
        self.loader = loader

    def analyze(self, ticker: str, direction: str, model: str,
                risk_amount: float = 500) -> OptionsAnalysisResult:
        """
        Generate complete options analysis for a trade setup.

        Args:
            ticker: Underlying symbol
            direction: 'long' or 'short'
            model: Entry model (EPCH1-4)
            risk_amount: Dollar risk (default $500)

        Returns:
            OptionsAnalysisResult with all recommendations
        """
        # 1. Get options chain
        contracts = self.loader.get_options_chain(ticker, direction)

        # 2. Get historical performance
        stats = self.loader.get_performance_stats(model, direction)

        # 3. Calculate entry/exit based on MFE/MAE
        # Take profit at median MFE%, stop at P75 MAE%
        if stats:
            take_profit_pct = stats.median_mfe_pct
            stop_loss_pct = stats.median_mae_pct * 1.25  # Buffer above median
        else:
            # Defaults if no historical data
            take_profit_pct = 20.0
            stop_loss_pct = 15.0

        # 4. Calculate sizing
        recommended = contracts[0]  # First ITM
        sizing = self.loader.calculate_size(
            risk_amount=risk_amount,
            premium=recommended.ask,
            stop_pct=stop_loss_pct
        )

        # 5. Calculate confidence
        if stats and stats.total_trades >= 50:
            confidence = "HIGH"
        elif stats and stats.total_trades >= 20:
            confidence = "MEDIUM"
        else:
            confidence = "LOW"

        return OptionsAnalysisResult(
            recommended_contract=recommended,
            alternative_contracts=contracts[1:],
            contracts_recommended=sizing['contracts'],
            total_cost=sizing['total_cost'],
            max_loss=sizing['max_loss'],
            performance_stats=stats,
            entry_target=(recommended.bid + recommended.ask) / 2,
            entry_max=recommended.ask,
            take_profit_pct=take_profit_pct,
            take_profit_price=recommended.ask * (1 + take_profit_pct / 100),
            stop_loss_pct=stop_loss_pct,
            stop_loss_price=recommended.ask * (1 - stop_loss_pct / 100),
            confidence_level=confidence,
            sample_size=stats.total_trades if stats else 0
        )
```

### Phase 4: CLI Integration

**Update:** `cli.py`

```python
# Add new command group for options

@cli.command()
@click.argument('ticker')
@click.argument('direction', type=click.Choice(['long', 'short']))
@click.option('--model', '-m', default='EPCH1', help='Entry model')
@click.option('--risk', '-r', default=500, type=float, help='Risk amount in dollars')
def options(ticker: str, direction: str, model: str, risk: float):
    """
    Get options recommendations for a trade setup.

    Example: python main.py options NVDA long -m EPCH1 -r 500
    """
    from analysis.options_analysis import OptionsAnalyzer
    from data.options_loader import OptionsDataLoader
    from config import POLYGON_API_KEY, DB_CONFIG

    print(f"\n{'='*70}")
    print(f"DOW AI OPTIONS ANALYSIS - {ticker.upper()} {direction.upper()}")
    print(f"{'='*70}\n")

    loader = OptionsDataLoader(POLYGON_API_KEY, DB_CONFIG)
    analyzer = OptionsAnalyzer(loader)

    result = analyzer.analyze(ticker, direction, model, risk)

    # Print formatted output
    print_options_recommendation(result)


def print_options_recommendation(result: OptionsAnalysisResult):
    """Format and print options recommendation."""
    rc = result.recommended_contract

    print("RECOMMENDED CONTRACT:")
    print(f"  Type: {rc.contract_type}")
    print(f"  Strike: ${rc.strike:.2f} ({rc.selection_method})")
    print(f"  Expiration: {rc.expiration}")
    print(f"  Current Bid/Ask: ${rc.bid:.2f} / ${rc.ask:.2f}")
    if rc.delta:
        print(f"  Delta: {rc.delta:.2f} | Theta: {rc.theta:.2f} | IV: {rc.implied_volatility*100:.1f}%")

    print(f"\nPOSITION SIZING (Based on ${result.max_loss:.0f} Risk):")
    print(f"  Recommended Contracts: {result.contracts_recommended}")
    print(f"  Total Capital Required: ${result.total_cost:.2f}")
    print(f"  Max Loss: ${result.max_loss:.2f}")

    if result.performance_stats:
        stats = result.performance_stats
        print(f"\nOPTIONS METRICS (Historical Analysis):")
        print(f"  Model {stats.model} {stats.direction} {stats.contract_type} Performance:")
        print(f"    Win Rate: {stats.win_rate:.1f}% (n={stats.total_trades})")
        print(f"    Median MFE%: +{stats.median_mfe_pct:.1f}%")
        print(f"    Median MAE%: -{stats.median_mae_pct:.1f}%")
        print(f"    MFE/MAE Ratio: {stats.mfe_mae_ratio:.2f}")

    print(f"\nENTRY RECOMMENDATION:")
    print(f"  Entry Price Target: ${result.entry_target:.2f} (mid-market)")
    print(f"  Max Entry Price: ${result.entry_max:.2f} (ask)")

    print(f"\nEXIT GUIDANCE (Based on MFE/MAE Analysis):")
    print(f"  Take Profit Target: +{result.take_profit_pct:.0f}% (${result.take_profit_price:.2f})")
    print(f"  Stop Loss Level: -{result.stop_loss_pct:.0f}% (${result.stop_loss_price:.2f})")
    print(f"  Time Stop: 15:30 ET same day")

    print(f"\nCONFIDENCE: {result.confidence_level} (based on {result.sample_size} historical trades)")
    print(f"{'='*70}\n")
```

### Phase 5: Enhance Existing Entry Command

**Update:** Existing entry command to include `--options` flag

```python
@cli.command()
@click.argument('ticker')
@click.argument('direction', type=click.Choice(['long', 'short']))
@click.argument('zone', type=click.Choice(['primary', 'secondary']))
@click.option('--options', '-o', is_flag=True, help='Include options recommendations')
def entry(ticker: str, direction: str, zone: str, options: bool):
    """
    Analyze entry setup for a ticker.

    Example: python main.py entry NVDA long secondary --options
    """
    # Existing entry analysis code...

    if options:
        # Add options analysis
        from analysis.options_analysis import OptionsAnalyzer
        # ... generate and print options recommendations
```

---

## 5. CONFIGURATION UPDATES

**Update:** `config.py`

```python
# =============================================================================
# OPTIONS CONFIGURATION
# =============================================================================

# Default risk per trade
DEFAULT_OPTIONS_RISK = 500  # $500 default risk

# Contract selection preferences
CONTRACT_SELECTION = {
    'default_method': 'FIRST_ITM',  # FIRST_ITM, ATM, or FIRST_OTM
    'min_dte': 5,                    # Minimum days to expiration
    'max_dte': 30,                   # Maximum days to expiration
    'prefer_weekly': True,           # Prefer weekly expirations
}

# Exit strategy defaults (used when no historical data)
DEFAULT_EXIT_STRATEGY = {
    'take_profit_pct': 20.0,         # Default +20% profit target
    'stop_loss_pct': 15.0,           # Default -15% stop loss
    'time_stop': '15:30',            # Default time stop (ET)
}

# MFE/MAE based exit adjustments
MFE_MAE_EXIT_CONFIG = {
    'take_profit_multiplier': 0.9,   # Target 90% of median MFE
    'stop_loss_percentile': 75,      # Stop at P75 of MAE distribution
    'stop_buffer': 1.25,             # 25% buffer above percentile
}
```

---

## 6. SAMPLE OUTPUT

### Command: `python main.py options NVDA long -m EPCH1 -r 500`

```
======================================================================
DOW AI OPTIONS ANALYSIS - NVDA LONG
======================================================================

RECOMMENDED CONTRACT:
  Type: CALL
  Strike: $145.00 (FIRST_ITM)
  Expiration: 2026-01-17 (9 DTE)
  Current Bid/Ask: $4.20 / $4.35
  Delta: 0.58 | Theta: -0.12 | IV: 42.3%

POSITION SIZING (Based on $500 Risk):
  Recommended Contracts: 1
  Total Capital Required: $435.00
  Max Loss: $435.00

OPTIONS METRICS (Historical Analysis):
  Model EPCH1 LONG CALL Performance:
    Win Rate: 52.3% (n=87)
    Median MFE%: +18.4%
    Median MAE%: -12.1%
    MFE/MAE Ratio: 1.52

ENTRY RECOMMENDATION:
  Entry Price Target: $4.27 (mid-market)
  Max Entry Price: $4.35 (ask)

EXIT GUIDANCE (Based on MFE/MAE Analysis):
  Take Profit Target: +17% ($5.00)
  Stop Loss Level: -15% ($3.70)
  Time Stop: 15:30 ET same day

CONFIDENCE: HIGH (based on 87 historical trades)
======================================================================
```

---

## 7. DEPENDENCIES

### Prerequisites (Must be complete first)
1. Options Analysis Tab implementation (options_analysis_tab.txt)
2. `op_mfe_mae_potential` table populated with data
3. Historical options performance statistics available

### Existing Components to Leverage
- `options_analysis/fetcher.py` - Polygon options API integration
- `options_analysis/contract_selector.py` - Strike/expiration selection
- `04_dow_ai/config.py` - Existing configuration
- `04_dow_ai/cli.py` - Existing CLI structure

### New Files to Create
- `data/options_loader.py` - Options data loading
- `analysis/options_analysis.py` - Options analysis logic
- Update `cli.py` - New commands
- Update `config.py` - Options configuration

---

## 8. TESTING CHECKLIST

- [ ] `options` command runs without errors
- [ ] Options chain fetched from Polygon successfully
- [ ] Historical performance stats retrieved from op_mfe_mae_potential
- [ ] Position sizing calculations are correct
- [ ] Entry/exit recommendations based on MFE/MAE data
- [ ] Confidence levels reflect sample sizes
- [ ] `--options` flag works with existing entry command
- [ ] Output formatting is clean and readable
- [ ] Handles missing data gracefully (new tickers, no history)

---

## 9. FUTURE ENHANCEMENTS (Out of Scope)

These are noted for future consideration but NOT part of this implementation:

1. **Greeks-Based Sizing** - Use delta to normalize position sizes
2. **IV Percentile** - Adjust strategy based on IV rank
3. **Multi-Leg Strategies** - Spreads, straddles, etc.
4. **Real-Time Alerts** - Price alerts when targets hit
5. **P&L Tracking** - Track actual vs recommended performance

---

## 10. EXECUTION SEQUENCE

1. **Wait for Prerequisites** - Options Analysis Tab must be complete
2. **Create data/options_loader.py** - Data loading infrastructure
3. **Create analysis/options_analysis.py** - Analysis logic
4. **Update config.py** - Add options configuration
5. **Update cli.py** - Add new commands
6. **Test with sample tickers** - Verify output
7. **Document usage** - Update help text and examples

---

**END OF DOCUMENT**
