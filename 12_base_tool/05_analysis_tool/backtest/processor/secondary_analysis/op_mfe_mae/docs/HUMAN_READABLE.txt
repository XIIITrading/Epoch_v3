================================================================================
EPOCH TRADING SYSTEM - OPTIONS MFE/MAE POTENTIAL MODULE
Human-Readable Documentation (Teaching Guide)
XIII Trading LLC
================================================================================

WHAT THIS MODULE DOES
================================================================================

This module calculates how far options prices moved during trades - both in
your favor (MFE) and against you (MAE). Think of it as measuring:

    "What was the best I could have done?" (MFE)
    "What was the worst it got?" (MAE)
    "Where did it end up?" (Exit at 15:30)

All measurements are from your entry time until 15:30 ET.


WHY THIS MATTERS
================================================================================

When trading options, you need to know:

1. STOP PLACEMENT: MAE tells you how far price typically moves against you.
   If median MAE is 15%, a 10% stop will get hit too often.

2. PROFIT TARGETS: MFE tells you how far price typically moves in your favor.
   If median MFE is 20%, a 30% target may rarely be hit.

3. WIN RATE: Exit% > 0 means the trade was profitable at 15:30.
   Track this by model to find what works.

4. LEVERAGE: Compare options MFE% to underlying stock MFE% to see if
   options are amplifying your gains (or losses).


HOW IT WORKS - STEP BY STEP
================================================================================

STEP 1: Find Trades to Calculate
--------------------------------
The module looks for trades that:
- Exist in the trades table (your simulation results)
- Have options data in options_analysis (contract was selected)
- Don't yet have results in op_mfe_mae_potential

STEP 2: Fetch Options Price Data
--------------------------------
For each trade's options contract, we fetch 1-minute bars from Polygon.io
Example: O:AAPL250117C00175000 (AAPL $175 Call expiring Jan 17, 2025)

We only look at bars between:
- Entry time (when you would have entered)
- 15:30 ET (our standard end-of-day cutoff)

STEP 3: Calculate MFE/MAE
-------------------------
MFE (Max Favorable Excursion):
    Find the HIGHEST price during the trade
    MFE = highest - entry (how much it went UP)

MAE (Max Adverse Excursion):
    Find the LOWEST price during the trade
    MAE = entry - lowest (how much it went DOWN)

Exit:
    Price at the last bar (near 15:30)
    Exit = exit_price - entry (can be negative = loss)

STEP 4: Convert to Percentages
------------------------------
Everything is also stored as % of entry price:
    mfe_pct = (mfe_points / entry_price) * 100
    mae_pct = (mae_points / entry_price) * 100
    exit_pct = (exit_points / entry_price) * 100

STEP 5: Compare to Underlying
-----------------------------
We also pull the underlying stock's MFE/MAE from mfe_mae_potential
so you can compare options vs shares performance.


EXAMPLE TRADE
================================================================================

Trade: NVDA_010826_EPCH1_1007
Entry: 10:07 AM at $4.25 (NVDA Call option)

During the day:
- Price went as high as $5.10 at 11:45
- Price went as low as $3.80 at 10:25
- Price at 15:30 was $4.85

Calculations:
- MFE = $5.10 - $4.25 = $0.85 (20.0%)
- MAE = $4.25 - $3.80 = $0.45 (10.6%)
- Exit = $4.85 - $4.25 = $0.60 (14.1%)

Interpretation:
- The trade moved 20% in your favor at best
- It moved 10.6% against you at worst
- It closed 14.1% profitable (WIN)


HOW TO RUN THE MODULE
================================================================================

From command line:

1. First time - create the database table:
   python op_mfe_mae_runner.py --schema

2. Check status:
   python op_mfe_mae_runner.py --status

3. Test without saving (dry run):
   python op_mfe_mae_runner.py --limit 10 --dry-run

4. Run full calculation:
   python op_mfe_mae_runner.py

5. Process a batch:
   python op_mfe_mae_runner.py --limit 100


WHAT THE OUTPUT MEANS
================================================================================

Sample output:
    AKAM_121525_EPCH2_0937: MFE=3.55%, MAE=32.26%, Exit=-30.16%

This means:
- Trade ID: AKAM_121525_EPCH2_0937
- Best the trade did: +3.55%
- Worst the trade did: -32.26%
- Final result: -30.16% (LOSS)

Analysis: This was a losing trade where the price dropped significantly
and never recovered. The MAE (32%) far exceeded the MFE (3.5%).


PATTERNS TO LOOK FOR
================================================================================

GOOD PATTERN (Trade has edge):
- MFE > MAE consistently
- MFE/MAE ratio > 1.0
- MFE happens before MAE (favorable move comes first)

BAD PATTERN (Trade struggles):
- MAE > MFE consistently
- Price immediately moves against you
- Exit% is negative more often than positive


IMPLEMENTING SIMILAR PATTERNS ELSEWHERE
================================================================================

This module follows the same pattern as mfe_mae/ for shares:

1. CONFIG FILE (config.py):
   - Central place for all settings
   - Database credentials, API keys
   - Table names as constants
   - Trading session times

2. DATA FETCHER (options_bar_fetcher.py):
   - Single responsibility: get price data
   - Caches results to avoid duplicate API calls
   - Handles API rate limits and errors
   - Returns pandas DataFrame for easy processing

3. CALCULATOR (op_mfe_mae_calc.py):
   - Queries database for pending work
   - Groups by (ticker, date) to minimize API calls
   - Pure calculation functions
   - Returns dataclass results

4. RUNNER (op_mfe_mae_runner.py):
   - CLI interface with argparse
   - --dry-run for testing
   - --limit for batching
   - --schema for setup
   - --status for monitoring

5. SCHEMA (schema/*.sql):
   - Table definition in version-controlled SQL
   - Indexes for common queries
   - Comments documenting columns

To create a similar module for something else:
1. Copy this structure
2. Update config.py with new table names
3. Create new fetcher for your data source
4. Implement your calculation logic
5. Create your schema
6. Write your runner


TROUBLESHOOTING
================================================================================

"No trades need calculation"
- All trades are already processed
- Check options_analysis has status = 'SUCCESS'
- Run --status to see counts

"No bar data for ticker"
- Options may have low liquidity
- Check if expiration date is in the past
- Verify options_ticker format is correct

"API rate limited"
- Module handles this automatically
- Will retry after delay
- Polygon max tier has no limits

"Connection refused"
- Check Supabase is accessible
- Verify credentials in config.py


NEXT STEPS
================================================================================

After running this module:

1. Build the Options Analysis Tab in 12_indicator_analysis
   - CALC-O01: Win rate by model
   - CALC-O02: MFE/MAE distribution
   - CALC-O03: Timing analysis
   - CALC-O04: vs underlying comparison

2. Generate Monte AI prompts for options analysis

3. Update DOW AI to provide options recommendations

================================================================================
VERSION: 1.0.0
CREATED: 2026-01-08
AUTHOR: Claude Code / Silva
================================================================================
