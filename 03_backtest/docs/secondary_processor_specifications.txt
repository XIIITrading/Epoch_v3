================================================================================
EPOCH TRADING SYSTEM v2.0 - SECONDARY ANALYSIS PROCESSOR
System Specifications
XIII Trading LLC
================================================================================

1. IMPLEMENTATION OVERVIEW
================================================================================

The Secondary Analysis Processor is a 15-step sequential pipeline that
enriches every completed backtest trade with detailed post-trade analytics
spanning excursion measurement, indicator snapshots, health scoring, stop
simulation, entry model refinement, R-multiple outcome evaluation, and
options performance tracking. The master orchestrator (run_all.py v1.6.0)
executes each processor as an isolated subprocess in strict dependency
order -- beginning with raw M1 and H1 bar ingestion from the Polygon.io
REST API, progressing through MFE/MAE potential calculation, multi-
timeframe indicator computation at the M1, M5, and entry-time level,
health-scored trade bar assembly, optimal trade event generation, R-level
crossing detection, options chain analysis, six distinct stop type
simulations, continuation and rejection indicator refinement scoring,
ATR-based R win/loss evaluation, and finally a unified canonical outcome
table that reconciles ATR-based and zone-buffer fallback methodologies.
All processors follow a consistent incremental pattern: query the source
trades table via LEFT JOIN exclusion to identify unprocessed records,
calculate metrics using a combination of Polygon.io market data and
previously computed secondary tables, and upsert results into dedicated
Supabase PostgreSQL target tables using psycopg2 with SSL and ON CONFLICT
handling. The shared indicators library provides standardized calculations
for SMA 9/21 spread and momentum, VWAP, volume rate of change, bar-
position volume delta, cumulative volume delta slope, and fractal-based
multi-timeframe market structure detection -- ensuring calculation
consistency across all 15 processors and the live Entry Qualifier tool.


2. HIGH-LEVEL TECHNICAL SPECIFICATIONS
================================================================================

2.1 ORCHESTRATION FRAMEWORK
--------------------------------------------------------------------------------
- Runner:           run_all.py v1.6.0 (SecondaryAnalysisRunner class)
- Execution:        subprocess.run() per module, real-time stdout
- Pipeline Steps:   15 sequential processors
- Dependency Graph: Strict ordering with declared depends_on per module
- CLI Arguments:    --dry-run, --limit N, --start-from STEP, --only STEP,
                    --no-stop, --verbose
- Error Handling:   Stop-on-error by default (--no-stop to continue)
- Database:         Supabase PostgreSQL via psycopg2 (SSL required)
- Data Source:      Polygon.io REST API for M1/M5/H1/H4/Daily bars

2.2 PIPELINE EXECUTION ORDER
--------------------------------------------------------------------------------
Step  Module               Description                           Target Table
----  -------------------  ------------------------------------  ----------------------
  1   m1_bars              Store raw M1 bar data from Polygon    m1_bars
  2   h1_bars              Store raw H1 bar data from Polygon    h1_bars
  3   mfe_mae              MFE/MAE potential (entry to EOD)      mfe_mae_potential
  4   entry_indicators     Entry-time indicator snapshots         entry_indicators
  5   m5_indicator_bars    Full-day M5 bars with indicators      m5_indicator_bars
  6   m1_indicator_bars    Full-day M1 bars with indicators      m1_indicator_bars
  7   m5_trade_bars        Trade-specific M5 bars + health       m5_trade_bars
  8   optimal_trade        ENTRY/MFE/MAE/EXIT event generation   optimal_trade
  9   r_level_events       R1/R2/R3 crossing event detection     optimal_trade (append)
 10   options_analysis     Options performance (FIRST_ITM)       options_analysis
 11   op_mfe_mae           Options MFE/MAE potential              op_mfe_mae_potential
 12   stop_analysis        6 stop types + outcome simulation     stop_analysis
 13   indicator_refinement Continuation/Rejection scores         indicator_refinement
 14   r_win_loss           ATR-based R win/loss (1R-5R)          r_win_loss
 15   trades_unified       Canonical outcome table               trades_m5_r_win

2.3 DEPENDENCY GRAPH
--------------------------------------------------------------------------------
Step 1  (m1_bars)              depends_on: []
Step 2  (h1_bars)              depends_on: []
Step 3  (mfe_mae)              depends_on: [m1_bars]
Step 4  (entry_indicators)     depends_on: [mfe_mae]
Step 5  (m5_indicator_bars)    depends_on: []
Step 6  (m1_indicator_bars)    depends_on: [m1_bars]
Step 7  (m5_trade_bars)        depends_on: [mfe_mae, m5_indicator_bars]
Step 8  (optimal_trade)        depends_on: [mfe_mae, m5_trade_bars]
Step 9  (r_level_events)       depends_on: [optimal_trade]
Step 10 (options_analysis)     depends_on: []
Step 11 (op_mfe_mae)           depends_on: [options_analysis]
Step 12 (stop_analysis)        depends_on: [mfe_mae, m1_bars, m5_trade_bars]
Step 13 (indicator_refinement) depends_on: [entry_indicators, m5_indicator_bars]
Step 14 (r_win_loss)           depends_on: [m1_bars, m5_trade_bars, m5_indicator_bars]
Step 15 (trades_unified)       depends_on: [r_win_loss, m1_bars]

2.4 STEP 1 - M1 BARS (Raw Data Ingestion)
--------------------------------------------------------------------------------
- Purpose:          Fetch and store raw 1-minute OHLCV bars from Polygon.io
- Batch Size:       500 records per INSERT
- Target Table:     m1_bars
- Fields:           trade_id, ticker, date, bar_time, bar_date, open, high,
                    low, close, volume, vwap

2.5 STEP 2 - H1 BARS (Raw Data Ingestion)
--------------------------------------------------------------------------------
- Purpose:          Fetch and store raw H1 (1-hour) bars from Polygon.io
- Lookback:         30 bars / 7 calendar days
- Target Table:     h1_bars
- Fields:           ticker, date, bar_time, open, high, low, close, volume

2.6 STEP 3 - MFE/MAE POTENTIAL (Excursion Analysis)
--------------------------------------------------------------------------------
- Purpose:          Calculate POTENTIAL MFE and MAE from entry time to EOD
                    (as opposed to REALIZED MFE/MAE which measures entry to exit)
- EOD Cutoff:       15:30 ET
- Minimum Risk:     $0.01 stop_distance (MIN_RISK_DOLLARS)
- Bar Timeframe:    1-minute bars from Polygon.io
- LONG Calculation:
    MFE = (highest_high - entry_price) / stop_distance
    MAE = (entry_price - lowest_low) / stop_distance
- SHORT Calculation:
    MFE = (entry_price - lowest_low) / stop_distance
    MAE = (highest_high - entry_price) / stop_distance
- Optimization:     Groups trades by (ticker, date) to minimize API calls
- Comparison Data:  Fetches realized MFE/MAE from optimal_trade for reference
- Target Table:     mfe_mae_potential
- Output Fields:    trade_id, date, ticker, direction, model, entry_time,
                    entry_price, stop_price, stop_distance, mfe_r_potential,
                    mfe_potential_price, mfe_potential_time, mae_r_potential,
                    mae_potential_price, mae_potential_time, bars_analyzed,
                    eod_cutoff, mfe_r_realized, mae_r_realized, pnl_r,
                    is_winner (21 fields)

2.7 STEP 4 - ENTRY INDICATORS (Entry-Time Snapshot)
--------------------------------------------------------------------------------
- Purpose:          Capture full indicator state at the exact moment of entry
- Data Source:      M1 bars aggregated to M5 for indicator calculation
- Minimum Bars:     25 M5 bars required (SMA21 + 10-bar momentum lookback)
- Health Score:     10-component composite (0-10 scale)
    Structure Score (0-4):
      - H4 aligned with direction:  +1
      - H1 aligned with direction:  +1
      - M15 aligned with direction: +1
      - M5 aligned with direction:  +1
    Volume Score (0-3):
      - Volume ROC >= 20%:           +1
      - Volume delta matches dir:    +1
      - CVD slope matches dir:       +1
    Price Score (0-3):
      - SMA alignment matches dir:   +1
      - SMA momentum WIDENING:       +1
      - VWAP position matches dir:   +1
- Health Labels:    CRITICAL (0-3), WEAK (4-5), MODERATE (6-7), STRONG (8-10)
- Structure:        Fractal-based at H4, H1, M15, M5 timeframes
                    (fractal_length=5, BOS/ChoCH detection)
- Structure Lookbacks:
    M5:  3 days
    M15: 7 days
    H1:  14 days
    H4:  30 days
- Target Table:     entry_indicators
- Output Fields:    50+ fields including all 10 health factors, structure
                    labels, indicator values, healthy flags per component

2.8 STEP 5 - M5 INDICATOR BARS (Full-Day M5 Analysis)
--------------------------------------------------------------------------------
- Purpose:          Calculate complete M5 indicator bars for full trading day
- Time Range:       09:30 - 16:00 ET (regular session)
- Data Source:      Extended M5 bars (includes prior day for lookback)
- Indicators Per Bar:
    - OHLCV + VWAP
    - SMA 9/21, spread, alignment, momentum ratio/label
    - Volume ROC (20-bar baseline)
    - Volume delta (5-bar rolling)
    - CVD slope (15-bar window)
    - Market structure at M5, M15, H1, H4
    - bars_in_calculation (running count)
- Target Table:     m5_indicator_bars

2.9 STEP 6 - M1 INDICATOR BARS (Full-Day M1 Analysis with Health)
--------------------------------------------------------------------------------
- Purpose:          Calculate complete M1 indicator bars with health scores
- Time Range:       08:00 - 16:00 ET (includes premarket ramp-up)
- Premarket Start:  08:00 ET
- Ramp-Up Bars:     15 M1 bars before entry for indicator warm-up
- Batch Size:       500 records per INSERT
- Indicators Per Bar:
    - All M5 indicators (calculated on M1 aggregation)
    - Structure at 5 timeframes: H4, H1, M15, M5, M1
    - Health score (0-10) using HealthCalculator
    - candle_range_pct: (high - low) / close * 100
    - Entry qualifier scores: long_score (0-7), short_score (0-7)
- Target Table:     m1_indicator_bars

2.10 STEP 7 - M5 TRADE BARS (Trade-Specific Health Scoring)
--------------------------------------------------------------------------------
- Purpose:          Build trade-specific M5 bars with direction-aware health
- Dependencies:     mfe_mae + m5_indicator_bars
- Health Calculator: Direction-specific scoring (10 components, 0-10 scale)
    LONG Health Logic:
      - vol_delta > 0                    = healthy
      - cvd_slope >= 0.1                 = healthy
      - sma9 > sma21                     = healthy (alignment)
      - sma momentum WIDENING            = healthy
      - price > vwap                     = healthy
      - structure BULL at each timeframe  = healthy
    SHORT Health Logic:
      - vol_delta < 0                    = healthy
      - cvd_slope <= -0.1               = healthy
      - sma9 < sma21                     = healthy (alignment)
      - sma momentum WIDENING            = healthy
      - price < vwap                     = healthy
      - structure BEAR at each timeframe  = healthy
- Health Buckets:   CRITICAL (0-3), WEAK (4-5), MODERATE (6-7), STRONG (8-10)
- Target Table:     m5_trade_bars
- Output:           Per-bar OHLCV, all indicators, 10 healthy flags,
                    structure_score, volume_score, price_score, health_score,
                    health_label, bars_from_entry

2.11 STEP 8 - OPTIMAL TRADE (Event-Based Trade Tracking)
--------------------------------------------------------------------------------
- Purpose:          Generate 4 events per trade: ENTRY, MFE, MAE, EXIT
- Version:          Points-Based v2.0
- Win Condition:    mfe_potential_time < mae_potential_time (temporal ordering)
- P&L Metric:       Points (absolute dollars), not R-multiples
- EOD Exit:         Fixed at 15:30 ET
- Time Alignment:   All event times floored to M5 boundaries
                    (e.g., 10:07:23 -> 10:05:00)
- Health Delta:     health_score_at_event - health_score_at_entry
    IMPROVING:      delta >= +2
    DEGRADING:      delta <= -2
    STABLE:         -1 <= delta <= +1
- Calculation Version: 2.0
- Target Table:     optimal_trade
- Output Per Event: trade_id, event_type, date, ticker, direction, model,
                    win, event_time, bars_from_entry, entry_price,
                    price_at_event, points_at_event, actual_points,
                    health_score, health_label, health_delta, health_summary,
                    structure/volume/price scores, all indicator values,
                    all structure labels, all healthy flags (~44 fields)

2.12 STEP 9 - R-LEVEL EVENTS (R-Multiple Crossing Detection)
--------------------------------------------------------------------------------
- Purpose:          Detect precise M1 bar when each R-level is first crossed
- Event Types:      R1_CROSS, R2_CROSS, R3_CROSS
- R-Levels:         R1 = 1.0R, R2 = 2.0R, R3 = 3.0R
- Stop Source:      zone_buffer stop from stop_analysis (5% buffer default)
- Crossing Logic:
    LONG:  bar high >= R-level price
    SHORT: bar low <= R-level price
- Data Source:      M1 indicator bars from entry to EOD
- Batch Processing: 100 trades per batch, log every 10
- Target Table:     optimal_trade (appended alongside ENTRY/MFE/MAE/EXIT)
- Output Per Event: trade_id, event_type, date, ticker, event_time,
                    bars_from_entry, points_at_event, health_delta,
                    health_summary, full indicator snapshot

2.13 STEP 10 - OPTIONS ANALYSIS (Options Performance Tracking)
--------------------------------------------------------------------------------
- Purpose:          Evaluate parallel options trade performance
- Strike Selection: FIRST_ITM (default), ATM, FIRST_OTM configurable
    FIRST_ITM Selection:
      LONG:  Highest ITM call strike (strike < entry_price)
      SHORT: Lowest ITM put strike (strike > entry_price)
    ATM Selection:   Strike closest to entry_price
    FIRST_OTM Selection:
      LONG:  Lowest OTM call strike (strike > entry_price)
      SHORT: Highest OTM put strike (strike < entry_price)
- Entry Bar:        15-second multiplier (matches S15 backtest entry)
- Exit Bar:         5-minute multiplier (matches M5 backtest exit)
- Min Expiry:       2 days to expiration
- P&L Calculations:
    pnl_dollars  = (exit_price - entry_price) * 100 * contracts
    pnl_percent  = ((exit_price - entry_price) / entry_price) * 100
    option_r     = pnl_dollars / (underlying_risk * 100)
    r_multiplier = option_r / underlying_pnl_r
- Status Codes:     SUCCESS, NO_CHAIN, NO_CONTRACT, NO_ENTRY_QUOTE,
                    NO_EXIT_QUOTE, CALCULATION_ERROR
- Target Table:     options_analysis

2.14 STEP 11 - OP MFE/MAE (Options Excursion Analysis)
--------------------------------------------------------------------------------
- Purpose:          Calculate MFE/MAE potential for options contracts
- Bar Multiplier:   1 minute
- Min Option Price: $0.01
- Target Table:     op_mfe_mae_potential

2.15 STEP 12 - STOP ANALYSIS (6 Stop Types + Outcome Simulation)
--------------------------------------------------------------------------------
- Purpose:          Calculate stop prices for 6 methodologies and simulate
                    trade outcomes under each
- Reference:        CALC-009
- Stop Types:
    1. Zone Boundary + 5% Buffer (price-based trigger)
       LONG:  stop = zone_low - (zone_distance * 0.05)
       SHORT: stop = zone_high + (zone_distance * 0.05)

    2. Prior M1 Bar High/Low (price-based trigger)
       Stop at high/low of M1 candle immediately before entry
       Handles prior-day bars for early morning entries

    3. Prior M5 Bar High/Low (price-based trigger)
       Stop at high/low of M5 bar at bars_from_entry = -1

    4. M5 ATR 1.1x (close-based trigger)
       LONG:  stop = entry - (M5_ATR_14 * 1.1)
       SHORT: stop = entry + (M5_ATR_14 * 1.1)
       Triggers only when M5 bar CLOSES beyond level

    5. M15 ATR 1.1x (close-based trigger)
       Same formula using M15 ATR (aggregated from M5 bars: 3 M5 = 1 M15)
       Checked at M15 boundaries (every 3rd M5 bar)

    6. M5 Fractal High/Low (price-based trigger)
       Stop at most recent confirmed fractal swing
       Fractal length: 2 (requires 2 bars on each side)
       Note: Uses fractal_length=2 (different from indicator modules' 5)

- ATR Parameters:   Period = 14, Multiplier = 1.1
- Zone Buffer:      5% of zone distance
- Outcome Simulation:
    For each stop type, walks M1 (price-based) or M5 (close-based) bars:
    - WIN:     MFE reached before stop (R >= 1.0)
    - LOSS:    Stop hit before meaningful MFE (R = -1.0)
    - PARTIAL: MFE reached but R < 1.0, or stop never hit
    Output: stop_distance, stop_distance_pct, stop_hit, stop_hit_time,
            mfe_price, mfe_time, mfe_distance, r_achieved, outcome,
            trigger_type
- Target Table:     stop_analysis

2.16 STEP 13 - INDICATOR REFINEMENT (Continuation/Rejection Scoring)
--------------------------------------------------------------------------------
- Purpose:          Score entry quality based on model type (CALC-010)
- Model Mapping:
    Continuation Models: EPCH1, EPCH3 (with-trend entries)
    Rejection Models:    EPCH2, EPCH4 (counter-trend/exhaustion entries)

- Continuation Score (0-10):
    CONT-01  Multi-Timeframe Alignment (0-4):
             1 point per timeframe aligned with direction (H4, H1, M15, M5)

    CONT-02  SMA Momentum (0-2):
             +1 if SMA9/SMA21 spread aligned with direction
             +1 if spread WIDENING (ROC > 5%)

    CONT-03  Volume Thrust (0-2):
             +1 if volume ROC > 20%
             +1 if volume delta aligned with direction

    CONT-04  Pullback Quality (0-2):
             Measures accumulation during pullback
             delta_ratio < 0.3 = strong (+2)
             delta_ratio < 0.5 = moderate (+1)
             Pullback lookback: 3 bars

- Rejection Score (0-11):
    REJ-01   Structure Divergence (0-2):
             +2 if HTF trend opposite to LTF overextension (strong divergence)
             +1 if partial divergence

    REJ-02   SMA Exhaustion (0-3):
             +1 if spread < 0.25% (tight, Q2)
             +2 if spread < 0.15% (very tight, Q1)
             +1 if spread contracting

    REJ-03   Delta Absorption (0-2):
             Measures delta/price ratio as exhaustion signal
             ratio > 2.0 = strong absorption (+2)
             ratio > 1.5 = moderate absorption (+1)

    REJ-04   Volume Climax (0-2):
             +2 if volume ROC > 50% (extreme spike)
             +1 if volume ROC > 30% AND declining from peak

    REJ-05   CVD Extreme (0-2):
             +2 if CVD slope normalized < -0.5 (Q1, extreme selling)
             +1 if CVD slope normalized < -0.3 (Q2)
             (Reversed for SHORT: > +0.5 / > +0.3)
             CVD slope period: 15 bars

- Target Table:     indicator_refinement

2.17 STEP 14 - R WIN/LOSS (ATR-Based Outcome Evaluation)
--------------------------------------------------------------------------------
- Purpose:          Evaluate trade outcomes using M5 ATR-based stop and
                    R-multiple targets from 1R through 5R
- ATR Parameters:   Period = 14, Multiplier = 1.1
- 1R Definition:    stop_distance = M5_ATR_14 * 1.1
- R-Level Targets:  entry_price +/- (N * 1R) for N = 1, 2, 3, 4, 5
- Pre-Entry Bars:   16 M5 bars required (14 for ATR + buffer)
- EOD Cutoff:       15:30 ET
- Bar Walk Logic:
    Walk M1 bars from entry to 15:30 ET:
    1. Check R-level targets: high/low touch = price-based trigger
    2. Check stop: close beyond stop = close-based trigger
    3. Same-candle conflict: stop on same bar as R-level hit = LOSS
- Outcome Determination:
    R1+ hit before stop:  WIN (exit_reason = R_TARGET)
    Stop before R1:       LOSS (exit_reason = STOP)
    EOD without either:   WIN if price > entry (LONG), else LOSS
- Target Table:     r_win_loss
- Output Fields:    trade_id, date, ticker, direction, model, entry_price,
                    atr_value, stop_price, stop_distance, outcome,
                    exit_reason, exit_time, exit_price, R1-R5 hit flags,
                    R1-R5 times, bars_from_entry at exit

2.18 STEP 15 - TRADES UNIFIED (Canonical Outcome Table)
--------------------------------------------------------------------------------
- Purpose:          Build single-source-of-truth outcome table reconciling
                    ATR-based and zone-buffer methodologies
- Outcome Priority:
    1. PRIMARY:   r_win_loss record exists -> use ATR-based outcome
    2. SECONDARY: No r_win_loss -> calculate zone_buffer fallback
    3. TERTIARY:  No zone data -> use original trades.is_winner
- Zone Buffer Fallback:
    Stop = zone_low/high +/- (zone_height * 5%)
    1R = stop distance
    Walk M1 bars: R1 hit (price-based) vs stop (close-based)
    Same-candle conflict: stop takes priority (LOSS)
- Convenience Fields:
    outcome_method:  "atr_r_target" or "zone_buffer_fallback"
    pnl_r:           R-multiple achieved
    reached_2r:      Boolean flag
    reached_3r:      Boolean flag
    minutes_to_r1:   Time from entry to first R1 touch
- Target Table:     trades_m5_r_win
- Output:           50+ fields merging trade metadata, R-level outcomes,
                    and method reconciliation

2.19 SHARED INDICATORS LIBRARY
--------------------------------------------------------------------------------
All processors import from a centralized indicators package to ensure
calculation consistency across the pipeline and with the live Entry
Qualifier tool.

- SMA (sma.py):
    Periods: 9 and 21
    Outputs: sma9, sma21, spread (sma9 - sma21), alignment (BULLISH/BEARISH)
    Momentum: Compares current spread to spread N bars ago
              WIDENING (ratio > 1.1x), NARROWING (ratio < 0.9x), FLAT
    Momentum lookback: 10 bars

- VWAP (vwap.py):
    Formula: Cumulative(TP * Volume) / Cumulative(Volume)
    Typical Price: (High + Low + Close) / 3
    Outputs: vwap, price_diff, price_pct, side (ABOVE/BELOW/AT)

- Volume ROC (volume_roc.py):
    Formula: ((current_volume - baseline_avg) / baseline_avg) * 100
    Baseline period: 20 bars
    Thresholds: > 30% elevated, > 50% high

- Volume Delta (volume_delta.py):
    Bar position: (close - low) / (high - low)
    Bar delta: volume * ((2 * bar_position) - 1)
    Rolling delta: Sum of bar_delta over N bars (default 5)
    Outputs: rolling_delta, signal (Bullish/Bearish/Neutral)

- CVD Slope (cumulative volume delta):
    Window: 15 bars
    Rising threshold: slope >= +0.1
    Falling threshold: slope <= -0.1

- Market Structure (structure.py):
    Detection: Fractal-based swing high/low identification
    Fractal length: 5 bars (for indicator modules)
    Break types: BOS (Break of Structure), ChoCH (Change of Character)
    States: BULL, BEAR, NEUTRAL
    Output: direction_label, break_type, strong_level, weak_level
    Multi-timeframe: H4, H1, M15, M5 with HTF bar fetching via Polygon

- Health Score (composite):
    Components: 10 equal-weight binary factors
    Structure (0-4): h4, h1, m15, m5 aligned with trade direction
    Volume (0-3): vol_roc healthy, vol_delta healthy, cvd_slope healthy
    Price (0-3): sma_alignment healthy, sma_momentum healthy, vwap healthy
    Total: 0-10
    Labels: CRITICAL (0-3), WEAK (4-5), MODERATE (6-7), STRONG (8-10)

- Entry Qualifier Score (composite):
    Max score: 7 per direction
    Separate long_score and short_score
    Includes: candle_range_pct = (high - low) / close * 100

2.20 DATABASE ARCHITECTURE
--------------------------------------------------------------------------------
Source Tables (read):
    trades              Base trade metadata (from backtest runner)
    setups              Zone definitions (from 01_application pipeline)

Generated Tables (write):
    m1_bars             Raw 1-minute OHLCV bars
    h1_bars             Raw 1-hour OHLCV bars
    mfe_mae_potential   Potential excursion from entry to EOD
    entry_indicators    Indicator snapshot at entry time
    m5_indicator_bars   Full-day M5 bars with all indicators
    m1_indicator_bars   Full-day M1 bars with health + EQ scores
    m5_trade_bars       Trade-specific M5 bars with health scoring
    optimal_trade       Event-based trade tracking (4+3 events per trade)
    options_analysis    Options P&L performance metrics
    op_mfe_mae_potential Options excursion analysis
    stop_analysis       6 stop types with simulated outcomes
    indicator_refinement Continuation/Rejection quality scores
    r_win_loss          ATR-based R-multiple outcomes
    trades_m5_r_win     Unified canonical outcome table

Incremental Processing:
    All modules use LEFT JOIN exclusion to skip already-processed trades
    ON CONFLICT (trade_id) DO NOTHING for upsert safety
    Batch INSERT sizes: 500 (m1_bars, m1_indicator_bars), 100 (default)

2.21 CONFIGURATION DEFAULTS
--------------------------------------------------------------------------------
Parameter                    Value        Context
---------------------------  -----------  -----------------------------------
SMA Periods                  9, 21        All indicator modules
SMA Momentum Lookback        10 bars      Spread trend detection
SMA Widening Threshold       1.1x ratio   Momentum classification
Volume ROC Baseline          20 bars      Elevated volume detection
Volume ROC Healthy           >= 20%       Health scoring threshold
Volume Delta Rolling         5 bars       Short-term delta window
CVD Window                   15 bars      Slope calculation period
CVD Rising Threshold         >= +0.1      Bullish pressure signal
CVD Falling Threshold        <= -0.1      Bearish pressure signal
Fractal Length (indicators)  5 bars       Structure detection
Fractal Length (stops)       2 bars       Stop Type 6 (tighter)
ATR Period                   14           Stop and R calculations
ATR Multiplier               1.1x         1R distance definition
Zone Buffer Percentage       5%           Stop Type 1 / fallback
R-Levels                     1, 2, 3      R-level event detection
R-Levels (win/loss)          1, 2, 3, 4, 5  Full R evaluation
EOD Cutoff                   15:30 ET     MFE/MAE and exit boundary
Health Improving Threshold   >= +2 delta  Optimal trade classification
Health Degrading Threshold   <= -2 delta  Optimal trade classification
Min Days to Expiry           2            Options contract filter
Default Strike Method        FIRST_ITM    Options strike selection
Entry Bar Multiplier         15 seconds   Options entry timing
Exit Bar Multiplier          5 minutes    Options exit timing
Min Option Price             $0.01        Options validity filter
Min Risk Dollars             $0.01        MFE/MAE minimum stop
H1 Lookback Bars             30           H1 data ingestion
H1 Lookback Days             7            H1 calendar window
Premarket Start              08:00 ET     M1 indicator bars
Ramp-Up Bars Before Entry    15           M1 warm-up period
M5 HTF Lookback              3 days       Structure detection
M15 HTF Lookback             7 days       Structure detection
H1 HTF Lookback              14 days      Structure detection
H4 HTF Lookback              30 days      Structure detection
Batch Insert Size (default)  100          Database batch writes
Batch Insert Size (M1)       500          High-volume bar tables
