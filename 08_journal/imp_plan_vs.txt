================================================================================
EPOCH TRADE JOURNAL ‚Äî CLAUDE CODE IMPLEMENTATION INSTRUCTIONS
XIII Trading LLC | Module 08_journal
================================================================================

PURPOSE OF THIS DOCUMENT
================================================================================
These are step-by-step implementation instructions for Claude Code (Sonnet 4)
to build the EPOCH Trade Journal system. This is a script-based module ‚Äî NO
Streamlit, NO PyQt, NO GUI. Just Python scripts that generate Notion pages
and PDF reports from existing Supabase trade data.

Read this ENTIRE document before writing any code. Follow the phases in order.
Ask clarifying questions if any specification is ambiguous.


================================================================================
SECTION 1: SYSTEM CONTEXT
================================================================================

The EPOCH Trading System v2.0 is a zone-based intraday trading platform with
6 existing modules (01-06). This journal module (07) is a READ-ONLY consumer
of data already in Supabase. It does NOT modify any existing tables.

Existing Data Flow:
  01_application (Zone Analysis)  ‚Üí zones, setups, bar_data, hvn_pocs,
                                    market_structure tables
  02_dow_ai (Entry Qualifier)     ‚Üí ai_predictions table
  03_backtest (Backtest Runner)   ‚Üí trades table
  03_backtest/processor (15-step) ‚Üí mfe_mae_potential, entry_indicators,
                                    m1_indicator_bars, m5_indicator_bars,
                                    m5_trade_bars, optimal_trade,
                                    stop_analysis, indicator_refinement,
                                    r_win_loss, trades_m5_r_win tables
  04_indicators (Edge Testing)    ‚Üí results/ markdown reports
  05_system_analysis (Dashboard)  ‚Üí ramp_up_* analysis tables
  06_training (Flashcard Review)  ‚Üí trade_reviews, trade_analysis tables

This module (08_journal) reads from ALL of the above and writes ONLY to:
  - Notion (via MCP or API) ‚Äî new Trade Journal database + pages
  - Local filesystem ‚Äî PDF files in outputs/ directory

IMPORTANT: Trade data is already in Supabase. The user has a separate trade
log cleaner that uploads raw trades. The backtest runner and secondary
processors then enrich that data. This module consumes the enriched data.


================================================================================
SECTION 2: TECHNOLOGY STACK & DEPENDENCIES
================================================================================

Runtime:        Python 3.12+
Database:       Supabase PostgreSQL via psycopg2 with SSL
Notion:         Notion MCP server (https://mcp.notion.com/mcp) ‚Äî PREFERRED
                Fallback: Notion API via requests
PDF:            reportlab (primary), matplotlib (charts in PDFs)
No frameworks:  No Streamlit, No PyQt, No Flask, No FastAPI

Required Packages:
  psycopg2-binary>=2.9.9    # PostgreSQL driver
  reportlab>=4.0             # PDF generation
  matplotlib>=3.8.0          # Chart generation for PDFs
  requests>=2.31.0           # Notion API fallback / Polygon calls
  python-dotenv>=1.0.0       # Environment variable loading

Supabase Connection (from existing EPOCH config pattern):
  Host:     db.pdbmcskznoaiybdiobje.supabase.co
  Port:     5432
  Database: postgres
  User:     postgres
  SSL:      require

IMPORTANT: Use the same credential pattern as existing EPOCH modules. Check
if 00_shared/config/credentials.py exists. If so, import from there. If not,
use a local config.py with the connection string. Do NOT hardcode credentials
in script files.

Notion MCP: The user has Notion MCP connected. When creating Notion pages,
use MCP tool calls (notion-create-pages, notion-create-database, notion-search,
notion-fetch) as the PRIMARY method. Only fall back to direct Notion API if
MCP is unavailable.


================================================================================
SECTION 3: MODULE STRUCTURE
================================================================================

Create the following directory structure under the EPOCH project root:

08_journal/
‚îú‚îÄ‚îÄ CLAUDE.md                        # Context file for future Claude sessions
‚îú‚îÄ‚îÄ config.py                        # Configuration (DB, Notion, paths)
‚îú‚îÄ‚îÄ requirements.txt                 # Python dependencies
‚îÇ
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ fetcher.py                   # All Supabase read queries
‚îÇ
‚îú‚îÄ‚îÄ notion/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ database_setup.py            # One-time Notion database creation
‚îÇ   ‚îú‚îÄ‚îÄ trade_report.py              # Per-trade Notion page generator
‚îÇ   ‚îî‚îÄ‚îÄ templates.py                 # Notion markdown/content templates
‚îÇ
‚îú‚îÄ‚îÄ pdf/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ daily_report.py              # Daily PDF generator
‚îÇ   ‚îú‚îÄ‚îÄ weekly_report.py             # Weekly PDF generator
‚îÇ   ‚îú‚îÄ‚îÄ monthly_report.py            # Monthly PDF generator
‚îÇ   ‚îú‚îÄ‚îÄ styles.py                    # Shared PDF styling (XIII branding)
‚îÇ   ‚îî‚îÄ‚îÄ charts.py                    # Matplotlib chart helpers for PDFs
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ setup_notion_db.py           # One-time: create Notion database
‚îÇ   ‚îú‚îÄ‚îÄ generate_trade_report.py     # Per-trade or batch Notion reports
‚îÇ   ‚îú‚îÄ‚îÄ generate_daily.py            # Daily PDF
‚îÇ   ‚îú‚îÄ‚îÄ generate_weekly.py           # Weekly PDF
‚îÇ   ‚îî‚îÄ‚îÄ generate_monthly.py          # Monthly PDF
‚îÇ
‚îî‚îÄ‚îÄ outputs/
    ‚îú‚îÄ‚îÄ daily/                       # Generated daily PDFs
    ‚îú‚îÄ‚îÄ weekly/                      # Generated weekly PDFs
    ‚îî‚îÄ‚îÄ monthly/                     # Generated monthly PDFs


================================================================================
SECTION 4: PHASE 1 ‚Äî DATA FETCHER
================================================================================

FILE: data/fetcher.py

This is the single data access layer. ALL Supabase queries live here.
Every function returns Python dicts or lists of dicts. No DataFrames ‚Äî
keep it simple for downstream consumption by both Notion and PDF generators.

Connection Pattern:
  - Use psycopg2 with RealDictCursor
  - SSL mode = require
  - Singleton connection with auto-reconnect
  - Follow the same pattern as 05_system_analysis/data/supabase_client.py

REQUIRED FUNCTIONS (implement ALL of these):

4.1 Core Trade Data
-------------------

def fetch_trade(trade_id: str) -> dict:
    """Fetch single trade by trade_id from trades table."""
    # Fields: trade_id, date, ticker, model, zone_type, direction,
    #         zone_high, zone_low, entry_price, entry_time, stop_price,
    #         target_3r, target_calc, target_used, exit_price, exit_time,
    #         exit_reason, pnl_dollars, pnl_r, risk, is_winner

def fetch_trades_by_date(date: str) -> list[dict]:
    """Fetch all trades for a given date. Format: 'YYYY-MM-DD'."""

def fetch_trades_by_date_range(date_from: str, date_to: str) -> list[dict]:
    """Fetch trades within date range (inclusive)."""

4.2 Canonical Outcomes (WIN CONDITION SOURCE)
---------------------------------------------

def fetch_canonical_outcome(trade_id: str) -> dict:
    """Fetch from trades_m5_r_win ‚Äî the single source of truth for outcomes.
    
    Fields: trade_id, date, ticker, model, direction, entry_price,
            stop_price, stop_distance, r1_price, outcome, exit_reason,
            outcome_method, is_winner, pnl_r, max_r_achieved,
            reached_2r, reached_3r, minutes_to_r1
    """

def fetch_canonical_outcomes_by_date(date: str) -> dict[str, dict]:
    """Returns dict keyed by trade_id for batch lookups."""

4.3 MFE/MAE Data
-----------------

def fetch_mfe_mae(trade_id: str) -> dict:
    """Fetch from mfe_mae_potential table.
    
    Fields: trade_id, mfe_r_potential, mfe_potential_price,
            mfe_potential_time, mae_r_potential, mae_potential_price,
            mae_potential_time, bars_analyzed, is_winner, pnl_r
    """

4.4 Event Indicators (R-Level Progression)
-------------------------------------------

def fetch_optimal_trade_events(trade_id: str) -> list[dict]:
    """Fetch from optimal_trade table. Returns list of events.
    
    Event types: ENTRY, R1_CROSS, R2_CROSS, R3_CROSS, MFE, MAE, EXIT
    
    Fields per event: trade_id, event_type, event_time, price_at_event,
                      points_at_event, health_score, health_label,
                      health_delta, health_summary, vwap, sma9, sma21,
                      sma_spread, sma_momentum_label, vol_roc, vol_delta,
                      cvd_slope, m5_structure, m15_structure,
                      h1_structure, h4_structure, bars_from_entry
    
    Order by: event_time ASC
    """

4.5 Entry Indicators
---------------------

def fetch_entry_indicators(trade_id: str) -> dict:
    """Fetch from entry_indicators table.
    
    Full indicator snapshot at entry time including:
    health_score, health_label, all structure labels,
    all indicator values, all healthy flags.
    """

4.6 M1 Ramp-Up Bars
---------------------

def fetch_ramp_up_bars(ticker: str, date: str, entry_time: str,
                       bar_count: int = 15) -> list[dict]:
    """Fetch M1 indicator bars BEFORE entry for ramp-up display.
    
    Query: SELECT * FROM m1_indicator_bars
           WHERE ticker = %s AND bar_date = %s AND bar_time < %s
           ORDER BY bar_time DESC LIMIT %s
    
    Then reverse to chronological order.
    
    Fields per bar: bar_time, bar_open, bar_high, bar_low, bar_close,
                    volume, candle_range_pct, vol_delta, vol_roc,
                    sma_spread, sma_momentum_label, h1_structure,
                    long_score, short_score
    """

4.7 Indicator Refinement
--------------------------

def fetch_indicator_refinement(trade_id: str) -> dict:
    """Fetch from indicator_refinement table.
    
    Fields: trade_id, trade_type (CONTINUATION/REJECTION),
            continuation_score, continuation_label,
            rejection_score, rejection_label,
            plus individual component scores (cont_01-04, rej_01-05)
    """

4.8 Zone Data
--------------

def fetch_zones_for_trade(ticker: str, date: str) -> list[dict]:
    """Fetch from zones table for a ticker+date.
    
    Fields: zone_id, zone_high, zone_low, hvn_poc, rank, tier, score
    """

4.9 Stop Analysis
------------------

def fetch_stop_analysis(trade_id: str, stop_type: str = 'm5_atr') -> dict:
    """Fetch from stop_analysis table for a specific stop type.
    
    Fields: stop_price, stop_distance, stop_distance_pct,
            stop_hit, stop_hit_time, mfe_price, mfe_time,
            r_achieved, outcome, trigger_type
    """

4.10 Aggregation Queries (for PDFs)
-------------------------------------

def fetch_daily_summary(date: str) -> dict:
    """Aggregate stats for a single date.
    
    Returns: total_trades, wins, losses, win_rate, net_pnl_r,
             expectancy, profit_factor, best_trade_r, worst_trade_r,
             by_model (dict), by_direction (dict), by_exit_reason (dict)
    
    Use trades_m5_r_win as the outcome source (canonical).
    JOIN with trades for entry/exit details.
    JOIN with mfe_mae_potential for MFE/MAE.
    """

def fetch_weekly_summary(week_start: str) -> dict:
    """Aggregate stats for Mon-Fri of the week containing the given date.
    Calculate the Monday of the week, then fetch Mon through Fri.
    
    Returns: Same as daily_summary but also includes daily_breakdown
    (list of daily stats for each day in the week).
    """

def fetch_monthly_summary(year: int, month: int) -> dict:
    """Aggregate stats for an entire month.
    
    Returns: Same structure plus weekly_breakdown list.
    """


================================================================================
SECTION 5: PHASE 2 ‚Äî NOTION DATABASE & TRADE REPORTS
================================================================================

5.1 DATABASE SETUP (One-Time)
------------------------------

FILE: notion/database_setup.py
SCRIPT: scripts/setup_notion_db.py

Create a Notion database called "EPOCH Trade Journal" with these properties:

PROPERTY NAME          TYPE           OPTIONS/CONFIG
--------------         ----           --------------
Trade ID               title          (auto ‚Äî every Notion DB has one title)
Date                   date           {}
Ticker                 select         (options created dynamically per trade)
Model                  select         options: EPCH1, EPCH2, EPCH3, EPCH4
Direction              select         options: LONG, SHORT
Zone Type              select         options: PRIMARY, SECONDARY
Outcome                select         options: WIN, LOSS
                                      colors: WIN=green, LOSS=red
P&L (R)                number         format: number (2 decimal places)
MFE (R)                number         format: number (2 decimal places)
MAE (R)                number         format: number (2 decimal places)
Health at Entry        number         format: number (0 decimal places)
Cont/Rej Score         number         format: number (0 decimal places)
Tags                   multi_select   options: (see Tag Options below)
Reviewed               checkbox       {}

TAG OPTIONS (multi_select ‚Äî user can filter/group by these):
Create these initial tag options. The user will add more over time.
  - "Clean Entry"        color: green
  - "Messy Entry"        color: red
  - "Absorption Skip"    color: orange
  - "H1 Neutral Edge"    color: blue
  - "With Trend"         color: green
  - "Counter Trend"      color: purple
  - "Fast R1"            color: green
  - "Slow R1"            color: yellow
  - "Max Pain"           color: red
  - "Perfect Setup"      color: green
  - "Review Again"       color: yellow
  - "Pattern Example"    color: blue
  - "Edge Validated"     color: green
  - "Edge Violated"      color: red

IMPLEMENTATION NOTES:
- Use Notion MCP (notion-create-database) as primary method
- Store the created database ID in config.py or a .env file for future use
- The script should be idempotent ‚Äî check if database exists before creating
- Print the database URL after creation so user can bookmark it

SCRIPT CLI:
  python scripts/setup_notion_db.py
  python scripts/setup_notion_db.py --parent-page-id <page_id>  # optional parent


5.2 PER-TRADE NOTION PAGE
---------------------------

FILE: notion/trade_report.py
FILE: notion/templates.py
SCRIPT: scripts/generate_trade_report.py

For each trade, create a Notion page in the Trade Journal database with:
  A) Database properties populated from fetched data
  B) Page content with 10 sections (Notion-flavored Markdown)

IMPORTANT: Before writing page content, fetch the Notion enhanced markdown
spec by calling: notion-fetch with id "notion://docs/enhanced-markdown-spec"
This will tell you the exact markdown syntax for tables, callouts, toggles,
colors, dividers, etc. Follow that spec EXACTLY.

PAGE PROPERTIES (set via the "properties" dict in notion-create-pages):

  "Trade ID":        "{trade_id}"                              # title
  "Date":            trades.date                                # date
  "Ticker":          trades.ticker                              # select
  "Model":           trades.model                               # select
  "Direction":       trades.direction                           # select
  "Zone Type":       trades.zone_type                           # select
  "Outcome":         trades_m5_r_win.outcome                    # select (WIN/LOSS)
  "P&L (R)":         trades_m5_r_win.pnl_r                     # number
  "MFE (R)":         mfe_mae_potential.mfe_r_potential          # number
  "MAE (R)":         mfe_mae_potential.mae_r_potential          # number
  "Health at Entry": entry_indicators.health_score              # number
  "Cont/Rej Score":  indicator_refinement.continuation_score    # number
                     OR indicator_refinement.rejection_score
                     (based on trade_type)
  "Tags":            []                                         # empty, user adds manually
  "Reviewed":        false                                      # checkbox, unchecked

PAGE CONTENT (10 sections using Notion markdown):

--- SECTION 1: TRADE SUMMARY + TAGS ---

Use a heading + formatted summary block:

# üìä Trade Summary

**{ticker}** | {date} | {model} | {direction} | {zone_type}

| Field | Value |
|-------|-------|
| Entry Price | ${entry_price} |
| Entry Time | {entry_time} ET |
| Exit Price | ${exit_price} |
| Exit Time | {exit_time} ET |
| Exit Reason | {exit_reason} |
| **Outcome** | **{WIN/LOSS}** |
| **P&L** | **{pnl_r}R** ({pnl_dollars} points) |

> üè∑Ô∏è **Tags:** Add tags above in database properties to group this trade
> with similar setups. Use tags like "Clean Entry", "H1 Neutral Edge",
> "Pattern Example" etc.

---

--- SECTION 2: RISK MANAGEMENT ---

# üéØ Risk Management

| Level | Price | Notes |
|-------|-------|-------|
| Stop (M5 ATR 1.1x) | ${stop_price} | Risk: ${risk_per_share}/share |
| Entry | ${entry_price} | ‚Äî |
| 1R Target | ${r1_price} | {‚úÖ if reached, ‚ùå if not} {time if reached} |
| 2R Target | ${r2_price} | {‚úÖ if reached, ‚ùå if not} {time if reached} |
| 3R Target | ${r3_price} | {‚úÖ if reached, ‚ùå if not} {time if reached} |
| Target Used | ${target_used} | Type: {3R or CALC} |

**Time to R1:** {minutes_to_r1} minutes
**Stop Distance:** {stop_distance_pct}%

---

--- SECTION 3: ZONE CONTEXT ---

# üó∫Ô∏è Zone Context

| Field | Value |
|-------|-------|
| Zone High | ${zone_high} |
| Zone POC | ${hvn_poc} |
| Zone Low | ${zone_low} |
| Zone Rank | {rank} (L1-L5) |
| Zone Tier | {tier} (T1-T3) |
| Zone Score | {score} |

**Market Structure at Entry:**

| Timeframe | Direction |
|-----------|-----------|
| D1 | {d1_structure} |
| H4 | {h4_structure} |
| H1 | {h1_structure} |
| M15 | {m15_structure} |
| M5 | {m5_structure} |

---

--- SECTION 4: INDICATOR SNAPSHOT AT ENTRY ---

# üìà Indicator Snapshot at Entry

| Indicator | Value | Signal |
|-----------|-------|--------|
| Candle Range % | {candle_range_pct}% | {‚úÖ NORMAL / ‚ö†Ô∏è LOW / ‚ùå ABSORPTION} |
| Volume Delta | {vol_delta_formatted} | {‚úÖ Aligned / ‚ùå Misaligned} |
| Volume ROC | {vol_roc}% | {‚úÖ Elevated / ‚ö†Ô∏è Normal / ‚ùå Low} |
| SMA Config | {sma_config} {sma_spread}% | {‚úÖ Wide / ‚ö†Ô∏è Narrow} |
| H1 Structure | {h1_structure} | {‚úÖ NEUTRAL (Edge) / ‚ö†Ô∏è Other} |
| CVD Slope | {cvd_slope} | {‚úÖ Aligned / ‚ùå Misaligned} |
| VWAP Position | {vwap_position} | {‚úÖ Aligned / ‚ùå Misaligned} |
| **Health Score** | **{health_score}/10** | **{health_label}** |
| LONG Score | {long_score}/7 | ‚Äî |
| SHORT Score | {short_score}/7 | ‚Äî |

SIGNAL LOGIC:
  Candle Range: >= 0.15% = ‚úÖ NORMAL, 0.12-0.15% = ‚ö†Ô∏è LOW, < 0.12% = ‚ùå ABSORPTION
  Volume Delta: Aligned = positive for LONG or negative for SHORT
  Volume ROC: >= 30% = ‚úÖ Elevated, 0-30% = ‚ö†Ô∏è Normal, < 0% = ‚ùå Low
  SMA Config: >= 0.15% spread = ‚úÖ Wide
  H1 Structure: NEUTRAL = ‚úÖ (strongest edge), BULL/BEAR = ‚ö†Ô∏è
  CVD Slope: > 0.1 for LONG or < -0.1 for SHORT = ‚úÖ Aligned
  VWAP: ABOVE for LONG or BELOW for SHORT = ‚úÖ Aligned
  Health: 8-10 = STRONG, 6-7 = MODERATE, 4-5 = WEAK, 0-3 = CRITICAL

---

--- SECTION 5: EXCURSION ANALYSIS ---

# üìê Excursion Analysis

| Metric | R-Multiple | Price | Time | Bars |
|--------|-----------|-------|------|------|
| MFE (Best) | +{mfe_r}R | ${mfe_price} | {mfe_time} | {mfe_bars} |
| MAE (Worst) | -{mae_r}R | ${mae_price} | {mae_time} | {mae_bars} |

**MFE before MAE:** {Yes/No}
**Trade Duration:** {duration} minutes
**Edge Efficiency:** {efficiency}% (Actual R / MFE R √ó 100)

---

--- SECTION 6: R-LEVEL PROGRESSION ---

# üìä R-Level Progression

Show health score evolution across trade events. Only include events that
actually occurred (some trades won't reach R2 or R3).

| Event | Time | Price | R-Multiple | Health | Œî Health | Status |
|-------|------|-------|------------|--------|----------|--------|
| ENTRY | {time} | ${price} | 0.0R | {health}/10 | ‚Äî | {label} |
| R1 | {time} | ${price} | +1.0R | {health}/10 | {delta} | {IMPROVING/STABLE/DEGRADING} |
| R2 | {time} | ${price} | +2.0R | {health}/10 | {delta} | {status} |
| R3 | {time} | ${price} | +3.0R | {health}/10 | {delta} | {status} |
| MFE | {time} | ${price} | +{mfe_r}R | {health}/10 | {delta} | {status} |
| MAE | {time} | ${price} | -{mae_r}R | {health}/10 | {delta} | {status} |
| EXIT | {time} | ${price} | {exit_r}R | {health}/10 | {delta} | {status} |

Health Delta Status:
  delta >= +2 = IMPROVING
  delta <= -2 = DEGRADING
  otherwise = STABLE

---

--- SECTION 7: M1 RAMP-UP (15 bars before entry) ---

# ‚è±Ô∏è M1 Ramp-Up (15 Bars Before Entry)

Table showing indicator values for each of the 15 M1 bars leading up to entry.
Use text formatting to indicate signal quality.

| Bar | Time | Candle% | Vol Delta | VROC | SMA | H1 | LONG | SHORT |
|-----|------|---------|-----------|------|-----|-----|------|-------|
| -15 | {time} | {cr}% | {vd} | {vroc}% | {sma} | {h1} | {ls}/7 | {ss}/7 |
| -14 | {time} | {cr}% | {vd} | {vroc}% | {sma} | {h1} | {ls}/7 | {ss}/7 |
| ... (all 15 bars) ...
| -1  | {time} | {cr}% | {vd} | {vroc}% | {sma} | {h1} | {ls}/7 | {ss}/7 |

FORMATTING NOTES:
  - Vol Delta: Format with K/M suffixes (+45K, -2M)
  - SMA: Show as "B 0.18%" (Bullish) or "S 0.12%" (Bearish)
  - H1: BULL / BEAR / NEUT
  - Bars in absorption zone (candle_range_pct < 0.12%): note with ‚ö†Ô∏è

---

--- SECTION 8: INDICATOR REFINEMENT ---

# üî¨ Indicator Refinement

**Trade Type:** {CONTINUATION or REJECTION}
**Score:** {score}/{max} ‚Äî **{label}**

For CONTINUATION trades (EPCH1/EPCH3), show:

| Component | Score | Detail |
|-----------|-------|--------|
| CONT-01: MTF Alignment | {x}/4 | {which timeframes aligned} |
| CONT-02: SMA Momentum | {x}/2 | {spread direction + expanding?} |
| CONT-03: Volume Thrust | {x}/2 | {vol ROC + delta aligned?} |
| CONT-04: Pullback Quality | {x}/2 | {pullback + delta ratio?} |
| **TOTAL** | **{total}/10** | **{STRONG/GOOD/WEAK/AVOID}** |

For REJECTION trades (EPCH2/EPCH4), show:

| Component | Score | Detail |
|-----------|-------|--------|
| REJ-01: Structure Divergence | {x}/2 | {HTF vs LTF divergence?} |
| REJ-02: SMA Exhaustion | {x}/3 | {contracting + tight?} |
| REJ-03: Delta Absorption | {x}/2 | {absorption ratio?} |
| REJ-04: Volume Climax | {x}/2 | {vol spike + declining?} |
| REJ-05: CVD Extreme | {x}/2 | {CVD slope extreme?} |
| **TOTAL** | **{total}/11** | **{STRONG/GOOD/WEAK/AVOID}** |

Score Labels:
  Continuation: STRONG (8-10), GOOD (6-7), WEAK (4-5), AVOID (0-3)
  Rejection: STRONG (9-11), GOOD (6-8), WEAK (4-5), AVOID (0-3)

---

--- SECTION 9: üì∏ CHARTS (Manual Paste) ---

# üì∏ Charts

Use Notion callout blocks (>) with instructions for manual screenshot pasting:

> üìä **M5 Execution Chart**
> Paste your TradingView M5 screenshot here showing entry, exit, and R-levels.

> üìä **M15 Structure Chart**
> Paste your TradingView M15 screenshot here showing zone context.

> üìä **H1 Context Chart**
> Paste your TradingView H1 screenshot here showing macro structure.

> üìä **Footprint / Bookmap** *(Optional)*
> Paste Bookmap or footprint screenshot here.

---

--- SECTION 10: JOURNAL NOTES ---

# ‚úèÔ∏è Journal Notes

Use Notion toggle blocks for structured journaling:

‚ñ∂ What did I learn from this trade?
  (empty ‚Äî user fills in)

‚ñ∂ What would I do differently?
  (empty ‚Äî user fills in)

‚ñ∂ Pattern recognition notes
  (empty ‚Äî user fills in)

‚ñ∂ Additional observations
  (empty ‚Äî user fills in)


5.3 BATCH MODE
---------------

SCRIPT: scripts/generate_trade_report.py

CLI Interface:

  # Single trade
  python scripts/generate_trade_report.py AAPL_012026_EPCH1_1045

  # All trades for a date
  python scripts/generate_trade_report.py --date 2026-02-03

  # Date range
  python scripts/generate_trade_report.py --date-from 2026-01-20 --date-to 2026-02-03

  # Dry run (show what would be created, don't create)
  python scripts/generate_trade_report.py --date 2026-02-03 --dry-run

  # Skip existing (don't recreate pages for trades already in Notion)
  python scripts/generate_trade_report.py --date 2026-02-03 --skip-existing

BATCH LOGIC:
  1. Fetch all trade_ids for the date(s)
  2. For each trade_id:
     a. Fetch ALL data via fetcher.py functions
     b. Build Notion page properties dict
     c. Build Notion page content string (all 10 sections)
     d. Call notion-create-pages with parent = Trade Journal database
     e. Print: "‚úÖ Created: {trade_id} ‚Üí {notion_url}"
  3. Print summary: "Created {N} pages for {date}"

RATE LIMITING:
  - Add 0.5s delay between Notion API calls to avoid rate limits
  - If creating 20+ pages, batch in groups of 10 with 2s pause between groups

SKIP-EXISTING LOGIC:
  - Search Notion database for existing pages with matching Trade ID
  - Use notion-search or query the database
  - Skip trades that already have a page


================================================================================
SECTION 6: PHASE 3 ‚Äî DAILY PDF
================================================================================

FILE: pdf/daily_report.py
FILE: pdf/styles.py
FILE: pdf/charts.py
SCRIPT: scripts/generate_daily.py

DESIGN PRINCIPLES:
  - Dark theme matching EPOCH branding (#1a1a2e background, white text)
  - Professional but compact ‚Äî fits on 3 pages
  - XIII Trading LLC header/footer
  - Use reportlab for layout, matplotlib for charts embedded as images

BRANDING:
  Background:    #1a1a2e (dark navy)
  Text Primary:  #FFFFFF (white)
  Text Muted:    #888888 (gray)
  Accent Win:    #26a69a (teal green)
  Accent Loss:   #ef5350 (red)
  Accent Warn:   #FFC107 (amber)
  Grid Lines:    #2a2a4e (muted purple)
  Font:          Helvetica (reportlab built-in), Courier for numbers

PAGE SIZE: Letter (8.5" x 11") portrait
MARGINS: 0.75" all sides

--- PAGE 1: DAY OVERVIEW ---

Header: "EPOCH DAILY REPORT | {date} | {day_of_week}"
Subheader: "XIII Trading LLC"

Session Stats Box:
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ  Total: {N}    Wins: {W}    Losses: {L}    WR: {%} ‚îÇ
  ‚îÇ  Net P&L: {R}R    Expectancy: {E}R    PF: {PF}     ‚îÇ
  ‚îÇ  Best: +{R}R    Worst: {R}R                         ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

By Model Table:
  | Model | Trades | Wins | Losses | Win Rate | Avg R |
  |-------|--------|------|--------|----------|-------|
  | EPCH1 | ... |
  | EPCH2 | ... |
  | EPCH3 | ... |
  | EPCH4 | ... |

By Direction Table:
  | Direction | Trades | Win Rate | Net R |
  |-----------|--------|----------|-------|
  | LONG | ... |
  | SHORT | ... |

By Exit Reason:
  | Exit | Count | % of Total |
  |------|-------|------------|
  | STOP | ... |
  | TARGET | ... |
  | CHOCH | ... |
  | EOD | ... |

--- PAGE 2: TRADE LOG ---

Header: "TRADE LOG | {date}"

Compact table ‚Äî one row per trade, sorted by entry_time:
  | # | Time | Ticker | Mod | Dir | Entry | Exit | Reason | R | MFE | MAE | HP | W/L |
  
  Where:
    Time = entry_time (HH:MM)
    Mod = EPCH1-4 (abbreviated)
    Dir = L/S (abbreviated)
    R = pnl_r (signed, 1 decimal)
    MFE = mfe_r_potential (1 decimal)
    MAE = mae_r_potential (1 decimal)
    HP = health_score at entry
    W/L = colored cell (green W, red L)

If more than ~20 trades, use smaller font (7pt) to fit on one page.
If more than ~35 trades, overflow to a second log page.

--- PAGE 3: JOURNAL SPACE ---

Header: "SESSION JOURNAL | {date}"

Lined sections with headings:
  "Pre-Market Thesis:"
  (6-8 blank ruled lines)

  "Session Observations:"
  (6-8 blank ruled lines)

  "Key Lessons:"
  (6-8 blank ruled lines)

  "Tomorrow's Focus:"
  (4-6 blank ruled lines)

Footer on all pages: "XIII Trading LLC | EPOCH Trading System v2.0 | Page {N} of 3"

SCRIPT CLI:
  python scripts/generate_daily.py 2026-02-03
  python scripts/generate_daily.py 2026-02-03 --output custom_name.pdf
  
OUTPUT: outputs/daily/EPOCH_Daily_{YYYY-MM-DD}.pdf


================================================================================
SECTION 7: PHASE 4 ‚Äî WEEKLY & MONTHLY PDFs
================================================================================

7.1 WEEKLY PDF
--------------

FILE: pdf/weekly_report.py
SCRIPT: scripts/generate_weekly.py

4 pages. Uses the same branding/styles as daily.

--- PAGE 1: WEEK OVERVIEW ---

Header: "EPOCH WEEKLY REPORT | {mon_date} to {fri_date}"

Cumulative stats box (same format as daily but for full week)

Daily P&L Bar Chart:
  - Matplotlib bar chart, Mon-Fri
  - Green bars for positive days, red for negative
  - Y-axis: R-multiple
  - Embedded as image in reportlab

Equity Curve:
  - Cumulative R through the week
  - Line chart, one point per trade in sequence

--- PAGE 2: PERFORMANCE BREAKDOWN ---

By Model table (same as daily but week totals)
By Direction table
By Zone Type: PRIMARY vs SECONDARY
By Exit Reason distribution

Best/Worst Days: Date + Net R + Win Rate

--- PAGE 3: INDICATOR EDGE TRACKING ---

Average Health Score Table:
  | Group | Avg Health | Trades |
  |-------|-----------|--------|
  | Winners | {avg} | {n} |
  | Losers | {avg} | {n} |

H1 Structure Distribution:
  | H1 State | Trades | Win Rate |
  |----------|--------|----------|
  | NEUTRAL | {n} | {wr}% |
  | BULLISH | {n} | {wr}% |
  | BEARISH | {n} | {wr}% |

Absorption Filter Check:
  "Trades in absorption zones (candle < 0.12%): {n} ({%} of total)"
  "Win rate in absorption: {wr}% vs Normal: {wr}%"

--- PAGE 4: JOURNAL SPACE ---

  "Week Summary:" (blank lines)
  "What worked this week:" (blank lines)
  "What needs improvement:" (blank lines)
  "Focus areas for next week:" (blank lines)

SCRIPT CLI:
  python scripts/generate_weekly.py 2026-02-03    # generates for the week containing this date
  
OUTPUT: outputs/weekly/EPOCH_Weekly_{YYYY-MM-DD}_to_{YYYY-MM-DD}.pdf


7.2 MONTHLY PDF
----------------

FILE: pdf/monthly_report.py
SCRIPT: scripts/generate_monthly.py

4 pages. Same branding.

--- PAGE 1: MONTH OVERVIEW ---

Header: "EPOCH MONTHLY REPORT | {Month} {Year}"

Cumulative stats for the month
Weekly breakdown table: | Week | Trades | WR% | Net R |
Month equity curve (cumulative R)
Comparison vs prior month (if data exists)

--- PAGE 2: DEEP ANALYTICS ---

Model Performance by Week:
  - 4 mini bar charts (one per EPCH model) showing weekly win rate trend

Time of Day Analysis:
  - Morning (09:30-11:00) vs Midday (11:00-14:00) vs Afternoon (14:00-15:30)
  - Trades, WR%, Avg R per window

MFE/MAE Summary:
  - Median MFE (R), Median MAE (R), Favorable Ratio

Zone Tier Performance:
  | Tier | Trades | Win Rate | Avg R |
  | T1 | ... |
  | T2 | ... |
  | T3 | ... |

--- PAGE 3: EDGE VALIDATION ---

Rolling Indicator Edges:
  - H1 Neutral win rate this month vs all-time
  - Absorption filter effectiveness this month vs all-time
  - Volume Delta paradox holding? (misaligned > aligned for SHORT?)

Sample Size Growth:
  - Total trades this month / cumulative all-time
  - "Statistical power improving" note

--- PAGE 4: JOURNAL SPACE ---

  "Monthly reflection:" (blank lines)
  "System changes to consider:" (blank lines)
  "Goals for next month:" (blank lines)

SCRIPT CLI:
  python scripts/generate_monthly.py 2026-01     # YYYY-MM format
  python scripts/generate_monthly.py 2026-02

OUTPUT: outputs/monthly/EPOCH_Monthly_{YYYY-MM}.pdf


================================================================================
SECTION 8: CONFIGURATION FILE
================================================================================

FILE: config.py

"""EPOCH Trade Journal Configuration"""
import os
from pathlib import Path

# Module paths
MODULE_DIR = Path(__file__).parent
OUTPUTS_DIR = MODULE_DIR / "outputs"
DAILY_DIR = OUTPUTS_DIR / "daily"
WEEKLY_DIR = OUTPUTS_DIR / "weekly"
MONTHLY_DIR = OUTPUTS_DIR / "monthly"

# Create output dirs
for d in [DAILY_DIR, WEEKLY_DIR, MONTHLY_DIR]:
    d.mkdir(parents=True, exist_ok=True)

# Supabase (import from shared if available, otherwise define here)
try:
    from shared.config.credentials import SUPABASE_HOST, SUPABASE_PORT, \
        SUPABASE_DB, SUPABASE_USER, SUPABASE_PASSWORD
except ImportError:
    SUPABASE_HOST = os.getenv("SUPABASE_HOST", "db.pdbmcskznoaiybdiobje.supabase.co")
    SUPABASE_PORT = os.getenv("SUPABASE_PORT", "5432")
    SUPABASE_DB = os.getenv("SUPABASE_DB", "postgres")
    SUPABASE_USER = os.getenv("SUPABASE_USER", "postgres")
    SUPABASE_PASSWORD = os.getenv("SUPABASE_PASSWORD", "")

# Notion
NOTION_DATABASE_ID = os.getenv("NOTION_JOURNAL_DB_ID", "")
# Set after running setup_notion_db.py

# Canonical win condition
CANONICAL_STOP_TYPE = "m5_atr"  # M5 ATR(14) x 1.1 close-based
CANONICAL_TABLE = "trades_m5_r_win"

# Indicator thresholds (for signal classification in reports)
ABSORPTION_THRESHOLD = 0.12    # candle_range_pct below this = skip
NORMAL_THRESHOLD = 0.15        # candle_range_pct above this = tradeable
VOL_ROC_ELEVATED = 30          # volume ROC above this = elevated
SMA_WIDE_SPREAD = 0.15         # SMA spread above this = wide
CVD_RISING = 0.1               # CVD slope above this = rising
CVD_FALLING = -0.1             # CVD slope below this = falling

# Health score labels
HEALTH_LABELS = {
    range(8, 11): "STRONG",
    range(6, 8): "MODERATE",
    range(4, 6): "WEAK",
    range(0, 4): "CRITICAL",
}

# PDF branding
PDF_BG_COLOR = "#1a1a2e"
PDF_TEXT_COLOR = "#FFFFFF"
PDF_MUTED_COLOR = "#888888"
PDF_WIN_COLOR = "#26a69a"
PDF_LOSS_COLOR = "#ef5350"
PDF_WARN_COLOR = "#FFC107"
PDF_GRID_COLOR = "#2a2a4e"

# Rate limiting
NOTION_DELAY = 0.5  # seconds between Notion API calls
BATCH_SIZE = 10     # pages per batch
BATCH_PAUSE = 2.0   # seconds between batches


================================================================================
SECTION 9: CLAUDE.md CONTEXT FILE
================================================================================

FILE: CLAUDE.md

Create this file so future Claude Code sessions understand the module:

```markdown
# 08_journal ‚Äî EPOCH Trade Journal

## Purpose
Script-based trade journal that generates:
1. Per-trade Notion pages (via MCP) with 10 content sections
2. Printable PDF summaries (Daily, Weekly, Monthly)

## Architecture
- READ-ONLY consumer of Supabase trade data
- No Streamlit, No PyQt, No GUI
- Python scripts ‚Üí Notion pages + PDF files

## Key Files
- `data/fetcher.py` ‚Äî All Supabase queries
- `notion/trade_report.py` ‚Äî Per-trade Notion page builder
- `pdf/daily_report.py` ‚Äî Daily PDF (3 pages)
- `pdf/weekly_report.py` ‚Äî Weekly PDF (4 pages)
- `pdf/monthly_report.py` ‚Äî Monthly PDF (4 pages)

## Win Condition
Canonical outcome from `trades_m5_r_win` table.
Stop: M5 ATR(14) √ó 1.1 close-based.
WIN = MFE >= 1R before stop hit.

## Scripts
```
python scripts/setup_notion_db.py                    # One-time DB setup
python scripts/generate_trade_report.py --date DATE  # Notion pages
python scripts/generate_daily.py DATE                # Daily PDF
python scripts/generate_weekly.py DATE               # Weekly PDF
python scripts/generate_monthly.py YYYY-MM           # Monthly PDF
```

## Dependencies
- psycopg2-binary, reportlab, matplotlib, requests, python-dotenv

## Data Sources (read-only)
trades, trades_m5_r_win, mfe_mae_potential, optimal_trade,
entry_indicators, m1_indicator_bars, indicator_refinement, zones,
stop_analysis, bar_data, hvn_pocs, market_structure, setups
```


================================================================================
SECTION 10: IMPLEMENTATION ORDER & VALIDATION
================================================================================

Build in this EXACT order. Test each phase before moving to the next.

PHASE 1: DATA FETCHER
  1. Create module structure (all directories and __init__.py files)
  2. Create config.py
  3. Implement data/fetcher.py with ALL functions from Section 4
  4. VALIDATE: Write a test script that calls each fetcher function
     with a known trade_id and prints results. Confirm data comes back.

PHASE 2: NOTION REPORTS
  1. Fetch the Notion enhanced markdown spec first
  2. Implement notion/database_setup.py and run setup_notion_db.py
  3. VALIDATE: Confirm database appears in Notion with all properties
  4. Implement notion/templates.py (content string builders for each section)
  5. Implement notion/trade_report.py (orchestrates fetcher + templates)
  6. Implement scripts/generate_trade_report.py (CLI wrapper)
  7. VALIDATE: Generate a single trade page, verify all 10 sections in Notion

PHASE 3: DAILY PDF
  1. Implement pdf/styles.py (colors, fonts, page layout helpers)
  2. Implement pdf/charts.py (matplotlib chart generators)
  3. Implement pdf/daily_report.py
  4. Implement scripts/generate_daily.py
  5. VALIDATE: Generate PDF, open it, verify 3 pages look correct

PHASE 4: WEEKLY + MONTHLY PDFs
  1. Implement pdf/weekly_report.py + scripts/generate_weekly.py
  2. Implement pdf/monthly_report.py + scripts/generate_monthly.py
  3. VALIDATE: Generate both, verify page counts and content

FINAL:
  1. Create CLAUDE.md
  2. Create requirements.txt
  3. Run all scripts end-to-end for a recent date
  4. Print summary of what was created


================================================================================
SECTION 11: EDGE CASES & ERROR HANDLING
================================================================================

HANDLE THESE CASES:

1. Missing Data: Some trades may not have all secondary processor data.
   If a table returns None/empty for a trade, use "N/A" or skip that section.
   NEVER crash on missing data.

2. No Trades for Date: If no trades exist for a requested date, print a
   friendly message and exit (don't create empty PDFs/pages).

3. Partial R-Level Data: Not all trades reach R1/R2/R3. Only show R-level
   rows for events that actually occurred.

4. Notion Rate Limits: If you get a 429 from Notion, implement exponential
   backoff (1s, 2s, 4s, 8s) with max 3 retries.

5. Large Batches: For dates with 30+ trades, show a progress counter
   "Creating page {N} of {total}..."

6. Weekend/Holiday Dates: Return "No trading data for weekends/holidays"
   rather than empty results.

7. Indicator Refinement Missing: Some trades may not have refinement scores.
   Show "Not calculated" rather than erroring.

8. Database Connection: Use try/except on all DB calls. Reconnect on
   connection drops. Print clear error messages.


================================================================================
SECTION 12: TESTING CHECKLIST
================================================================================

Before considering the module complete, verify:

[ ] data/fetcher.py ‚Äî All functions return data for known trade IDs
[ ] Notion database created with all 14 properties (including Tags)
[ ] Single trade Notion page has all 10 sections populated correctly
[ ] Batch mode creates pages for all trades on a date
[ ] --skip-existing flag works (doesn't recreate existing pages)
[ ] --dry-run flag works (prints without creating)
[ ] Daily PDF generates 3 clean pages
[ ] Weekly PDF generates 4 clean pages with charts
[ ] Monthly PDF generates 4 clean pages with charts
[ ] All scripts have --help with clear usage instructions
[ ] Error handling: missing data doesn't crash scripts
[ ] CLAUDE.md is accurate and complete
[ ] requirements.txt lists all dependencies


================================================================================
END OF INSTRUCTIONS
================================================================================